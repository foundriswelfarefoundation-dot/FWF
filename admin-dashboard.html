<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin Dashboard — FWF</title>
  <link rel="icon" type="image/png" href="/assets/images/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
/* ==============================
   CSS VARIABLES
   ============================== */
:root {
  --bg-1:#f0f2f8; --bg-2:#e8ecf4;
  --accent:#6366f1; --accent2:#ec4899; --accent-soft:rgba(99,102,241,.1);
  --sidebar-bg:linear-gradient(180deg,#0f172a 0%,#1e293b 100%);
  --sidebar-text:#94a3b8;
  --card-bg:#ffffff; --card-border:#e2e8f0;
  --text-primary:#0f172a; --text-secondary:#475569; --text-muted:#94a3b8;
  --success:#22c55e; --warning:#f59e0b; --danger:#ef4444; --info:#3b82f6;
}

/* ==============================
   RESET & BASE
   ============================== */
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Plus Jakarta Sans',system-ui,sans-serif;
  background:var(--bg-1);
  min-height:100vh; color:var(--text-primary);
  display:flex;
}
a{color:inherit;text-decoration:none}

/* ==============================
   SIDEBAR
   ============================== */
.sidebar{
  position:fixed; left:0; top:0; bottom:0; width:260px; z-index:100;
  background:var(--sidebar-bg);
  display:flex; flex-direction:column;
  padding:20px 14px 14px;
  transition:transform .3s ease;
}
.sidebar-brand{
  display:flex; align-items:center; gap:12px;
  padding:4px 10px 20px; border-bottom:1px solid rgba(255,255,255,.08);
  margin-bottom:14px;
}
.sidebar-brand img{ width:40px; height:40px; border-radius:10px; }
.sidebar-brand span{ font-size:18px; font-weight:900; color:#fff; }
.sidebar-brand small{ display:block; font-size:11px; color:#ef4444; font-weight:700; margin-top:2px; }
.sidebar-nav{ flex:1; display:flex; flex-direction:column; gap:3px; }
.nav-item{
  display:flex; align-items:center; gap:12px;
  padding:11px 14px; border-radius:10px;
  font-size:13px; font-weight:700;
  color:var(--sidebar-text); opacity:.7;
  cursor:pointer; transition:all .2s;
  border:none; background:none; width:100%; text-align:left;
  font-family:inherit;
}
.nav-item:hover{ opacity:1; background:rgba(255,255,255,.06); }
.nav-item.active{
  opacity:1; background:rgba(99,102,241,.15); color:#818cf8;
  box-shadow:inset 3px 0 0 #6366f1;
}
.nav-item i{ width:18px; text-align:center; font-size:14px; }
.nav-badge{
  margin-left:auto; background:#ef4444; color:#fff;
  padding:2px 7px; border-radius:99px; font-size:10px; font-weight:800;
}
.sidebar-footer{
  border-top:1px solid rgba(255,255,255,.08);
  padding-top:12px; margin-top:auto;
}
.nav-item.logout-btn{ color:#f87171; opacity:.9; }

/* ==============================
   MOBILE
   ============================== */
.mobile-toggle{
  display:none; position:fixed; top:14px; left:14px; z-index:200;
  width:42px; height:42px; border-radius:10px;
  background:#fff; border:1px solid var(--card-border);
  box-shadow:0 4px 12px rgba(0,0,0,.06);
  font-size:16px; cursor:pointer; color:var(--text-primary);
  font-family:inherit;
}
.mobile-overlay{
  display:none; position:fixed; inset:0; z-index:90;
  background:rgba(0,0,0,.4); backdrop-filter:blur(4px);
}

/* ==============================
   MAIN
   ============================== */
.main{
  flex:1; margin-left:260px;
  padding:20px 28px;
  min-height:100vh;
}

/* ==============================
   TOP BAR
   ============================== */
.topbar{
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:24px; flex-wrap:wrap; gap:14px;
}
.topbar h1{
  font-size:24px; font-weight:900; letter-spacing:-.5px;
}
.topbar-right{ display:flex; align-items:center; gap:10px; }
.admin-badge{
  display:inline-flex; align-items:center; gap:6px;
  background:linear-gradient(135deg,#6366f1,#ec4899);
  color:#fff; padding:6px 14px; border-radius:99px;
  font-size:12px; font-weight:800;
}

/* ==============================
   PAGES
   ============================== */
.page{ display:none; animation:fadeIn .3s ease; }
.page.active{ display:block; }
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* ==============================
   STAT CARDS
   ============================== */
.stats-row{
  display:grid; grid-template-columns:repeat(4,1fr); gap:16px;
  margin-bottom:24px;
}
.stat-card{
  background:var(--card-bg); border:1px solid var(--card-border);
  border-radius:16px; padding:20px;
  box-shadow:0 2px 8px rgba(0,0,0,.03);
  transition:transform .2s, box-shadow .2s;
  position:relative; overflow:hidden;
}
.stat-card:hover{ transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.06); }
.stat-card .s-icon{
  width:40px; height:40px; border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:18px; margin-bottom:12px; color:#fff;
}
.stat-card .s-label{
  font-size:11px; font-weight:700; color:var(--text-muted);
  text-transform:uppercase; letter-spacing:.5px; margin-bottom:4px;
}
.stat-card .s-value{
  font-size:26px; font-weight:900; color:var(--text-primary);
  letter-spacing:-.5px;
}
.stat-card .s-sub{ font-size:11px; color:var(--text-secondary); margin-top:2px; font-weight:600; }
.s-purple{ background:linear-gradient(135deg,#6366f1,#8b5cf6); }
.s-green{ background:linear-gradient(135deg,#22c55e,#059669); }
.s-blue{ background:linear-gradient(135deg,#3b82f6,#2563eb); }
.s-amber{ background:linear-gradient(135deg,#f59e0b,#d97706); }
.s-pink{ background:linear-gradient(135deg,#ec4899,#be185d); }
.s-red{ background:linear-gradient(135deg,#ef4444,#dc2626); }
.s-cyan{ background:linear-gradient(135deg,#06b6d4,#0891b2); }
.s-teal{ background:linear-gradient(135deg,#14b8a6,#0d9488); }

/* ==============================
   CONTENT CARD
   ============================== */
.content-card{
  background:var(--card-bg); border:1px solid var(--card-border);
  border-radius:16px; padding:22px;
  box-shadow:0 2px 8px rgba(0,0,0,.03);
  margin-bottom:18px;
}
.content-card h3{
  font-size:16px; font-weight:800; margin-bottom:14px;
  display:flex; align-items:center; gap:8px;
}
.content-card h3 i{ color:var(--accent); font-size:14px; }

/* ==============================
   GRIDS
   ============================== */
.grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:18px; }

/* ==============================
   TABLE
   ============================== */
.data-table{ width:100%; border-collapse:collapse; }
.data-table th{
  text-align:left; font-size:10px; font-weight:700;
  color:var(--text-muted); text-transform:uppercase; letter-spacing:.5px;
  padding:8px 12px; border-bottom:2px solid var(--card-border);
  white-space:nowrap;
}
.data-table td{
  padding:10px 12px; border-bottom:1px solid #f1f5f9;
  font-size:13px; font-weight:600; color:var(--text-secondary);
}
.data-table tr:hover td{ background:#f8faff; }
.data-table tr:last-child td{ border-bottom:0; }
.badge{
  display:inline-flex; padding:3px 9px; border-radius:99px;
  font-size:10px; font-weight:800; white-space:nowrap;
}
.b-active{ background:#dcfce7; color:#166534; }
.b-inactive{ background:#fee2e2; color:#991b1b; }
.b-open{ background:#dbeafe; color:#1e40af; }
.b-progress{ background:#fef3c7; color:#92400e; }
.b-resolved{ background:#d1fae5; color:#065f46; }
.b-closed{ background:#e2e8f0; color:#475569; }
.b-lead{ background:#f3e8ff; color:#6b21a8; }
.b-contacted{ background:#e0e7ff; color:#3730a3; }
.b-negotiating{ background:#fef3c7; color:#92400e; }
.b-pending{ background:#fff7ed; color:#9a3412; }
.b-funding{ background:#d1fae5; color:#065f46; }
.b-low{ background:#e2e8f0; color:#475569; }
.b-medium{ background:#fef3c7; color:#92400e; }
.b-high{ background:#fed7aa; color:#9a3412; }
.b-urgent{ background:#fee2e2; color:#991b1b; }

.member-link{
  font-weight:800; color:var(--accent); cursor:pointer;
}
.member-link:hover{ text-decoration:underline; }

/* ==============================
   FORMS
   ============================== */
.form-group{ margin-bottom:14px; }
.form-group label{
  display:block; font-size:12px; font-weight:700;
  color:var(--text-secondary); margin-bottom:4px;
}
.form-input{
  width:100%; padding:10px 14px;
  border:2px solid var(--card-border); border-radius:10px;
  background:#fff; color:var(--text-primary);
  font:inherit; font-size:13px; font-weight:600;
  transition:border-color .2s;
}
.form-input:focus{
  outline:none; border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-soft);
}
.form-row{ display:flex; gap:12px; flex-wrap:wrap; }
.form-row .form-group{ flex:1; min-width:180px; }
select.form-input{
  appearance:none; cursor:pointer;
  background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%2394a3b8" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>');
  background-repeat:no-repeat; background-position:right 12px center;
  padding-right:36px;
}
textarea.form-input{ resize:vertical; min-height:80px; }

/* ==============================
   BUTTONS
   ============================== */
.btn{
  padding:8px 18px; border:none; border-radius:10px;
  font:inherit; font-size:12px; font-weight:800;
  cursor:pointer; display:inline-flex; align-items:center; gap:6px;
  transition:all .2s;
}
.btn-primary{ background:var(--accent); color:#fff; }
.btn-primary:hover{ background:#4f46e5; }
.btn-success{ background:var(--success); color:#fff; }
.btn-danger{ background:var(--danger); color:#fff; }
.btn-warning{ background:var(--warning); color:#fff; }
.btn-ghost{
  background:transparent; color:var(--text-secondary);
  border:1px solid var(--card-border);
}
.btn-ghost:hover{ background:#f1f5f9; }
.btn-sm{ padding:5px 10px; font-size:11px; border-radius:8px; }
.btn-icon{
  width:32px; height:32px; border-radius:8px; padding:0;
  display:inline-flex; align-items:center; justify-content:center;
  border:1px solid var(--card-border); background:#fff;
  cursor:pointer; transition:.2s; font-size:13px; color:var(--text-secondary);
}
.btn-icon:hover{ background:#f1f5f9; }

/* ==============================
   SEARCH BAR
   ============================== */
.search-bar{
  position:relative; margin-bottom:16px;
}
.search-bar input{
  width:100%; padding:10px 14px 10px 38px;
  border:2px solid var(--card-border); border-radius:10px;
  font:inherit; font-size:13px; font-weight:600;
  background:#fff; color:var(--text-primary);
}
.search-bar input:focus{ outline:none; border-color:var(--accent); }
.search-bar i{
  position:absolute; left:14px; top:50%; transform:translateY(-50%);
  color:var(--text-muted); font-size:13px;
}

/* ==============================
   EMPTY STATE
   ============================== */
.empty-state{
  text-align:center; padding:40px 20px; color:var(--text-muted);
}
.empty-state i{ font-size:48px; margin-bottom:12px; opacity:.3; }
.empty-state p{ font-weight:600; font-size:14px; }

/* ==============================
   MODAL
   ============================== */
.modal-overlay{
  position:fixed; inset:0; z-index:999;
  background:rgba(15,23,42,.5); backdrop-filter:blur(6px);
  display:flex; align-items:center; justify-content:center;
  padding:20px; animation:fadeIn .2s;
}
.modal-overlay.hidden{ display:none; }
.modal-card{
  background:#fff; border-radius:18px;
  max-width:640px; width:100%; padding:28px;
  box-shadow:0 24px 60px rgba(0,0,0,.2);
  max-height:85vh; overflow-y:auto;
  animation:scaleIn .3s cubic-bezier(.34,1.56,.64,1);
}
@keyframes scaleIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.modal-head{
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:18px;
}
.modal-head h3{ font-size:18px; font-weight:900; display:flex; align-items:center; gap:8px; }
.modal-head h3 i{ color:var(--accent); }
.modal-close{
  width:34px; height:34px; border-radius:10px;
  border:1px solid var(--card-border); background:#fff;
  cursor:pointer; font-size:14px; display:grid; place-items:center;
  transition:.2s;
}
.modal-close:hover{ background:#f1f5f9; }
.modal-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:18px; }

/* ==============================
   MEMBER DETAIL PANEL
   ============================== */
.detail-header{
  display:flex; align-items:center; gap:18px; margin-bottom:20px;
  padding-bottom:18px; border-bottom:1px solid var(--card-border);
}
.detail-avatar{
  width:64px; height:64px; border-radius:50%;
  background:linear-gradient(135deg,#6366f1,#ec4899);
  color:#fff; display:flex; align-items:center; justify-content:center;
  font-size:24px; font-weight:900;
}
.detail-name{ font-size:22px; font-weight:900; }
.detail-id{ color:var(--accent); font-weight:700; font-size:13px; }
.detail-meta{
  display:flex; gap:20px; flex-wrap:wrap; margin-top:6px;
}
.detail-meta span{
  font-size:12px; color:var(--text-muted); font-weight:600;
  display:flex; align-items:center; gap:4px;
}
.detail-meta i{ font-size:11px; }

/* ==============================
   TABS
   ============================== */
.tab-bar{
  display:flex; gap:6px; margin-bottom:16px;
  border-bottom:2px solid var(--card-border);
  padding-bottom:0;
}
.tab-btn{
  padding:8px 16px; border:none; background:none;
  font:inherit; font-size:12px; font-weight:800;
  color:var(--text-muted); cursor:pointer;
  border-bottom:2px solid transparent;
  margin-bottom:-2px; transition:.2s;
}
.tab-btn:hover{ color:var(--text-primary); }
.tab-btn.active{ color:var(--accent); border-bottom-color:var(--accent); }
.tab-content{ display:none; }
.tab-content.active{ display:block; }

/* ==============================
   RESPONSIVE
   ============================== */
@media(max-width:1100px){
  .stats-row{ grid-template-columns:repeat(2,1fr) !important; }
  .grid-3{ grid-template-columns:1fr 1fr; }
}
@media(max-width:900px){
  .sidebar{ transform:translateX(-100%); }
  .sidebar.open{ transform:translateX(0); }
  .main{ margin-left:0; padding:16px; padding-top:60px; padding-bottom:76px; }
  .mobile-toggle{ display:grid; place-items:center; }
  .mobile-overlay.show{ display:block; }
}
@media(max-width:640px){
  .stats-row{ grid-template-columns:1fr 1fr !important; }
  .grid-2,.grid-3{ grid-template-columns:1fr; }
  .form-row{ flex-direction:column; }
  .form-row .form-group{ min-width:100%; }
  .topbar{ flex-direction:column; align-items:flex-start; gap:8px; }
  .topbar h1{ font-size:18px; }
  .tab-bar{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .main{ padding:12px 10px; padding-top:56px; padding-bottom:76px; }
}

/* ==============================
   MOBILE APP ENHANCEMENTS (≤480px)
   ============================== */
@media(max-width:480px){
  .main{ padding:8px; padding-top:52px; padding-bottom:72px; }
  .mobile-toggle{ top:8px; left:8px; width:36px; height:36px; font-size:14px; border-radius:8px; }

  /* Topbar compact */
  .topbar{ margin-bottom:14px; gap:6px; }
  .topbar h1{ font-size:16px; letter-spacing:-.3px; }
  .admin-badge{ font-size:10px; padding:4px 10px; }

  /* Stat cards compact */
  .stats-row{ gap:8px !important; margin-bottom:14px; }
  .stat-card{ padding:14px; border-radius:12px; }
  .stat-card .s-icon{ width:34px; height:34px; font-size:14px; margin-bottom:8px; border-radius:8px; }
  .stat-card .s-value{ font-size:18px; }
  .stat-card .s-label{ font-size:10px; }
  .stat-card .s-change{ font-size:10px; }

  /* Content cards */
  .content-card{ border-radius:14px; padding:14px; margin-bottom:14px; }
  .content-card h3{ font-size:15px; }

  /* Tables compact */
  .data-table th,.data-table td{ padding:8px 6px; font-size:11px; }
  .data-table th{ font-size:9px; }
  .badge{ font-size:9px; padding:3px 8px; }

  /* Forms compact */
  .form-input{ padding:10px 12px; font-size:13px; border-radius:10px; }
  .form-group label{ font-size:12px; }

  /* Buttons */
  .btn{ padding:10px 14px; font-size:12px; border-radius:10px; }
  .btn.btn-sm{ padding:6px 10px; font-size:10px; }

  /* Search bar */
  .search-bar{ border-radius:10px; }
  .search-bar input{ padding:10px 12px; font-size:13px; }

  /* Tab bar compact */
  .tab-bar{ gap:0; margin-bottom:12px; }
  .tab-btn{ padding:8px 10px; font-size:11px; }

  /* Modals — bottom sheet on mobile */
  .modal-overlay{ padding:8px !important; }
  .modal-card{ max-width:100% !important; border-radius:16px !important; padding:18px; max-height:92vh; }
  .detail-header{ flex-direction:column; text-align:center; gap:10px; }
  .detail-meta{ justify-content:center; }

  /* Inline flex buttons — wrap on mobile */
  div[style*="display:flex"][style*="justify-content:flex-end"]{ flex-wrap:wrap; }
}

/* ==============================
   MOBILE BOTTOM NAV BAR
   ============================== */
.mobile-bottom-nav{
  display:none;
  position:fixed; bottom:0; left:0; right:0; z-index:200;
  background:var(--sidebar-bg); border-top:1px solid rgba(255,255,255,.06);
  box-shadow:0 -2px 16px rgba(0,0,0,.3);
  padding:4px 0; padding-bottom:max(4px, env(safe-area-inset-bottom));
}
.mobile-bottom-nav .nav-row{
  display:flex; justify-content:space-around; align-items:center;
}
.mobile-bottom-nav .bnav{
  display:flex; flex-direction:column; align-items:center; gap:2px;
  padding:6px 4px; border:none; background:none;
  font-family:inherit; font-size:9px; font-weight:700;
  color:var(--sidebar-text); opacity:.5; cursor:pointer; transition:.15s;
  min-width:0; flex:1;
}
.mobile-bottom-nav .bnav i{ font-size:17px; transition:.15s; }
.mobile-bottom-nav .bnav.active{ opacity:1; color:#818cf8; }
.mobile-bottom-nav .bnav.active i{ transform:scale(1.1); }
@media(max-width:900px){
  .mobile-bottom-nav{ display:block; }
}

.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  </style>
</head>
<body>

<!-- Mobile toggle -->
<button class="mobile-toggle" id="mobileToggle"><i class="fa-solid fa-bars"></i></button>
<div class="mobile-overlay" id="mobileOverlay"></div>

<!-- ======== SIDEBAR ======== -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <img src="/assets/images/logo.png" alt="FWF">
    <div>
      <small>ADMIN PANEL</small>
    </div>
  </div>
  <nav class="sidebar-nav">
    <button class="nav-item active" data-page="home">
      <i class="fa-solid fa-chart-pie"></i> Dashboard
    </button>
    <button class="nav-item" data-page="members">
      <i class="fa-solid fa-users"></i> Members
    </button>
    <button class="nav-item" data-page="supporters">
      <i class="fa-solid fa-hand-holding-heart"></i> Supporters
    </button>
    <button class="nav-item" data-page="csr">
      <i class="fa-solid fa-handshake"></i> CSR Partners
    </button>
    <button class="nav-item" data-page="support">
      <i class="fa-solid fa-headset"></i> Support
      <span class="nav-badge" id="supportBadge" style="display:none">0</span>
    </button>
    <button class="nav-item" data-page="posts">
      <i class="fa-solid fa-newspaper"></i> Social Posts
      <span class="nav-badge" id="postsBadge" style="display:none">0</span>
    </button>
    <button class="nav-item" data-page="payments">
      <i class="fa-solid fa-indian-rupee-sign"></i> Payments
      <span class="nav-badge" id="paymentBadge" style="display:none">0</span>
    </button>
    <button class="nav-item" data-page="points">
      <i class="fa-solid fa-coins"></i> Points & Activity
    </button>
    <button class="nav-item" data-page="courses">
      <i class="fa-solid fa-graduation-cap"></i> Courses
    </button>
    <button class="nav-item" data-page="marketplace">
      <i class="fa-solid fa-store"></i> Marketplace
    </button>
    <button class="nav-item" data-page="funds">
      <i class="fa-solid fa-piggy-bank"></i> Funds & Loans
    </button>
    <button class="nav-item" data-page="fundraiser">
      <i class="fa-solid fa-trophy"></i> Fund Raiser
    </button>
    <button class="nav-item" data-page="invoices">
      <i class="fa-solid fa-file-invoice"></i> Invoices
    </button>
    <button class="nav-item" data-page="reports">
      <i class="fa-solid fa-chart-bar"></i> Reports
    </button>
    <button class="nav-item" data-page="settings">
      <i class="fa-solid fa-gear"></i> Settings
    </button>
    <button class="nav-item" data-page="projectcosts">
      <i class="fa-solid fa-indian-rupee-sign"></i> Project Costs
      <span class="nav-badge" style="background:#22c55e;font-size:10px;padding:1px 6px;border-radius:8px;color:#fff;margin-left:4px">Edit</span>
    </button>
  </nav>
  <div class="sidebar-footer">
    <button class="nav-item logout-btn" id="logoutBtn">
      <i class="fa-solid fa-right-from-bracket"></i> Logout
    </button>
  </div>
</aside>

<!-- ======== MAIN ======== -->
<main class="main">
  <div class="topbar">
    <h1 id="pageTitle"><i class="fa-solid fa-chart-pie"></i> Dashboard Overview</h1>
    <div class="topbar-right">
      <span class="admin-badge"><i class="fa-solid fa-shield-halved"></i> Administrator</span>
    </div>
  </div>

  <!-- ===================== HOME / DASHBOARD ===================== -->
  <div class="page active" id="page-home">
    <div class="stats-row">
      <div class="stat-card">
        <div class="s-icon s-purple"><i class="fa-solid fa-users"></i></div>
        <div class="s-label">Total Members</div>
        <div class="s-value" id="hMembers">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-green"><i class="fa-solid fa-user-check"></i></div>
        <div class="s-label">Active Members</div>
        <div class="s-value" id="hActive">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-amber"><i class="fa-solid fa-coins"></i></div>
        <div class="s-label">Total Points Issued</div>
        <div class="s-value" id="hPoints">0</div>
      </div>
      <div class="stat-card" style="cursor:pointer" onclick="switchPage('payments')">
        <div class="s-icon s-pink"><i class="fa-solid fa-hand-holding-heart"></i></div>
        <div class="s-label">Donations Collected</div>
        <div class="s-value" id="hDonations">₹0</div>
        <div class="s-sub" id="hDonCount">0 donations</div>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card" style="cursor:pointer" onclick="switchPage('supporters')">
        <div class="s-icon s-green"><i class="fa-solid fa-people-group"></i></div>
        <div class="s-label">Supporters (Volunteers)</div>
        <div class="s-value" id="hSupporters">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-blue"><i class="fa-solid fa-user-plus"></i></div>
        <div class="s-label">Referrals</div>
        <div class="s-value" id="hReferrals">0</div>
        <div class="s-sub" id="hRefActive">0 active</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-cyan"><i class="fa-solid fa-ticket"></i></div>
        <div class="s-label">Quiz Tickets Sold</div>
        <div class="s-value" id="hTickets">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-teal"><i class="fa-solid fa-handshake"></i></div>
        <div class="s-label">CSR Partners</div>
        <div class="s-value" id="hCSR">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-red"><i class="fa-solid fa-headset"></i></div>
        <div class="s-label">Open Tickets</div>
        <div class="s-value" id="hSupport">0</div>
      </div>
    </div>

    <div class="stats-row" style="grid-template-columns:repeat(2,1fr)">
      <div class="stat-card" style="cursor:pointer" onclick="switchPage('payments')">
        <div class="s-icon s-green"><i class="fa-solid fa-indian-rupee-sign"></i></div>
        <div class="s-label">Fee Collected</div>
        <div class="s-value" id="hFeeCollected">₹0</div>
      </div>
      <div class="stat-card" style="cursor:pointer" onclick="switchPage('payments')">
        <div class="s-icon s-amber"><i class="fa-solid fa-clock"></i></div>
        <div class="s-label">Pending Fee Verifications</div>
        <div class="s-value" id="hFeePending">0</div>
      </div>
    </div>

    <div class="content-card">
      <h3><i class="fa-solid fa-clock"></i> Recent Members</h3>
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr><th>Member ID</th><th>Name</th><th>Mobile</th><th>Email</th><th>Status</th><th>Joined</th></tr></thead>
          <tbody id="hLatest">
            <tr><td colspan="6" class="empty-state"><p>Loading...</p></td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="content-card" style="margin-top:16px">
      <h3><i class="fa-solid fa-envelope-circle-check"></i> Email System Test</h3>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <input type="email" id="testEmailAddr" placeholder="Enter email to test" style="flex:1;min-width:220px;padding:10px 14px;border:1px solid var(--brd);border-radius:8px;font-size:14px">
        <button onclick="sendTestEmail()" style="padding:10px 22px;background:#6366f1;color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap">
          <i class="fa-solid fa-paper-plane"></i> Send Test Email
        </button>
        <span id="testEmailResult" style="font-size:13px;font-weight:600"></span>
      </div>
    </div>
  </div>

  <!-- ===================== MEMBERS PAGE ===================== -->
  <div class="page" id="page-members">
    <div class="grid-2" style="margin-bottom:16px">
      <div class="search-bar">
        <i class="fa-solid fa-search"></i>
        <input type="text" id="memberSearch" placeholder="Search by name, ID, mobile, email...">
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;align-items:center">
        <button class="btn btn-ghost" onclick="loadMembers()"><i class="fa-solid fa-refresh"></i> Refresh</button>
        <button class="btn btn-primary" onclick="openResetPasswordModal()"><i class="fa-solid fa-key"></i> Reset Password</button>
      </div>
    </div>

    <div class="content-card">
      <h3><i class="fa-solid fa-users"></i> All Members <span style="font-weight:500;color:var(--text-muted);font-size:12px;margin-left:8px" id="memberCountLabel">(0)</span></h3>
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr><th>ID</th><th>Name</th><th>Mobile</th><th>Email</th><th>Points</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead>
          <tbody id="membersBody">
            <tr><td colspan="8" class="empty-state"><p>Loading...</p></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===================== SUPPORTERS PAGE ===================== -->
  <div class="page" id="page-supporters">
    <div class="stats-row" style="grid-template-columns:repeat(3,1fr)">
      <div class="stat-card">
        <div class="s-icon s-green"><i class="fa-solid fa-people-group"></i></div>
        <div class="s-label">Total Supporters</div>
        <div class="s-value" id="supTotalCount">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-blue"><i class="fa-solid fa-user-check"></i></div>
        <div class="s-label">Active</div>
        <div class="s-value" id="supActiveCount">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-amber"><i class="fa-solid fa-user-clock"></i></div>
        <div class="s-label">Inactive</div>
        <div class="s-value" id="supInactiveCount">0</div>
      </div>
    </div>

    <div class="grid-2" style="margin-bottom:16px">
      <div class="search-bar">
        <i class="fa-solid fa-search"></i>
        <input type="text" id="supporterSearch" placeholder="Search by name, ID, mobile, email...">
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;align-items:center">
        <button class="btn btn-ghost" onclick="loadSupporters()"><i class="fa-solid fa-refresh"></i> Refresh</button>
      </div>
    </div>

    <div class="content-card">
      <h3><i class="fa-solid fa-people-group"></i> Supporter Volunteers <span style="font-weight:500;color:var(--text-muted);font-size:12px;margin-left:8px" id="supporterCountLabel">(0)</span></h3>
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr><th>ID</th><th>Name</th><th>Mobile</th><th>Email</th><th>Project / Message</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead>
          <tbody id="supportersBody">
            <tr><td colspan="8" class="empty-state"><p>Loading...</p></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===================== PAYMENTS PAGE ===================== -->
  <div class="page" id="page-payments">
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="pay-fees-tab">Membership Fees</button>
      <button class="tab-btn" data-tab="pay-donations-tab">Donors / Donations</button>
    </div>

    <!-- Membership Fees Tab -->
    <div class="tab-content active" id="pay-fees-tab">
      <div class="stats-row" style="grid-template-columns:repeat(4,1fr)">
        <div class="stat-card">
          <div class="s-icon s-green"><i class="fa-solid fa-indian-rupee-sign"></i></div>
          <div class="s-label">Total Collected</div>
          <div class="s-value" id="feeCollected">₹0</div>
        </div>
        <div class="stat-card">
          <div class="s-icon s-amber"><i class="fa-solid fa-clock"></i></div>
          <div class="s-label">Pending</div>
          <div class="s-value" id="feePending">0</div>
          <div class="s-sub" id="feePendingAmt">₹0</div>
        </div>
        <div class="stat-card">
          <div class="s-icon s-blue"><i class="fa-solid fa-check-double"></i></div>
          <div class="s-label">Verified</div>
          <div class="s-value" id="feeVerified">0</div>
        </div>
        <div class="stat-card">
          <div class="s-icon s-red"><i class="fa-solid fa-xmark"></i></div>
          <div class="s-label">Rejected</div>
          <div class="s-value" id="feeRejected">0</div>
        </div>
      </div>

      <div class="grid-2" style="margin-bottom:16px">
        <div class="search-bar">
          <i class="fa-solid fa-search"></i>
          <input type="text" id="feeSearch" placeholder="Search by member ID, name, transaction ID...">
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;align-items:center">
          <select id="feeFilter" class="form-input" style="width:auto;padding:8px 12px;font-size:12px">
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="verified">Verified</option>
            <option value="rejected">Rejected</option>
            <option value="refunded">Refunded</option>
          </select>
          <button class="btn btn-ghost" onclick="loadMembershipFees()"><i class="fa-solid fa-refresh"></i> Refresh</button>
          <button class="btn btn-primary" onclick="openModal('addFeeModal')"><i class="fa-solid fa-plus"></i> Add Fee Record</button>
        </div>
      </div>

      <div class="content-card">
        <h3><i class="fa-solid fa-receipt"></i> Membership Fee Transactions</h3>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr>
              <th>TXN ID</th><th>Member</th><th>Amount</th><th>Type</th><th>Payment Mode</th><th>Ref</th><th>Status</th><th>Date</th><th>Actions</th>
            </tr></thead>
            <tbody id="feesBody">
              <tr><td colspan="9" class="empty-state"><p>Loading...</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div> <!-- /pay-fees-tab -->

    <!-- Donors / Donations Tab -->
    <div class="tab-content" id="pay-donations-tab">
      <div class="stats-row" style="grid-template-columns:repeat(4,1fr)">
        <div class="stat-card">
          <div class="s-icon s-pink"><i class="fa-solid fa-hand-holding-heart"></i></div>
          <div class="s-label">Total Donated</div>
          <div class="s-value" id="donTotalAmt">₹0</div>
        </div>
        <div class="stat-card">
          <div class="s-icon s-purple"><i class="fa-solid fa-users"></i></div>
          <div class="s-label">Total Donors</div>
          <div class="s-value" id="donTotalCount">0</div>
        </div>
        <div class="stat-card">
          <div class="s-icon s-amber"><i class="fa-solid fa-shield-halved"></i></div>
          <div class="s-label">KYC Pending</div>
          <div class="s-value" id="donKycPending">0</div>
        </div>
        <div class="stat-card">
          <div class="s-icon s-red"><i class="fa-solid fa-gem"></i></div>
          <div class="s-label">High-Value (≥50k)</div>
          <div class="s-value" id="donHighValue">0</div>
        </div>
      </div>
      <div class="grid-2" style="margin-bottom:16px">
        <div class="search-bar">
          <i class="fa-solid fa-search"></i>
          <input type="text" id="donSearch" placeholder="Search by name, email, mobile, PAN, DON ID...">
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;align-items:center">
          <select id="donKycFilter" class="form-input" style="width:auto;padding:8px 12px;font-size:12px">
            <option value="">All KYC</option>
            <option value="not_required">Not Required</option>
            <option value="otp_verified">OTP Verified</option>
            <option value="pending_docs">Pending Docs</option>
            <option value="doc_verified">Docs Verified</option>
          </select>
          <button class="btn btn-ghost" onclick="loadDonations()"><i class="fa-solid fa-refresh"></i> Refresh</button>
        </div>
      </div>
      <div class="content-card">
        <h3><i class="fa-solid fa-hand-holding-heart"></i> Donor / Donation Records</h3>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr>
              <th>DON ID</th><th>Donor</th><th>Amount</th><th>PAN</th><th>KYC</th><th>OTP</th><th>Member</th><th>Payment ID</th><th>Date</th><th>Actions</th>
            </tr></thead>
            <tbody id="donationsAdminBody">
              <tr><td colspan="10" class="empty-state"><p>Loading...</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div> <!-- /pay-donations-tab -->

  </div> <!-- /page-payments -->

  <!-- ===================== CSR PARTNERS PAGE ===================== -->
  <div class="page" id="page-csr">
    <div class="stats-row" style="grid-template-columns:repeat(4,1fr)">
      <div class="stat-card">
        <div class="s-icon s-teal"><i class="fa-solid fa-building"></i></div>
        <div class="s-label">Total Partners</div>
        <div class="s-value" id="csrTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-green"><i class="fa-solid fa-check-circle"></i></div>
        <div class="s-label">Active</div>
        <div class="s-value" id="csrActive">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-blue"><i class="fa-solid fa-indian-rupee-sign"></i></div>
        <div class="s-label">Total Commitment</div>
        <div class="s-value" id="csrCommit">₹0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-amber"><i class="fa-solid fa-coins"></i></div>
        <div class="s-label">Total Paid</div>
        <div class="s-value" id="csrPaid">₹0</div>
      </div>
    </div>

    <div style="margin-bottom:16px;display:flex;justify-content:flex-end;gap:10px">
      <button class="btn btn-ghost" onclick="loadCSRPartners()"><i class="fa-solid fa-refresh"></i> Refresh</button>
      <button class="btn btn-primary" onclick="openAddCSRModal()"><i class="fa-solid fa-plus"></i> Add CSR Partner</button>
    </div>

    <div class="content-card">
      <h3><i class="fa-solid fa-handshake"></i> CSR Partners</h3>
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr><th>Partner ID</th><th>Company</th><th>Contact</th><th>Type</th><th>Commitment</th><th>Paid</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="csrBody">
            <tr><td colspan="8" class="empty-state"><i class="fa-solid fa-handshake"></i><p>No CSR partners yet</p></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===================== SUPPORT PAGE ===================== -->
  <div class="page" id="page-support">
    <div class="stats-row" style="grid-template-columns:repeat(5,1fr)">
      <div class="stat-card">
        <div class="s-icon s-purple"><i class="fa-solid fa-ticket"></i></div>
        <div class="s-label">Total Tickets</div>
        <div class="s-value" id="supTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-red"><i class="fa-solid fa-exclamation-circle"></i></div>
        <div class="s-label">Open</div>
        <div class="s-value" id="supOpen">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-amber"><i class="fa-solid fa-spinner"></i></div>
        <div class="s-label">In Progress</div>
        <div class="s-value" id="supProgress">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-green"><i class="fa-solid fa-check"></i></div>
        <div class="s-label">Resolved</div>
        <div class="s-value" id="supResolved">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-cyan"><i class="fa-solid fa-lock"></i></div>
        <div class="s-label">Closed</div>
        <div class="s-value" id="supClosed">0</div>
      </div>
    </div>

    <div style="margin-bottom:16px;display:flex;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="loadSupportTickets()"><i class="fa-solid fa-refresh"></i> Refresh</button>
    </div>

    <div class="content-card">
      <h3><i class="fa-solid fa-headset"></i> Support Tickets</h3>
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr><th>Ticket ID</th><th>User</th><th>Subject</th><th>Category</th><th>Priority</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead>
          <tbody id="supportBody">
            <tr><td colspan="8" class="empty-state"><i class="fa-solid fa-headset"></i><p>No support tickets</p></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===================== POINTS & ACTIVITY PAGE ===================== -->
  <div class="page" id="page-points">
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="donations-tab">Donations</button>
      <button class="tab-btn" data-tab="referrals-tab">Referrals</button>
      <button class="tab-btn" data-tab="tickets-tab">Quiz Tickets</button>
    </div>

    <div class="tab-content active" id="donations-tab">
      <div class="content-card">
        <h3><i class="fa-solid fa-hand-holding-heart"></i> Donation Records</h3>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Member</th><th>Amount</th><th>Donor</th><th>Points Earned</th><th>Date</th></tr></thead>
            <tbody id="donationsBody">
              <tr><td colspan="5" class="empty-state"><p>No donations yet</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-content" id="referrals-tab">
      <div class="content-card">
        <h3><i class="fa-solid fa-user-plus"></i> Referral Records</h3>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Referrer</th><th>Referred Member</th><th>Payment</th><th>Points</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
            <tbody id="referralsBody">
              <tr><td colspan="7" class="empty-state"><p>No referrals yet</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tickets-tab">
      <div class="content-card">
        <h3><i class="fa-solid fa-ticket"></i> Quiz Ticket Sales</h3>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Seller</th><th>Buyer</th><th>Price</th><th>Points Earned</th><th>Date</th></tr></thead>
            <tbody id="ticketsBody">
              <tr><td colspan="5" class="empty-state"><p>No tickets sold yet</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== COURSE MANAGEMENT ===================== -->
  <div class="page" id="page-courses">
    <div class="stats-row" style="grid-template-columns:repeat(4,1fr)">
      <div class="stat-card">
        <div class="s-icon s-purple"><i class="fa-solid fa-book-open"></i></div>
        <div class="s-label">Total Courses</div>
        <div class="s-value">6</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-green"><i class="fa-solid fa-users"></i></div>
        <div class="s-label">Total Enrollments</div>
        <div class="s-value">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-blue"><i class="fa-solid fa-check-circle"></i></div>
        <div class="s-label">Completed</div>
        <div class="s-value">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-amber"><i class="fa-solid fa-certificate"></i></div>
        <div class="s-label">Certificates Issued</div>
        <div class="s-value">0</div>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 style="font-size:16px;font-weight:800"><i class="fa-solid fa-graduation-cap" style="color:var(--accent)"></i> Course Management</h3>
      <button class="btn btn-primary" onclick="openModal('addCourseModal')"><i class="fa-solid fa-plus"></i> Add Course</button>
    </div>

    <div class="content-card">
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr><th>Course</th><th>Category</th><th>Duration</th><th>Enrollments</th><th>Completed</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody>
            <tr>
              <td style="font-weight:800">Tailoring & Stitching</td>
              <td><span class="badge b-active">Skill</span></td>
              <td>4 Weeks</td>
              <td style="font-weight:700">0</td>
              <td>0</td>
              <td><span class="badge b-active">Active</span></td>
              <td>
                <button class="btn-icon" title="Edit"><i class="fa-solid fa-pen"></i></button>
                <button class="btn-icon" title="Toggle"><i class="fa-solid fa-toggle-on"></i></button>
              </td>
            </tr>
            <tr>
              <td style="font-weight:800">Basic Computer Skills</td>
              <td><span class="badge b-open">Digital</span></td>
              <td>6 Weeks</td>
              <td style="font-weight:700">0</td>
              <td>0</td>
              <td><span class="badge b-active">Active</span></td>
              <td>
                <button class="btn-icon" title="Edit"><i class="fa-solid fa-pen"></i></button>
                <button class="btn-icon" title="Toggle"><i class="fa-solid fa-toggle-on"></i></button>
              </td>
            </tr>
            <tr>
              <td style="font-weight:800">Food Processing & Packaging</td>
              <td><span class="badge b-progress">Business</span></td>
              <td>3 Weeks</td>
              <td style="font-weight:700">0</td>
              <td>0</td>
              <td><span class="badge b-active">Active</span></td>
              <td>
                <button class="btn-icon" title="Edit"><i class="fa-solid fa-pen"></i></button>
                <button class="btn-icon" title="Toggle"><i class="fa-solid fa-toggle-on"></i></button>
              </td>
            </tr>
            <tr>
              <td style="font-weight:800">Handicraft & Mehndi Art</td>
              <td><span class="badge b-active">Skill</span></td>
              <td>3 Weeks</td>
              <td style="font-weight:700">0</td>
              <td>0</td>
              <td><span class="badge b-active">Active</span></td>
              <td>
                <button class="btn-icon" title="Edit"><i class="fa-solid fa-pen"></i></button>
                <button class="btn-icon" title="Toggle"><i class="fa-solid fa-toggle-on"></i></button>
              </td>
            </tr>
            <tr>
              <td style="font-weight:800">Digital Marketing</td>
              <td><span class="badge b-open">Digital</span></td>
              <td>5 Weeks</td>
              <td style="font-weight:700">0</td>
              <td>0</td>
              <td><span class="badge b-active">Active</span></td>
              <td>
                <button class="btn-icon" title="Edit"><i class="fa-solid fa-pen"></i></button>
                <button class="btn-icon" title="Toggle"><i class="fa-solid fa-toggle-on"></i></button>
              </td>
            </tr>
            <tr>
              <td style="font-weight:800">Organic Farming</td>
              <td><span class="badge b-resolved">Agriculture</span></td>
              <td>4 Weeks</td>
              <td style="font-weight:700">0</td>
              <td>0</td>
              <td><span class="badge b-active">Active</span></td>
              <td>
                <button class="btn-icon" title="Edit"><i class="fa-solid fa-pen"></i></button>
                <button class="btn-icon" title="Toggle"><i class="fa-solid fa-toggle-on"></i></button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===================== MARKETPLACE MANAGEMENT ===================== -->
  <div class="page" id="page-marketplace">
    <div class="stats-row" style="grid-template-columns:repeat(4,1fr)">
      <div class="stat-card">
        <div class="s-icon s-teal"><i class="fa-solid fa-store"></i></div>
        <div class="s-label">Total Sellers</div>
        <div class="s-value" id="mkSellers">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-purple"><i class="fa-solid fa-box-open"></i></div>
        <div class="s-label">Total Products</div>
        <div class="s-value" id="mkProducts">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-green"><i class="fa-solid fa-shopping-cart"></i></div>
        <div class="s-label">Total Orders</div>
        <div class="s-value" id="mkOrders">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-amber"><i class="fa-solid fa-indian-rupee-sign"></i></div>
        <div class="s-label">Total Revenue</div>
        <div class="s-value" id="mkRevenue">₹0</div>
      </div>
    </div>

    <div class="tab-bar">
      <button class="tab-btn active" data-tab="m-products-tab">Product Approval</button>
      <button class="tab-btn" data-tab="m-orders-tab">Orders</button>
    </div>

    <div class="tab-content active" id="m-products-tab">
      <div class="content-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
          <h3 style="margin:0"><i class="fa-solid fa-box-open"></i> All Products</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <select class="form-input" id="mkProdFilter" style="padding:8px 12px;font-size:12px;max-width:150px" onchange="renderAdminProducts()">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
              <option value="out-of-stock">Out of Stock</option>
            </select>
          </div>
        </div>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Image</th><th>Product</th><th>Seller</th><th>Category</th><th>Price</th><th>Stock</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="mkProductsBody">
              <tr><td colspan="8" class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i><p>Loading...</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-content" id="m-orders-tab">
      <div class="content-card">
        <h3 style="margin-bottom:12px"><i class="fa-solid fa-receipt"></i> All Orders</h3>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Order ID</th><th>Product</th><th>Buyer</th><th>Seller</th><th>Qty</th><th>Amount</th><th>Payment</th><th>Status</th><th>Date</th><th>Action</th></tr></thead>
            <tbody id="mkOrdersBody">
              <tr><td colspan="10" class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i><p>Loading...</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== FUND & LOAN MANAGEMENT ===================== -->
  <div class="page" id="page-funds">
    <div class="stats-row" style="grid-template-columns:repeat(4,1fr)">
      <div class="stat-card">
        <div class="s-icon s-green"><i class="fa-solid fa-piggy-bank"></i></div>
        <div class="s-label">Care Fund Balance</div>
        <div class="s-value">₹0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-blue"><i class="fa-solid fa-file-invoice"></i></div>
        <div class="s-label">Pending Requests</div>
        <div class="s-value">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-amber"><i class="fa-solid fa-hand-holding-dollar"></i></div>
        <div class="s-label">Loans Disbursed</div>
        <div class="s-value">₹0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-purple"><i class="fa-solid fa-check-double"></i></div>
        <div class="s-label">Loans Repaid</div>
        <div class="s-value">₹0</div>
      </div>
    </div>

    <div class="tab-bar">
      <button class="tab-btn active" data-tab="f-requests-tab">Fund Requests</button>
      <button class="tab-btn" data-tab="f-loans-tab">Interest-Free Loans</button>
      <button class="tab-btn" data-tab="f-tracking-tab">Fund Tracking</button>
    </div>

    <div class="tab-content active" id="f-requests-tab">
      <div class="content-card">
        <h3><i class="fa-solid fa-file-invoice"></i> Member Care Fund Requests</h3>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Member</th><th>Amount</th><th>Purpose</th><th>Priority</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
            <tbody>
              <tr><td colspan="7" class="empty-state"><i class="fa-solid fa-hand-holding-heart"></i><p>No fund requests yet</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-content" id="f-loans-tab">
      <div class="content-card">
        <h3><i class="fa-solid fa-hand-holding-dollar"></i> Interest-Free Loan Approvals</h3>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Member</th><th>Loan Amount</th><th>Purpose</th><th>Tenure</th><th>EMI</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>
              <tr><td colspan="7" class="empty-state"><i class="fa-solid fa-piggy-bank"></i><p>No loan applications yet</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-content" id="f-tracking-tab">
      <div class="content-card">
        <h3><i class="fa-solid fa-chart-line"></i> Fund Balance Tracking</h3>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Credit</th><th>Debit</th><th>Balance</th></tr></thead>
            <tbody>
              <tr><td colspan="6" class="empty-state"><i class="fa-solid fa-clock-rotate-left"></i><p>No fund transactions yet</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== REPORTS & ANALYTICS ===================== -->
  <div class="page" id="page-reports">
    <div class="stats-row" style="grid-template-columns:repeat(4,1fr)">
      <div class="stat-card">
        <div class="s-icon s-purple"><i class="fa-solid fa-users"></i></div>
        <div class="s-label">Total Members</div>
        <div class="s-value" id="rMembers">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-green"><i class="fa-solid fa-hand-holding-heart"></i></div>
        <div class="s-label">Total Donations</div>
        <div class="s-value" id="rDonations">₹0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-blue"><i class="fa-solid fa-handshake"></i></div>
        <div class="s-label">CSR Funds</div>
        <div class="s-value" id="rCSR">₹0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-amber"><i class="fa-solid fa-store"></i></div>
        <div class="s-label">Marketplace Sales</div>
        <div class="s-value">₹0</div>
      </div>
    </div>

    <div class="grid-2">
      <div class="content-card">
        <h3><i class="fa-solid fa-chart-pie"></i> Member Distribution</h3>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f1f5f9">
            <span style="font-weight:700;font-size:13px"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--success);margin-right:8px"></span>Active Members</span>
            <span style="font-weight:900;color:var(--success)" id="rActive">0</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f1f5f9">
            <span style="font-weight:700;font-size:13px"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--danger);margin-right:8px"></span>Inactive Members</span>
            <span style="font-weight:900;color:var(--danger)" id="rInactive">0</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f1f5f9">
            <span style="font-weight:700;font-size:13px"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--info);margin-right:8px"></span>Total Referrals</span>
            <span style="font-weight:900;color:var(--info)" id="rReferrals">0</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0">
            <span style="font-weight:700;font-size:13px"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--accent);margin-right:8px"></span>Total Points Issued</span>
            <span style="font-weight:900;color:var(--accent)" id="rPoints">0</span>
          </div>
        </div>
      </div>

      <div class="content-card">
        <h3><i class="fa-solid fa-calendar"></i> Monthly Activity Summary</h3>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f1f5f9">
            <span style="font-weight:700;font-size:13px">New Members (this month)</span>
            <span style="font-weight:900" id="rNewMembers">0</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f1f5f9">
            <span style="font-weight:700;font-size:13px">Donations Collected</span>
            <span style="font-weight:900" id="rMonthDon">0</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #f1f5f9">
            <span style="font-weight:700;font-size:13px">Tickets Sold</span>
            <span style="font-weight:900" id="rMonthTix">0</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0">
            <span style="font-weight:700;font-size:13px">Support Tickets Resolved</span>
            <span style="font-weight:900" id="rMonthResolved">0</span>
          </div>
        </div>
      </div>
    </div>

    <div class="content-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <h3 style="margin-bottom:0"><i class="fa-solid fa-download"></i> Download Reports</h3>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-ghost"><i class="fa-solid fa-file-csv"></i> Members CSV</button>
        <button class="btn btn-ghost"><i class="fa-solid fa-file-csv"></i> Donations CSV</button>
        <button class="btn btn-ghost"><i class="fa-solid fa-file-csv"></i> Points Ledger CSV</button>
        <button class="btn btn-ghost"><i class="fa-solid fa-file-csv"></i> CSR Partners CSV</button>
      </div>
    </div>
  </div>

  <!-- ===================== WEBSITE & SYSTEM SETTINGS ===================== -->
  <div class="page" id="page-settings">
    <div class="grid-2">
      <div>
        <div class="content-card">
          <h3><i class="fa-solid fa-image"></i> Homepage Banners</h3>
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:14px">Manage homepage hero banners and announcements</p>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div style="display:flex;align-items:center;gap:12px;padding:10px;background:#f8fafc;border-radius:10px">
              <div style="width:80px;height:50px;border-radius:8px;background:linear-gradient(135deg,#6366f1,#ec4899);flex-shrink:0"></div>
              <div style="flex:1">
                <div style="font-size:12px;font-weight:700">Hero Banner 1</div>
                <div style="font-size:11px;color:var(--text-muted)">Active</div>
              </div>
              <button class="btn-icon"><i class="fa-solid fa-pen"></i></button>
            </div>
          </div>
          <button class="btn btn-ghost btn-sm" style="margin-top:10px"><i class="fa-solid fa-plus"></i> Add Banner</button>
        </div>

        <div class="content-card">
          <h3><i class="fa-solid fa-bell"></i> Notifications</h3>
          <p style="font-size:12px;color:var(--text-muted);margin-bottom:14px">Send notifications to members</p>
          <div class="form-group">
            <label>Title</label>
            <input type="text" class="form-input" placeholder="Notification title">
          </div>
          <div class="form-group">
            <label>Message</label>
            <textarea class="form-input" placeholder="Notification message..." rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>Send to</label>
            <select class="form-input">
              <option>All Members</option>
              <option>Active Members Only</option>
              <option>CSR Partners</option>
            </select>
          </div>
          <button class="btn btn-primary"><i class="fa-solid fa-paper-plane"></i> Send Notification</button>
        </div>
      </div>

      <div>
        <div class="content-card">
          <h3><i class="fa-solid fa-shield-halved"></i> Roles & Permissions</h3>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f8fafc;border-radius:10px">
              <div>
                <div style="font-size:13px;font-weight:800">Admin</div>
                <div style="font-size:11px;color:var(--text-muted)">Full system access</div>
              </div>
              <span class="badge b-active">Active</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f8fafc;border-radius:10px">
              <div>
                <div style="font-size:13px;font-weight:800">Member</div>
                <div style="font-size:11px;color:var(--text-muted)">Dashboard, wallet, marketplace</div>
              </div>
              <span class="badge b-active">Active</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f8fafc;border-radius:10px">
              <div>
                <div style="font-size:13px;font-weight:800">CSR Partner</div>
                <div style="font-size:11px;color:var(--text-muted)">Impact reports, funding view</div>
              </div>
              <span class="badge b-active">Active</span>
            </div>
          </div>
        </div>

        <div class="content-card">
          <h3><i class="fa-solid fa-plug"></i> Integrations</h3>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f8fafc;border-radius:10px">
              <div style="display:flex;align-items:center;gap:10px">
                <i class="fa-brands fa-whatsapp" style="font-size:20px;color:#25D366"></i>
                <div>
                  <div style="font-size:13px;font-weight:800">WhatsApp</div>
                  <div style="font-size:11px;color:var(--text-muted)">Message notifications</div>
                </div>
              </div>
              <span class="badge b-progress">Setup</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f8fafc;border-radius:10px">
              <div style="display:flex;align-items:center;gap:10px">
                <i class="fa-solid fa-envelope" style="font-size:20px;color:var(--accent)"></i>
                <div>
                  <div style="font-size:13px;font-weight:800">Email (SMTP)</div>
                  <div style="font-size:11px;color:var(--text-muted)">Transactional emails</div>
                </div>
              </div>
              <span class="badge b-active">Connected</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f8fafc;border-radius:10px">
              <div style="display:flex;align-items:center;gap:10px">
                <i class="fa-solid fa-bug" style="font-size:20px;color:#362d59"></i>
                <div>
                  <div style="font-size:13px;font-weight:800">Sentry</div>
                  <div style="font-size:11px;color:var(--text-muted)">Error monitoring</div>
                </div>
              </div>
              <span class="badge b-active">Connected</span>
            </div>
          </div>
        </div>

        <div class="content-card">
          <h3><i class="fa-solid fa-coins"></i> Points Configuration</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Donation Points (%)</label>
              <input type="number" class="form-input" value="10" min="0" max="100">
            </div>
            <div class="form-group">
              <label>Referral Points (%)</label>
              <input type="number" class="form-input" value="50" min="0" max="100">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Quiz Ticket Points (%)</label>
              <input type="number" class="form-input" value="10" min="0" max="100">
            </div>
            <div class="form-group">
              <label>Default Ticket Price (₹)</label>
              <input type="number" class="form-input" value="100" min="1">
            </div>
          </div>
          <button class="btn btn-primary"><i class="fa-solid fa-save"></i> Save Config</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== PROJECT COST MANAGER ===================== -->
  <div class="page" id="page-projectcosts">
    <div class="content-card" style="margin-bottom:16px;background:#fef3c7;border:1px solid #f59e0b">
      <p style="font-size:13px;color:#92400e;margin:0"><i class="fa-solid fa-circle-info" style="margin-right:6px"></i><strong>How it works:</strong> Changes saved here override the displayed figures in the Project Booklet and Projects page. Data is stored in this browser's localStorage. This is useful for updating costs when prices change due to inflation.</p>
    </div>

    <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap">
      <select class="form-input" id="costProjectSelect" style="max-width:260px" onchange="renderCostEditor()">
        <option value="suraksha">Suraksha — Health & Hygiene</option>
        <option value="swachh-bharat">Swachh Bharat — Home Care</option>
        <option value="happy-meal">Happy Meal — Food Processing</option>
        <option value="green-energy">Green Energy</option>
        <option value="diy-crafts">DIY Crafts</option>
        <option value="swachh-jal">Swachh Jal — Water</option>
        <option value="samman">Samman — Apparel</option>
        <option value="sweet-home">Sweet Home — Textiles</option>
        <option value="hariyali">Hariyali — Green Livelihoods</option>
        <option value="worship">Worship — Puja Essentials</option>
        <option value="shiksha">Shiksha — Stationery</option>
      </select>
      <button class="btn btn-danger btn-sm" onclick="resetAllCostOverrides()"><i class="fa-solid fa-rotate-left"></i> Reset ALL Overrides</button>
    </div>

    <div id="costEditorGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px"></div>
  </div>

  <!-- ===================== FUND RAISER / QUIZ MANAGEMENT ===================== -->
  <div class="page" id="page-fundraiser">
    <!-- Stats Row -->
    <div class="stats-row" style="grid-template-columns:repeat(4,1fr)">
      <div class="stat-card"><div class="s-icon s-blue"><i class="fa-solid fa-gamepad"></i></div><div class="s-label">Active Quizzes</div><div class="s-value" id="frStatActive">0</div></div>
      <div class="stat-card"><div class="s-icon s-amber"><i class="fa-solid fa-clock"></i></div><div class="s-label">Pending Draw</div><div class="s-value" id="frStatPending">0</div></div>
      <div class="stat-card"><div class="s-icon s-green"><i class="fa-solid fa-trophy"></i></div><div class="s-label">Results Declared</div><div class="s-value" id="frStatDeclared">0</div></div>
      <div class="stat-card"><div class="s-icon s-purple"><i class="fa-solid fa-users"></i></div><div class="s-label">Total Participants</div><div class="s-value" id="frStatParticipants">0</div></div>
    </div>

    <!-- Tab Bar -->
    <div style="display:flex;gap:6px;margin-bottom:16px;border-bottom:2px solid var(--brd,#e2e8f0);padding-bottom:0;flex-wrap:wrap">
      <button class="fr-tab fr-tab-active" onclick="switchFRTab('overview')" id="frTab-overview" style="padding:9px 18px;border:none;background:none;font-weight:700;font-size:13px;cursor:pointer;border-bottom:3px solid #3b82f6;color:#3b82f6;margin-bottom:-2px">
        <i class="fa-solid fa-bolt"></i> Overview
      </button>
      <button class="fr-tab" onclick="switchFRTab('quizzes')" id="frTab-quizzes" style="padding:9px 18px;border:none;background:none;font-weight:600;font-size:13px;cursor:pointer;border-bottom:3px solid transparent;color:#64748b;margin-bottom:-2px">
        <i class="fa-solid fa-list"></i> All Quizzes
      </button>
      <button class="fr-tab" onclick="switchFRTab('results')" id="frTab-results" style="padding:9px 18px;border:none;background:none;font-weight:600;font-size:13px;cursor:pointer;border-bottom:3px solid transparent;color:#64748b;margin-bottom:-2px">
        <i class="fa-solid fa-trophy"></i> Results History
      </button>
      <button class="fr-tab" onclick="switchFRTab('demo')" id="frTab-demo" style="padding:9px 18px;border:none;background:none;font-weight:600;font-size:13px;cursor:pointer;border-bottom:3px solid transparent;color:#f59e0b;margin-bottom:-2px">
        <i class="fa-solid fa-flask"></i> Demo Mode
      </button>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button onclick="triggerAutoCreate()" style="background:#3b82f6;border:none;color:#fff;padding:8px 16px;border-radius:8px;font-weight:700;cursor:pointer;font-size:12px"><i class="fa-solid fa-plus"></i> Auto-Create</button>
        <button onclick="triggerAutoDraw()" style="background:#f59e0b;border:none;color:#fff;padding:8px 16px;border-radius:8px;font-weight:700;cursor:pointer;font-size:12px"><i class="fa-solid fa-dice"></i> Auto-Draw</button>
        <button onclick="loadFundRaiser()" style="background:transparent;border:1px solid var(--brd,#e2e8f0);color:var(--text-muted,#64748b);padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;font-size:12px"><i class="fa-solid fa-refresh"></i></button>
        <span id="frLastRefresh" style="font-size:11px;color:#94a3b8"></span>
      </div>
    </div>

    <!-- TAB: OVERVIEW -->
    <div id="frSection-overview">
      <!-- Active Quizzes -->
      <div class="content-card" style="margin-bottom:16px">
        <h3><i class="fa-solid fa-bolt" style="color:#3b82f6"></i> Active Quizzes</h3>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Quiz ID</th><th>Title</th><th>Type</th><th>Fee</th><th>Prize 1st</th><th>End Date</th><th>Result Date</th><th>Enrolled</th><th>Collection</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody id="frActiveBody"><tr><td colspan="11" class="empty-state"><p>Loading...</p></td></tr></tbody>
          </table>
        </div>
      </div>
      <!-- Pending Draw -->
      <div class="content-card">
        <h3><i class="fa-solid fa-clock" style="color:#f59e0b"></i> Pending Draw</h3>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Quiz ID</th><th>Title</th><th>Type</th><th>Enrolled</th><th>Collection</th><th>Result Date</th><th>Actions</th></tr></thead>
            <tbody id="frPendingBody"><tr><td colspan="7" class="empty-state"><p>No pending draws</p></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: ALL QUIZZES -->
    <div id="frSection-quizzes" style="display:none">
      <div class="content-card">
        <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;align-items:center">
          <input type="text" id="frQuizSearch" placeholder="Search by ID or title..." class="form-input" style="width:220px;font-size:13px" oninput="filterAllQuizzes()">
          <select id="frQuizFilterType" class="form-input" style="width:140px;font-size:13px" onchange="filterAllQuizzes()">
            <option value="">All Types</option>
            <option value="monthly">Monthly</option>
            <option value="half_yearly">Half-Yearly</option>
            <option value="yearly">Annual</option>
          </select>
          <select id="frQuizFilterStatus" class="form-input" style="width:150px;font-size:13px" onchange="filterAllQuizzes()">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="upcoming">Upcoming</option>
            <option value="closed">Closed</option>
            <option value="result_declared">Result Declared</option>
          </select>
          <span id="frQuizCount" style="font-size:12px;color:#64748b;margin-left:auto"></span>
        </div>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Quiz ID</th><th>Title</th><th>Type</th><th>Status</th><th>Fee</th><th>Prizes</th><th>Start</th><th>End</th><th>Result</th><th>Enrolled</th><th>Collection</th><th>Actions</th></tr></thead>
            <tbody id="frAllQuizzesBody"><tr><td colspan="12" class="empty-state"><p>Loading...</p></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: RESULTS HISTORY -->
    <div id="frSection-results" style="display:none">
      <div class="content-card">
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Quiz ID</th><th>Title</th><th>Type</th><th>Result Date</th><th>🥇 1st Place</th><th>🥈 2nd Place</th><th>🥉 3rd Place</th><th>Total Paid Out</th><th>Actions</th></tr></thead>
            <tbody id="frResultsBody"><tr><td colspan="9" class="empty-state"><p>No results yet</p></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: DEMO MODE -->
    <div id="frSection-demo" style="display:none">
      <div class="content-card" style="border:2px dashed #f59e0b;background:linear-gradient(135deg,#1e1b4b 0%,#312e81 100%);margin-bottom:20px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px">
          <span style="font-size:32px">🧪</span>
          <div>
            <h3 style="margin:0;color:#fbbf24;font-size:18px">Demo / Test Mode</h3>
            <p style="margin:0;color:#c4b5fd;font-size:13px">Create demo quizzes with fake participants for data analysis & testing</p>
          </div>
        </div>

        <!-- Duration Config -->
        <div style="background:rgba(255,255,255,.07);border-radius:12px;padding:16px;margin-bottom:16px">
          <p style="color:#e2e8f0;font-weight:700;margin:0 0 12px;font-size:13px">⏱️ Select Demo Duration</p>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <label style="cursor:pointer">
              <input type="radio" name="demoDuration" value="0" checked onchange="updateDemoTimingInfo()">
              <span style="background:#6366f1;color:#fff;padding:8px 16px;border-radius:10px;font-weight:700;font-size:12px;cursor:pointer;margin-left:4px">⚡ Quick (30/60/90 min)</span>
            </label>
            <label style="cursor:pointer">
              <input type="radio" name="demoDuration" value="24" onchange="updateDemoTimingInfo()">
              <span style="background:#0ea5e9;color:#fff;padding:8px 16px;border-radius:10px;font-weight:700;font-size:12px;cursor:pointer;margin-left:4px">🕐 24-Hour Analysis</span>
            </label>
            <label style="cursor:pointer">
              <input type="radio" name="demoDuration" value="custom" onchange="updateDemoTimingInfo()">
              <span style="background:#8b5cf6;color:#fff;padding:8px 16px;border-radius:10px;font-weight:700;font-size:12px;cursor:pointer;margin-left:4px">🔧 Custom</span>
            </label>
          </div>
          <div id="customDemoInput" style="display:none;margin-top:10px">
            <input type="number" id="customDemoHours" min="1" max="72" value="24" placeholder="Hours (1-72)" class="form-input" style="width:180px;font-size:13px" oninput="updateDemoTimingInfo()">
            <span style="color:#94a3b8;font-size:12px;margin-left:8px">hours for Monthly (HY+2h, Annual+4h)</span>
          </div>
          <div id="demoTimingInfo" style="margin-top:12px;color:#a5b4fc;font-size:12px;line-height:1.8"></div>
        </div>

        <!-- Participant count config -->
        <div style="background:rgba(255,255,255,.07);border-radius:12px;padding:16px;margin-bottom:16px">
          <p style="color:#e2e8f0;font-weight:700;margin:0 0 12px;font-size:13px">👥 Fake Participants per Quiz</p>
          <div style="display:flex;gap:10px;align-items:center">
            <input type="range" id="demoFakeCount" min="5" max="50" value="15" oninput="document.getElementById('demoFakeCountVal').textContent=this.value" style="width:200px">
            <span id="demoFakeCountVal" style="color:#fbbf24;font-weight:800;font-size:18px">15</span>
            <span style="color:#94a3b8;font-size:12px">participants</span>
          </div>
        </div>

        <!-- Buttons -->
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <button id="btnDemoStart" onclick="startDemo()" style="background:linear-gradient(135deg,#22c55e,#16a34a);border:none;color:#fff;padding:12px 26px;border-radius:10px;font-weight:700;cursor:pointer;font-size:14px">
            <i class="fa-solid fa-play"></i> Start Demo
          </button>
          <button id="btnDemoStop" onclick="stopDemo()" style="background:linear-gradient(135deg,#ef4444,#dc2626);border:none;color:#fff;padding:12px 26px;border-radius:10px;font-weight:700;cursor:pointer;font-size:14px;display:none">
            <i class="fa-solid fa-stop"></i> Stop & Cleanup
          </button>
          <button id="btnDemoRefresh" onclick="refreshDemoStatus()" style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#e2e8f0;padding:12px 18px;border-radius:10px;font-weight:600;cursor:pointer;font-size:13px;display:none">
            <i class="fa-solid fa-sync"></i> Refresh
          </button>
          <span id="demoStatusBadge" style="display:none;background:#fbbf24;color:#1e1b4b;padding:5px 14px;border-radius:20px;font-size:12px;font-weight:800">RUNNING</span>
        </div>

        <!-- Live Tracker -->
        <div id="demoTracker" style="display:none;margin-top:20px">
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px" id="demoCardsGrid"></div>
          <div id="demoLog" style="margin-top:14px;max-height:220px;overflow-y:auto;background:rgba(0,0,0,.35);border-radius:10px;padding:12px;font-family:monospace;font-size:11px;color:#a5b4fc;line-height:1.8"></div>
        </div>
      </div>

      <!-- Demo Analysis Note -->
      <div class="content-card" style="border-left:4px solid #0ea5e9">
        <h4 style="margin:0 0 8px;color:#0ea5e9"><i class="fa-solid fa-chart-line"></i> 24-Hour Data Analysis Mode</h4>
        <p style="color:#64748b;font-size:13px;margin:0">Use <strong>24-Hour</strong> mode to simulate real participant behavior over a full day. Demo quizzes appear in Active Quizzes and Pending Draw tables. You can click <strong>View Participants</strong> anytime to inspect all enrolled members, their scores, and payment status. All demo data is labelled <code>DEMO-*</code> and can be cleaned up via Stop & Cleanup.</p>
      </div>
    </div>
  </div>

  <!-- ===== QUIZ DETAIL MODAL ===== -->
  <div id="modalQuizDetail" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:2000;overflow-y:auto;padding:20px">
    <div style="max-width:780px;margin:40px auto;background:#fff;border-radius:18px;overflow:hidden;box-shadow:0 24px 60px rgba(0,0,0,.3)">
      <div style="background:linear-gradient(135deg,#1e40af,#3b82f6);padding:22px 28px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 id="qdTitle" style="margin:0;color:#fff;font-size:20px">Quiz Detail</h2>
          <p id="qdSubtitle" style="margin:4px 0 0;color:#bfdbfe;font-size:13px"></p>
        </div>
        <button onclick="closeQuizDetail()" style="background:rgba(255,255,255,.2);border:none;color:#fff;width:38px;height:38px;border-radius:50%;font-size:18px;cursor:pointer">✕</button>
      </div>
      <div style="padding:24px" id="qdBody">Loading...</div>
    </div>
  </div>

  <!-- ===== PARTICIPANTS MODAL ===== -->
  <div id="modalParticipants" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:2000;overflow-y:auto;padding:20px">
    <div style="max-width:1000px;margin:40px auto;background:#fff;border-radius:18px;overflow:hidden;box-shadow:0 24px 60px rgba(0,0,0,.3)">
      <div style="background:linear-gradient(135deg,#4f46e5,#7c3aed);padding:22px 28px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <h2 id="pModalTitle" style="margin:0;color:#fff;font-size:20px">Participants</h2>
          <p id="pModalSubtitle" style="margin:4px 0 0;color:#ddd6fe;font-size:13px"></p>
        </div>
        <button onclick="closeParticipantsModal()" style="background:rgba(255,255,255,.2);border:none;color:#fff;width:38px;height:38px;border-radius:50%;font-size:18px;cursor:pointer">✕</button>
      </div>
      <!-- Stats Bar -->
      <div id="pModalStats" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0;border-bottom:1px solid #e2e8f0"></div>
      <!-- Search + Filter -->
      <div style="padding:14px 24px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;background:#f8fafc;border-bottom:1px solid #e2e8f0">
        <input type="text" id="pSearch" placeholder="Search name / ID / enrollment..." class="form-input" style="width:280px;font-size:13px" oninput="searchParticipants()">
        <select id="pFilterStatus" class="form-input" style="width:150px;font-size:13px" onchange="searchParticipants()">
          <option value="">All Status</option>
          <option value="enrolled">Enrolled</option>
          <option value="submitted">Submitted</option>
          <option value="won">Won</option>
          <option value="lost">Lost</option>
        </select>
        <button onclick="exportParticipantsCSV()" style="background:#22c55e;border:none;color:#fff;padding:8px 14px;border-radius:8px;font-weight:700;cursor:pointer;font-size:12px;margin-left:auto"><i class="fa-solid fa-download"></i> Export CSV</button>
      </div>
      <!-- Table -->
      <div style="padding:0 24px 24px;overflow-x:auto">
        <table class="data-table" style="min-width:800px">
          <thead><tr>
            <th>#</th><th>Name</th><th>Member ID</th><th>Enrollment No.</th>
            <th>Payment</th><th>Status</th><th>Score</th><th>Submitted</th><th>Enrolled On</th>
          </tr></thead>
          <tbody id="pModalBody"><tr><td colspan="9" class="empty-state"><p>Loading...</p></td></tr></tbody>
        </table>
        <div id="pModalPagination" style="display:flex;justify-content:center;gap:8px;margin-top:14px"></div>
      </div>
    </div>
  </div>

  <!-- ===================== SOCIAL POSTS APPROVAL ===================== -->
  <div class="page" id="page-posts">
    <div class="stats-row" style="grid-template-columns:repeat(3,1fr)">
      <div class="stat-card">
        <div class="s-icon s-amber"><i class="fa-solid fa-clock"></i></div>
        <div class="s-label">Pending Approval</div>
        <div class="s-value" id="postStatPending">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-green"><i class="fa-solid fa-check-circle"></i></div>
        <div class="s-label">Approved</div>
        <div class="s-value" id="postStatApproved">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-red"><i class="fa-solid fa-ban"></i></div>
        <div class="s-label">Rejected</div>
        <div class="s-value" id="postStatRejected">0</div>
      </div>
    </div>

    <div style="margin-bottom:16px;display:flex;gap:10px;align-items:center">
      <select class="form-input" id="postFilterStatus" style="width:160px" onchange="loadSocialPosts()">
        <option value="pending">Pending</option>
        <option value="active">Approved</option>
        <option value="removed">Rejected</option>
        <option value="all">All Posts</option>
      </select>
      <button class="btn btn-ghost" onclick="loadSocialPosts()"><i class="fa-solid fa-refresh"></i> Refresh</button>
    </div>

    <div class="content-card">
      <h3><i class="fa-solid fa-newspaper"></i> Member Posts</h3>
      <div id="postsGrid" style="display:flex;flex-direction:column;gap:16px;margin-top:12px">
        <div class="empty-state"><i class="fa-solid fa-newspaper"></i><p>Loading posts...</p></div>
      </div>
    </div>
  </div>

  <!-- ======== INVOICES PAGE ======== -->
  <div class="page" id="page-invoices">
    <!-- Stats Row -->
    <div class="stats-row" style="grid-template-columns:repeat(5,1fr)">
      <div class="stat-card"><div class="s-icon s-blue"><i class="fa-solid fa-file-invoice"></i></div><div class="s-label">Total Receipts</div><div class="s-value" id="invStatTotal">0</div></div>
      <div class="stat-card"><div class="s-icon s-green"><i class="fa-solid fa-indian-rupee-sign"></i></div><div class="s-label">Total Amount</div><div class="s-value" id="invStatAmount">₹0</div></div>
      <div class="stat-card"><div class="s-icon s-purple"><i class="fa-solid fa-id-card"></i></div><div class="s-label">Membership</div><div class="s-value" id="invStatMembership">0</div></div>
      <div class="stat-card"><div class="s-icon s-amber"><i class="fa-solid fa-hand-holding-heart"></i></div><div class="s-label">Donations</div><div class="s-value" id="invStatDonation">0</div></div>
      <div class="stat-card"><div class="s-icon" style="background:#dcfce7"><i class="fa-solid fa-leaf" style="color:#16a34a"></i></div><div class="s-label">80G Eligible</div><div class="s-value" id="invStat80g">0</div></div>
    </div>

    <!-- Filter Bar -->
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap">
      <input id="invSearch" type="text" placeholder="Search receipt ID, name, payment ID..." style="flex:1;min-width:220px;padding:9px 14px;border:1px solid var(--brd,#e2e8f0);border-radius:8px;font-size:13px;background:var(--card,#fff);color:inherit" oninput="loadInvoices()">
      <select id="invFilterType" style="padding:9px 14px;border:1px solid var(--brd,#e2e8f0);border-radius:8px;font-size:13px;background:var(--card,#fff);color:inherit" onchange="loadInvoices()">
        <option value="">All Types</option>
        <option value="membership">Membership</option>
        <option value="donation">Donation</option>
        <option value="renewal">Renewal</option>
        <option value="quiz">Quiz</option>
      </select>
      <button onclick="loadInvoices()" style="padding:9px 18px;background:var(--gA,#3b82f6);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:13px"><i class="fa-solid fa-rotate-right"></i> Refresh</button>
    </div>

    <!-- Invoices Table -->
    <div style="background:var(--card,#fff);border-radius:12px;border:1px solid var(--brd,#e2e8f0);overflow:hidden">
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead>
            <tr style="background:var(--card,#f8fafc);border-bottom:1px solid var(--brd,#e2e8f0)">
              <th style="padding:11px 14px;text-align:left;font-weight:600;color:#6b7280">Receipt ID</th>
              <th style="padding:11px 14px;text-align:left;font-weight:600;color:#6b7280">Type</th>
              <th style="padding:11px 14px;text-align:left;font-weight:600;color:#6b7280">Customer</th>
              <th style="padding:11px 14px;text-align:right;font-weight:600;color:#6b7280">Amount</th>
              <th style="padding:11px 14px;text-align:left;font-weight:600;color:#6b7280">Payment ID</th>
              <th style="padding:11px 14px;text-align:left;font-weight:600;color:#6b7280">80G</th>
              <th style="padding:11px 14px;text-align:left;font-weight:600;color:#6b7280">Status</th>
              <th style="padding:11px 14px;text-align:left;font-weight:600;color:#6b7280">Date</th>
              <th style="padding:11px 14px;text-align:center;font-weight:600;color:#6b7280">Actions</th>
            </tr>
          </thead>
          <tbody id="invTableBody">
            <tr><td colspan="9" style="padding:32px;text-align:center;color:#9ca3af"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <!-- Pagination -->
      <div id="invPagination" style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-top:1px solid var(--brd,#e2e8f0);font-size:13px;color:#6b7280">
        <span id="invPageInfo">—</span>
        <div style="display:flex;gap:8px">
          <button id="invPrevBtn" onclick="invChangePage(-1)" style="padding:6px 14px;border:1px solid var(--brd,#e2e8f0);border-radius:6px;background:var(--card,#fff);cursor:pointer;font-size:13px;color:inherit">← Prev</button>
          <button id="invNextBtn" onclick="invChangePage(1)" style="padding:6px 14px;border:1px solid var(--brd,#e2e8f0);border-radius:6px;background:var(--card,#fff);cursor:pointer;font-size:13px;color:inherit">Next →</button>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- ======== MOBILE BOTTOM NAV ======== -->
<nav class="mobile-bottom-nav" id="mobileBottomNav">
  <div class="nav-row">
    <button class="bnav active" data-page="home"><i class="fa-solid fa-chart-pie"></i><span>Home</span></button>
    <button class="bnav" data-page="members"><i class="fa-solid fa-users"></i><span>Members</span></button>
    <button class="bnav" data-page="payments"><i class="fa-solid fa-indian-rupee-sign"></i><span>Payments</span></button>
    <button class="bnav" data-page="support"><i class="fa-solid fa-headset"></i><span>Support</span></button>
    <button class="bnav" data-page="settings"><i class="fa-solid fa-gear"></i><span>Settings</span></button>
  </div>
</nav>

<!-- ======== MODALS ======== -->

<!-- Reset Password Modal -->
<div class="modal-overlay hidden" id="resetPwdModal">
  <div class="modal-card" style="max-width:440px">
    <div class="modal-head">
      <h3><i class="fa-solid fa-key"></i> Reset Member Password</h3>
      <button class="modal-close" onclick="closeModal('resetPwdModal')">&times;</button>
    </div>
    <div class="form-group">
      <label>Member ID</label>
      <input type="text" class="form-input" id="rpMemberId" placeholder="e.g. FWF-000001">
    </div>
    <div class="form-group">
      <label>New Password</label>
      <input type="text" class="form-input" id="rpNewPass" placeholder="Enter new password">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('resetPwdModal')">Cancel</button>
      <button class="btn btn-primary" id="rpSubmit"><i class="fa-solid fa-check"></i> Reset</button>
    </div>
  </div>
</div>

<!-- Add CSR Partner Modal -->
<div class="modal-overlay hidden" id="addCSRModal">
  <div class="modal-card">
    <div class="modal-head">
      <h3><i class="fa-solid fa-building"></i> Add CSR Partner</h3>
      <button class="modal-close" onclick="closeModal('addCSRModal')">&times;</button>
    </div>
    <div class="form-group">
      <label>Company Name *</label>
      <input type="text" class="form-input" id="csrCompany" placeholder="Company name">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Contact Person</label>
        <input type="text" class="form-input" id="csrContact" placeholder="Name">
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" class="form-input" id="csrEmail" placeholder="Email">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Phone</label>
        <input type="tel" class="form-input" id="csrPhone" placeholder="Phone">
      </div>
      <div class="form-group">
        <label>Industry</label>
        <input type="text" class="form-input" id="csrIndustry" placeholder="e.g. IT, Manufacturing">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Partnership Type</label>
        <select class="form-input" id="csrType">
          <option value="funding">Funding</option>
          <option value="skill-training">Skill Training</option>
          <option value="infrastructure">Infrastructure</option>
          <option value="employment">Employment</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Commitment Amount (₹)</label>
        <input type="number" class="form-input" id="csrAmount" placeholder="0" min="0">
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea class="form-input" id="csrNotes" placeholder="Additional notes..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addCSRModal')">Cancel</button>
      <button class="btn btn-primary" id="csrSubmit"><i class="fa-solid fa-plus"></i> Add Partner</button>
    </div>
  </div>
</div>

<!-- Update CSR Partner Modal -->
<div class="modal-overlay hidden" id="editCSRModal">
  <div class="modal-card" style="max-width:440px">
    <div class="modal-head">
      <h3><i class="fa-solid fa-edit"></i> Update CSR Partner</h3>
      <button class="modal-close" onclick="closeModal('editCSRModal')">&times;</button>
    </div>
    <input type="hidden" id="editCSRId">
    <div class="form-group">
      <label>Status</label>
      <select class="form-input" id="editCSRStatus">
        <option value="lead">Lead</option>
        <option value="contacted">Contacted</option>
        <option value="negotiating">Negotiating</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>
    <div class="form-group">
      <label>Paid Amount (₹)</label>
      <input type="number" class="form-input" id="editCSRPaid" placeholder="0" min="0">
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea class="form-input" id="editCSRNotes" placeholder="Update notes..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('editCSRModal')">Cancel</button>
      <button class="btn btn-primary" id="editCSRSubmit"><i class="fa-solid fa-save"></i> Update</button>
    </div>
  </div>
</div>

<!-- Support Ticket Reply Modal -->
<div class="modal-overlay hidden" id="replyTicketModal">
  <div class="modal-card" style="max-width:540px">
    <div class="modal-head">
      <h3><i class="fa-solid fa-reply"></i> Reply to Ticket</h3>
      <button class="modal-close" onclick="closeModal('replyTicketModal')">&times;</button>
    </div>
    <input type="hidden" id="replyTicketId">
    <div class="content-card" style="background:#f8fafc;margin-bottom:14px">
      <div style="font-size:12px;color:var(--text-muted);font-weight:700;margin-bottom:4px">Original Message</div>
      <div id="replyOriginal" style="font-size:13px;font-weight:600;line-height:1.6"></div>
    </div>
    <div class="form-group">
      <label>Status</label>
      <select class="form-input" id="replyStatus">
        <option value="in-progress">In Progress</option>
        <option value="resolved">Resolved</option>
        <option value="closed">Closed</option>
      </select>
    </div>
    <div class="form-group">
      <label>Admin Reply</label>
      <textarea class="form-input" id="replyMessage" placeholder="Type your reply..." rows="4"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('replyTicketModal')">Cancel</button>
      <button class="btn btn-primary" id="replySubmit"><i class="fa-solid fa-paper-plane"></i> Send Reply</button>
    </div>
  </div>
</div>

<!-- Member Detail Modal -->
<div class="modal-overlay hidden" id="memberDetailModal">
  <div class="modal-card" style="max-width:720px">
    <div class="modal-head">
      <h3><i class="fa-solid fa-user"></i> Member Details</h3>
      <button class="modal-close" onclick="closeModal('memberDetailModal')">&times;</button>
    </div>
    <div id="memberDetailContent">Loading...</div>
  </div>
</div>

<!-- Donation KYC Detail Modal -->
<div class="modal-overlay hidden" id="donDetailModal">
  <div class="modal-card" style="max-width:560px">
    <div class="modal-head">
      <h3><i class="fa-solid fa-shield-halved"></i> Donation Details & KYC</h3>
      <button class="modal-close" onclick="closeModal('donDetailModal')">&times;</button>
    </div>
    <div id="donDetailContent">Loading...</div>
    <div class="form-group" style="margin-top:14px">
      <label>KYC Status</label>
      <select class="form-input" id="donDetailKycStatus">
        <option value="not_required">Not Required</option>
        <option value="otp_verified">OTP Verified</option>
        <option value="pending_docs">Pending Documents</option>
        <option value="doc_verified">Documents Verified ✅</option>
      </select>
    </div>
    <div class="form-group">
      <label>Receipt Issued</label>
      <select class="form-input" id="donDetailReceipt">
        <option value="false">No</option>
        <option value="true">Yes — 80G Receipt Sent</option>
      </select>
    </div>
    <div class="form-group">
      <label>Admin Notes</label>
      <textarea class="form-input" id="donDetailNotes" rows="2" placeholder="Internal notes..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('donDetailModal')">Cancel</button>
      <button class="btn btn-primary" id="donDetailSave"><i class="fa-solid fa-save"></i> Save KYC</button>
    </div>
  </div>
</div>

<!-- Add Fee Record Modal -->
<div class="modal-overlay hidden" id="addFeeModal">
  <div class="modal-card">
    <div class="modal-head">
      <h3><i class="fa-solid fa-indian-rupee-sign"></i> Add Fee Record</h3>
      <button class="modal-close" onclick="closeModal('addFeeModal')">&times;</button>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Member ID *</label>
        <input type="text" class="form-input" id="afMemberId" placeholder="e.g. FWF-000001">
      </div>
      <div class="form-group">
        <label>Amount (₹) *</label>
        <input type="number" class="form-input" id="afAmount" placeholder="500" min="1">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Fee Type</label>
        <select class="form-input" id="afType">
          <option value="joining">Joining Fee</option>
          <option value="renewal">Renewal</option>
          <option value="upgrade">Upgrade</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label>Payment Mode</label>
        <select class="form-input" id="afMode">
          <option value="upi">UPI</option>
          <option value="bank_transfer">Bank Transfer</option>
          <option value="cash">Cash</option>
          <option value="cheque">Cheque</option>
          <option value="online">Online</option>
          <option value="other">Other</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>Payment Reference / UTR</label>
        <input type="text" class="form-input" id="afRef" placeholder="UTR / Reference number">
      </div>
      <div class="form-group">
        <label>Status</label>
        <select class="form-input" id="afStatus">
          <option value="pending">Pending</option>
          <option value="verified">Verified</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea class="form-input" id="afNotes" placeholder="Optional notes..." rows="2"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addFeeModal')">Cancel</button>
      <button class="btn btn-primary" id="afSubmit"><i class="fa-solid fa-plus"></i> Add Record</button>
    </div>
  </div>
</div>

<!-- Update Fee Status Modal -->
<div class="modal-overlay hidden" id="updateFeeModal">
  <div class="modal-card" style="max-width:480px">
    <div class="modal-head">
      <h3><i class="fa-solid fa-edit"></i> Update Transaction</h3>
      <button class="modal-close" onclick="closeModal('updateFeeModal')">&times;</button>
    </div>
    <input type="hidden" id="ufTxnId">
    <div id="ufInfo" style="padding:10px;background:#f8fafc;border-radius:10px;margin-bottom:12px;font-size:13px;font-weight:600"></div>
    <div class="form-group">
      <label>Status</label>
      <select class="form-input" id="ufStatus">
        <option value="pending">Pending</option>
        <option value="verified">Verified ✅</option>
        <option value="rejected">Rejected ❌</option>
        <option value="refunded">Refunded 🔄</option>
      </select>
    </div>
    <div class="form-group">
      <label>Payment Reference / UTR</label>
      <input type="text" class="form-input" id="ufRef" placeholder="UTR / Reference number">
    </div>
    <div class="form-group">
      <label>Notes</label>
      <textarea class="form-input" id="ufNotes" placeholder="Admin notes..." rows="2"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('updateFeeModal')">Cancel</button>
      <button class="btn btn-primary" id="ufSubmit"><i class="fa-solid fa-check"></i> Update</button>
    </div>
  </div>
</div>

<script src="/assets/js/fwf.js"></script>
<script src="/auth.js"></script>
<script>
/* ============================================
   NAVIGATION
   ============================================ */
const pageTitles = {
  home: '<i class="fa-solid fa-chart-pie"></i> Dashboard Overview',
  members: '<i class="fa-solid fa-users"></i> Members Management',
  csr: '<i class="fa-solid fa-handshake"></i> CSR Partners',
  posts: '<i class="fa-solid fa-newspaper"></i> Social Posts Approval',
  support: '<i class="fa-solid fa-headset"></i> Support Tickets',
  payments: '<i class="fa-solid fa-indian-rupee-sign"></i> Payments',
  points: '<i class="fa-solid fa-coins"></i> Points & Activity',
  courses: '<i class="fa-solid fa-graduation-cap"></i> Course Management',
  marketplace: '<i class="fa-solid fa-store"></i> Marketplace Management',
  funds: '<i class="fa-solid fa-piggy-bank"></i> Fund & Loan Management',
  reports: '<i class="fa-solid fa-chart-bar"></i> Reports & Analytics',
  settings: '<i class="fa-solid fa-gear"></i> Website & Settings',
  projectcosts: '<i class="fa-solid fa-indian-rupee-sign"></i> Project Cost Manager',
  fundraiser: '<i class="fa-solid fa-trophy"></i> Fund Raiser Quiz Management',
  invoices: '<i class="fa-solid fa-file-invoice"></i> Invoice & Receipt Management'
};

function switchPage(page, updateHash = true){
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item[data-page]').forEach(n => n.classList.remove('active'));
  const el = document.getElementById('page-' + page);
  if(el) el.classList.add('active');
  const nav = document.querySelector('.nav-item[data-page="'+page+'"]');
  if(nav) nav.classList.add('active');
  document.getElementById('pageTitle').innerHTML = pageTitles[page] || page;
  closeMobile();

  // Sync bottom nav
  document.querySelectorAll('.mobile-bottom-nav .bnav').forEach(b => b.classList.remove('active'));
  const bnav = document.querySelector('.mobile-bottom-nav .bnav[data-page="'+page+'"]');
  if(bnav) bnav.classList.add('active');

  // Update URL hash without reloading
  if(updateHash) {
    const hash = page === 'home' ? '#' : '#' + page;
    history.pushState({ page }, '', location.pathname + (page === 'home' ? '' : hash));
  }

  if(page === 'posts')       loadSocialPosts();
  if(page === 'members')     loadMembers();
  if(page === 'supporters')  loadSupporters();
  if(page === 'csr')         loadCSRPartners();
  if(page === 'support')     loadSupportTickets();
  if(page === 'payments')    { loadMembershipFees(); loadDonations(); }
  if(page === 'points')      loadPointsActivity();
  if(page === 'reports')     loadReports();
  if(page === 'marketplace') loadMarketplaceAdmin();
  if(page === 'projectcosts') renderCostEditor();
  if(page === 'fundraiser')  { loadFundRaiser(); checkDemoOnLoad(); }
  if(page === 'invoices')    loadInvoices();
}

document.querySelectorAll('.nav-item[data-page]').forEach(btn => {
  btn.addEventListener('click', () => switchPage(btn.dataset.page));
});

// Bottom nav clicks
document.querySelectorAll('.mobile-bottom-nav .bnav').forEach(btn => {
  btn.addEventListener('click', () => switchPage(btn.dataset.page));
});

// Handle browser back/forward
window.addEventListener('popstate', (e) => {
  const page = (e.state && e.state.page) || (location.hash.slice(1)) || 'home';
  switchPage(page, false);
});

// On load — path-based routing takes precedence over hash
window.addEventListener('load', () => {
  const pathMap = {
    '/admin/members':    'members',
    '/admin/projects':   'reports',
    '/admin/payments':   'payments',
    '/admin/posts':      'posts',
    '/admin/csr':        'csr',
    '/admin/support':    'support',
    '/admin/points':     'points',
    '/admin/store':      'marketplace',
  };
  const pathPage = pathMap[location.pathname];
  const hashPage = location.hash.slice(1);
  const target = pathPage || hashPage;
  if(target && document.getElementById('page-' + target)) {
    switchPage(target, false);
  }
});

// Mobile
document.getElementById('mobileToggle').addEventListener('click', () => {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('mobileOverlay').classList.toggle('show');
});
document.getElementById('mobileOverlay').addEventListener('click', closeMobile);
function closeMobile(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('mobileOverlay').classList.remove('show');
}

// Tabs (scoped to parent page)
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const parentPage = btn.closest('.page') || btn.parentElement;
    parentPage.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    parentPage.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

/* ============================================
   MODALS
   ============================================ */
function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
function openResetPasswordModal(){ openModal('resetPwdModal'); }
function openAddCSRModal(){ openModal('addCSRModal'); }

/* ============================================
   UTILITIES
   ============================================ */
function fmtN(n){ return Math.round(n||0).toLocaleString('en-IN'); }
function fmtDate(d){
  if(!d) return '—';
  try{ return new Date(d).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}); }
  catch(e){ return d; }
}
function notify(msg, type){
  if(typeof FWF_Notify !== 'undefined') FWF_Notify.toast(msg, type);
  else alert(msg);
}
function statusBadge(s){
  const map = {active:'b-active',inactive:'b-inactive',open:'b-open','in-progress':'b-progress',resolved:'b-resolved',closed:'b-closed',lead:'b-lead',contacted:'b-contacted',negotiating:'b-negotiating',pending:'b-pending',verified:'b-active',rejected:'b-inactive',refunded:'b-closed'};
  return `<span class="badge ${map[s]||'b-open'}">${s}</span>`;
}
function priBadge(p){
  const map = {low:'b-low',medium:'b-medium',high:'b-high',urgent:'b-urgent'};
  return `<span class="badge ${map[p]||'b-medium'}">${p}</span>`;
}

/* ============================================
   DASHBOARD (HOME)
   ============================================ */
async function loadDashboard(){
  try {
    const data = await AUTH.api('/api/admin/overview');
    const t = data.totals;
    document.getElementById('hSupporters').textContent = fmtN(t.supporters || 0);
    document.getElementById('hMembers').textContent = fmtN(t.members);
    document.getElementById('hActive').textContent = fmtN(t.active_members);
    document.getElementById('hPoints').textContent = fmtN(t.total_points);
    document.getElementById('hDonations').textContent = '₹' + fmtN(t.total_donations_amount);
    document.getElementById('hDonCount').textContent = t.total_donations_count + ' donations';
    document.getElementById('hReferrals').textContent = fmtN(t.total_referrals);
    document.getElementById('hRefActive').textContent = t.active_referrals + ' active';
    document.getElementById('hTickets').textContent = fmtN(t.total_tickets_sold);
    document.getElementById('hCSR').textContent = fmtN(t.csr_partners);
    document.getElementById('hSupport').textContent = fmtN(t.support_tickets);
    document.getElementById('hFeeCollected').textContent = '₹' + fmtN(t.total_fee_collected);
    document.getElementById('hFeePending').textContent = fmtN(t.pending_fees);

    const tbody = document.getElementById('hLatest');
    if(data.latest && data.latest.length > 0){
      tbody.innerHTML = data.latest.map(r => `<tr>
        <td><span class="member-link" onclick="viewMember('${r.member_id}')">${r.member_id}</span></td>
        <td style="font-weight:700">${r.name||'—'}</td>
        <td>${r.mobile||'—'}</td>
        <td>${r.email||'—'}</td>
        <td>${r.membership_active ? statusBadge('active') : statusBadge('inactive')}</td>
        <td style="color:var(--text-muted)">${fmtDate(r.created_at)}</td>
      </tr>`).join('');
    }

    // Load CSR + support + fee counts
    loadCSRCount();
    loadSupportCount();
    loadFeeCount();
    loadPostsCount();
  } catch(e){
    if(e.status === 401 || e.status === 403){
      notify('Session expired. Redirecting to login...', 'error');
      setTimeout(() => location.href = '/admin/login', 2000);
    } else {
      notify('Failed to load dashboard: ' + (e.message || 'Server error. Please refresh.'), 'error');
    }
  }
}

async function loadCSRCount(){
  try{
    const d = await AUTH.api('/api/admin/csr-partners');
    document.getElementById('hCSR').textContent = fmtN(d.stats.total);
  } catch(e){}
}

async function loadSupportCount(){
  try{
    const d = await AUTH.api('/api/admin/support-tickets');
    document.getElementById('hSupport').textContent = fmtN(d.stats.open);
    const badge = document.getElementById('supportBadge');
    if(d.stats.open > 0){ badge.textContent = d.stats.open; badge.style.display = ''; }
    else { badge.style.display = 'none'; }
  } catch(e){}
}

async function loadFeeCount(){
  try{
    const d = await AUTH.api('/api/admin/membership-fees');
    document.getElementById('hFeeCollected').textContent = '₹' + fmtN(d.stats.totalAmount);
    document.getElementById('hFeePending').textContent = fmtN(d.stats.pending);
    const badge = document.getElementById('paymentBadge');
    if(d.stats.pending > 0){ badge.textContent = d.stats.pending; badge.style.display = ''; }
    else { badge.style.display = 'none'; }
  } catch(e){}
}

async function loadPostsCount(){
  try{
    const d = await AUTH.api('/api/admin/social-posts?status=pending');
    const badge = document.getElementById('postsBadge');
    const pending = d.pending || 0;
    document.getElementById('postStatPending').textContent = pending;
    if(pending > 0){ badge.textContent = pending; badge.style.display = ''; }
    else { badge.style.display = 'none'; }
  } catch(e){}
}

/* ============================================
   MEMBERS
   ============================================ */
let allMembers = [];

async function loadMembers(){
  try{
    const d = await AUTH.api('/api/admin/members');
    allMembers = d.members || [];
    renderMembers(allMembers);
  } catch(e){ notify('Failed to load members','error'); }
}

function renderMembers(list){
  document.getElementById('memberCountLabel').textContent = `(${list.length})`;
  const tbody = document.getElementById('membersBody');
  if(!list.length){
    tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fa-solid fa-users"></i><p>No members found</p></td></tr>';
    return;
  }
  tbody.innerHTML = list.map(m => `<tr>
    <td><span class="member-link" onclick="viewMember('${m.member_id}')">${m.member_id}</span></td>
    <td style="font-weight:700">${m.name||'—'}</td>
    <td>${m.mobile||'—'}</td>
    <td>${m.email||'—'}</td>
    <td style="font-weight:800;color:var(--accent)">${fmtN(m.points_balance||0)}</td>
    <td>${m.membership_active ? statusBadge('active') : statusBadge('inactive')}</td>
    <td style="color:var(--text-muted)">${fmtDate(m.created_at)}</td>
    <td>
      <button class="btn-icon" title="View" onclick="viewMember('${m.member_id}')"><i class="fa-solid fa-eye"></i></button>
      <button class="btn-icon" title="Toggle status" onclick="toggleMember('${m.member_id}')"><i class="fa-solid fa-toggle-${m.membership_active?'on':'off'}"></i></button>
      <button class="btn-icon" title="Delete Member" onclick="deleteMember('${m.member_id}','${(m.name||'').replace(/'/g,"\\'")}')" style="color:var(--danger)"><i class="fa-solid fa-trash"></i></button>
    </td>
  </tr>`).join('');
}

document.getElementById('memberSearch').addEventListener('input', function(){
  const q = this.value.toLowerCase().trim();
  if(!q){ renderMembers(allMembers); return; }
  const filtered = allMembers.filter(m =>
    (m.name||'').toLowerCase().includes(q) ||
    (m.member_id||'').toLowerCase().includes(q) ||
    (m.mobile||'').includes(q) ||
    (m.email||'').toLowerCase().includes(q)
  );
  renderMembers(filtered);
});

async function toggleMember(memberId){
  try{
    const r = await AUTH.api('/api/admin/toggle-member',{method:'POST',body:{memberId}});
    notify(`${memberId} is now ${r.membership_active ? 'active' : 'inactive'}`,'success');
    loadMembers();
  } catch(e){ notify(e.message||'Failed','error'); }
}

async function sendTestEmail() {
  const emailInput = document.getElementById('testEmailAddr');
  const result = document.getElementById('testEmailResult');
  const email = emailInput.value.trim();
  if (!email) { result.innerHTML = '<span style="color:#ef4444">Email daalo pehle</span>'; return; }
  result.innerHTML = '<span style="color:#6b7280"><i class="fa-solid fa-spinner fa-spin"></i> Sending...</span>';
  try {
    const data = await AUTH.api('/api/admin/test-email', { method: 'POST', body: { to: email } });
    result.innerHTML = '<span style="color:#10b981"><i class="fa-solid fa-check-circle"></i> Email sent! Inbox check karo.</span>';
  } catch(e) {
    result.innerHTML = `<span style="color:#ef4444"><i class="fa-solid fa-circle-xmark"></i> Failed: ${e.message}</span>`;
  }
}

async function deleteMember(memberId, name){
  if(!confirm(`⚠️ DELETE member "${name}" (${memberId})?\n\nThis will permanently delete the member and all their associated data (points, referrals, orders, etc.).\nThis action cannot be undone.`)) return;
  try{
    await AUTH.api('/api/admin/member/' + memberId, {method:'DELETE'});
    notify(`Member ${memberId} deleted`, 'success');
    loadMembers();
  } catch(e){ notify(e.message||'Delete failed','error'); }
}

async function viewMember(memberId){
  openModal('memberDetailModal');
  const content = document.getElementById('memberDetailContent');
  content.innerHTML = '<div class="empty-state"><p>Loading...</p></div>';
  try{
    const d = await AUTH.api('/api/admin/member/' + memberId);
    const u = d.user, w = d.wallet || {};
    const initials = (u.name||'M').split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
    let html = `
      <div class="detail-header">
        <div class="detail-avatar">${initials}</div>
        <div>
          <div class="detail-name">${u.name||'—'}</div>
          <div class="detail-id">${u.member_id}</div>
          <div class="detail-meta">
            <span><i class="fa-solid fa-phone"></i> ${u.mobile||'—'}</span>
            <span><i class="fa-solid fa-envelope"></i> ${u.email||'—'}</span>
            <span><i class="fa-solid fa-calendar"></i> ${fmtDate(u.created_at)}</span>
            <span>${u.membership_active ? statusBadge('active') : statusBadge('inactive')}</span>
          </div>
        </div>
      </div>
      <div class="stats-row" style="grid-template-columns:repeat(4,1fr);margin-bottom:16px">
        <div class="stat-card"><div class="s-label">Points</div><div class="s-value" style="font-size:20px">${fmtN(w.points_balance)}</div></div>
        <div class="stat-card"><div class="s-label">Wallet ₹</div><div class="s-value" style="font-size:20px">${fmtN(w.balance_inr)}</div></div>
        <div class="stat-card"><div class="s-label">Donation Pts</div><div class="s-value" style="font-size:20px">${fmtN(w.points_from_donations)}</div></div>
        <div class="stat-card"><div class="s-label">Referral Pts</div><div class="s-value" style="font-size:20px">${fmtN(w.points_from_referrals)}</div></div>
      </div>
    `;
    // Recent points
    if(d.points && d.points.length){
      html += '<h4 style="margin:12px 0 8px;font-size:13px;font-weight:800"><i class="fa-solid fa-clock" style="color:var(--accent)"></i> Recent Activity</h4>';
      html += '<div class="table-wrap"><table class="data-table"><thead><tr><th>Type</th><th>Points</th><th>Description</th><th>Date</th></tr></thead><tbody>';
      html += d.points.slice(0,10).map(p => `<tr><td>${statusBadge(p.type)}</td><td style="font-weight:800;color:var(--accent)">+${p.points}</td><td>${p.description||'—'}</td><td style="color:var(--text-muted)">${fmtDate(p.created_at)}</td></tr>`).join('');
      html += '</tbody></table></div>';
    }
    content.innerHTML = html;
  } catch(e){ content.innerHTML = '<div class="empty-state"><p>Failed to load member details</p></div>'; }
}

/* ============================================
   SUPPORTERS (Volunteers)
   ============================================ */
let allSupporters = [];

async function loadSupporters(){
  try{
    const d = await AUTH.api('/api/admin/supporters');
    allSupporters = d.supporters || [];
    const active = allSupporters.filter(s => s.membership_active).length;
    document.getElementById('supTotalCount').textContent = fmtN(allSupporters.length);
    document.getElementById('supActiveCount').textContent = fmtN(active);
    document.getElementById('supInactiveCount').textContent = fmtN(allSupporters.length - active);
    renderSupporters(allSupporters);
  } catch(e){ notify('Failed to load supporters','error'); }
}

function renderSupporters(list){
  document.getElementById('supporterCountLabel').textContent = `(${list.length})`;
  const tbody = document.getElementById('supportersBody');
  if(!list.length){
    tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fa-solid fa-people-group"></i><p>No supporters registered yet</p></td></tr>';
    return;
  }
  tbody.innerHTML = list.map(s => `<tr>
    <td style="font-weight:700;color:var(--accent)">${s.member_id}</td>
    <td style="font-weight:700">${s.name||'—'}</td>
    <td>${s.mobile||'—'}</td>
    <td>${s.email||'—'}</td>
    <td style="font-size:12px;color:var(--text-muted);max-width:200px">${s.bio||'—'}</td>
    <td>${s.membership_active ? statusBadge('active') : statusBadge('inactive')}</td>
    <td style="color:var(--text-muted)">${fmtDate(s.created_at)}</td>
    <td>
      <button class="btn-icon" title="Toggle status" onclick="toggleSupporter('${s.member_id}')"><i class="fa-solid fa-toggle-${s.membership_active?'on':'off'}"></i></button>
      <button class="btn-icon" title="Delete Supporter" onclick="deleteSupporter('${s.member_id}','${(s.name||'').replace(/'/g,"\\\'")}')" style="color:var(--danger)"><i class="fa-solid fa-trash"></i></button>
    </td>
  </tr>`).join('');
}

document.getElementById('supporterSearch').addEventListener('input', function(){
  const q = this.value.toLowerCase().trim();
  if(!q){ renderSupporters(allSupporters); return; }
  renderSupporters(allSupporters.filter(s =>
    (s.name||'').toLowerCase().includes(q) ||
    (s.member_id||'').toLowerCase().includes(q) ||
    (s.mobile||'').includes(q) ||
    (s.email||'').toLowerCase().includes(q)
  ));
});

async function toggleSupporter(memberId){
  try{
    const r = await AUTH.api('/api/admin/toggle-member',{method:'POST',body:{memberId}});
    notify(`${memberId} is now ${r.membership_active ? 'active' : 'inactive'}`,'success');
    loadSupporters();
  } catch(e){ notify(e.message||'Failed','error'); }
}

async function deleteSupporter(memberId, name){
  if(!confirm(`⚠️ DELETE supporter "${name}" (${memberId})?\n\nThis action cannot be undone.`)) return;
  try{
    await AUTH.api('/api/admin/supporter/' + memberId, {method:'DELETE'});
    notify(`Supporter ${memberId} deleted`, 'success');
    loadSupporters();
  } catch(e){ notify(e.message||'Delete failed','error'); }
}

/* ============================================
   MEMBERSHIP FEE PAYMENTS
   ============================================ */
let allFees = [];

async function loadMembershipFees(){
  try{
    const d = await AUTH.api('/api/admin/membership-fees');
    const s = d.stats;
    allFees = d.fees || [];
    document.getElementById('feeCollected').textContent = '₹' + fmtN(s.totalAmount);
    document.getElementById('feePending').textContent = fmtN(s.pending);
    document.getElementById('feePendingAmt').textContent = '₹' + fmtN(s.pendingAmount);
    document.getElementById('feeVerified').textContent = fmtN(s.verified);
    document.getElementById('feeRejected').textContent = fmtN(s.rejected);
    
    // Update dashboard badge
    const badge = document.getElementById('paymentBadge');
    if(s.pending > 0){ badge.textContent = s.pending; badge.style.display = ''; }
    else { badge.style.display = 'none'; }
    
    renderFees(allFees);
  } catch(e){
    document.getElementById('feesBody').innerHTML = '<tr><td colspan="9" class="empty-state" style="color:var(--danger)"><i class="fa-solid fa-exclamation-triangle"></i><p>⚠️ Failed to load payment data<br><small>Backend may be unavailable</small></p></td></tr>';
    console.error('Fee load error:', e);
  }
}

function renderFees(list){
  const tb = document.getElementById('feesBody');
  if(!list.length){ tb.innerHTML = '<tr><td colspan="9" class="empty-state"><i class="fa-solid fa-receipt"></i><p>No fee transactions yet</p></td></tr>'; return; }
  tb.innerHTML = list.map(f => {
    const feeTypeLabel = {joining:'Joining',renewal:'Renewal',upgrade:'Upgrade',other:'Other'}[f.fee_type]||f.fee_type;
    const modeLabel = {upi:'UPI',bank_transfer:'Bank Transfer',cash:'Cash',cheque:'Cheque',online:'Online',other:'Other'}[f.payment_mode]||f.payment_mode;
    return `<tr>
      <td><span style="font-weight:800;color:var(--accent);font-size:11px">${f.txn_id}</span></td>
      <td>
        <div style="font-weight:700;font-size:12px">${f.member_name||'—'}</div>
        <div style="font-size:11px;color:var(--text-muted)">${f.member_id}</div>
      </td>
      <td style="font-weight:800;color:#059669">₹${fmtN(f.amount)}</td>
      <td><span class="badge b-${f.fee_type==='joining'?'active':f.fee_type==='renewal'?'progress':'open'}">${feeTypeLabel}</span></td>
      <td style="font-size:12px;font-weight:600">${modeLabel}</td>
      <td style="font-size:11px;color:var(--text-muted)">${f.payment_ref||'—'}</td>
      <td>${statusBadge(f.status)}</td>
      <td style="color:var(--text-muted);font-size:12px">${fmtDate(f.created_at)}</td>
      <td>
        <div style="display:flex;gap:6px">
          <button class="btn-icon" title="Update" onclick="openUpdateFee('${f.txn_id}')"><i class="fa-solid fa-pen"></i></button>
          ${f.status==='pending'?`<button class="btn-icon" title="Quick Verify" style="color:#059669" onclick="quickVerifyFee('${f.txn_id}')"><i class="fa-solid fa-check"></i></button>`:''}
        </div>
      </td>
    </tr>`;
  }).join('');
}

// Search & Filter
document.getElementById('feeSearch')?.addEventListener('input', e => {
  const q = e.target.value.toLowerCase();
  const filtered = allFees.filter(f => 
    (f.txn_id||'').toLowerCase().includes(q) || 
    (f.member_id||'').toLowerCase().includes(q) || 
    (f.member_name||'').toLowerCase().includes(q) ||
    (f.payment_ref||'').toLowerCase().includes(q)
  );
  renderFees(filtered);
});

document.getElementById('feeFilter')?.addEventListener('change', e => {
  const val = e.target.value;
  if(val === 'all') renderFees(allFees);
  else renderFees(allFees.filter(f => f.status === val));
});

// Add Fee Record
document.getElementById('afSubmit')?.addEventListener('click', async ()=>{
  const memberId = document.getElementById('afMemberId').value.trim();
  const amount = document.getElementById('afAmount').value;
  if(!memberId || !amount){ notify('Member ID and Amount required','error'); return; }
  
  try{
    const res = await AUTH.api('/api/admin/membership-fee', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        memberId,
        amount: parseFloat(amount),
        feeType: document.getElementById('afType').value,
        paymentMode: document.getElementById('afMode').value,
        paymentRef: document.getElementById('afRef').value.trim() || null,
        status: document.getElementById('afStatus').value,
        notes: document.getElementById('afNotes').value.trim() || null
      })
    });
    notify('Fee record added: ' + res.txnId, 'success');
    closeModal('addFeeModal');
    document.getElementById('afMemberId').value = '';
    document.getElementById('afAmount').value = '';
    document.getElementById('afRef').value = '';
    document.getElementById('afNotes').value = '';
    loadMembershipFees();
  } catch(e){ notify('Failed to add: ' + (e.message||'error'), 'error'); }
});

// Open Update Fee Modal
function openUpdateFee(txnId){
  const f = allFees.find(x => x.txn_id === txnId);
  if(!f) return;
  document.getElementById('ufTxnId').value = txnId;
  document.getElementById('ufInfo').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${f.txn_id}</strong> · ${f.member_name} (${f.member_id})</div>
      <div style="font-weight:800;color:#059669">₹${fmtN(f.amount)}</div>
    </div>`;
  document.getElementById('ufStatus').value = f.status;
  document.getElementById('ufRef').value = f.payment_ref || '';
  document.getElementById('ufNotes').value = f.notes || '';
  openModal('updateFeeModal');
}

// Update Fee Status
document.getElementById('ufSubmit')?.addEventListener('click', async ()=>{
  const txnId = document.getElementById('ufTxnId').value;
  try{
    await AUTH.api('/api/admin/membership-fee/' + txnId, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        status: document.getElementById('ufStatus').value,
        paymentRef: document.getElementById('ufRef').value.trim() || undefined,
        notes: document.getElementById('ufNotes').value.trim() || undefined
      })
    });
    notify('Transaction updated!', 'success');
    closeModal('updateFeeModal');
    loadMembershipFees();
  } catch(e){ notify('Failed to update: ' + (e.message||'error'), 'error'); }
});

// Quick Verify
async function quickVerifyFee(txnId){
  if(!confirm('Mark this transaction as VERIFIED? This will activate the member\'s membership.')) return;
  try{
    await AUTH.api('/api/admin/membership-fee/' + txnId, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ status: 'verified' })
    });
    notify('Transaction verified!', 'success');
    loadMembershipFees();
  } catch(e){ notify('Error: ' + (e.message||''), 'error'); }
}

/* ============================================
   DONATIONS
   ============================================ */
let allDonations = [];
let currentDonId = null;

async function loadDonations(){
  const search  = (document.getElementById('donSearch')?.value  || '').trim();
  const kycFilt = document.getElementById('donKycFilter')?.value || '';
  try{
    const params = new URLSearchParams();
    if(search)  params.set('search', search);
    if(kycFilt) params.set('kyc', kycFilt);
    const d = await AUTH.api('/api/admin/donations?' + params.toString());
    allDonations = d.donations || [];
    document.getElementById('donTotalAmt').textContent   = '₹' + fmtN(d.stats.totalAmount);
    document.getElementById('donTotalCount').textContent = fmtN(d.stats.total);
    document.getElementById('donKycPending').textContent = fmtN(d.stats.kycPending);
    document.getElementById('donHighValue').textContent  = fmtN(d.stats.highValue);
    renderDonations(allDonations);
  } catch(e){
    document.getElementById('donationsAdminBody').innerHTML = '<tr><td colspan="10" class="empty-state" style="color:var(--danger)"><i class="fa-solid fa-exclamation-triangle"></i><p>Failed to load donations</p></td></tr>';
    console.error('Donations load error:', e);
  }
}

function kycBadge(status, otpVerified){
  const map = {
    'not_required': '<span class="badge b-resolved" style="font-size:10px">Not Required</span>',
    'otp_verified':  '<span class="badge b-active"   style="font-size:10px">OTP ✓</span>',
    'pending_docs':  '<span class="badge b-progress" style="font-size:10px">Pending Docs</span>',
    'doc_verified':  '<span class="badge b-active"   style="font-size:10px;background:#059669">Docs ✓</span>'
  };
  return map[status] || status;
}

function renderDonations(list){
  const tb = document.getElementById('donationsAdminBody');
  if(!list.length){ tb.innerHTML = '<tr><td colspan="10" class="empty-state"><i class="fa-solid fa-hand-holding-heart"></i><p>No donations found</p></td></tr>'; return; }
  tb.innerHTML = list.map(d => {
    const isHighValue = d.amount >= 50000;
    return `<tr>
      <td><span style="font-weight:800;color:var(--accent);font-size:11px">${d.donation_id||'—'}</span></td>
      <td>
        <div style="font-weight:700;font-size:12px">${d.donor_name||'Anonymous'}</div>
        <div style="font-size:11px;color:var(--text-muted)">${d.donor_email||''}</div>
        <div style="font-size:11px;color:var(--text-muted)">${d.donor_mobile||''}</div>
      </td>
      <td>
        <span style="font-weight:900;color:#059669">₹${fmtN(d.amount)}</span>
        ${isHighValue ? '<br><span class="badge b-open" style="font-size:9px">High Value</span>' : ''}
      </td>
      <td style="font-size:12px;font-weight:600;color:var(--text-muted)">${d.donor_pan||'—'}</td>
      <td>${kycBadge(d.kyc_status)}</td>
      <td style="text-align:center">${d.otp_verified ? '<i class="fa-solid fa-circle-check" style="color:#059669" title="OTP Verified"></i>' : '<i class="fa-solid fa-circle-xmark" style="color:#94a3b8" title="Not OTP Verified"></i>'}</td>
      <td style="font-size:11px;color:var(--text-muted)">${d.member_display_id||'—'}</td>
      <td style="font-size:10px;color:var(--text-muted);max-width:120px;overflow:hidden;text-overflow:ellipsis">${d.payment_id||'—'}</td>
      <td style="color:var(--text-muted);font-size:12px">${fmtDate(d.created_at)}</td>
      <td>
        <button class="btn-icon" title="View KYC Details" onclick="openDonDetail('${d.donation_id}')"><i class="fa-solid fa-eye"></i></button>
        ${d.receipt_issued ? '<i class="fa-solid fa-file-invoice" style="color:#059669;margin-left:4px" title="80G Receipt Issued"></i>' : ''}
        <button class="btn-icon" title="Delete Donation" onclick="deleteDonation('${d.donation_id}','${(d.donor_name||'Anonymous').replace(/'/g,"\\'")}'" style="color:var(--danger)"><i class="fa-solid fa-trash"></i></button>
      </td>
    </tr>`;
  }).join('');
}

// Search & filter
document.getElementById('donSearch')?.addEventListener('input', loadDonations);
document.getElementById('donKycFilter')?.addEventListener('change', loadDonations);

async function deleteDonation(donationId, donorName){
  if(!confirm(`⚠️ DELETE donation from "${donorName}" (${donationId})?\n\nThis action cannot be undone.`)) return;
  try{
    await AUTH.api('/api/admin/donation/' + donationId, {method:'DELETE'});
    notify('Donation deleted', 'success');
    loadDonations();
  } catch(e){ notify(e.message||'Delete failed','error'); }
}

// Open donation KYC detail modal
async function openDonDetail(donationId){
  currentDonId = donationId;
  openModal('donDetailModal');
  document.getElementById('donDetailContent').innerHTML = '<div style="text-align:center;padding:20px"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>';
  try{
    const d = await AUTH.api('/api/admin/donation/' + donationId);
    const don = d.donation;
    document.getElementById('donDetailContent').innerHTML = `
      <div style="background:#f8fafc;border-radius:10px;padding:14px;font-size:13px;line-height:1.8">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 16px">
          <div><span style="color:var(--text-muted)">DON ID:</span> <strong>${don.donation_id||'—'}</strong></div>
          <div><span style="color:var(--text-muted)">Amount:</span> <strong style="color:#059669">₹${fmtN(don.amount)}</strong></div>
          <div><span style="color:var(--text-muted)">Name:</span> <strong>${don.donor_name||'—'}</strong></div>
          <div><span style="color:var(--text-muted)">Email:</span> <strong>${don.donor_email||'—'}</strong></div>
          <div><span style="color:var(--text-muted)">Mobile:</span> <strong>${don.donor_mobile||'—'}</strong></div>
          <div><span style="color:var(--text-muted)">PAN:</span> <strong>${don.donor_pan||'—'}</strong></div>
          <div><span style="color:var(--text-muted)">Address:</span> <strong>${don.donor_address||'—'}</strong></div>
          <div><span style="color:var(--text-muted)">Payment ID:</span> <small style="word-break:break-all">${don.payment_id||'—'}</small></div>
          <div><span style="color:var(--text-muted)">OTP Verified:</span> <strong>${don.otp_verified ? '✅ Yes' : '❌ No'}</strong></div>
          <div><span style="color:var(--text-muted)">Member:</span> <strong>${don.member_display_id||'—'}</strong></div>
          <div><span style="color:var(--text-muted)">Date:</span> <strong>${fmtDate(don.created_at)}</strong></div>
        </div>
      </div>`;
    document.getElementById('donDetailKycStatus').value = don.kyc_status || 'not_required';
    document.getElementById('donDetailReceipt').value = don.receipt_issued ? 'true' : 'false';
    document.getElementById('donDetailNotes').value = don.admin_notes || '';
  } catch(e){
    document.getElementById('donDetailContent').innerHTML = '<p style="color:var(--danger)">Failed to load donation details</p>';
  }
}

document.getElementById('donDetailSave')?.addEventListener('click', async ()=>{
  if(!currentDonId) return;
  try{
    await AUTH.api('/api/admin/donation-kyc/' + currentDonId, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        kyc_status:      document.getElementById('donDetailKycStatus').value,
        receipt_issued:  document.getElementById('donDetailReceipt').value === 'true',
        admin_notes:     document.getElementById('donDetailNotes').value.trim()
      })
    });
    notify('Donation KYC updated!', 'success');
    closeModal('donDetailModal');
    loadDonations();
  } catch(e){ notify('Error: ' + (e.message||''), 'error'); }
});

/* ============================================
   CSR PARTNERS
   ============================================ */
async function loadCSRPartners(){
  try{
    const d = await AUTH.api('/api/admin/csr-partners');
    const s = d.stats;
    document.getElementById('csrTotal').textContent = fmtN(s.total);
    document.getElementById('csrActive').textContent = fmtN(s.active);
    document.getElementById('csrCommit').textContent = '₹' + fmtN(s.totalCommitment);
    document.getElementById('csrPaid').textContent = '₹' + fmtN(s.totalPaid);
    
    const tbody = document.getElementById('csrBody');
    if(!d.partners.length){
      tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fa-solid fa-handshake"></i><p>No CSR partners yet. Click "Add CSR Partner" to begin.</p></td></tr>';
      return;
    }
    tbody.innerHTML = d.partners.map(p => `<tr>
      <td style="font-weight:700;color:var(--accent)">${p.partner_id}</td>
      <td style="font-weight:800">${p.company_name}</td>
      <td>${p.contact_person||'—'}<br><span style="font-size:11px;color:var(--text-muted)">${p.email||''} ${p.phone||''}</span></td>
      <td><span class="badge b-funding">${p.partnership_type}</span></td>
      <td style="font-weight:700">₹${fmtN(p.commitment_amount)}</td>
      <td style="font-weight:700;color:var(--success)">₹${fmtN(p.paid_amount)}</td>
      <td>${statusBadge(p.status)}</td>
      <td>
        <button class="btn-icon" title="Edit" onclick="openEditCSR('${p.partner_id}','${p.status}',${p.paid_amount},'${(p.notes||'').replace(/'/g,"\\'")}')"><i class="fa-solid fa-pen"></i></button>
        <button class="btn-icon" title="Delete" onclick="deleteCSR('${p.partner_id}','${p.company_name}')"><i class="fa-solid fa-trash" style="color:var(--danger)"></i></button>
      </td>
    </tr>`).join('');
  } catch(e){ 
    document.getElementById('csrBody').innerHTML = '<tr><td colspan="8" class="empty-state" style="color:var(--danger)"><i class="fa-solid fa-exclamation-triangle"></i><p>⚠️ Backend server connection failed<br><small style="font-weight:600;opacity:.8">Please ensure Railway backend is deployed and running</small></p></td></tr>';
    console.error('CSR load error:', e);
  }
}

document.getElementById('csrSubmit').addEventListener('click', async ()=>{
  const companyName = document.getElementById('csrCompany').value.trim();
  if(!companyName) return notify('Company name required','warning');
  try{
    const r = await AUTH.api('/api/admin/csr-partner',{method:'POST',body:{
      companyName,
      contactPerson: document.getElementById('csrContact').value.trim(),
      email: document.getElementById('csrEmail').value.trim(),
      phone: document.getElementById('csrPhone').value.trim(),
      industry: document.getElementById('csrIndustry').value.trim(),
      partnershipType: document.getElementById('csrType').value,
      commitmentAmount: document.getElementById('csrAmount').value,
      notes: document.getElementById('csrNotes').value.trim()
    }});
    notify(r.message||'Partner added!','success');
    closeModal('addCSRModal');
    ['csrCompany','csrContact','csrEmail','csrPhone','csrIndustry','csrAmount','csrNotes'].forEach(id => document.getElementById(id).value = '');
    loadCSRPartners();
  } catch(e){ notify(e.message||'Failed','error'); }
});

function openEditCSR(id, status, paid, notes){
  document.getElementById('editCSRId').value = id;
  document.getElementById('editCSRStatus').value = status;
  document.getElementById('editCSRPaid').value = paid || 0;
  document.getElementById('editCSRNotes').value = notes || '';
  openModal('editCSRModal');
}

document.getElementById('editCSRSubmit').addEventListener('click', async ()=>{
  const partnerId = document.getElementById('editCSRId').value;
  try{
    await AUTH.api('/api/admin/csr-partner/' + partnerId,{method:'POST',body:{
      status: document.getElementById('editCSRStatus').value,
      paidAmount: document.getElementById('editCSRPaid').value,
      notes: document.getElementById('editCSRNotes').value.trim()
    }});
    notify('Partner updated!','success');
    closeModal('editCSRModal');
    loadCSRPartners();
  } catch(e){ notify(e.message||'Failed','error'); }
});

async function deleteCSR(id, name){
  if(!confirm(`Delete CSR partner "${name}"?`)) return;
  try{
    await AUTH.api('/api/admin/csr-partner/' + id,{method:'DELETE'});
    notify('Partner deleted','success');
    loadCSRPartners();
  } catch(e){ notify(e.message||'Failed','error'); }
}

/* ============================================
   SOCIAL POSTS APPROVAL
   ============================================ */
async function loadSocialPosts(){
  const status = document.getElementById('postFilterStatus')?.value || 'pending';
  const grid = document.getElementById('postsGrid');
  grid.innerHTML = '<div class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i><p>Loading...</p></div>';
  try{
    const d = await AUTH.api('/api/admin/social-posts?status=' + status);
    const posts = d.posts || [];

    // Update badge
    const badge = document.getElementById('postsBadge');
    if(d.pending > 0){ badge.textContent = d.pending; badge.style.display = ''; }
    else { badge.style.display = 'none'; }

    // Update stat counts (when viewing pending)
    if(status === 'pending') document.getElementById('postStatPending').textContent = posts.length;
    if(status === 'active')  document.getElementById('postStatApproved').textContent = posts.length;
    if(status === 'removed') document.getElementById('postStatRejected').textContent = posts.length;

    if(!posts.length){
      grid.innerHTML = '<div class="empty-state"><i class="fa-solid fa-newspaper"></i><p>No posts found</p></div>';
      return;
    }

    grid.innerHTML = posts.map(p => {
      const imgs = (p.images||[]).map(u =>
        `<img src="${u}" style="width:80px;height:60px;object-fit:cover;border-radius:8px;flex-shrink:0">`
      ).join('');
      const statusBadge = p.status === 'active'
        ? '<span class="badge b-active">Approved</span>'
        : p.status === 'removed'
        ? '<span class="badge b-inactive">Rejected</span>'
        : '<span class="badge b-progress">Pending</span>';
      const actions = p.status === 'pending' ? `
        <button class="btn btn-ghost btn-sm" style="color:#16a34a;border-color:#16a34a" onclick="approvePost('${p._id}')">
          <i class="fa-solid fa-check"></i> Approve
        </button>
        <button class="btn btn-ghost btn-sm" style="color:#dc2626;border-color:#dc2626" onclick="rejectPost('${p._id}')">
          <i class="fa-solid fa-times"></i> Reject
        </button>` : '';
      return `
        <div style="border:1px solid var(--brd);border-radius:12px;padding:16px;background:#fff" id="post-card-${p._id}">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
            <div>
              <div style="font-weight:700;font-size:13px">${p.user_name || 'Unknown'}</div>
              <div style="font-size:11px;color:var(--text-muted)">${p.member_id} &bull; ${new Date(p.created_at).toLocaleString('en-IN')}</div>
            </div>
            ${statusBadge}
          </div>
          <p style="font-size:13px;margin:0 0 10px;line-height:1.6;color:#374151">${p.content}</p>
          ${imgs ? `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">${imgs}</div>` : ''}
          <div style="display:flex;gap:8px">${actions}</div>
        </div>`;
    }).join('');
  } catch(e){
    grid.innerHTML = `<div class="empty-state"><i class="fa-solid fa-triangle-exclamation"></i><p>${e.message}</p></div>`;
  }
}

async function approvePost(id){
  try{
    await AUTH.api('/api/admin/social-posts/' + id + '/approve', { method:'POST' });
    document.getElementById('post-card-' + id)?.remove();
    const pending = document.getElementById('postStatPending');
    if(pending) pending.textContent = Math.max(0, parseInt(pending.textContent||0) - 1);
    const badge = document.getElementById('postsBadge');
    const cnt = Math.max(0, parseInt(badge.textContent||0) - 1);
    if(cnt > 0){ badge.textContent = cnt; } else { badge.style.display = 'none'; }
    notify('Post approved and published','success');
  } catch(e){ notify(e.message,'error'); }
}

async function rejectPost(id){
  try{
    await AUTH.api('/api/admin/social-posts/' + id + '/reject', { method:'POST' });
    document.getElementById('post-card-' + id)?.remove();
    const pending = document.getElementById('postStatPending');
    if(pending) pending.textContent = Math.max(0, parseInt(pending.textContent||0) - 1);
    const badge = document.getElementById('postsBadge');
    const cnt = Math.max(0, parseInt(badge.textContent||0) - 1);
    if(cnt > 0){ badge.textContent = cnt; } else { badge.style.display = 'none'; }
    notify('Post rejected','warning');
  } catch(e){ notify(e.message,'error'); }
}

/* ============================================
   SUPPORT TICKETS
   ============================================ */
async function loadSupportTickets(){
  try{
    const d = await AUTH.api('/api/admin/support-tickets');
    const s = d.stats;
    document.getElementById('supTotal').textContent = fmtN(s.total);
    document.getElementById('supOpen').textContent = fmtN(s.open);
    document.getElementById('supProgress').textContent = fmtN(s.inProgress);
    document.getElementById('supResolved').textContent = fmtN(s.resolved);
    document.getElementById('supClosed').textContent = fmtN(s.closed);

    const badge = document.getElementById('supportBadge');
    if(s.open > 0){ badge.textContent = s.open; badge.style.display = ''; }
    else { badge.style.display = 'none'; }

    const tbody = document.getElementById('supportBody');
    if(!d.tickets.length){
      tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fa-solid fa-headset"></i><p>No support tickets</p></td></tr>';
      return;
    }
    tbody.innerHTML = d.tickets.map(t => `<tr>
      <td style="font-weight:700;color:var(--accent)">${t.ticket_id}</td>
      <td>${t.user_name||'—'}<br><span style="font-size:11px;color:var(--text-muted)">${t.user_email||''}</span></td>
      <td style="font-weight:700;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.subject}</td>
      <td><span class="badge b-open">${t.category}</span></td>
      <td>${priBadge(t.priority)}</td>
      <td>${statusBadge(t.status)}</td>
      <td style="color:var(--text-muted)">${fmtDate(t.created_at)}</td>
      <td>
        <button class="btn-icon" title="Reply" onclick="openReplyTicket('${t.ticket_id}',\`${(t.message||'').replace(/`/g,"'").replace(/\\/g,"\\\\")}\`)"><i class="fa-solid fa-reply"></i></button>
      </td>
    </tr>`).join('');
  } catch(e){ 
    document.getElementById('supportBody').innerHTML = '<tr><td colspan="8" class="empty-state" style="color:var(--danger)"><i class="fa-solid fa-exclamation-triangle"></i><p>⚠️ Backend server connection failed<br><small style="font-weight:600;opacity:.8">Please ensure Railway backend is deployed and running</small></p></td></tr>';
    console.error('Support tickets load error:', e);
  }
}

function openReplyTicket(ticketId, message){
  document.getElementById('replyTicketId').value = ticketId;
  document.getElementById('replyOriginal').textContent = message;
  document.getElementById('replyMessage').value = '';
  openModal('replyTicketModal');
}

document.getElementById('replySubmit').addEventListener('click', async ()=>{
  const ticketId = document.getElementById('replyTicketId').value;
  const status = document.getElementById('replyStatus').value;
  const adminReply = document.getElementById('replyMessage').value.trim();
  try{
    await AUTH.api('/api/admin/support-ticket/' + ticketId,{method:'POST',body:{status, adminReply}});
    notify('Ticket updated!','success');
    closeModal('replyTicketModal');
    loadSupportTickets();
  } catch(e){ notify(e.message||'Failed','error'); }
});

/* ============================================
   POINTS & ACTIVITY
   ============================================ */
async function loadPointsActivity(){
  try{
    const [dons, refs, tix] = await Promise.all([
      AUTH.api('/api/admin/donations'),
      AUTH.api('/api/admin/referrals'),
      AUTH.api('/api/admin/tickets')
    ]);

    // Donations
    const dBody = document.getElementById('donationsBody');
    if(dons.donations.length){
      dBody.innerHTML = dons.donations.map(d => `<tr>
        <td><span class="member-link" onclick="viewMember('${d.member_id}')">${d.member_id}</span> <span style="font-weight:600;color:var(--text-muted)">${d.member_name||''}</span></td>
        <td style="font-weight:800">₹${fmtN(d.amount)}</td>
        <td>${d.donor_name||'Anonymous'}</td>
        <td style="font-weight:800;color:var(--accent)">+${d.points_earned}</td>
        <td style="color:var(--text-muted)">${fmtDate(d.created_at)}</td>
      </tr>`).join('');
    } else {
      dBody.innerHTML = '<tr><td colspan="5" class="empty-state"><p>No donations yet</p></td></tr>';
    }

    // Referrals
    const rBody = document.getElementById('referralsBody');
    if(refs.referrals.length){
      rBody.innerHTML = refs.referrals.map(r => `<tr>
        <td style="font-weight:700">${r.referrer_member_id} <span style="color:var(--text-muted)">${r.referrer_name||''}</span></td>
        <td>${r.referred_member_id} <span style="color:var(--text-muted)">${r.referred_name||''}</span></td>
        <td style="font-weight:700">₹${fmtN(r.payment_amount)}</td>
        <td style="font-weight:800;color:var(--accent)">+${r.referral_points||0}</td>
        <td>${statusBadge(r.status)}</td>
        <td style="color:var(--text-muted)">${fmtDate(r.created_at)}</td>
        <td>${r.status==='pending' ? `<button class="btn btn-sm btn-success" onclick="activateReferral('${r.referred_member_id}')"><i class="fa-solid fa-check"></i> Activate</button>` : ''}</td>
      </tr>`).join('');
    } else {
      rBody.innerHTML = '<tr><td colspan="7" class="empty-state"><p>No referrals yet</p></td></tr>';
    }

    // Tickets
    const tBody = document.getElementById('ticketsBody');
    if(tix.tickets.length){
      tBody.innerHTML = tix.tickets.map(t => `<tr>
        <td><span class="member-link" onclick="viewMember('${t.seller_member_id}')">${t.seller_member_id}</span> <span style="color:var(--text-muted)">${t.seller_name||''}</span></td>
        <td>${t.buyer_name||'—'}</td>
        <td style="font-weight:700">₹${fmtN(t.ticket_price)}</td>
        <td style="font-weight:800;color:var(--accent)">+${t.points_earned}</td>
        <td style="color:var(--text-muted)">${fmtDate(t.sold_at)}</td>
      </tr>`).join('');
    } else {
      tBody.innerHTML = '<tr><td colspan="5" class="empty-state"><p>No tickets sold yet</p></td></tr>';
    }
  } catch(e){ notify('Failed to load activity','error'); }
}

async function activateReferral(referredMemberId){
  const amount = prompt('Enter payment amount for referral activation (default ₹500):','500');
  if(amount === null) return;
  try{
    await AUTH.api('/api/member/activate-referral',{method:'POST',body:{referredMemberId, paymentAmount: parseFloat(amount)||500}});
    notify('Referral activated! Points credited.','success');
    loadPointsActivity();
  } catch(e){ notify(e.message||'Failed','error'); }
}

/* ============================================
   REPORTS & ANALYTICS
   ============================================ */
async function loadReports(){
  try{
    const data = await AUTH.api('/api/admin/overview');
    document.getElementById('rMembers').textContent = data.totalMembers||0;
    document.getElementById('rActive').textContent = data.activeMembers||0;
    document.getElementById('rInactive').textContent = (data.totalMembers||0) - (data.activeMembers||0);
    document.getElementById('rDonations').textContent = '₹' + fmtN(data.totalDonationsINR||0);
    document.getElementById('rCSR').textContent = '₹' + fmtN(data.totalCSR||0);
    document.getElementById('rReferrals').textContent = data.totalReferrals||0;
    document.getElementById('rPoints').textContent = fmtN(data.totalPointsIssued||0);
    document.getElementById('rNewMembers').textContent = data.newMembersThisMonth||0;
    document.getElementById('rMonthDon').textContent = data.donationsThisMonth||0;
    document.getElementById('rMonthTix').textContent = data.ticketsSoldThisMonth||0;
    document.getElementById('rMonthResolved').textContent = data.resolvedThisMonth||0;
  } catch(e){ /* silent */ }
}

/* ============================================
   RESET PASSWORD
   ============================================ */
document.getElementById('rpSubmit').addEventListener('click', async ()=>{
  const memberId = document.getElementById('rpMemberId').value.trim();
  const newPassword = document.getElementById('rpNewPass').value.trim();
  if(!memberId || !newPassword) return notify('Fill all fields','warning');
  try{
    await AUTH.api('/api/admin/reset-password',{method:'POST',body:{memberId, newPassword}});
    notify(`Password reset for ${memberId}!`,'success');
    closeModal('resetPwdModal');
    document.getElementById('rpMemberId').value = '';
    document.getElementById('rpNewPass').value = '';
  } catch(e){ notify(e.message||'Failed','error'); }
});

/* ============================================
   LOGOUT
   ============================================ */
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  if(typeof FWF_Notify !== 'undefined'){
    FWF_Notify.confirm('Logout from admin panel?', async ()=>{
      await AUTH.api('/api/auth/logout',{method:'POST'});
      notify('Logged out','success');
      setTimeout(()=> location.href = '/', 1000);
    });
  } else {
    if(confirm('Logout?')){
      AUTH.api('/api/auth/logout',{method:'POST'}).finally(()=> location.href = '/');
    }
  }
});

/* ============================================
   MARKETPLACE ADMIN
   ============================================ */
let allAdminProducts = [];
let allAdminOrders = [];

async function loadMarketplaceAdmin(){
  try{
    const [prodData, ordData] = await Promise.all([
      AUTH.api('/api/admin/products'),
      AUTH.api('/api/admin/orders')
    ]);
    allAdminProducts = prodData.products || [];
    allAdminOrders = ordData.orders || [];

    // Stats
    if(prodData.stats){
      document.getElementById('mkSellers').textContent = prodData.stats.sellers || 0;
      document.getElementById('mkProducts').textContent = prodData.stats.total || 0;
    }
    if(ordData.stats){
      document.getElementById('mkOrders').textContent = ordData.stats.total || 0;
      document.getElementById('mkRevenue').textContent = '₹' + fmtN(ordData.stats.totalRevenue || 0);
    }
    renderAdminProducts();
    renderAdminOrders();
  } catch(e){
    console.error('Marketplace admin load error:', e);
  }
}

function renderAdminProducts(){
  const filter = document.getElementById('mkProdFilter').value;
  let prods = allAdminProducts;
  if(filter) prods = prods.filter(p => p.status === filter);
  
  const tbody = document.getElementById('mkProductsBody');
  if(!prods.length){
    tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fa-solid fa-box-open"></i><p>No products found</p></td></tr>';
    return;
  }
  const statusColors = {pending:'#f59e0b',approved:'#22c55e',rejected:'#ef4444','out-of-stock':'#6b7280',draft:'#94a3b8',archived:'#6b7280'};
  tbody.innerHTML = prods.map(p => {
    const img = p.thumbnail || (p.images && p.images.length ? p.images[0] : '');
    return `<tr>
      <td><div style="width:45px;height:45px;border-radius:8px;overflow:hidden;background:var(--soft);display:flex;align-items:center;justify-content:center">
        ${img ? `<img src="${img}" style="width:100%;height:100%;object-fit:cover"/>` : '<i class="fa-solid fa-image" style="color:var(--muted)"></i>'}
      </div></td>
      <td><div style="font-weight:700;font-size:12px">${p.title}</div><div style="font-size:10px;color:var(--muted)">${p.product_id}</div></td>
      <td><div style="font-size:12px">${p.seller_name||'—'}</div><div style="font-size:10px;color:var(--muted)">${p.seller_member_id||''}</div></td>
      <td style="font-size:12px">${p.category}${p.subcategory ? '<br><span style="color:var(--muted)">'+p.subcategory+'</span>' : ''}</td>
      <td style="font-weight:700">₹${fmtN(p.price)}${p.mrp && p.mrp > p.price ? '<br><span style="font-size:10px;color:var(--muted);text-decoration:line-through">₹'+fmtN(p.mrp)+'</span>' : ''}</td>
      <td style="text-align:center">${p.stock}</td>
      <td><span style="font-size:11px;font-weight:800;color:${statusColors[p.status]||'#6b7280'};background:${statusColors[p.status]||'#6b7280'}15;padding:3px 10px;border-radius:8px;text-transform:uppercase">${p.status}</span></td>
      <td style="white-space:nowrap">
        ${p.status === 'pending' ? `<button class="btn btn-success btn-sm" onclick="adminProductAction('${p.product_id}','approved')" title="Approve"><i class="fa-solid fa-check"></i></button>
        <button class="btn btn-danger btn-sm" onclick="adminProductAction('${p.product_id}','rejected')" title="Reject"><i class="fa-solid fa-times"></i></button>` : ''}
        ${p.status === 'approved' ? `<button class="btn btn-ghost btn-sm" onclick="adminProductAction('${p.product_id}','rejected')" title="Disable"><i class="fa-solid fa-ban"></i></button>
        <button class="btn btn-ghost btn-sm" onclick="adminToggleFeatured('${p.product_id}',${p.featured?0:1})" title="${p.featured?'Unfeature':'Feature'}"><i class="fa-solid fa-star" style="color:${p.featured?'#f59e0b':'var(--muted)'}"></i></button>` : ''}
        ${p.status === 'rejected' ? `<button class="btn btn-success btn-sm" onclick="adminProductAction('${p.product_id}','approved')" title="Approve"><i class="fa-solid fa-check"></i></button>` : ''}
      </td>
    </tr>`;
  }).join('');
}

async function adminProductAction(productId, status){
  const notes = status === 'rejected' ? prompt('Rejection reason (optional):') : null;
  try{
    await AUTH.api('/api/admin/product/' + productId, {
      method: 'POST',
      body: { status, adminNotes: notes || undefined }
    });
    notify(`Product ${status}!`, 'success');
    loadMarketplaceAdmin();
  } catch(e){ notify(e.message||'Failed','error'); }
}

async function adminToggleFeatured(productId, featured){
  try{
    await AUTH.api('/api/admin/product/' + productId, { method:'POST', body:{ featured } });
    notify(featured ? 'Product featured!' : 'Feature removed', 'success');
    loadMarketplaceAdmin();
  } catch(e){ notify(e.message||'Failed','error'); }
}

function renderAdminOrders(){
  const tbody = document.getElementById('mkOrdersBody');
  if(!allAdminOrders.length){
    tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><i class="fa-solid fa-shopping-cart"></i><p>No orders yet</p></td></tr>';
    return;
  }
  tbody.innerHTML = allAdminOrders.map(o => `<tr>
    <td style="font-weight:700;color:var(--accent);font-size:12px">${o.order_id}</td>
    <td style="font-size:12px">${o.product_title||o.product_id}</td>
    <td style="font-size:12px">${o.buyer_name||'—'}<br><span style="color:var(--muted)">${o.buyer_contact||''}</span></td>
    <td style="font-size:12px">${o.seller_member_id||'—'}</td>
    <td style="text-align:center">${o.quantity}</td>
    <td style="font-weight:700">₹${fmtN(o.total_amount)}</td>
    <td style="font-size:11px">${o.payment_mode||'—'}</td>
    <td>${statusBadge(o.status)}</td>
    <td style="color:var(--muted);font-size:12px">${fmtDate(o.created_at)}</td>
    <td><select class="form-input" style="padding:4px 8px;font-size:11px;min-width:100px" onchange="updateOrderStatus('${o.order_id}',this.value)">
      <option value="pending" ${o.status==='pending'?'selected':''}>Pending</option>
      <option value="confirmed" ${o.status==='confirmed'?'selected':''}>Confirmed</option>
      <option value="processing" ${o.status==='processing'?'selected':''}>Processing</option>
      <option value="shipped" ${o.status==='shipped'?'selected':''}>Shipped</option>
      <option value="delivered" ${o.status==='delivered'?'selected':''}>Delivered</option>
      <option value="cancelled" ${o.status==='cancelled'?'selected':''}>Cancelled</option>
      <option value="refunded" ${o.status==='refunded'?'selected':''}>Refunded</option>
    </select></td>
  </tr>`).join('');
}

async function updateOrderStatus(orderId, status){
  try{
    await AUTH.api('/api/admin/order/' + orderId, { method:'POST', body:{ status } });
    notify('Order status updated!','success');
  } catch(e){ notify(e.message||'Failed','error'); }
}

/* ============================================
   PROJECT COST EDITOR
   ============================================ */

const UNIT_DEFAULTS = {
  "suraksha": [
    { name:"MediSan Liquids Unit",       machineryTotal:"₹3,80,000", setupTotal:"₹1,50,000", workingTotal:"₹3,60,000", fundingTotal:"₹8,90,000", beneficiaryAmt:"₹4,45,000", emiAmount:"₹3,708", profit:"₹30,000–50,000/mo" },
    { name:"FreshWipe Converting Unit",  machineryTotal:"₹4,62,000", setupTotal:"₹1,58,000", workingTotal:"₹2,60,000", fundingTotal:"₹8,80,000", beneficiaryAmt:"₹4,40,000", emiAmount:"₹3,667", profit:"₹40,000–65,000/mo" },
    { name:"MedBand Manufacturing Unit", machineryTotal:"₹4,56,000", setupTotal:"₹1,14,000", workingTotal:"₹1,70,000", fundingTotal:"₹7,40,000", beneficiaryAmt:"₹3,70,000", emiAmount:"₹3,083", profit:"₹25,000–40,000/mo" },
    { name:"SteriGauze Pack Unit",        machineryTotal:"₹3,67,000", setupTotal:"₹1,27,000", workingTotal:"₹1,76,000", fundingTotal:"₹6,70,000", beneficiaryAmt:"₹3,35,000", emiAmount:"₹2,792", profit:"₹22,000–35,000/mo" },
    { name:"PPE Lite Pack Unit",          machineryTotal:"₹4,56,000", setupTotal:"₹1,33,000", workingTotal:"₹1,86,000", fundingTotal:"₹7,75,000", beneficiaryAmt:"₹3,87,500", emiAmount:"₹3,229", profit:"₹25,000–38,000/mo" },
    { name:"FirstAid & ClinicKit Unit",   machineryTotal:"₹2,78,000", setupTotal:"₹1,48,000", workingTotal:"₹1,90,000", fundingTotal:"₹6,16,000", beneficiaryAmt:"₹3,08,000", emiAmount:"₹2,567", profit:"₹22,000–35,000/mo" },
    { name:"VectorGuard Repellent Unit",  machineryTotal:"₹5,95,000", setupTotal:"₹1,77,000", workingTotal:"₹2,90,000", fundingTotal:"₹10,62,000",beneficiaryAmt:"₹5,31,000", emiAmount:"₹4,425", profit:"₹35,000–55,000/mo" },
    { name:"HomeShield Net & Mesh Unit",  machineryTotal:"₹3,38,000", setupTotal:"₹1,33,000", workingTotal:"₹2,10,000", fundingTotal:"₹6,81,000", beneficiaryAmt:"₹3,40,500", emiAmount:"₹2,838", profit:"₹28,000–45,000/mo" },
    { name:"Antiseptic Liquid Unit",      machineryTotal:"₹1,90,000", setupTotal:"₹1,40,000", workingTotal:"₹3,60,000", fundingTotal:"₹6,90,000", beneficiaryAmt:"₹3,45,000", emiAmount:"₹2,875", profit:"₹25,000–40,000/mo" }
  ]
};

const COST_FIELDS = [
  { key:'machineryTotal', label:'Machinery Total' },
  { key:'setupTotal',     label:'Setup Costs Total' },
  { key:'workingTotal',   label:'Working Capital (2 mo)' },
  { key:'fundingTotal',   label:'Total Project Cost' },
  { key:'beneficiaryAmt',label:'Beneficiary Amount (50%)' },
  { key:'emiAmount',      label:'Monthly EMI' },
  { key:'profit',         label:'Profit Range' }
];

// ═══════════════════════════════════════════
// FUND RAISER / QUIZ MANAGEMENT — Extended
// ═══════════════════════════════════════════
let frAllQuizzesCache = [];
let pCurrentQuizId = '';
let pCurrentPage = 1;
let pParticipantsCache = [];

/* ---------- TABS ---------- */
function switchFRTab(tab) {
  ['overview','quizzes','results','demo'].forEach(t => {
    document.getElementById(`frSection-${t}`).style.display = t === tab ? '' : 'none';
    const btn = document.getElementById(`frTab-${t}`);
    if(t === tab){
      btn.style.borderBottom = t === 'demo' ? '3px solid #f59e0b' : '3px solid #3b82f6';
      btn.style.color = t === 'demo' ? '#f59e0b' : '#3b82f6';
      btn.style.fontWeight = '700';
    } else {
      btn.style.borderBottom = '3px solid transparent';
      btn.style.color = '#64748b';
      btn.style.fontWeight = '600';
    }
  });
  if(tab === 'quizzes') loadAllQuizzesList();
  if(tab === 'results') loadResultsHistory();
}

/* ---------- HELPER BADGES ---------- */
function frTypeBadge(type) {
  const map = { monthly:'#3b82f6', half_yearly:'#8b5cf6', yearly:'#f59e0b' };
  const lbl = { monthly:'Monthly', half_yearly:'Half-Yearly', yearly:'Annual' };
  const c = map[type] || '#64748b';
  return `<span style="background:${c}22;color:${c};padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700;border:1px solid ${c}44">${lbl[type]||type}</span>`;
}
function frStatusBadge(s) {
  const map = { active:['#dcfce7','#166534'], upcoming:['#dbeafe','#1e40af'], closed:['#fef3c7','#92400e'], result_declared:['#d1fae5','#065f46'] };
  const [bg,c] = map[s] || ['#f1f5f9','#475569'];
  return `<span style="background:${bg};color:${c};padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700">${s.replace('_',' ').toUpperCase()}</span>`;
}
function fmtDt(d){ return d ? new Date(d).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '—'; }
function fmtDate(d){ return d ? new Date(d).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}) : '—'; }

/* ---------- MAIN LOAD ---------- */
async function loadFundRaiser(){
  try {
    const data = await AUTH.api('/api/admin/quiz-scheduler-status');
    if(!data.ok) throw new Error(data.error || 'Failed');
    document.getElementById('frStatActive').textContent      = data.summary.active;
    document.getElementById('frStatPending').textContent     = data.summary.pendingDraw;
    document.getElementById('frStatDeclared').textContent    = data.summary.recentDrawn;
    const totalP = data.activeQuizzes.reduce((s,q)=>s+(q.total_participants||0),0);
    document.getElementById('frStatParticipants').textContent = totalP;
    document.getElementById('frLastRefresh').textContent = 'Updated: ' + new Date(data.serverTime).toLocaleTimeString('en-IN');

    // Active quizzes table
    const ab = document.getElementById('frActiveBody');
    ab.innerHTML = data.activeQuizzes.length === 0
      ? '<tr><td colspan="11" class="empty-state"><p>No active quizzes</p></td></tr>'
      : data.activeQuizzes.map(q => `<tr>
          <td style="font-family:monospace;font-weight:700;font-size:11px">${q.quiz_id}</td>
          <td style="font-weight:600">${q.title}</td>
          <td>${frTypeBadge(q.type)}</td>
          <td style="font-weight:700">₹${q.entry_fee}</td>
          <td style="font-weight:800;color:#166534">₹${(q.prizes?.first||0).toLocaleString('en-IN')}</td>
          <td style="font-size:12px">${fmtDate(q.end_date)}</td>
          <td style="font-size:12px">${fmtDate(q.result_date)}</td>
          <td style="font-weight:700;color:#6366f1">${q.total_participants||0}</td>
          <td style="font-weight:700">₹${(q.total_collection||0).toLocaleString('en-IN')}</td>
          <td>${frStatusBadge(q.status)}</td>
          <td style="white-space:nowrap">
            <button onclick="openQuizDetail('${q.quiz_id}')" style="background:#dbeafe;color:#1e40af;border:none;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;margin-right:4px">📋 Detail</button>
            <button onclick="openParticipants('${q.quiz_id}')" style="background:#ede9fe;color:#6d28d9;border:none;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">👥 Members</button>
          </td>
        </tr>`).join('');

    // Pending draw table
    const pb = document.getElementById('frPendingBody');
    pb.innerHTML = data.pendingDraw.length === 0
      ? '<tr><td colspan="7" class="empty-state"><p>No pending draws</p></td></tr>'
      : data.pendingDraw.map(q => `<tr>
          <td style="font-family:monospace;font-weight:700;font-size:11px">${q.quiz_id}</td>
          <td>${q.title}</td>
          <td>${frTypeBadge(q.type)}</td>
          <td style="font-weight:700;color:#6366f1">${q.total_participants||0}</td>
          <td style="font-weight:700">₹${(q.total_collection||0).toLocaleString('en-IN')}</td>
          <td style="color:#ef4444;font-weight:700">${fmtDt(q.result_date)}</td>
          <td style="white-space:nowrap">
            <button onclick="openParticipants('${q.quiz_id}')" style="background:#ede9fe;color:#6d28d9;border:none;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;margin-right:4px">👥 Members</button>
            <button onclick="manualDraw('${q.quiz_id}')" style="background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:#fff;padding:5px 12px;border-radius:6px;font-weight:700;cursor:pointer;font-size:11px">🎲 Draw Now</button>
          </td>
        </tr>`).join('');
  } catch(err){
    console.error('Fund Raiser load error:', err);
  }
}

/* ---------- ALL QUIZZES LIST ---------- */
async function loadAllQuizzesList(){
  document.getElementById('frAllQuizzesBody').innerHTML = '<tr><td colspan="12" class="empty-state"><p>Loading...</p></td></tr>';
  try {
    const data = await AUTH.api('/api/admin/quizzes');
    if(!data.ok) throw new Error(data.error);
    frAllQuizzesCache = data.quizzes || [];
    filterAllQuizzes();
  } catch(err){
    document.getElementById('frAllQuizzesBody').innerHTML = `<tr><td colspan="12" class="empty-state"><p style="color:#ef4444">Error: ${err.message}</p></td></tr>`;
  }
}

function filterAllQuizzes(){
  const s = (document.getElementById('frQuizSearch')?.value||'').toLowerCase();
  const t = document.getElementById('frQuizFilterType')?.value || '';
  const st = document.getElementById('frQuizFilterStatus')?.value || '';
  let list = frAllQuizzesCache.filter(q =>
    (!s || q.quiz_id.toLowerCase().includes(s) || q.title.toLowerCase().includes(s)) &&
    (!t || q.type === t) &&
    (!st || q.status === st)
  );
  document.getElementById('frQuizCount').textContent = `${list.length} quiz${list.length!==1?'es':''}`;
  document.getElementById('frAllQuizzesBody').innerHTML = list.length === 0
    ? '<tr><td colspan="12" class="empty-state"><p>No quizzes found</p></td></tr>'
    : list.map(q => `<tr>
        <td style="font-family:monospace;font-weight:700;font-size:11px">${q.quiz_id}</td>
        <td style="font-weight:600;max-width:180px;word-break:break-word">${q.title}</td>
        <td>${frTypeBadge(q.type)}</td>
        <td>${frStatusBadge(q.status)}</td>
        <td>₹${q.entry_fee||0}</td>
        <td style="font-size:11px;line-height:1.6">🥇₹${(q.prizes?.first||0).toLocaleString('en-IN')}<br>🥈₹${(q.prizes?.second||0).toLocaleString('en-IN')}<br>🥉₹${(q.prizes?.third||0).toLocaleString('en-IN')}</td>
        <td style="font-size:11px">${fmtDate(q.start_date)}</td>
        <td style="font-size:11px">${fmtDate(q.end_date)}</td>
        <td style="font-size:11px">${fmtDate(q.result_date)}</td>
        <td style="font-weight:700;color:#6366f1">${q.total_participants||0}</td>
        <td style="font-weight:700">₹${(q.total_collection||0).toLocaleString('en-IN')}</td>
        <td style="white-space:nowrap">
          <button onclick="openQuizDetail('${q.quiz_id}')" style="background:#dbeafe;color:#1e40af;border:none;padding:4px 9px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;margin-right:3px">📋</button>
          <button onclick="openParticipants('${q.quiz_id}')" style="background:#ede9fe;color:#6d28d9;border:none;padding:4px 9px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;margin-right:3px">👥</button>
          ${q.status === 'closed' || (q.status === 'active' && new Date(q.result_date) < new Date()) ? `<button onclick="manualDraw('${q.quiz_id}')" style="background:#fef3c7;color:#92400e;border:none;padding:4px 9px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">🎲</button>` : ''}
        </td>
      </tr>`).join('');
}

/* ---------- RESULTS HISTORY ---------- */
async function loadResultsHistory(){
  document.getElementById('frResultsBody').innerHTML = '<tr><td colspan="9" class="empty-state"><p>Loading...</p></td></tr>';
  try {
    const data = await AUTH.api('/api/admin/quiz-scheduler-status');
    if(!data.ok) throw new Error(data.error);
    const results = data.recentResults || [];
    if(results.length === 0){
      document.getElementById('frResultsBody').innerHTML = '<tr><td colspan="9" class="empty-state"><p>No results declared yet</p></td></tr>';
      return;
    }
    document.getElementById('frResultsBody').innerHTML = results.map(q => {
      const w = q.winners || [];
      const paid = (w.reduce((s,ww)=>s+(ww.prize_amount||0),0)).toLocaleString('en-IN');
      const wHtml = (rank, cls) => {
        const ww = w[rank-1];
        return ww ? `<span style="font-weight:700${cls ? ';color:'+cls : ''}">${ww.name}</span><br><small style="color:#64748b">Score:${ww.score} • ₹${(ww.prize_amount||0).toLocaleString('en-IN')}</small>` : '—';
      };
      return `<tr>
        <td style="font-family:monospace;font-weight:700;font-size:11px">${q.quiz_id}</td>
        <td style="font-weight:600">${q.title}</td>
        <td>${frTypeBadge(q.type)}</td>
        <td style="font-size:12px">${fmtDate(q.result_date)}</td>
        <td>${wHtml(1,'#166534')}</td>
        <td>${wHtml(2,'#1e40af')}</td>
        <td>${wHtml(3,'#92400e')}</td>
        <td style="font-weight:700;color:#166534">₹${paid}</td>
        <td><button onclick="openParticipants('${q.quiz_id}')" style="background:#ede9fe;color:#6d28d9;border:none;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer">👥 Members</button></td>
      </tr>`;
    }).join('');
  } catch(err){
    document.getElementById('frResultsBody').innerHTML = `<tr><td colspan="9" class="empty-state"><p style="color:#ef4444">Error: ${err.message}</p></td></tr>`;
  }
}

/* ---------- QUIZ DETAIL MODAL ---------- */
async function openQuizDetail(quizId){
  document.getElementById('modalQuizDetail').style.display = '';
  document.getElementById('qdTitle').textContent = 'Loading...';
  document.getElementById('qdSubtitle').textContent = '';
  document.getElementById('qdBody').innerHTML = '<div style="text-align:center;padding:40px;color:#64748b"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><p>Loading quiz details...</p></div>';
  try {
    const data = await AUTH.api(`/api/admin/quiz/${quizId}/detail`);
    if(!data.ok) throw new Error(data.error);
    const q = data.quiz;
    const s = data.stats;
    document.getElementById('qdTitle').textContent = q.title;
    document.getElementById('qdSubtitle').textContent = `${q.quiz_id} • ${q.type} • ${q.status?.toUpperCase()}`;
    document.getElementById('qdBody').innerHTML = `
      <!-- Info Grid -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px">
        ${[
          ['Fee',`₹${q.entry_fee||0}`,'#3b82f6'],
          ['🥇 Prize',`₹${(q.prizes?.first||0).toLocaleString('en-IN')}`,'#22c55e'],
          ['Enrolled',s.participantCount,'#6366f1'],
          ['Paid',s.paidCount,'#f59e0b'],
          ['Submitted',s.submittedCount,'#0ea5e9'],
          ['Avg Score',s.avgScore,'#8b5cf6'],
          ['Collection',`₹${(q.total_collection||0).toLocaleString('en-IN')}`,'#ec4899'],
          ['Status',q.status?.replace('_',' '),'#64748b']
        ].map(([l,v,c])=>`<div style="background:#f8fafc;border-radius:10px;padding:14px;text-align:center;border:1px solid #e2e8f0">
          <div style="font-size:11px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:.5px">${l}</div>
          <div style="font-size:18px;font-weight:800;color:${c};margin-top:4px">${v}</div>
        </div>`).join('')}
      </div>
      <!-- Dates -->
      <div style="background:#f8fafc;border-radius:10px;padding:14px;margin-bottom:20px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
        <div><div style="font-size:11px;color:#64748b;font-weight:600">START DATE</div><div style="font-weight:700;font-size:13px">${fmtDt(q.start_date)}</div></div>
        <div><div style="font-size:11px;color:#64748b;font-weight:600">END DATE</div><div style="font-weight:700;font-size:13px">${fmtDt(q.end_date)}</div></div>
        <div><div style="font-size:11px;color:#64748b;font-weight:600">RESULT DATE</div><div style="font-weight:700;font-size:13px;color:#ef4444">${fmtDt(q.result_date)}</div></div>
      </div>
      <!-- Winners -->
      ${q.winners?.length ? `<div style="margin-bottom:20px">
        <h4 style="margin:0 0 12px;font-size:14px;color:#166534"><i class="fa-solid fa-trophy"></i> Winners</h4>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
          ${q.winners.map(w=>`<div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px">
            <div style="font-weight:800;font-size:13px">#${w.rank} ${w.name}</div>
            <div style="font-size:11px;color:#64748b">${w.member_id||''}</div>
            <div style="font-size:12px;color:#166534;font-weight:700;margin-top:4px">₹${(w.prize_amount||0).toLocaleString('en-IN')} • Score: ${w.score}</div>
          </div>`).join('')}
        </div>
      </div>` : ''}
      <!-- Questions -->
      <h4 style="margin:0 0 12px;font-size:14px"><i class="fa-solid fa-question-circle" style="color:#3b82f6"></i> Questions (${(q.questions||[]).length})</h4>
      ${(s.questionStats||[]).map((qs,i)=>{
        const total = qs.distribution.reduce((a,b)=>a+b,0)||1;
        return `<div style="background:#f8fafc;border-radius:10px;padding:14px;margin-bottom:10px;border:1px solid #e2e8f0">
          <div style="font-weight:700;font-size:13px;margin-bottom:10px">Q${i+1}. ${qs.question}</div>
          <div style="display:grid;gap:6px">
            ${(qs.options||[]).map((opt,j)=>`
              <div style="display:flex;align-items:center;gap:8px">
                <div style="flex:1;background:${j===qs.correct_answer?'#dcfce7':'#f1f5f9'};border:1px solid ${j===qs.correct_answer?'#4ade80':'#e2e8f0'};border-radius:6px;padding:6px 10px;font-size:12px;display:flex;justify-content:space-between">
                  <span>${j===qs.correct_answer?'✅ ':''}${opt}</span>
                  <span style="font-weight:700;color:#64748b">${qs.distribution[j]||0} (${Math.round((qs.distribution[j]||0)/total*100)}%)</span>
                </div>
                <div style="width:80px;background:#e2e8f0;border-radius:4px;height:8px;overflow:hidden"><div style="height:100%;background:${j===qs.correct_answer?'#22c55e':'#94a3b8'};width:${Math.round((qs.distribution[j]||0)/total*100)}%"></div></div>
              </div>`).join('')}
          </div>
        </div>`;
      }).join('')||'<p style="color:#94a3b8;font-size:13px">No questions data</p>'}
      <div style="text-align:right;margin-top:16px">
        <button onclick="openParticipants('${quizId}')" style="background:linear-gradient(135deg,#4f46e5,#7c3aed);border:none;color:#fff;padding:10px 20px;border-radius:10px;font-weight:700;cursor:pointer;margin-right:8px">👥 View All Participants</button>
        <button onclick="closeQuizDetail()" style="background:#f1f5f9;border:1px solid #e2e8f0;color:#475569;padding:10px 18px;border-radius:10px;font-weight:600;cursor:pointer">Close</button>
      </div>`;
  } catch(err){
    document.getElementById('qdBody').innerHTML = `<p style="color:#ef4444">${err.message}</p>`;
  }
}
function closeQuizDetail(){ document.getElementById('modalQuizDetail').style.display = 'none'; }

/* ---------- PARTICIPANTS MODAL ---------- */
async function openParticipants(quizId, page=1){
  pCurrentQuizId = quizId;
  pCurrentPage = page;
  document.getElementById('modalParticipants').style.display = '';
  document.getElementById('pModalTitle').textContent = 'Participants — ' + quizId;
  document.getElementById('pModalSubtitle').textContent = 'Loading...';
  document.getElementById('pModalBody').innerHTML = '<tr><td colspan="9" class="empty-state"><p><i class="fa-solid fa-spinner fa-spin"></i> Loading...</p></td></tr>';
  document.getElementById('pModalStats').innerHTML = '';
  await loadParticipantsPage(quizId, page);
}

async function loadParticipantsPage(quizId, page=1){
  const search = document.getElementById('pSearch')?.value || '';
  const status = document.getElementById('pFilterStatus')?.value || '';
  try {
    const qs = new URLSearchParams({ page, limit: 50, search, status });
    const data = await AUTH.api(`/api/admin/quiz/${quizId}/participants?${qs}`);
    if(!data.ok) throw new Error(data.error);
    pParticipantsCache = data.participants || [];
    
    document.getElementById('pModalTitle').textContent = data.quiz.title;
    document.getElementById('pModalSubtitle').textContent = `${data.quiz.quiz_id} • ${data.quiz.type} • Entry: ₹${data.quiz.entry_fee}`;

    // Stats bar
    document.getElementById('pModalStats').innerHTML = [
      ['Total Enrolled', data.stats.total, '#6366f1'],
      ['Total Collection', '₹'+(data.stats.totalCollection||0).toLocaleString('en-IN'), '#22c55e'],
      ['Submitted Quiz', data.stats.submittedCount, '#0ea5e9'],
      ['Avg Score', data.stats.avgScore, '#f59e0b']
    ].map(([l,v,c])=>`<div style="padding:14px 20px;text-align:center;border-right:1px solid #e2e8f0">
      <div style="font-size:11px;color:#64748b;font-weight:600;text-transform:uppercase">${l}</div>
      <div style="font-size:20px;font-weight:800;color:${c};margin-top:4px">${v}</div>
    </div>`).join('');

    // Table
    const ps = data.participants;
    if(ps.length === 0){
      document.getElementById('pModalBody').innerHTML = '<tr><td colspan="9" class="empty-state"><p>No participants found</p></td></tr>';
    } else {
      const offset = (page-1)*50;
      document.getElementById('pModalBody').innerHTML = ps.map((p,i)=>{
        const payBadge = p.payment_status === 'paid'
          ? '<span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700">PAID</span>'
          : '<span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700">'+(p.payment_status||'pending').toUpperCase()+'</span>';
        const stBadge = p.status === 'won'
          ? '<span style="background:#d1fae5;color:#065f46;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700">🏆 WON</span>'
          : p.quiz_submitted
            ? '<span style="background:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700">✅ SUBMITTED</span>'
            : '<span style="background:#f1f5f9;color:#64748b;padding:2px 8px;border-radius:6px;font-size:10px;font-weight:700">ENROLLED</span>';
        return `<tr>
          <td style="color:#94a3b8">${offset+i+1}</td>
          <td style="font-weight:700">${p.name||'—'}</td>
          <td style="font-family:monospace;font-size:11px">${p.member_id||'—'}</td>
          <td style="font-family:monospace;font-size:11px;word-break:break-word">${p.enrollment_number||'—'}</td>
          <td>${payBadge}${p.amount_paid?' <small style="color:#64748b">₹'+p.amount_paid+'</small>':''}</td>
          <td>${stBadge}</td>
          <td style="font-weight:700;text-align:center;color:${p.score>0?'#1e40af':'#94a3b8'}">${p.score||0}</td>
          <td style="font-size:11px;color:#64748b">${p.submitted_at ? new Date(p.submitted_at).toLocaleString('en-IN') : '—'}</td>
          <td style="font-size:11px;color:#64748b">${p.created_at ? new Date(p.created_at).toLocaleDateString('en-IN') : '—'}</td>
        </tr>`;
      }).join('');
    }

    // Pagination
    const pg = data.pagination;
    let paginHtml = '';
    for(let i=1; i<=pg.pages; i++){
      paginHtml += `<button onclick="loadParticipantsPage('${quizId}',${i})" style="padding:6px 12px;border-radius:6px;border:1px solid #e2e8f0;font-weight:${i===pg.page?800:600};background:${i===pg.page?'#6366f1':'#fff'};color:${i===pg.page?'#fff':'#475569'};cursor:pointer">${i}</button>`;
    }
    document.getElementById('pModalPagination').innerHTML = paginHtml;
  } catch(err){
    document.getElementById('pModalBody').innerHTML = `<tr><td colspan="9" class="empty-state"><p style="color:#ef4444">Error: ${err.message}</p></td></tr>`;
  }
}

function searchParticipants(){ loadParticipantsPage(pCurrentQuizId, 1); }
function closeParticipantsModal(){ document.getElementById('modalParticipants').style.display = 'none'; pCurrentQuizId=''; }

function exportParticipantsCSV(){
  if(!pParticipantsCache.length){ alert('No data to export'); return; }
  const rows = [['#','Name','Member ID','Enrollment','Payment Status','Amount','Status','Score','Submitted At','Enrolled On']];
  pParticipantsCache.forEach((p,i)=>{
    rows.push([i+1, p.name||'', p.member_id||'', p.enrollment_number||'', p.payment_status||'', p.amount_paid||0, p.status||'', p.score||0,
      p.submitted_at ? new Date(p.submitted_at).toLocaleString() : '', p.created_at ? new Date(p.created_at).toLocaleString() : '']);
  });
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download = `participants_${pCurrentQuizId}_${Date.now()}.csv`; a.click();
}

async function triggerAutoCreate(){
  if(!confirm('Auto-create quizzes for current period?')) return;
  try {
    const data = await AUTH.api('/api/admin/quiz-auto-create', { method: 'POST' });
    if(!data.ok) throw new Error(data.error || 'Failed');
    alert('✅ ' + (data.message||'Done'));
    loadFundRaiser();
  } catch(err){ alert('❌ Error: ' + err.message); }
}

async function triggerAutoDraw(){
  if(!confirm('Run auto-draw for all quizzes past result date?')) return;
  try {
    const data = await AUTH.api('/api/admin/quiz-auto-draw', { method: 'POST' });
    if(!data.ok) throw new Error(data.error || 'Failed');
    alert('✅ ' + (data.message||'Done'));
    loadFundRaiser();
  } catch(err){ alert('❌ Error: ' + err.message); }
}

async function manualDraw(quizId){
  if(!confirm('Draw results for quiz ' + quizId + '?')) return;
  try {
    const data = await AUTH.api('/api/admin/quiz-draw/' + quizId, { method: 'POST' });
    if(!data.ok) throw new Error(data.error || 'Failed');
    alert('✅ Result declared for ' + quizId);
    loadFundRaiser();
  } catch(err){ alert('❌ Error: ' + err.message); }
}

/* ---------- DEMO MODE ---------- */
let demoRefreshTimer = null;

function updateDemoTimingInfo(){
  const radios = document.querySelectorAll('input[name="demoDuration"]');
  let val = '0';
  radios.forEach(r => { if(r.checked) val = r.value; });
  const custInp = document.getElementById('customDemoInput');
  custInp.style.display = val === 'custom' ? '' : 'none';
  let minsM, minsH, minsY, resGap;
  if(val === '0'){ minsM=30; minsH=60; minsY=90; resGap=5; }
  else if(val === '24'){ minsM=24*60; minsH=26*60; minsY=28*60; resGap=60; }
  else {
    const h = Number(document.getElementById('customDemoHours')?.value||24);
    minsM=h*60; minsH=(h+2)*60; minsY=(h+4)*60; resGap=60;
  }
  const fmt = m => m >= 60 ? `${m/60}h` : `${m}min`;
  document.getElementById('demoTimingInfo').innerHTML =
    `📅 <b>Monthly:</b> Ends in <b>${fmt(minsM)}</b> • Result <b>${fmt(minsM+resGap)}</b> after start<br>` +
    `📅 <b>Half-Yearly:</b> Ends in <b>${fmt(minsH)}</b> • Result <b>${fmt(minsH+resGap)}</b> after start<br>` +
    `📅 <b>Annual:</b> Ends in <b>${fmt(minsY)}</b> • Result <b>${fmt(minsY+resGap)}</b> after start<br>` +
    `⚡ Scheduler checks every <b>${val==='0'?'1 min':'5 min'}</b>`;
}

function demoLog(msg){
  const log = document.getElementById('demoLog');
  if(!log) return;
  const t = new Date().toLocaleTimeString('en-IN');
  log.innerHTML = `<div>[${t}] ${msg}</div>` + log.innerHTML;
}

function buildDemoCard(q){
  const colors = { monthly:'#3b82f6', half_yearly:'#8b5cf6', yearly:'#f59e0b' };
  const labels = { monthly:'Monthly', half_yearly:'Half-Yearly', yearly:'Annual' };
  const c = colors[q.type] || '#64748b';
  let statusHtml = '';
  if(q.status === 'result_declared'){
    const ws = (q.winners||[]).map(w => `<div style="font-size:11px;color:#fbbf24">🏆 #${w.rank} ${w.name} — ₹${w.prize.toLocaleString('en-IN')}</div>`).join('');
    statusHtml = `<div style="background:#166534;color:#4ade80;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:700;margin-top:6px">✅ RESULT DECLARED</div>${ws}`;
  } else if(q.ends_in === 'ENDED'){
    statusHtml = `<div style="background:#78350f;color:#fbbf24;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:700;margin-top:6px">⏳ ${q.result_in}</div>`;
  } else {
    statusHtml = `<div style="background:rgba(255,255,255,.1);color:#e2e8f0;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:600;margin-top:6px">⏱️ Ends ${q.ends_in} • Result ${q.result_in}</div>`;
  }
  return `<div style="background:linear-gradient(135deg,${c}22,${c}11);border:1px solid ${c}55;border-radius:12px;padding:14px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <span style="color:${c};font-weight:800;font-size:13px">${labels[q.type]||q.type}</span>
      <span style="background:${c};color:#fff;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700">${q.status?.toUpperCase()}</span>
    </div>
    <div style="color:#cbd5e1;font-size:11px">${q.participants} participants • ₹${q.collection.toLocaleString('en-IN')} collected</div>
    ${statusHtml}
    <button onclick="openParticipants('${q.quiz_id}')" style="margin-top:8px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);color:#e2e8f0;padding:4px 12px;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;width:100%">👥 View Participants</button>
  </div>`;
}

async function refreshDemoStatus(){
  try {
    const data = await AUTH.api('/api/admin/quiz-demo-status');
    if(!data.ok) throw new Error(data.error);
    const grid = document.getElementById('demoCardsGrid');
    if(data.quizzes.length === 0){ setDemoUI(false); return; }
    grid.innerHTML = data.quizzes.map(q => buildDemoCard(q)).join('');
    const allDone = data.quizzes.every(q => q.status === 'result_declared');
    if(allDone){ demoLog('🎉 All demo quizzes completed!'); setDemoUI(false); }
    if(data.demoRunning) document.getElementById('demoStatusBadge').textContent = 'RUNNING';
    else if(allDone) document.getElementById('demoStatusBadge').textContent = 'COMPLETED';
    loadFundRaiser();
  } catch(err){ demoLog('❌ ' + err.message); }
}

function setDemoUI(running){
  document.getElementById('btnDemoStart').style.display  = running ? 'none' : '';
  document.getElementById('btnDemoStop').style.display   = running ? '' : 'none';
  document.getElementById('btnDemoRefresh').style.display= running ? '' : 'none';
  document.getElementById('demoStatusBadge').style.display = running ? '' : 'none';
  document.getElementById('demoTracker').style.display   = running ? '' : 'none';
  if(running && !demoRefreshTimer){
    demoRefreshTimer = setInterval(refreshDemoStatus, 15000);
  }
  if(!running && demoRefreshTimer){ clearInterval(demoRefreshTimer); demoRefreshTimer = null; }
}

async function startDemo(){
  const radios = document.querySelectorAll('input[name="demoDuration"]');
  let demoVal = '0';
  radios.forEach(r => { if(r.checked) demoVal = r.value; });
  let demoHours = 0;
  if(demoVal === '24') demoHours = 24;
  else if(demoVal === 'custom') demoHours = Number(document.getElementById('customDemoHours')?.value||24);
  const fakeCount = document.getElementById('demoFakeCount')?.value || 15;
  const durLabel = demoHours === 0 ? 'Quick (30/60/90 min)' : demoHours + ' hours';
  if(!confirm(`Start Fund Raiser Demo?\n\nDuration: ${durLabel}\nFake participants: ~${fakeCount} per quiz\n\nAll demo data will be labelled DEMO-*`)) return;
  document.getElementById('btnDemoStart').disabled = true;
  document.getElementById('btnDemoStart').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Starting...';
  document.getElementById('demoLog').innerHTML = '';
  try {
    const data = await AUTH.api('/api/admin/quiz-demo-start', { method:'POST', body: JSON.stringify({ demoHours, fakeCount: Number(fakeCount) }) });
    if(!data.ok) throw new Error(data.error);
    demoLog(`✅ Demo started! ${data.totalParticipants} participants added.`);
    data.quizzes.forEach(q => demoLog(`📋 ${q.type}: ends in ${q.ends_in}, result in ${q.result_in} (${q.participants} participants)`));
    setDemoUI(true);
    refreshDemoStatus();
    switchFRTab('overview'); // show overview after start
    setTimeout(()=>switchFRTab('demo'),100);
  } catch(err){
    alert('❌ Error: ' + err.message);
    demoLog('❌ Failed: ' + err.message);
  } finally {
    document.getElementById('btnDemoStart').disabled = false;
    document.getElementById('btnDemoStart').innerHTML = '<i class="fa-solid fa-play"></i> Start Demo';
  }
}

async function stopDemo(){
  if(!confirm('Stop demo and delete all demo quizzes & participants?')) return;
  try {
    const data = await AUTH.api('/api/admin/quiz-demo-stop', { method:'POST' });
    if(!data.ok) throw new Error(data.error);
    demoLog(`🛑 Stopped. Deleted ${data.deleted.quizzes} quizzes, ${data.deleted.participations} participations.`);
    setDemoUI(false);
    document.getElementById('demoCardsGrid').innerHTML = '';
    loadFundRaiser();
  } catch(err){ alert('❌ Error: ' + err.message); }
}

async function checkDemoOnLoad(){
  try {
    const data = await AUTH.api('/api/admin/quiz-demo-status');
    if(data.ok && data.quizzes.length > 0){
      const allDone = data.quizzes.every(q => q.status === 'result_declared');
      if(data.demoRunning || !allDone){ setDemoUI(true); refreshDemoStatus(); }
    }
  } catch(e){}
  updateDemoTimingInfo();
}

// ═══════════════════════════════════════════
// PROJECT COST EDITOR
// ═══════════════════════════════════════════
function renderCostEditor() {
  const projectKey = document.getElementById('costProjectSelect').value;
  const grid = document.getElementById('costEditorGrid');
  const units = UNIT_DEFAULTS[projectKey];

  if (!units) {
    grid.innerHTML = `<div class="content-card" style="grid-column:1/-1"><p style="color:var(--text-muted);text-align:center;padding:24px">Default unit data not available for this project. You can still save overrides if you know the unit names.</p></div>`;
    return;
  }

  const overrides = JSON.parse(localStorage.getItem('fwf_cost_overrides') || '{}');
  const projOverrides = overrides[projectKey] || {};

  grid.innerHTML = units.map(unit => {
    const ov = projOverrides[unit.name] || {};
    const hasOverride = Object.keys(ov).length > 0;
    const fieldsHTML = COST_FIELDS.map(f => {
      const current = ov[f.key] || unit[f.key] || '';
      return `<div class="form-group" style="margin-bottom:8px">
        <label style="font-size:11px;color:var(--text-muted)">${f.label}</label>
        <input type="text" class="form-input" style="font-size:12px" data-field="${f.key}" value="${current}" placeholder="${unit[f.key]||''}">
      </div>`;
    }).join('');
    return `<div class="content-card" style="position:relative${hasOverride ? ';border:2px solid #22c55e' : ''}">
      ${hasOverride ? '<span style="position:absolute;top:10px;right:12px;background:#22c55e;color:#fff;font-size:10px;padding:1px 7px;border-radius:8px;font-weight:700">OVERRIDDEN</span>' : ''}
      <h4 style="font-size:13px;margin-bottom:12px"><i class="fa-solid fa-industry" style="color:#6366f1;margin-right:6px"></i>${unit.name}</h4>
      ${fieldsHTML}
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-primary btn-sm" style="flex:1" onclick="saveCostOverrideUnit('${projectKey}','${unit.name.replace(/'/g,"\\'")}',this.closest('.content-card'))">
          <i class="fa-solid fa-save"></i> Save
        </button>
        <button class="btn btn-ghost btn-sm" onclick="resetUnitOverride('${projectKey}','${unit.name.replace(/'/g,"\\'")}')">
          <i class="fa-solid fa-rotate-left"></i> Reset
        </button>
      </div>
    </div>`;
  }).join('');
}

function saveCostOverrideUnit(projectKey, unitName, card) {
  const all = JSON.parse(localStorage.getItem('fwf_cost_overrides') || '{}');
  if (!all[projectKey]) all[projectKey] = {};
  const fields = {};
  card.querySelectorAll('input[data-field]').forEach(inp => {
    if (inp.value.trim()) fields[inp.dataset.field] = inp.value.trim();
  });
  all[projectKey][unitName] = fields;
  localStorage.setItem('fwf_cost_overrides', JSON.stringify(all));
  notify('Costs saved for "' + unitName + '"', 'success');
  renderCostEditor();
}

function resetUnitOverride(projectKey, unitName) {
  const all = JSON.parse(localStorage.getItem('fwf_cost_overrides') || '{}');
  if (all[projectKey]) {
    delete all[projectKey][unitName];
    if (!Object.keys(all[projectKey]).length) delete all[projectKey];
    localStorage.setItem('fwf_cost_overrides', JSON.stringify(all));
  }
  notify('Reset to default for "' + unitName + '"', 'success');
  renderCostEditor();
}

function resetAllCostOverrides() {
  if (!confirm('Reset ALL project cost overrides to defaults?')) return;
  localStorage.removeItem('fwf_cost_overrides');
  notify('All cost overrides cleared', 'success');
  renderCostEditor();
}

/* ============================================
   INVOICES / RECEIPTS
   ============================================ */
let invCurrentPage = 1;

async function loadInvoices(resetPage = false) {
  if (resetPage) invCurrentPage = 1;
  const search = document.getElementById('invSearch')?.value.trim() || '';
  const type   = document.getElementById('invFilterType')?.value || '';
  const tbody  = document.getElementById('invTableBody');
  if (!tbody) return;
  tbody.innerHTML = '<tr><td colspan="9" style="padding:32px;text-align:center;color:#9ca3af"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</td></tr>';
  try {
    const params = new URLSearchParams({ page: invCurrentPage, limit: 50 });
    if (search) params.set('search', search);
    if (type)   params.set('type', type);
    const data = await api(`/api/admin/invoices?${params}`);
    if (!data.ok) throw new Error(data.error || 'Failed');

    // Stats
    const s = data.stats || {};
    document.getElementById('invStatTotal').textContent     = s.total || 0;
    document.getElementById('invStatAmount').textContent    = '₹' + (s.totalAmount || 0).toLocaleString('en-IN');
    document.getElementById('invStatMembership').textContent = s.membership || 0;
    document.getElementById('invStatDonation').textContent  = s.donation || 0;
    document.getElementById('invStat80g').textContent       = s.is80g || 0;

    // Table
    const typeColors = { membership: '#3b82f6', donation: '#f59e0b', renewal: '#8b5cf6', quiz: '#10b981', other: '#6b7280' };
    if (!data.invoices.length) {
      tbody.innerHTML = '<tr><td colspan="9" style="padding:32px;text-align:center;color:#9ca3af">No receipts found</td></tr>';
    } else {
      tbody.innerHTML = data.invoices.map(inv => {
        const color = typeColors[inv.type] || '#6b7280';
        const dateStr = new Date(inv.created_at).toLocaleDateString('en-IN', { day:'2-digit', month:'short', year:'numeric' });
        const amtInr = (inv.total || 0).toLocaleString('en-IN');
        const statusBadge = inv.status === 'viewed'
          ? '<span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600">VIEWED</span>'
          : inv.status === 'sent'
          ? '<span style="background:#dbeafe;color:#1e40af;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600">SENT</span>'
          : '<span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600">GENERATED</span>';
        return `<tr style="border-bottom:1px solid var(--brd,#e2e8f0);transition:background .15s" onmouseover="this.style.background='var(--hover,#f9fafb)'" onmouseout="this.style.background=''">
          <td style="padding:11px 14px;font-family:monospace;font-size:12px;font-weight:600;color:#111">${inv.receipt_id}</td>
          <td style="padding:11px 14px"><span style="background:${color}22;color:${color};padding:2px 10px;border-radius:10px;font-size:11px;font-weight:700;text-transform:uppercase">${inv.type}</span></td>
          <td style="padding:11px 14px;color:#374151">${inv.customer_name || '—'}</td>
          <td style="padding:11px 14px;text-align:right;font-weight:700;color:#059669">₹${amtInr}</td>
          <td style="padding:11px 14px;font-family:monospace;font-size:11px;color:#6b7280">${inv.razorpay_payment_id ? inv.razorpay_payment_id.slice(0, 18) + '…' : '—'}</td>
          <td style="padding:11px 14px">${inv.is_80g ? '<span style="color:#16a34a;font-weight:700">✓ Yes</span>' : '<span style="color:#9ca3af">—</span>'}</td>
          <td style="padding:11px 14px">${statusBadge}</td>
          <td style="padding:11px 14px;color:#6b7280;font-size:12px">${dateStr}</td>
          <td style="padding:11px 14px;text-align:center">
            <div style="display:flex;gap:6px;justify-content:center">
              <a href="${inv.receipt_url}" target="_blank" style="padding:5px 10px;background:#dbeafe;color:#1d4ed8;border-radius:6px;font-size:12px;font-weight:600;text-decoration:none;border:none;cursor:pointer" title="View Receipt">View</a>
              <button onclick="resendInvoice('${inv.receipt_id}')" style="padding:5px 10px;background:#f3e8ff;color:#7c3aed;border-radius:6px;font-size:12px;font-weight:600;border:none;cursor:pointer" title="Resend Email">Resend</button>
            </div>
          </td>
        </tr>`;
      }).join('');
    }

    // Pagination
    const p = data.pagination;
    document.getElementById('invPageInfo').textContent = `Showing ${(p.page - 1) * p.limit + 1}–${Math.min(p.page * p.limit, p.total)} of ${p.total}`;
    document.getElementById('invPrevBtn').disabled = p.page <= 1;
    document.getElementById('invNextBtn').disabled = p.page >= p.pages;
  } catch(err) {
    tbody.innerHTML = `<tr><td colspan="9" style="padding:32px;text-align:center;color:#ef4444">Error: ${err.message}</td></tr>`;
  }
}

function invChangePage(dir) {
  invCurrentPage += dir;
  if (invCurrentPage < 1) invCurrentPage = 1;
  loadInvoices();
}

async function resendInvoice(receiptId) {
  if (!confirm(`Resend receipt email for ${receiptId}?`)) return;
  try {
    const data = await api(`/api/admin/invoice/${receiptId}/resend`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
    if (data.ok) notify('Receipt email resent ✓', 'success');
    else notify(data.error || 'Resend failed', 'error');
  } catch(err) {
    notify(err.message, 'error');
  }
}

/* ============================================
   INIT
   ============================================ */
// Close modals on backdrop click
document.addEventListener('click', e => {
  if(e.target.id === 'modalQuizDetail') closeQuizDetail();
  if(e.target.id === 'modalParticipants') closeParticipantsModal();
});
loadDashboard();
</script>
</body>
</html>
