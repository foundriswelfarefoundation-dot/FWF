<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Member Dashboard ‚Äî FWF</title>
  <link rel="icon" type="image/png" href="/assets/images/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
/* ==============================
   CSS VARIABLES (Professional)
   ============================== */
:root {
  --bg-1:#f4f5f7; --bg-2:#ebedf0;
  --accent:#E87722; --accent2:#c9621a; --accent-soft:rgba(232,119,34,.08);
  --accent-light:#FFF4EB; --accent-dark:#b8591a;
  --sidebar-bg:#ffffff;
  --sidebar-text:#5f6368; --sidebar-active:#E87722;
  --card-bg:#ffffff; --card-border:#e0e0e0;
  --text-primary:#1a1a2e; --text-secondary:#54595f; --text-muted:#8c8c8c;
  --success:#0a8f3f; --warning:#e5a100; --danger:#d93025; --info:#1a73e8;
  --topbar-bg:#E87722;
  --radius-sm:8px; --radius-md:12px; --radius-lg:16px;
  --shadow-card:0 1px 3px rgba(0,0,0,.08), 0 1px 2px rgba(0,0,0,.04);
  --shadow-hover:0 4px 12px rgba(0,0,0,.1);
}

*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Plus Jakarta Sans',system-ui,-apple-system,sans-serif;
  background:var(--bg-1);
  min-height:100vh; color:var(--text-primary);
  display:flex; -webkit-font-smoothing:antialiased;
}
a{color:inherit;text-decoration:none}
::selection{background:var(--accent);color:#fff}

/* ==============================
   SIDEBAR (Professional Light)
   ============================== */
.sidebar{
  position:fixed; left:0; top:0; bottom:0; width:240px; z-index:100;
  background:var(--sidebar-bg);
  border-right:1px solid var(--card-border);
  display:flex; flex-direction:column;
  padding:0;
  transition:transform .3s ease;
  box-shadow:1px 0 3px rgba(0,0,0,.04);
}
.sidebar-brand{
  display:flex; align-items:center; gap:10px;
  padding:16px 18px;
  border-bottom:1px solid var(--card-border);
}
.sidebar-brand img{ width:36px; height:36px; border-radius:8px; }
.sidebar-brand span{ font-size:16px; font-weight:900; color:var(--accent); }
.sidebar-brand small{ display:block; font-size:10px; color:var(--success); font-weight:700; margin-top:1px; letter-spacing:.3px; }
.sidebar-nav{ flex:1; display:flex; flex-direction:column; gap:1px; overflow-y:auto; padding:8px 0; }
.sidebar-nav::-webkit-scrollbar{width:3px}
.sidebar-nav::-webkit-scrollbar-thumb{background:#ddd;border-radius:3px}
.nav-item{
  display:flex; align-items:center; gap:12px;
  padding:10px 20px; border-radius:0;
  font-size:13px; font-weight:600;
  color:var(--sidebar-text);
  cursor:pointer; transition:all .15s;
  border:none; background:none; width:100%; text-align:left;
  font-family:inherit;
  position:relative;
}
.nav-item:hover{ background:var(--accent-light); color:var(--accent); }
.nav-item.active{
  background:var(--accent-light); color:var(--accent); font-weight:700;
}
.nav-item.active::before{
  content:''; position:absolute; left:0; top:6px; bottom:6px;
  width:3px; background:var(--accent); border-radius:0 3px 3px 0;
}
.nav-item i{ width:18px; text-align:center; font-size:14px; }
.nav-badge{
  margin-left:auto; background:var(--danger); color:#fff;
  padding:2px 7px; border-radius:99px; font-size:10px; font-weight:800;
}
.nav-divider{
  font-size:10px; font-weight:700; color:var(--text-muted);
  text-transform:uppercase; letter-spacing:.8px;
  padding:18px 20px 6px; user-select:none;
}
.sidebar-footer{
  border-top:1px solid var(--card-border);
  padding:8px 0;
}
.nav-item.logout-btn{ color:var(--danger); }
.nav-item.logout-btn:hover{ background:#fef2f2; }

/* ==============================
   MOBILE
   ============================== */
.mobile-toggle{
  display:none; position:fixed; top:12px; left:12px; z-index:200;
  width:40px; height:40px; border-radius:var(--radius-sm);
  background:#fff; border:1px solid var(--card-border);
  box-shadow:var(--shadow-card);
  font-size:16px; cursor:pointer; color:var(--text-primary);
  font-family:inherit;
}
.mobile-overlay{
  display:none; position:fixed; inset:0; z-index:90;
  background:rgba(0,0,0,.35); backdrop-filter:blur(3px);
}

/* ==============================
   TOP HEADER BAR (ICICI-style)
   ============================== */
.top-header{
  position:fixed; top:0; left:240px; right:0; z-index:50;
  background:var(--topbar-bg);
  height:56px;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 28px;
  box-shadow:0 2px 4px rgba(0,0,0,.08);
}
.top-header h1{
  font-size:16px; font-weight:700; color:#fff; letter-spacing:-.2px;
  display:flex; align-items:center; gap:8px;
}
.top-header h1 i{ font-size:15px; opacity:.85; }
.top-header-right{ display:flex; align-items:center; gap:12px; }
.member-badge{
  display:inline-flex; align-items:center; gap:6px;
  background:rgba(255,255,255,.2); backdrop-filter:blur(4px);
  color:#fff; padding:6px 14px; border-radius:99px;
  font-size:12px; font-weight:700;
}
.top-header .btn-header{
  background:rgba(255,255,255,.15); color:#fff;
  border:1px solid rgba(255,255,255,.25);
  padding:6px 14px; border-radius:var(--radius-sm);
  font-size:12px; font-weight:700; cursor:pointer;
  display:flex; align-items:center; gap:5px;
  transition:.2s; font-family:inherit;
}
.top-header .btn-header:hover{ background:rgba(255,255,255,.25); }

/* ==============================
   MAIN
   ============================== */
.main{
  flex:1; margin-left:240px;
  padding:72px 28px 28px;
  min-height:100vh;
}

.topbar{ display:none; }
.topbar h1{ display:none; }
.topbar-right{ display:none; }

/* ==============================
   PAGES
   ============================== */
.page{ display:none; animation:fadeIn .3s ease; }
.page.active{ display:block; }
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* ==============================
   STAT CARDS (Clean Professional)
   ============================== */
.stats-row{
  display:grid; grid-template-columns:repeat(4,1fr); gap:14px;
  margin-bottom:22px;
}
.stat-card{
  background:var(--card-bg); border:1px solid var(--card-border);
  border-radius:var(--radius-md); padding:18px 20px;
  box-shadow:var(--shadow-card);
  transition:box-shadow .2s;
  position:relative; overflow:hidden;
}
.stat-card:hover{ box-shadow:var(--shadow-hover); }
.stat-card .s-icon{
  width:36px; height:36px; border-radius:var(--radius-sm);
  display:flex; align-items:center; justify-content:center;
  font-size:16px; margin-bottom:10px; color:#fff;
}
.stat-card .s-label{
  font-size:11px; font-weight:700; color:var(--text-muted);
  text-transform:uppercase; letter-spacing:.5px; margin-bottom:4px;
}
.stat-card .s-value{
  font-size:24px; font-weight:800; color:var(--text-primary);
  letter-spacing:-.3px; line-height:1.2;
}
.stat-card .s-sub{ font-size:11px; color:var(--text-secondary); margin-top:3px; font-weight:600; }
.s-purple{ background:#5b5fc7; }
.s-green{ background:#0a8f3f; }
.s-blue{ background:#1a73e8; }
.s-amber{ background:var(--accent); }
.s-pink{ background:#c2185b; }
.s-red{ background:#d93025; }
.s-cyan{ background:#0097a7; }
.s-teal{ background:#00897b; }

/* ==============================
   CONTENT CARD (Clean)
   ============================== */
.content-card{
  background:var(--card-bg); border:1px solid var(--card-border);
  border-radius:var(--radius-md); padding:20px;
  box-shadow:var(--shadow-card);
  margin-bottom:16px;
}
.content-card h3{
  font-size:15px; font-weight:700; margin-bottom:14px;
  display:flex; align-items:center; gap:8px;
  color:var(--text-primary);
}
.content-card h3 i{ color:var(--accent); font-size:14px; }

/* ==============================
   GRIDS
   ============================== */
.grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:18px; }

/* ==============================
   TABLE
   ============================== */
.data-table{ width:100%; border-collapse:collapse; }
.data-table th{
  text-align:left; font-size:10px; font-weight:700;
  color:var(--text-muted); text-transform:uppercase; letter-spacing:.5px;
  padding:8px 12px; border-bottom:2px solid var(--card-border);
  white-space:nowrap; background:var(--bg-1);
}
.data-table td{
  padding:10px 12px; border-bottom:1px solid #f0f0f0;
  font-size:13px; font-weight:600; color:var(--text-secondary);
}
.data-table tr:hover td{ background:var(--accent-light); }
.data-table tr:last-child td{ border-bottom:0; }
.badge{
  display:inline-flex; padding:3px 9px; border-radius:4px;
  font-size:10px; font-weight:700; white-space:nowrap;
}
.b-active{ background:#e6f4ea; color:#137333; }
.b-inactive{ background:#fce8e6; color:#c5221f; }
.b-open{ background:#e8f0fe; color:#1a73e8; }
.b-progress{ background:#fef7e0; color:#b06000; }
.b-resolved{ background:#e6f4ea; color:#137333; }
.b-closed{ background:#f1f3f4; color:#5f6368; }
.b-pending{ background:#fef7e0; color:#b06000; }

/* ==============================
   FORMS
   ============================== */
.form-group{ margin-bottom:14px; }
.form-group label{
  display:block; font-size:12px; font-weight:700;
  color:var(--text-secondary); margin-bottom:4px;
}
.form-input{
  width:100%; padding:9px 12px;
  border:1px solid #dadce0; border-radius:var(--radius-sm);
  background:#fff; color:var(--text-primary);
  font:inherit; font-size:13px; font-weight:600;
  transition:border-color .2s, box-shadow .2s;
}
.form-input:focus{
  outline:none; border-color:var(--accent);
  box-shadow:0 0 0 2px var(--accent-soft);
}
.form-row{ display:flex; gap:12px; flex-wrap:wrap; }
.form-row .form-group{ flex:1; min-width:180px; }
select.form-input{
  appearance:none; cursor:pointer;
  background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%2394a3b8" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>');
  background-repeat:no-repeat; background-position:right 12px center;
  padding-right:36px;
}
textarea.form-input{ resize:vertical; min-height:80px; }

/* ==============================
   BUTTONS (Professional)
   ============================== */
.btn{
  padding:8px 18px; border:none; border-radius:var(--radius-sm);
  font:inherit; font-size:12px; font-weight:700;
  cursor:pointer; display:inline-flex; align-items:center; gap:6px;
  transition:all .15s;
}
.btn-primary{ background:var(--accent); color:#fff; }
.btn-primary:hover{ background:var(--accent-dark); }
.btn-success{ background:var(--success); color:#fff; }
.btn-success:hover{ background:#077a35; }
.btn-danger{ background:var(--danger); color:#fff; }
.btn-danger:hover{ background:#c22b20; }
.btn-warning{ background:var(--warning); color:#fff; }
.btn-ghost{
  background:transparent; color:var(--text-secondary);
  border:1px solid var(--card-border);
}
.btn-ghost:hover{ background:var(--bg-2); }
.btn-sm{ padding:5px 10px; font-size:11px; border-radius:6px; }
.btn-icon{
  width:32px; height:32px; border-radius:6px; padding:0;
  display:inline-flex; align-items:center; justify-content:center;
  border:1px solid var(--card-border); background:#fff;
  cursor:pointer; transition:.15s; font-size:13px; color:var(--text-secondary);
}
.btn-icon:hover{ background:var(--bg-2); }

/* ==============================
   ACCOUNT OVERVIEW (ICICI-style)
   ============================== */
.account-overview{
  background:var(--card-bg); border:1px solid var(--card-border);
  border-radius:var(--radius-lg); padding:0;
  box-shadow:var(--shadow-card);
  margin-bottom:22px; overflow:hidden;
}
.account-overview-header{
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 24px;
  background:var(--bg-2); border-bottom:1px solid var(--card-border);
}
.account-overview-header h3{
  font-size:14px; font-weight:700; color:var(--text-primary);
  display:flex; align-items:center; gap:8px; margin:0;
}
.account-overview-header .acc-type{
  background:var(--accent); color:#fff;
  padding:2px 10px; border-radius:99px;
  font-size:10px; font-weight:700;
}
.account-overview-body{
  padding:24px;
}
.account-balance{
  margin-bottom:6px;
}
.account-balance .currency{
  font-size:16px; font-weight:600; color:var(--text-muted);
  vertical-align:super;
}
.account-balance .amount{
  font-size:32px; font-weight:800; color:var(--text-primary);
  letter-spacing:-1px;
}
.account-subtitle{
  font-size:12px; color:var(--text-muted); font-weight:600;
  margin-bottom:20px;
}
.account-actions{
  display:flex; gap:0; border-top:1px solid var(--card-border);
  padding-top:0; margin:0 -24px -24px;
}
.account-action-btn{
  flex:1; display:flex; flex-direction:column; align-items:center;
  gap:8px; padding:18px 12px; border:none; background:none;
  cursor:pointer; font-family:inherit; transition:.15s;
  border-right:1px solid var(--card-border);
  color:var(--text-secondary); font-size:12px; font-weight:600;
}
.account-action-btn:last-child{ border-right:none; }
.account-action-btn:hover{ background:var(--accent-light); color:var(--accent); }
.account-action-btn i{
  font-size:20px; color:var(--accent);
}

/* Legacy welcome banner (hidden, replaced) */
.welcome-banner{ display:none; }
.welcome-banner::after{ display:none; }
.welcome-banner h2{ display:none; }
.welcome-banner p{ display:none; }
.welcome-banner .wid{ display:none; }

/* ==============================
   PROFILE CARD
   ============================== */
.profile-header{
  display:flex; align-items:center; gap:20px;
  margin-bottom:20px; padding-bottom:20px;
  border-bottom:1px solid var(--card-border);
}
.profile-avatar{
  width:72px; height:72px; border-radius:50%;
  background:var(--accent);
  color:#fff; display:flex; align-items:center; justify-content:center;
  font-size:28px; font-weight:800; flex-shrink:0;
}
.profile-name{ font-size:22px; font-weight:800; }
.profile-id{ color:var(--accent); font-weight:700; font-size:14px; margin-top:2px; }
.profile-meta{ display:flex; gap:20px; flex-wrap:wrap; margin-top:8px; }
.profile-meta span{
  font-size:12px; color:var(--text-muted); font-weight:600;
  display:flex; align-items:center; gap:4px;
}

/* ==============================
   ACTIVITY FEED
   ============================== */
.feed-card{
  background:var(--card-bg); border:1px solid var(--card-border);
  border-radius:var(--radius-md); padding:18px 20px; margin-bottom:12px;
  transition:box-shadow .2s;
}
.feed-card:hover{ box-shadow:var(--shadow-hover); }
.feed-header{
  display:flex; align-items:center; gap:12px; margin-bottom:12px;
}
.feed-avatar{
  width:40px; height:40px; border-radius:50%;
  background:var(--accent);
  color:#fff; display:flex; align-items:center; justify-content:center;
  font-size:14px; font-weight:800;
}
.feed-name{ font-weight:800; font-size:14px; }
.feed-time{ font-size:11px; color:var(--text-muted); font-weight:600; }
.feed-body{ font-size:14px; line-height:1.7; color:var(--text-secondary); margin-bottom:12px; }
.feed-image{
  width:100%; border-radius:12px; max-height:320px;
  object-fit:cover; margin-bottom:12px;
}
.feed-actions{
  display:flex; gap:16px;
}
.feed-actions button{
  background:none; border:none; cursor:pointer;
  font:inherit; font-size:13px; font-weight:700;
  color:var(--text-muted); display:flex; align-items:center; gap:6px;
  transition:color .2s;
}
.feed-actions button:hover{ color:var(--accent); }

/* ==============================
   COURSE CARD
   ============================== */
.course-card{
  background:var(--card-bg); border:1px solid var(--card-border);
  border-radius:var(--radius-md); overflow:hidden;
  transition:box-shadow .2s;
}
.course-card:hover{ box-shadow:var(--shadow-hover); }
.course-thumb{
  height:130px; background:var(--accent);
  display:flex; align-items:center; justify-content:center;
  font-size:44px; color:rgba(255,255,255,.3);
}
.course-info{ padding:16px; }
.course-info h4{ font-size:14px; font-weight:800; margin-bottom:6px; }
.course-info p{ font-size:12px; color:var(--text-muted); font-weight:600; margin-bottom:10px; }
.course-progress{
  height:6px; background:#e2e8f0; border-radius:99px; overflow:hidden;
}
.course-progress-bar{
  height:100%; background:var(--accent);
  border-radius:99px; transition:width .5s;
}
.course-status{
  display:flex; justify-content:space-between; align-items:center;
  margin-top:8px; font-size:11px; font-weight:700;
}

/* ==============================
   REDEEM CARD
   ============================== */
.redeem-card{
  background:var(--card-bg); border:1px solid var(--card-border);
  border-radius:var(--radius-md); padding:18px; text-align:center;
  transition:box-shadow .2s;
}
.redeem-card:hover{ box-shadow:var(--shadow-hover); }
.redeem-icon{
  width:56px; height:56px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:24px; color:#fff; margin:0 auto 12px;
}
.redeem-card h4{ font-size:14px; font-weight:800; margin-bottom:4px; }
.redeem-card p{ font-size:12px; color:var(--text-muted); font-weight:600; margin-bottom:12px; }
.redeem-cost{ font-size:13px; font-weight:800; color:var(--accent); margin-bottom:8px; }

/* ==============================
   WALLET SINGLE PAGE - APP STYLE
   ============================== */
.wallet-single-section{
  background:var(--card-bg);
  border:1px solid var(--card-border);
  border-radius:var(--radius-lg);
  overflow:hidden;
  box-shadow:var(--shadow-card);
}
.wallet-section-header{
  display:flex;
  align-items:center;
  gap:10px;
  font-size:16px;
  font-weight:900;
  padding:18px 20px 0;
  margin:0;
  color:var(--text-primary);
}
.wallet-section-header i{ font-size:18px; }

/* Mobile App Style Tabs */
.app-tabs{
  display:flex;
  gap:0;
  overflow-x:auto;
  padding:12px 16px 0;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
}
.app-tabs::-webkit-scrollbar{ display:none; }
.app-tab{
  flex:1;
  min-width:0;
  padding:12px 6px 14px;
  border:none;
  background:transparent;
  font-size:11px;
  font-weight:700;
  color:var(--text-muted);
  cursor:pointer;
  font-family:inherit;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  position:relative;
  transition:color .2s;
  text-align:center;
  white-space:nowrap;
}
.app-tab::after{
  content:'';
  position:absolute;
  bottom:0;
  left:20%;
  right:20%;
  height:3px;
  border-radius:3px 3px 0 0;
  background:transparent;
  transition:all .25s;
}
.app-tab:hover{
  color:var(--text-primary);
}
.app-tab.active{
  color:var(--accent);
}
.app-tab.active::after{
  background:var(--accent);
  left:10%;
  right:10%;
}
.app-tab .tab-icon{
  width:36px;
  height:36px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:15px;
  background:var(--bg-1);
  color:var(--text-muted);
  transition:all .25s;
}
.app-tab.active .tab-icon{
  background:var(--accent);
  color:#fff;
  box-shadow:0 4px 12px rgba(232,119,34,.3);
  transform:scale(1.05);
}
.app-tab .tab-label{
  font-size:10px;
  line-height:1.2;
}
@media(max-width:560px){
  .app-tab .tab-label{ font-size:9px; }
  .app-tab .tab-icon{ width:32px; height:32px; font-size:13px; }
  .app-tab{ padding:10px 4px 12px; }
}

/* Tab content area */
.app-tab-divider{
  height:1px;
  background:var(--card-border);
  margin:0;
}
.app-tab-body{
  padding:18px 20px 20px;
  animation:tabSlideIn .3s ease;
}
@keyframes tabSlideIn{
  from{ opacity:0; transform:translateY(8px); }
  to{ opacity:1; transform:translateY(0); }
}
@keyframes fadeIn{ from{opacity:0} to{opacity:1} }

/* ==============================
   PRODUCT CARD (Marketplace)
   ============================== */
.product-card{
  background:var(--card-bg); border:1px solid var(--card-border);
  border-radius:var(--radius-md); overflow:hidden;
  transition:box-shadow .2s;
}
.product-card:hover{ box-shadow:var(--shadow-hover); }
.product-thumb{
  height:160px; background:#f1f5f9;
  display:flex; align-items:center; justify-content:center;
  font-size:48px; color:var(--text-muted); opacity:.3;
}
.product-info{ padding:14px; }
.product-info h4{ font-size:14px; font-weight:800; margin-bottom:4px; }
.product-info .seller{ font-size:11px; color:var(--text-muted); font-weight:600; margin-bottom:6px; }
.product-price{ font-size:18px; font-weight:900; color:var(--accent); }
.product-rating{ font-size:12px; color:#f59e0b; margin-top:4px; }

/* ==============================
   EVENT CARD
   ============================== */
.event-card{
  display:flex; gap:14px; align-items:center;
  background:var(--card-bg); border:1px solid var(--card-border);
  border-radius:var(--radius-md); padding:14px 16px; margin-bottom:10px;
  transition:box-shadow .2s;
}
.event-card:hover{ box-shadow:var(--shadow-hover); }
.event-date{
  width:50px; height:50px; border-radius:var(--radius-sm);
  background:var(--accent);
  color:#fff; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  flex-shrink:0;
}
.event-date .day{ font-size:20px; font-weight:900; line-height:1; }
.event-date .month{ font-size:10px; font-weight:700; text-transform:uppercase; }
.event-info h4{ font-size:14px; font-weight:800; margin-bottom:2px; }
.event-info p{ font-size:12px; color:var(--text-muted); font-weight:600; }

/* ==============================
   TABS
   ============================== */
.tab-bar{
  display:flex; gap:0; margin-bottom:16px;
  border-bottom:2px solid var(--card-border);
}
.tab-btn{
  padding:10px 18px; border:none; background:none;
  font:inherit; font-size:12px; font-weight:700;
  color:var(--text-muted); cursor:pointer;
  border-bottom:2px solid transparent;
  margin-bottom:-2px; transition:.15s;
}
.tab-btn:hover{ color:var(--text-primary); }
.tab-btn.active{ color:var(--accent); border-bottom-color:var(--accent); }
.tab-content{ display:none; }
.tab-content.active{ display:block; }

/* ==============================
   MODAL
   ============================== */
.modal{
  position:fixed; inset:0; z-index:999;
  background:rgba(15,23,42,.5); backdrop-filter:blur(6px);
  display:none; align-items:center; justify-content:center;
  padding:20px; animation:fadeIn .2s;
}
.modal.show{ display:flex; }
.modal-content{
  background:#fff; border-radius:var(--radius-lg);
  max-width:640px; width:100%; padding:0;
  box-shadow:0 12px 40px rgba(0,0,0,.15);
  max-height:85vh; overflow:hidden;
  animation:scaleIn .25s ease-out;
  display:flex; flex-direction:column;
}
.modal-header{
  display:flex; justify-content:space-between; align-items:center;
  padding:24px 28px 20px;
  border-bottom:1px solid var(--card-border);
}
.modal-header h3{ 
  font-size:18px; font-weight:900; 
  display:flex; align-items:center; gap:8px; 
  margin:0;
}
.modal-header h3 i{ color:var(--accent); }
.modal-body{
  padding:24px 28px;
  overflow-y:auto;
  flex:1;
}
.modal-actions{ 
  display:flex; gap:10px; justify-content:flex-end; 
  padding:20px 28px;
  border-top:1px solid var(--card-border);
  background:var(--bg-1);
}
.modal-overlay{
  position:fixed; inset:0; z-index:999;
  background:rgba(15,23,42,.5); backdrop-filter:blur(6px);
  display:flex; align-items:center; justify-content:center;
  padding:20px; animation:fadeIn .2s;
}
.modal-overlay.hidden{ display:none; }
.modal-card{
  background:#fff; border-radius:var(--radius-lg);
  max-width:640px; width:100%; padding:28px;
  box-shadow:0 12px 40px rgba(0,0,0,.15);
  max-height:85vh; overflow-y:auto;
  animation:scaleIn .25s ease-out;
}
@keyframes scaleIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.modal-head{
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:18px;
}
.modal-head h3{ font-size:18px; font-weight:900; display:flex; align-items:center; gap:8px; }
.modal-head h3 i{ color:var(--accent); }
.modal-close{
  width:32px; height:32px; border-radius:6px;
  border:1px solid var(--card-border); background:#fff;
  cursor:pointer; font-size:14px; display:grid; place-items:center;
  transition:.15s;
}
.modal-close:hover{ background:var(--bg-2); }
.modal-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:18px; }

/* ==============================
   SELLER PANEL
   ============================== */
.seller-stat{
  text-align:center; padding:16px;
}
.seller-stat .val{ font-size:28px; font-weight:900; color:var(--text-primary); }
.seller-stat .lbl{ font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-top:2px; }

/* ==============================
   RESPONSIVE
   ============================== */
@media(max-width:1100px){
  .stats-row{ grid-template-columns:repeat(2,1fr); }
  .grid-3{ grid-template-columns:1fr 1fr; }
}
@media(max-width:900px){
  .sidebar{ transform:translateX(-100%); }
  .sidebar.open{ transform:translateX(0); }
  .main{ margin-left:0; padding:16px; padding-top:68px; padding-bottom:80px; }
  .top-header{ left:0; }
  .mobile-toggle{ display:grid; place-items:center; z-index:200; }
  .mobile-overlay.show{ display:block; }
}
@media(max-width:640px){
  .stats-row{ grid-template-columns:1fr 1fr; }
  .grid-2,.grid-3{ grid-template-columns:1fr; }
  .form-row{ flex-direction:column; }
  .account-actions{ flex-wrap:wrap; }
  .account-action-btn{ min-width:33%; flex:1 1 40%; }
  .account-balance .amount{ font-size:26px; }
  .profile-header{ flex-direction:column; text-align:center; }
  .profile-meta{ justify-content:center; }
  .tab-bar{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .top-header{ padding:0 14px; }
  .top-header h1{ font-size:14px; }
  .main{ padding:12px 10px; padding-top:64px; padding-bottom:80px; }
  .home-cards-grid{ grid-template-columns:1fr !important; }

  /* Stack account overview cards */
  .account-overview-header{ padding:12px 16px; }
  .account-overview-header h3{ font-size:12px; }
  .account-overview-body{ padding:16px; }
  .account-subtitle{ font-size:11px; flex-wrap:wrap; }
}

/* ==============================
   MOBILE APP ENHANCEMENTS (‚â§480px)
   ============================== */
@media(max-width:480px){
  body{ background:var(--bg-1); }
  .main{ padding:8px; padding-top:60px; padding-bottom:76px; }
  .top-header{ height:50px; padding:0 12px; }
  .top-header h1{ font-size:13px; gap:6px; }
  .top-header h1 i{ font-size:13px; }
  .top-header-right{ gap:8px; }
  .member-badge{ padding:4px 10px; font-size:10px; gap:4px; }
  .top-header .btn-header{ padding:4px 10px; font-size:10px; }
  .mobile-toggle{ top:8px; left:8px; width:36px; height:36px; font-size:14px; }

  /* Stat cards compact */
  .stats-row{ grid-template-columns:1fr 1fr; gap:8px; }
  .stat-card{ padding:14px; border-radius:12px; }
  .stat-card .s-icon{ width:34px; height:34px; font-size:15px; margin-bottom:8px; border-radius:8px; }
  .stat-card .s-value{ font-size:20px; }
  .stat-card .s-label{ font-size:10px; }

  /* Content cards */
  .content-card{ border-radius:14px; padding:16px; margin-bottom:14px; }
  .content-card h3{ font-size:15px; }

  /* Account overview (home cards) */
  .account-overview{ border-radius:14px; margin-bottom:14px; }
  .account-overview-header{ padding:10px 14px; }
  .account-overview-header h3{ font-size:11px; }
  .account-overview-body{ padding:14px; }
  .account-balance .amount{ font-size:24px; }
  .account-subtitle{ font-size:10px; line-height:1.7; }
  .account-actions{ margin:0 -14px -14px; }
  .account-action-btn{ padding:12px 6px; font-size:10px; gap:4px; }
  .account-action-btn i{ font-size:16px; }

  /* Wallet sections */
  .wallet-single-section{ border-radius:14px; margin-bottom:14px; }
  .wallet-section-header{ font-size:14px; padding:14px 14px 0; }
  .wallet-section-header i{ font-size:15px; }
  .app-tabs{ padding:10px 10px 0; }
  .app-tab{ padding:8px 4px 10px; }
  .app-tab .tab-icon{ width:30px; height:30px; font-size:12px; }
  .app-tab .tab-label{ font-size:8px; }
  .app-tab-body{ padding:14px 12px; }

  /* Data tables */
  .data-table th,.data-table td{ padding:8px 6px; font-size:11px; }
  .data-table th{ font-size:9px; }

  /* Forms */
  .form-input{ padding:10px 12px; font-size:13px; border-radius:10px; }
  .form-group label{ font-size:12px; }

  /* Buttons */
  .btn{ padding:10px 16px; font-size:12px; border-radius:10px; }

  /* Profile */
  .profile-avatar{ width:56px; height:56px; font-size:22px; }
  .profile-name{ font-size:18px; }

  /* Feed cards */
  .feed-card{ padding:14px; border-radius:12px; }
  .feed-avatar{ width:34px; height:34px; font-size:12px; }
  .feed-name{ font-size:13px; }
  .feed-body{ font-size:13px; }

  /* Course cards */
  .course-thumb{ height:100px; }

  /* Product cards */
  .product-thumb{ height:120px; }

  /* Redeem cards */
  .redeem-icon{ width:44px; height:44px; font-size:20px; }

  /* Tab bar compact */
  .tab-bar{ gap:0; }
  .tab-btn{ padding:8px 10px; font-size:11px; }

  /* Action cards grid ‚Äî 2 columns on phone */
  .action-cards-grid{ grid-template-columns:1fr 1fr !important; gap:10px !important; padding:12px 12px 4px !important; }
  .action-cards-grid > div{ padding:14px !important; border-radius:12px !important; }
  .action-cards-grid > div h4{ font-size:13px !important; }
  .action-cards-grid > div p{ font-size:10px !important; line-height:1.4 !important; }
  .action-cards-grid > div > div:first-child{ width:38px !important; height:38px !important; border-radius:10px !important; margin-bottom:8px !important; }
  .action-cards-grid > div > div:first-child i{ font-size:15px !important; }

  /* Referral code bar compact */
  .wallet-single-section > div[style*="margin:14px"]{ margin:10px 12px 0 !important; padding:10px 12px !important; }

  /* Modals ‚Äî full screen bottom sheet on mobile */
  .modal{ padding:0; }
  .modal-content{ max-width:100%; border-radius:16px 16px 0 0; max-height:92vh; margin-top:auto; }
  .modal-header{ padding:16px 18px 14px; }
  .modal-header h3{ font-size:16px; }
  .modal-body{ padding:16px 18px; }
  .modal-actions{ padding:14px 18px; }
  .modal-overlay{ padding:0; }
  .modal-card{ max-width:100%; border-radius:16px 16px 0 0; padding:20px; max-height:92vh; margin-top:auto; }

  /* Action modals (Razorpay, Supporter, Donation, Ticket) ‚Äî bottom sheet */
  [id^="modal"]{ padding:8px !important; }
  [id^="modal"] > div{ max-width:100% !important; border-radius:16px !important; max-height:94vh; overflow-y:auto; }
}

/* ==============================
   MOBILE BOTTOM NAV BAR
   ============================== */
.mobile-bottom-nav{
  display:none;
  position:fixed; bottom:0; left:0; right:0; z-index:200;
  background:#fff; border-top:1px solid var(--card-border);
  box-shadow:0 -2px 10px rgba(0,0,0,.06);
  padding:4px 0; padding-bottom:max(4px, env(safe-area-inset-bottom));
}
.mobile-bottom-nav .nav-row{
  display:flex; justify-content:space-around; align-items:center;
}
.mobile-bottom-nav .bnav{
  display:flex; flex-direction:column; align-items:center; gap:2px;
  padding:6px 8px; border:none; background:none;
  font-family:inherit; font-size:9px; font-weight:700;
  color:var(--text-muted); cursor:pointer; transition:.15s;
  min-width:0; flex:1;
}
.mobile-bottom-nav .bnav i{ font-size:18px; transition:.15s; }
.mobile-bottom-nav .bnav.active{ color:var(--accent); }
.mobile-bottom-nav .bnav.active i{ transform:scale(1.1); }
@media(max-width:900px){
  .mobile-bottom-nav{ display:block; }
}

.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  </style>
</head>
<body>

<!-- Mobile toggle -->
<button class="mobile-toggle" id="mobileToggle"><i class="fa-solid fa-bars"></i></button>
<div class="mobile-overlay" id="mobileOverlay"></div>

<!-- ======== SIDEBAR ======== -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <img src="/assets/images/logo.png" alt="FWF">
    <div>
      <small>MEMBER PANEL</small>
    </div>
  </div>
  <nav class="sidebar-nav">
    <button class="nav-item active" data-page="home">
      <i class="fa-solid fa-house"></i> Dashboard
    </button>

    <div class="nav-divider">Membership</div>
    <button class="nav-item" data-page="profile">
      <i class="fa-solid fa-id-card"></i> Profile & ID Card
    </button>

    <div class="nav-divider">Engage</div>
    <button class="nav-item" data-page="feed">
      <i class="fa-solid fa-book-open"></i> Social Book
    </button>
    <button class="nav-item" data-page="training">
      <i class="fa-solid fa-graduation-cap"></i> Training & Courses
    </button>

    <div class="nav-divider">Wallet</div>
    <button class="nav-item" data-page="wallet">
      <i class="fa-solid fa-wallet"></i> Wallet
    </button>
    <button class="nav-item" data-page="referral">
      <i class="fa-solid fa-user-plus"></i> Referral & Earn
    </button>

    <div class="nav-divider">Marketplace</div>
    <button class="nav-item" data-page="marketplace">
      <i class="fa-solid fa-store"></i> Marketplace
    </button>
    <button class="nav-item" data-page="seller">
      <i class="fa-solid fa-boxes-stacked"></i> Seller Panel
    </button>

    <div class="nav-divider">More</div>
    <button class="nav-item" data-page="events">
      <i class="fa-solid fa-calendar-days"></i> Events & Activities
    </button>
    <button class="nav-item" data-page="support">
      <i class="fa-solid fa-headset"></i> Help & Support
    </button>
  </nav>
  <div class="sidebar-footer">
    <button class="nav-item logout-btn" id="logoutBtn">
      <i class="fa-solid fa-right-from-bracket"></i> Logout
    </button>
  </div>
</aside>

<!-- ======== TOP HEADER (ICICI-style) ======== -->
<header class="top-header" id="topHeader">
  <h1 id="pageTitle"><i class="fa-solid fa-house"></i> Dashboard</h1>
  <div class="top-header-right">
    <span class="member-badge" id="memberBadge"><i class="fa-solid fa-circle-check"></i> Member</span>
    <button class="btn-header" id="topLogoutBtn"><i class="fa-solid fa-user"></i> <span id="topUserName">MEMBER</span> <i class="fa-solid fa-chevron-down" style="font-size:9px;opacity:.7"></i></button>
  </div>
</header>

<!-- ======== MAIN ======== -->
<main class="main">
  <div class="topbar">
    <h1><i class="fa-solid fa-house"></i> Dashboard</h1>
    <div class="topbar-right">
      <span class="member-badge"><i class="fa-solid fa-circle-check"></i> Member</span>
    </div>
  </div>

  <!-- ===================== HOME / DASHBOARD ===================== -->
  <div class="page active" id="page-home">
    <!-- Hidden welcome banner (data still populates via JS) -->
    <div class="welcome-banner" id="welcomeBanner">
      <h2 id="welcomeName">Welcome Back!</h2>
      <p>Empowering women through skills, welfare & self-employment.</p>
      <div class="wid"><i class="fa-solid fa-id-badge"></i> <span id="welcomeId">FWFM000</span></div>
    </div>

    <!-- ACCOUNT OVERVIEW ‚Äî ICICI-style -->
    <div class="home-cards-grid" style="display:grid;grid-template-columns:1.4fr 1fr;gap:16px;margin-bottom:22px">
      <!-- Left: Balance Card -->
      <div class="account-overview">
        <div class="account-overview-header">
          <h3><i class="fa-solid fa-wallet" style="color:var(--accent)"></i> MEMBER ACCOUNT <span class="acc-type">PRIMARY</span></h3>
          <a href="#" onclick="switchPage('wallet');return false" style="color:var(--accent);font-size:12px;font-weight:700">VIEW DETAILS</a>
        </div>
        <div class="account-overview-body">
          <div class="account-balance">
            <span class="currency">‚òÖ</span> <span class="amount" id="hPoints">0</span> <small style="font-size:12px;color:var(--text-muted);font-weight:600;margin-left:2px">Points</small>
          </div>
          <div class="account-subtitle">
            Wallet Balance <strong style="color:var(--text-primary)" id="hWallet">‚Çπ0</strong> &nbsp;|&nbsp;
            Referrals <strong style="color:var(--text-primary)" id="hReferrals">0</strong> &nbsp;|&nbsp;
            Donations <strong style="color:var(--text-primary)" id="hDonations">‚Çπ0</strong>
          </div>
          <div class="account-actions">
            <button class="account-action-btn" onclick="switchPage('wallet')">
              <i class="fa-solid fa-coins"></i> Earn Points
            </button>
            <button class="account-action-btn" onclick="switchPage('training')">
              <i class="fa-solid fa-graduation-cap"></i> Start Course
            </button>
            <button class="account-action-btn" onclick="switchPage('marketplace')">
              <i class="fa-solid fa-store"></i> Marketplace
            </button>
            <button class="account-action-btn" onclick="switchPage('support')">
              <i class="fa-solid fa-headset"></i> Help
            </button>
          </div>
        </div>
      </div>

      <!-- Right: Member ID Card -->
      <div class="account-overview">
        <div class="account-overview-header">
          <h3><i class="fa-solid fa-id-card" style="color:var(--accent)"></i> MEMBER ID CARD</h3>
        </div>
        <div class="account-overview-body" style="padding:20px">
          <div style="background:linear-gradient(135deg,#1a1a2e, #2d2d4e);border-radius:var(--radius-md);padding:20px;color:#fff;position:relative;overflow:hidden">
            <div style="position:absolute;right:-15px;top:-15px;width:100px;height:100px;border-radius:50%;background:rgba(232,119,34,.12)"></div>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;position:relative;z-index:1">
              <img src="/assets/images/logo.png" alt="FWF" style="width:32px;height:32px;border-radius:6px">
              <div>
                <div style="font-size:13px;font-weight:800">Foundris Welfare Foundation</div>
                <div style="font-size:9px;opacity:.6;font-weight:600;text-transform:uppercase;letter-spacing:.5px">Member Identity Card</div>
              </div>
            </div>
            <div style="position:relative;z-index:1">
              <div style="font-size:18px;font-weight:800;margin-bottom:4px" id="dashCardName">Member Name</div>
              <div style="display:inline-flex;align-items:center;gap:6px;background:rgba(232,119,34,.2);padding:4px 10px;border-radius:6px;margin-bottom:12px">
                <i class="fa-solid fa-id-badge" style="color:#E87722;font-size:12px"></i>
                <span style="font-size:13px;font-weight:700;color:#ffb366" id="dashCardId">FWFM000</span>
              </div>
              <div style="display:flex;gap:16px;font-size:11px;opacity:.75;font-weight:600;flex-wrap:wrap">
                <span><i class="fa-solid fa-phone" style="margin-right:4px;color:#E87722;font-size:10px"></i><span id="dashCardMobile">‚Äî</span></span>
                <span><i class="fa-solid fa-calendar" style="margin-right:4px;color:#E87722;font-size:10px"></i>Joined <span id="dashCardJoined">‚Äî</span></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="content-card">
      <h3><i class="fa-solid fa-clock-rotate-left"></i> Recent Activity</h3>
      <div id="homeActivity">
        <div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px"><p>No recent activity</p></div>
      </div>
    </div>
  </div>

  <!-- ===================== PROFILE & ID CARD ===================== -->
  <div class="page" id="page-profile">
    <div class="content-card">
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar">M</div>
        <div>
          <div class="profile-name" id="profileName">Member</div>
          <div class="profile-id" id="profileId">FWFM000</div>
          <div class="profile-meta">
            <span><i class="fa-solid fa-phone"></i> <span id="profileMobile">‚Äî</span></span>
            <span><i class="fa-solid fa-envelope"></i> <span id="profileEmail">‚Äî</span></span>
            <span><i class="fa-solid fa-calendar"></i> Joined <span id="profileJoined">‚Äî</span></span>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <h3 style="font-size:15px;font-weight:800;margin-bottom:12px"><i class="fa-solid fa-circle-check" style="color:var(--success)"></i> Membership Status</h3>
          <div class="stat-card" style="margin-bottom:12px">
            <div class="s-label">Status</div>
            <div id="profileStatus" style="font-weight:800;font-size:16px;color:var(--success)">Active</div>
          </div>
        </div>
        <div>
          <h3 style="font-size:15px;font-weight:800;margin-bottom:12px"><i class="fa-solid fa-pen" style="color:var(--accent)"></i> Update Profile</h3>
          <div class="form-group">
            <label>Display Name</label>
            <input type="text" class="form-input" id="editName" placeholder="Your name">
          </div>
          <div class="form-group">
            <label>Bio</label>
            <textarea class="form-input" id="editBio" placeholder="Tell us about yourself..." rows="3"></textarea>
          </div>
          <button class="btn btn-primary" id="saveProfileBtn"><i class="fa-solid fa-save"></i> Save Profile</button>
        </div>
      </div>
    </div>

    <!-- ID Card -->
    <div class="content-card">
      <h3><i class="fa-solid fa-id-card"></i> Digital Member ID Card</h3>
      <div style="max-width:400px;margin:0 auto">
        <div style="background:linear-gradient(135deg,#1a1a2e,#2d2d4e);border-radius:var(--radius-md);padding:22px;color:#fff;position:relative;overflow:hidden">
          <div style="position:absolute;right:-20px;top:-20px;width:100px;height:100px;border-radius:50%;background:rgba(232,119,34,.15)"></div>
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
            <img src="/assets/images/logo.png" alt="FWF" style="width:40px;height:40px;border-radius:8px">
            <div>
              <div style="font-size:16px;font-weight:900">Foundris Welfare Foundation</div>
              <div style="font-size:10px;opacity:.7;font-weight:600">Member Identity Card</div>
            </div>
          </div>
          <div style="font-size:22px;font-weight:900;margin-bottom:4px" id="cardName">Member Name</div>
          <div style="font-size:14px;font-weight:700;color:#E87722;margin-bottom:16px" id="cardId">FWFM000</div>
          <div style="display:flex;gap:20px;font-size:11px;opacity:.7;font-weight:600">
            <span><i class="fa-solid fa-phone"></i> <span id="cardMobile">‚Äî</span></span>
            <span><i class="fa-solid fa-calendar"></i> <span id="cardJoined">‚Äî</span></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== SOCIAL BOOK ===================== -->
  <div class="page" id="page-feed">
    <!-- Info Banner -->
    <div style="background:var(--accent);border-radius:var(--radius-md);padding:16px 22px;color:#fff;margin-bottom:18px;display:flex;align-items:center;gap:14px">
      <div style="width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">
        <i class="fa-solid fa-users"></i>
      </div>
      <div style="flex:1">
        <h2 style="font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px"><i class="fa-solid fa-book-open"></i> Share your social work, inspire others!</h2>
      </div>
    </div>

    <!-- Create Post Box -->
    <div class="content-card" style="margin-bottom:20px">
      <div style="display:flex;align-items:center;gap:12px;cursor:pointer;padding:4px" onclick="openModal('postModal')">
        <div class="feed-avatar" style="width:40px;height:40px;font-size:14px" id="feedUserAvatar">M</div>
        <div style="flex:1;background:var(--bg-1);padding:10px 16px;border-radius:var(--radius-sm);color:var(--text-muted);font-size:13px;font-weight:600;cursor:pointer;transition:.15s;border:1px solid var(--card-border)" onmouseover="this.style.background='var(--bg-2)'" onmouseout="this.style.background='var(--bg-1)'">
          What's your social work story today?
        </div>
        <button class="btn btn-primary" onclick="openModal('postModal')"><i class="fa-solid fa-image"></i> Post</button>
      </div>
    </div>

    <div id="feedContainer">
      <!-- Sample Feed Posts -->
      <div class="feed-card">
        <div class="feed-header">
          <div class="feed-avatar">FW</div>
          <div style="flex:1">
            <div class="feed-name">FWF Community</div>
            <div class="feed-time">Today ‚Ä¢ Welfare Activity</div>
          </div>
        </div>
        <div class="feed-body">
          üå± Tree plantation drive completed! 50 trees planted by our members in collaboration with local schools. 
          Together, we're building a greener future.
        </div>
        <div class="feed-image-container" style="margin-bottom:12px">
          <div style="background:#0a8f3f;border-radius:var(--radius-md);padding:60px 20px;text-align:center;color:#fff">
            <i class="fa-solid fa-seedling" style="font-size:48px;opacity:.7"></i>
            <p style="margin:12px 0 0;font-size:13px;opacity:.8">50 trees planted üå≥</p>
          </div>
        </div>
        <div class="feed-actions">
          <button><i class="fa-regular fa-heart"></i> 24</button>
          <button><i class="fa-regular fa-comment"></i> 8</button>
          <button><i class="fa-solid fa-share"></i> Share</button>
        </div>
      </div>

      <div class="feed-card">
        <div class="feed-header">
          <div class="feed-avatar" style="background:linear-gradient(135deg,#c2185b,#ad1457)">RK</div>
          <div style="flex:1">
            <div class="feed-name">Rajesh Kumar</div>
            <div class="feed-time">Yesterday ‚Ä¢ Training</div>
          </div>
        </div>
        <div class="feed-body">
          üé® Free tailoring workshop for 30 women completed! Our members are learning and earning. 
          Next batch starts soon ‚Äî refer friends to join!
        </div>
        <div class="feed-actions">
          <button><i class="fa-regular fa-heart"></i> 42</button>
          <button><i class="fa-regular fa-comment"></i> 15</button>
          <button><i class="fa-solid fa-share"></i> Share</button>
        </div>
      </div>

      <div class="feed-card">
        <div class="feed-header">
          <div class="feed-avatar" style="background:#d97706">TC</div>
          <div style="flex:1">
            <div class="feed-name">Tech Corp India</div>
            <div class="feed-time">3 days ago ‚Ä¢ Health</div>
          </div>
        </div>
        <div class="feed-body">
          üè• Free health checkup camp organized for 100+ women in rural area. Eye testing, blood pressure 
          screening & nutrition counseling provided. Proud to support FWF's mission!
        </div>
        <div class="feed-actions">
          <button><i class="fa-regular fa-heart"></i> 67</button>
          <button><i class="fa-regular fa-comment"></i> 22</button>
          <button><i class="fa-solid fa-share"></i> Share</button>
        </div>
      </div>

      <!-- Empty state for no posts -->
      <div class="content-card" style="text-align:center;padding:40px 20px;display:none" id="emptyFeedState">
        <i class="fa-solid fa-book-open" style="font-size:48px;color:var(--text-muted);opacity:.5;margin-bottom:12px"></i>
        <h4 style="font-size:16px;font-weight:800;margin-bottom:6px">No posts yet</h4>
        <p style="color:var(--text-muted);font-size:13px;margin-bottom:16px">Be the first to share your social work story!</p>
        <button class="btn btn-primary" onclick="openModal('postModal')"><i class="fa-solid fa-plus"></i> Create First Post</button>
      </div>
    </div>
  </div>

  <!-- ===================== TRAINING & COURSES ===================== -->
  <div class="page" id="page-training">
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="available-courses">Available Courses</button>
      <button class="tab-btn" data-tab="my-courses">My Courses</button>
      <button class="tab-btn" data-tab="certificates">Certificates</button>
    </div>

    <div class="tab-content active" id="available-courses">
      <div class="grid-3">
        <div class="course-card">
          <div class="course-thumb" style="background:#E87722"><i class="fa-solid fa-scissors"></i></div>
          <div class="course-info">
            <h4>Tailoring & Stitching</h4>
            <p>Learn complete tailoring from basic to advanced level</p>
            <div class="course-status">
              <span style="color:var(--success)"><i class="fa-solid fa-clock"></i> 4 Weeks</span>
              <span class="badge b-active">Free</span>
            </div>
            <button class="btn btn-primary btn-sm" style="margin-top:10px;width:100%;justify-content:center">Enroll Now</button>
          </div>
        </div>
        <div class="course-card">
          <div class="course-thumb" style="background:#0a8f3f"><i class="fa-solid fa-laptop-code"></i></div>
          <div class="course-info">
            <h4>Basic Computer Skills</h4>
            <p>MS Office, Internet, Email & Digital basics</p>
            <div class="course-status">
              <span style="color:var(--success)"><i class="fa-solid fa-clock"></i> 6 Weeks</span>
              <span class="badge b-active">Free</span>
            </div>
            <button class="btn btn-primary btn-sm" style="margin-top:10px;width:100%;justify-content:center">Enroll Now</button>
          </div>
        </div>
        <div class="course-card">
          <div class="course-thumb" style="background:#d97706"><i class="fa-solid fa-utensils"></i></div>
          <div class="course-info">
            <h4>Food Processing & Packaging</h4>
            <p>Start your own food business from home</p>
            <div class="course-status">
              <span style="color:var(--success)"><i class="fa-solid fa-clock"></i> 3 Weeks</span>
              <span class="badge b-active">Free</span>
            </div>
            <button class="btn btn-primary btn-sm" style="margin-top:10px;width:100%;justify-content:center">Enroll Now</button>
          </div>
        </div>
        <div class="course-card">
          <div class="course-thumb" style="background:#c2185b"><i class="fa-solid fa-palette"></i></div>
          <div class="course-info">
            <h4>Handicraft & Mehndi Art</h4>
            <p>Traditional & modern designs for business</p>
            <div class="course-status">
              <span style="color:var(--success)"><i class="fa-solid fa-clock"></i> 3 Weeks</span>
              <span class="badge b-active">Free</span>
            </div>
            <button class="btn btn-primary btn-sm" style="margin-top:10px;width:100%;justify-content:center">Enroll Now</button>
          </div>
        </div>
        <div class="course-card">
          <div class="course-thumb" style="background:#0097a7"><i class="fa-solid fa-chart-bar"></i></div>
          <div class="course-info">
            <h4>Digital Marketing</h4>
            <p>Social media, SEO & online business skills</p>
            <div class="course-status">
              <span style="color:var(--success)"><i class="fa-solid fa-clock"></i> 5 Weeks</span>
              <span class="badge b-active">Free</span>
            </div>
            <button class="btn btn-primary btn-sm" style="margin-top:10px;width:100%;justify-content:center">Enroll Now</button>
          </div>
        </div>
        <div class="course-card">
          <div class="course-thumb" style="background:#00897b"><i class="fa-solid fa-seedling"></i></div>
          <div class="course-info">
            <h4>Organic Farming</h4>
            <p>Kitchen garden & organic produce business</p>
            <div class="course-status">
              <span style="color:var(--success)"><i class="fa-solid fa-clock"></i> 4 Weeks</span>
              <span class="badge b-active">Free</span>
            </div>
            <button class="btn btn-primary btn-sm" style="margin-top:10px;width:100%;justify-content:center">Enroll Now</button>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="my-courses">
      <div class="content-card">
        <div class="empty-state">
          <i class="fa-solid fa-graduation-cap"></i>
          <p>You haven't enrolled in any course yet. Start learning today!</p>
          <button class="btn btn-primary" style="margin-top:12px" onclick="document.querySelector('[data-tab=available-courses]').click()">Browse Courses</button>
        </div>
      </div>
    </div>

    <div class="tab-content" id="certificates">
      <div class="content-card">
        <div class="empty-state">
          <i class="fa-solid fa-certificate"></i>
          <p>Complete a course to earn your certificate!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== WALLET ===================== -->
  <div class="page" id="page-wallet">
    <!-- Wallet Overview Stats -->
    <div class="stats-row" style="margin-bottom:24px">
      <div class="stat-card" style="cursor:pointer" onclick="scrollToSection('section-points')">
        <div class="s-icon s-purple"><i class="fa-solid fa-star"></i></div>
        <div class="s-label">Total Points</div>
        <div class="s-value" id="walletTotalPoints">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-green"><i class="fa-solid fa-wallet"></i></div>
        <div class="s-label">Wallet Balance</div>
        <div class="s-value" id="walletBalance">‚Çπ0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-amber"><i class="fa-solid fa-arrow-up"></i></div>
        <div class="s-label">Total Earned</div>
        <div class="s-value" id="walletTotalEarned">0</div>
      </div>
      <div class="stat-card">
        <div class="s-icon s-blue"><i class="fa-solid fa-arrow-down"></i></div>
        <div class="s-label">Redeemed</div>
        <div class="s-value" id="walletRedeemed">0</div>
      </div>
    </div>

    <!-- ==================== SECTION 1: PAYMENTS ==================== -->
    <div class="wallet-single-section" style="margin-bottom:24px">
      <h3 class="wallet-section-header"><i class="fa-solid fa-credit-card" style="color:var(--accent)"></i> Payments</h3>
      
      <!-- App Style Tabs -->
      <div class="app-tabs">
        <button class="app-tab active" data-group="activity" data-target="tab-membership">
          <div class="tab-icon"><i class="fa-solid fa-credit-card"></i></div>
          <span class="tab-label">Membership</span>
        </button>
        <button class="app-tab" data-group="activity" data-target="tab-donations">
          <div class="tab-icon"><i class="fa-solid fa-hand-holding-heart"></i></div>
          <span class="tab-label">Donations</span>
        </button>
      </div>
      <div class="app-tab-divider"></div>

      <!-- Tab: Membership Details -->
      <div class="app-tab-body" id="tab-membership">
        <h4 style="margin-bottom:12px;font-size:14px;font-weight:800"><i class="fa-solid fa-credit-card" style="color:var(--info)"></i> Membership Fees & Invoices</h4>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Date</th><th>Amount</th><th>Status</th><th>Invoice</th></tr></thead>
            <tbody id="membershipFeesBody">
              <tr><td colspan="4" class="empty-state"><p>No records yet</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tab: My Donations -->
      <div class="app-tab-body" id="tab-donations" style="display:none">
        <h4 style="margin-bottom:12px;font-size:14px;font-weight:800"><i class="fa-solid fa-hand-holding-heart" style="color:var(--success)"></i> My Donation History</h4>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Donor</th><th>Amount</th><th>Points</th><th>Date</th></tr></thead>
            <tbody id="myDonationsBody">
              <tr><td colspan="4" class="empty-state"><p>No donations yet</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ==================== SECTION 3: POINTS ==================== -->
    <div class="wallet-single-section" id="section-points">
      <h3 class="wallet-section-header" style="padding-bottom:18px"><i class="fa-solid fa-star" style="color:var(--accent)"></i> Points Management</h3>
      <div class="app-tab-divider"></div>
      <div style="padding:18px 20px 20px">
      
      <!-- Points Breakdown -->
      <div class="stats-row" style="margin-bottom:20px">
        <div class="stat-card">
          <div class="s-icon s-purple"><i class="fa-solid fa-star"></i></div>
          <div class="s-label">Total Points</div>
          <div class="s-value" id="wPoints">0</div>
        </div>
        <div class="stat-card">
          <div class="s-icon s-green"><i class="fa-solid fa-hand-holding-heart"></i></div>
          <div class="s-label">From Donations</div>
          <div class="s-value" id="wDonPts">0</div>
        </div>
        <div class="stat-card">
          <div class="s-icon s-blue"><i class="fa-solid fa-user-plus"></i></div>
          <div class="s-label">From Referrals</div>
          <div class="s-value" id="wRefPts">0</div>
        </div>
        <div class="stat-card">
          <div class="s-icon s-amber"><i class="fa-solid fa-ticket"></i></div>
          <div class="s-label">From Quiz Tickets</div>
          <div class="s-value" id="wQuizPts">0</div>
        </div>
      </div>

      <div class="grid-2">
        <!-- Redeem Action Card -->
        <div class="content-card" style="background:var(--accent);color:#fff;border:none">
          <div style="display:flex;flex-direction:column;gap:12px;align-items:center;text-align:center;padding:18px">
            <div style="width:52px;height:52px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:24px">
              <i class="fa-solid fa-gift"></i>
            </div>
            <h4 style="margin:0;font-size:17px;font-weight:800">Redeem Points</h4>
            <p style="font-size:12px;opacity:.9;margin:0">Convert your points to support social causes and make a difference</p>
            <button class="btn" onclick="openRedeemModal()" style="background:#fff;color:var(--accent);font-weight:700;margin-top:6px">
              <i class="fa-solid fa-arrow-right"></i> Start Redeeming
            </button>
          </div>
        </div>

        <!-- Points Summary -->
        <div class="content-card">
          <h4 style="margin-bottom:12px;font-size:14px;font-weight:800"><i class="fa-solid fa-chart-pie"></i> Points Summary</h4>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-1);border-radius:8px">
              <span style="font-size:12px;font-weight:700;color:var(--text-secondary)"><i class="fa-solid fa-hand-holding-heart" style="color:var(--success)"></i> Donations</span>
              <span style="font-weight:900;color:var(--success)" id="pointsDonSummary">0 pts</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-1);border-radius:8px">
              <span style="font-size:12px;font-weight:700;color:var(--text-secondary)"><i class="fa-solid fa-user-plus" style="color:var(--info)"></i> Referrals</span>
              <span style="font-weight:900;color:var(--info)" id="pointsRefSummary">0 pts</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-1);border-radius:8px">
              <span style="font-size:12px;font-weight:700;color:var(--text-secondary)"><i class="fa-solid fa-ticket" style="color:var(--warning)"></i> Quiz Tickets</span>
              <span style="font-weight:900;color:var(--warning)" id="pointsQuizSummary">0 pts</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Points History -->
      <div class="content-card" style="margin-top:16px">
        <h4 style="margin-bottom:12px;font-size:14px;font-weight:800"><i class="fa-solid fa-clock-rotate-left"></i> Points History</h4>
        <div class="table-wrap">
          <table class="data-table">
            <thead><tr><th>Type</th><th>Points</th><th>Description</th><th>Date</th></tr></thead>
            <tbody id="pointsHistoryBody">
              <tr><td colspan="4" class="empty-state"><p>No points earned yet</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
      </div>
    </div>

  </div>
  <div class="modal" id="redeemModal">
    <div class="modal-content" style="max-width:600px">
      <div class="modal-header">
        <h3><i class="fa-solid fa-gift"></i> Redeem Points for Social Cause</h3>
        <button class="modal-close" onclick="closeModal('redeemModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div style="background:var(--accent-soft);padding:14px;border-radius:10px;margin-bottom:16px;text-align:center">
          <div style="font-size:12px;color:var(--text-muted);font-weight:700">Available Points</div>
          <div style="font-size:32px;font-weight:900;color:var(--accent)" id="availPointsDisplay">0</div>
        </div>

        <div class="form-group">
          <label>Points to Redeem</label>
          <input type="number" class="form-input" id="redeemPointsInput" placeholder="Enter points" min="1">
        </div>

        <div class="form-group">
          <label>Social Cause</label>
          <select class="form-input" id="socialCauseSelect">
            <option value="">Select a cause</option>
            <option value="Scholarship">Scholarship Program</option>
            <option value="Tree Plantation">Tree Plantation Drive</option>
            <option value="Food Distribution">Food Distribution</option>
            <option value="Health Camp">Health Camp Support</option>
            <option value="Women Empowerment">Women Empowerment Fund</option>
            <option value="Clean Water">Clean Water Initiative</option>
          </select>
        </div>

        <div class="form-group">
          <label>Payment Method</label>
          <div style="display:flex;gap:16px;margin-top:8px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="radio" name="paymentMethod" value="bank" id="bankRadio" checked>
              <span>Bank Account</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="radio" name="paymentMethod" value="upi" id="upiRadio">
              <span>UPI</span>
            </label>
          </div>
        </div>

        <!-- Bank Details Section -->
        <div id="bankDetailsSection">
          <div class="form-row">
            <div class="form-group">
              <label>Account Number</label>
              <input type="text" class="form-input" id="accNumber1" placeholder="Account number">
            </div>
            <div class="form-group">
              <label>Confirm Account Number</label>
              <input type="text" class="form-input" id="accNumber2" placeholder="Re-enter account">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>IFSC Code</label>
              <input type="text" class="form-input" id="ifscCode" placeholder="IFSC code">
            </div>
            <div class="form-group">
              <label>Bank Name</label>
              <input type="text" class="form-input" id="bankName" placeholder="Bank name">
            </div>
          </div>
          <div class="form-group">
            <label>Account Holder Name</label>
            <input type="text" class="form-input" id="accHolder" placeholder="As per bank records">
          </div>
        </div>

        <!-- UPI Section -->
        <div id="upiDetailsSection" style="display:none">
          <div class="form-group">
            <label>UPI ID</label>
            <input type="text" class="form-input" id="upiId" placeholder="yourname@paytm">
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="closeModal('redeemModal')">Cancel</button>
        <button class="btn btn-success" id="submitRedeemBtn" onclick="submitRedeemRequest()"><i class="fa-solid fa-check"></i> Submit Request</button>
      </div>
    </div>

  </div>


  <!-- ===================== REFERRAL & EARN ===================== -->
  <div class="page" id="page-referral">
    <!-- ==================== SECTION 2: REFERRALS & ACTIONS ==================== -->
    <div class="wallet-single-section" style="margin-bottom:24px">
      <h3 class="wallet-section-header"><i class="fa-solid fa-user-plus" style="color:var(--accent)"></i> Referrals & Actions</h3>

      <!-- Referral Code Bar -->
      <div style="margin:14px 20px 0;background:var(--accent-light);border:1px solid #f5c99d;border-radius:var(--radius-md);padding:14px 16px">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
          <div>
            <h4 style="margin:0 0 4px;font-size:13px;color:#b8591a"><i class="fa-solid fa-link"></i> Your Referral Code</h4>
            <p style="font-size:11px;color:#c9621a;margin:0">Share with friends to earn 250 points!</p>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <input type="text" class="form-input" id="refCode" readonly style="font-weight:900;font-size:15px;text-align:center;max-width:180px;background:#fff;padding:8px 12px">
            <button class="btn btn-ghost" onclick="copyRefCode()" style="background:#fff;padding:8px 12px"><i class="fa-solid fa-copy"></i></button>
          </div>
        </div>
      </div>

      <!-- Action Cards Grid -->
      <div class="action-cards-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;padding:18px 20px 4px">

        <!-- Card: Add Member -->
        <div onclick="openActionModal('addMember')" style="background:#fff;border:1.5px solid #ffe0b2;border-radius:16px;padding:20px;cursor:pointer;transition:.2s;position:relative;overflow:hidden"
             onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 24px rgba(232,119,34,.18)'"
             onmouseout="this.style.transform='';this.style.boxShadow=''">
          <div style="width:46px;height:46px;background:linear-gradient(135deg,#ff9a3c,#e87722);border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:12px">
            <i class="fa-solid fa-user-plus" style="color:#fff;font-size:18px"></i>
          </div>
          <div style="font-size:12px;font-weight:800;color:var(--accent);background:rgba(232,119,34,.1);border-radius:20px;padding:2px 8px;display:inline-block;margin-bottom:8px">+250 Points</div>
          <h4 style="font-size:15px;font-weight:800;color:var(--text-primary);margin-bottom:4px">Add Member</h4>
          <p style="font-size:12px;color:var(--text-muted);margin:0;line-height:1.5">Register a new member with ‚Çπ500 payment. You earn 250 points instantly!</p>
          <div style="position:absolute;bottom:16px;right:16px;width:28px;height:28px;background:var(--accent-light);border-radius:50%;display:flex;align-items:center;justify-content:center">
            <i class="fa-solid fa-arrow-right" style="color:var(--accent);font-size:11px"></i>
          </div>
        </div>

        <!-- Card: Add Supporter -->
        <div onclick="openActionModal('addSupporter')" style="background:#fff;border:1.5px solid #c8f7db;border-radius:16px;padding:20px;cursor:pointer;transition:.2s;position:relative;overflow:hidden"
             onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 24px rgba(10,143,63,.15)'"
             onmouseout="this.style.transform='';this.style.boxShadow=''">
          <div style="width:46px;height:46px;background:linear-gradient(135deg,#34d366,#0a8f3f);border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:12px">
            <i class="fa-solid fa-hands-helping" style="color:#fff;font-size:18px"></i>
          </div>
          <div style="font-size:12px;font-weight:800;color:#0a8f3f;background:rgba(10,143,63,.1);border-radius:20px;padding:2px 8px;display:inline-block;margin-bottom:8px">10% Back</div>
          <h4 style="font-size:15px;font-weight:800;color:var(--text-primary);margin-bottom:4px">Add Supporter</h4>
          <p style="font-size:12px;color:var(--text-muted);margin:0;line-height:1.5">Bring a new supporter on board and earn 100 referral points.</p>
          <div style="position:absolute;bottom:16px;right:16px;width:28px;height:28px;background:#f0fdf4;border-radius:50%;display:flex;align-items:center;justify-content:center">
            <i class="fa-solid fa-arrow-right" style="color:#0a8f3f;font-size:11px"></i>
          </div>
        </div>

        <!-- Card: Receive Donation -->
        <div onclick="openActionModal('donation')" style="background:#fff;border:1.5px solid #dbeafe;border-radius:16px;padding:20px;cursor:pointer;transition:.2s;position:relative;overflow:hidden"
             onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 24px rgba(26,115,232,.15)'"
             onmouseout="this.style.transform='';this.style.boxShadow=''">
          <div style="width:46px;height:46px;background:linear-gradient(135deg,#4f9ef8,#1a73e8);border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:12px">
            <i class="fa-solid fa-hand-holding-heart" style="color:#fff;font-size:18px"></i>
          </div>
          <div style="font-size:12px;font-weight:800;color:#1a73e8;background:rgba(26,115,232,.1);border-radius:20px;padding:2px 8px;display:inline-block;margin-bottom:8px">10% Back</div>
          <h4 style="font-size:15px;font-weight:800;color:var(--text-primary);margin-bottom:4px">Record Donation</h4>
          <p style="font-size:12px;color:var(--text-muted);margin:0;line-height:1.5">Record a donation you collected and earn 10% as reward points.</p>
          <div style="position:absolute;bottom:16px;right:16px;width:28px;height:28px;background:#eff6ff;border-radius:50%;display:flex;align-items:center;justify-content:center">
            <i class="fa-solid fa-arrow-right" style="color:#1a73e8;font-size:11px"></i>
          </div>
        </div>

        <!-- Card: Sell Ticket -->
        <div onclick="openActionModal('sellTicket')" style="background:#fff;border:1.5px solid #fef3c7;border-radius:16px;padding:20px;cursor:pointer;transition:.2s;position:relative;overflow:hidden"
             onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 24px rgba(229,161,0,.15)'"
             onmouseout="this.style.transform='';this.style.boxShadow=''">
          <div style="width:46px;height:46px;background:linear-gradient(135deg,#fbbf24,#e5a100);border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:12px">
            <i class="fa-solid fa-ticket" style="color:#fff;font-size:18px"></i>
          </div>
          <div style="font-size:12px;font-weight:800;color:#b45309;background:rgba(180,83,9,.1);border-radius:20px;padding:2px 8px;display:inline-block;margin-bottom:8px">10% Back</div>
          <h4 style="font-size:15px;font-weight:800;color:var(--text-primary);margin-bottom:4px">Sell Quiz Ticket</h4>
          <p style="font-size:12px;color:var(--text-muted);margin:0;line-height:1.5">Sold a quiz ticket? Record it and earn 10% of the ticket price.</p>
          <div style="position:absolute;bottom:16px;right:16px;width:28px;height:28px;background:#fffbeb;border-radius:50%;display:flex;align-items:center;justify-content:center">
            <i class="fa-solid fa-arrow-right" style="color:#e5a100;font-size:11px"></i>
          </div>
        </div>
      </div>

      <!-- Referral Tracking Table -->
      <div style="padding:4px 20px 20px">
        <div style="border-top:1px solid var(--card-border);padding-top:16px;margin-top:10px">
          <h4 style="margin-bottom:12px;font-size:14px;font-weight:800"><i class="fa-solid fa-list"></i> My Referrals</h4>
          <div class="table-wrap">
            <table class="data-table">
              <thead><tr><th>Name</th><th>Member ID</th><th>Amount</th><th>Points</th><th>Status</th><th>Date</th></tr></thead>
              <tbody id="referralsBody">
                <tr><td colspan="6" class="empty-state"><p>No referrals yet</p></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ MODAL: Add Member (with Razorpay) ============ -->
    <div id="modalAddMember" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9000;align-items:center;justify-content:center;padding:16px">
      <div style="background:#fff;border-radius:20px;width:100%;max-width:480px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25)">
        <div style="background:linear-gradient(135deg,#ff9a3c,#e87722);padding:20px 24px 16px;position:relative">
          <h3 style="color:#fff;margin:0;font-size:17px;font-weight:800"><i class="fa-solid fa-user-plus"></i> Add New Member</h3>
          <p style="color:rgba(255,255,255,.8);font-size:12px;margin:4px 0 0">Register & earn <strong>250 points</strong> on successful payment</p>
          <button onclick="closeActionModal('addMember')" style="position:absolute;top:14px;right:16px;background:rgba(255,255,255,.2);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:14px">‚úï</button>
        </div>
        <div style="padding:22px 24px 24px">
          <div id="amStep1">
            <div style="display:grid;gap:12px">
              <div class="form-group" style="margin:0">
                <label>Full Name *</label>
                <input type="text" class="form-input" id="amName" placeholder="New member's full name">
              </div>
              <div class="form-group" style="margin:0">
                <label>Mobile Number *</label>
                <input type="tel" class="form-input" id="amMobile" placeholder="10-digit mobile" maxlength="10">
              </div>
              <div class="form-group" style="margin:0">
                <label>Email *</label>
                <input type="email" class="form-input" id="amEmail" placeholder="member@email.com">
              </div>
            </div>
            <div style="background:#fff8f0;border:1px solid #f5c99d;border-radius:10px;padding:12px 14px;margin-top:14px;font-size:12px;color:#b8591a">
              <i class="fa-solid fa-circle-info"></i> Payment of <strong>‚Çπ500</strong> will be collected via Razorpay. Login credentials will be generated automatically.
            </div>
            <button id="amPayBtn" onclick="startMemberPayment()" style="width:100%;margin-top:16px;background:linear-gradient(135deg,#ff9a3c,#e87722);color:#fff;border:none;border-radius:12px;padding:13px;font-size:14px;font-weight:800;cursor:pointer">
              <i class="fa-solid fa-lock"></i> Proceed to Pay ‚Çπ500
            </button>
          </div>
          <!-- Success step -->
          <div id="amStep2" style="display:none;text-align:center">
            <div style="font-size:40px;margin-bottom:8px">üéâ</div>
            <h4 style="color:var(--success);font-size:16px;font-weight:800;margin-bottom:4px">Member Added!</h4>
            <p style="color:var(--text-muted);font-size:12px;margin-bottom:16px">Share these credentials with the new member</p>
            <div style="background:#f8fffe;border:1.5px solid #a7f3d0;border-radius:12px;padding:16px;text-align:left">
              <div style="margin-bottom:8px"><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;font-weight:700">Member ID</span><br><strong id="amResultId" style="font-size:16px;color:var(--accent)"></strong></div>
              <div><span style="font-size:11px;color:var(--text-muted);text-transform:uppercase;font-weight:700">Password</span><br><strong id="amResultPass" style="font-size:16px;font-family:monospace;background:#f1f5f9;padding:4px 8px;border-radius:6px;color:#d93025"></strong></div>
            </div>
            <p id="amResultPoints" style="margin-top:12px;font-size:13px;color:var(--success);font-weight:700"></p>
            <button onclick="closeActionModal('addMember')" style="margin-top:14px;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 28px;font-size:13px;font-weight:700;cursor:pointer">Done</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ MODAL: Add Supporter (with Razorpay) ============ -->
    <div id="modalAddSupporter" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9000;align-items:center;justify-content:center;padding:16px">
      <div style="background:#fff;border-radius:20px;width:100%;max-width:480px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25)">
        <div style="background:linear-gradient(135deg,#34d366,#0a8f3f);padding:20px 24px 16px;position:relative">
          <h3 style="color:#fff;margin:0;font-size:17px;font-weight:800"><i class="fa-solid fa-hands-helping"></i> Add Supporter</h3>
          <p style="color:rgba(255,255,255,.8);font-size:12px;margin:4px 0 0">Earn <strong>10% back</strong> of the supporter's joining amount as points!</p>
          <button onclick="closeActionModal('addSupporter')" style="position:absolute;top:14px;right:16px;background:rgba(255,255,255,.2);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:14px">‚úï</button>
        </div>
        <div style="padding:22px 24px 24px">
          <div id="spStep1">
            <div style="display:grid;gap:12px">
              <div class="form-group" style="margin:0">
                <label>Supporter Name *</label>
                <input type="text" class="form-input" id="spName" placeholder="Full name">
              </div>
              <div class="form-group" style="margin:0">
                <label>Mobile / Email *</label>
                <input type="text" class="form-input" id="spContact" placeholder="Phone or email">
              </div>
              <div class="form-group" style="margin:0">
                <label>Joining Amount (‚Çπ) *</label>
                <input type="number" class="form-input" id="spAmount" placeholder="e.g. 500" min="1" value="500">
              </div>
              <div class="form-group" style="margin:0">
                <label>Notes (optional)</label>
                <input type="text" class="form-input" id="spNotes" placeholder="e.g. Corporate, Local leader">
              </div>
            </div>
            <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:10px;padding:12px 14px;margin-top:14px;font-size:12px;color:#166534">
              <i class="fa-solid fa-circle-info"></i> You earn <strong>10%</strong> of the supporter's payment as reward points. e.g. ‚Çπ500 ‚Üí <strong>5 points</strong>.
            </div>
            <button id="spPayBtn" onclick="startSupporterPayment()" style="width:100%;margin-top:16px;background:linear-gradient(135deg,#34d366,#0a8f3f);color:#fff;border:none;border-radius:12px;padding:13px;font-size:14px;font-weight:800;cursor:pointer">
              <i class="fa-solid fa-lock"></i> Proceed to Payment
            </button>
          </div>
          <!-- Success step -->
          <div id="spStep2" style="display:none;text-align:center">
            <div style="font-size:40px;margin-bottom:8px">üéâ</div>
            <h4 style="color:var(--success);font-size:16px;font-weight:800;margin-bottom:4px">Supporter Added!</h4>
            <p id="spResultPoints" style="color:var(--text-muted);font-size:13px;margin-bottom:16px"></p>
            <button onclick="closeActionModal('addSupporter')" style="background:linear-gradient(135deg,#34d366,#0a8f3f);color:#fff;border:none;border-radius:10px;padding:10px 28px;font-size:13px;font-weight:700;cursor:pointer">Done</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ MODAL: Record Donation ============ -->
    <div id="modalDonation" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9000;align-items:center;justify-content:center;padding:16px">
      <div style="background:#fff;border-radius:20px;width:100%;max-width:440px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25)">
        <div style="background:linear-gradient(135deg,#4f9ef8,#1a73e8);padding:20px 24px 16px;position:relative">
          <h3 style="color:#fff;margin:0;font-size:17px;font-weight:800"><i class="fa-solid fa-hand-holding-heart"></i> Record Donation</h3>
          <p style="color:rgba(255,255,255,.8);font-size:12px;margin:4px 0 0">Earn <strong>10%</strong> of the donated amount as reward points</p>
          <button onclick="closeActionModal('donation')" style="position:absolute;top:14px;right:16px;background:rgba(255,255,255,.2);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:14px">‚úï</button>
        </div>
        <div style="padding:22px 24px 24px;display:grid;gap:12px">
          <div class="form-group" style="margin:0">
            <label>Donation Amount (‚Çπ) *</label>
            <input type="number" class="form-input" id="donAmount" placeholder="e.g. 1000" min="1">
          </div>
          <div class="form-group" style="margin:0">
            <label>Donor Name *</label>
            <input type="text" class="form-input" id="donName" placeholder="Donor's name">
          </div>
          <div class="form-group" style="margin:0">
            <label>Donor Contact</label>
            <input type="text" class="form-input" id="donContact" placeholder="Phone or email">
          </div>
          <button id="donBtn" onclick="submitDonation()" style="background:linear-gradient(135deg,#4f9ef8,#1a73e8);color:#fff;border:none;border-radius:12px;padding:13px;font-size:14px;font-weight:800;cursor:pointer;margin-top:4px">
            <i class="fa-solid fa-plus"></i> Record Donation
          </button>
        </div>
      </div>
    </div>

    <!-- ============ MODAL: Sell Quiz Ticket ============ -->
    <div id="modalSellTicket" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9000;align-items:center;justify-content:center;padding:16px">
      <div style="background:#fff;border-radius:20px;width:100%;max-width:440px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25)">
        <div style="background:linear-gradient(135deg,#fbbf24,#e5a100);padding:20px 24px 16px;position:relative">
          <h3 style="color:#fff;margin:0;font-size:17px;font-weight:800"><i class="fa-solid fa-ticket"></i> Sell Quiz Ticket</h3>
          <p style="color:rgba(255,255,255,.8);font-size:12px;margin:4px 0 0">Earn <strong>10%</strong> of the ticket price as reward points</p>
          <button onclick="closeActionModal('sellTicket')" style="position:absolute;top:14px;right:16px;background:rgba(255,255,255,.2);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:14px">‚úï</button>
        </div>
        <div style="padding:22px 24px 24px;display:grid;gap:12px">
          <div class="form-group" style="margin:0">
            <label>Buyer Name *</label>
            <input type="text" class="form-input" id="tickBuyer" placeholder="Buyer's full name">
          </div>
          <div class="form-group" style="margin:0">
            <label>Buyer Contact</label>
            <input type="text" class="form-input" id="tickContact" placeholder="Phone or email">
          </div>
          <div class="form-group" style="margin:0">
            <label>Ticket Price (‚Çπ)</label>
            <input type="number" class="form-input" id="tickPrice" value="100" min="1">
          </div>
          <button id="tickBtn" onclick="submitTicket()" style="background:linear-gradient(135deg,#fbbf24,#e5a100);color:#fff;border:none;border-radius:12px;padding:13px;font-size:14px;font-weight:800;cursor:pointer;margin-top:4px">
            <i class="fa-solid fa-plus"></i> Record Ticket Sale
          </button>
        </div>
      </div>
    </div>


    <!-- ==================== SECTION 4: AFFILIATE / REFERRAL TRACKING ==================== -->
    <div class="wallet-single-section" style="margin-bottom:24px">
      <h3 class="wallet-section-header"><i class="fa-solid fa-chart-line" style="color:var(--accent)"></i> Affiliate Dashboard</h3>
      <div class="app-tab-divider"></div>

      <div style="padding:18px 20px 20px">
        <!-- Affiliate Stats -->
        <div class="stats-row" style="margin-bottom:16px">
          <div class="stat-card">
            <div class="s-icon s-purple"><i class="fa-solid fa-mouse-pointer"></i></div>
            <div class="s-label">Total Clicks</div>
            <div class="s-value" id="affTotalClicks">0</div>
          </div>
          <div class="stat-card">
            <div class="s-icon s-green"><i class="fa-solid fa-check-circle"></i></div>
            <div class="s-label">Conversions</div>
            <div class="s-value" id="affConversions">0</div>
          </div>
          <div class="stat-card">
            <div class="s-icon s-blue"><i class="fa-solid fa-gamepad"></i></div>
            <div class="s-label">Quiz Referrals</div>
            <div class="s-value" id="affQuizClicks">0</div>
          </div>
          <div class="stat-card">
            <div class="s-icon s-amber"><i class="fa-solid fa-indian-rupee-sign"></i></div>
            <div class="s-label">Revenue Generated</div>
            <div class="s-value" id="affRevenue">‚Çπ0</div>
          </div>
        </div>

        <!-- Referral Links -->
        <div class="content-card" style="background:linear-gradient(135deg,#FFF4EB,#FFE8D6);border:1px solid #f5c99d">
          <h4 style="margin-bottom:8px;font-size:14px;font-weight:800;color:#b8591a"><i class="fa-solid fa-link"></i> ‡§Ö‡§™‡§®‡§æ Referral Link Share ‡§ï‡§∞‡•á‡§Ç</h4>
          <div class="form-group" style="margin-bottom:8px">
            <label style="font-size:12px;color:#c9621a">Join Referral Link</label>
            <div style="display:flex;gap:8px">
              <input type="text" class="form-input" id="affJoinLink" readonly style="font-size:11px;background:#fff">
              <button class="btn btn-sm" onclick="copyAffLink('affJoinLink')" style="background:var(--accent);color:#fff;white-space:nowrap"><i class="fa-solid fa-copy"></i></button>
            </div>
          </div>
          <div class="form-group" style="margin-bottom:8px">
            <label style="font-size:12px;color:#c9621a">Quiz Referral Link</label>
            <div style="display:flex;gap:8px">
              <input type="text" class="form-input" id="affQuizLink" readonly style="font-size:11px;background:#fff">
              <button class="btn btn-sm" onclick="copyAffLink('affQuizLink')" style="background:var(--accent);color:#fff;white-space:nowrap"><i class="fa-solid fa-copy"></i></button>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn btn-sm" onclick="shareAffLink('whatsapp')" style="background:#25d366;color:#fff;flex:1"><i class="fa-brands fa-whatsapp"></i> WhatsApp</button>
            <button class="btn btn-sm" onclick="shareAffLink('telegram')" style="background:#0088cc;color:#fff;flex:1"><i class="fa-brands fa-telegram"></i> Telegram</button>
            <button class="btn btn-sm" onclick="shareAffLink('copy')" style="background:var(--accent);color:#fff;flex:1"><i class="fa-solid fa-share"></i> Share</button>
          </div>
        </div>

        <!-- Quiz Referral Earnings -->
        <div class="content-card" style="margin-top:12px">
          <h4 style="margin-bottom:12px;font-size:14px;font-weight:800"><i class="fa-solid fa-coins"></i> Quiz Referral Earnings</h4>
          <div class="table-wrap">
            <table class="data-table">
              <thead><tr><th>Description</th><th>Points</th><th>Date</th></tr></thead>
              <tbody id="affQuizEarningsBody">
                <tr><td colspan="3" class="empty-state"><p>No quiz referral earnings yet</p></td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Recent Click Activity -->
        <div class="content-card" style="margin-top:12px">
          <h4 style="margin-bottom:12px;font-size:14px;font-weight:800"><i class="fa-solid fa-clock-rotate-left"></i> Recent Click Activity</h4>
          <div class="table-wrap">
            <table class="data-table">
              <thead><tr><th>Type</th><th>Converted</th><th>Amount</th><th>Date</th></tr></thead>
              <tbody id="affRecentClicksBody">
                <tr><td colspan="4" class="empty-state"><p>No click activity yet</p></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== MARKETPLACE ===================== -->
  <div class="page" id="page-marketplace">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
      <h3 style="font-size:16px;font-weight:800"><i class="fa-solid fa-store" style="color:var(--accent)"></i> Member Marketplace</h3>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input type="text" class="form-input" id="marketSearch" placeholder="Search products..." style="max-width:200px;padding:8px 12px;font-size:13px">
        <select class="form-input" id="marketCatFilter" style="max-width:180px;padding:8px 12px;font-size:13px" onchange="loadMarketProducts()">
          <option value="">All Categories</option>
        </select>
        <select class="form-input" id="marketSort" style="max-width:160px;padding:8px 12px;font-size:13px" onchange="loadMarketProducts()">
          <option value="">Featured</option>
          <option value="newest">Newest</option>
          <option value="price-low">Price: Low ‚Üí High</option>
          <option value="price-high">Price: High ‚Üí Low</option>
          <option value="popular">Most Popular</option>
        </select>
        <a href="store.html" class="btn btn-primary btn-sm" target="_blank"><i class="fa-solid fa-external-link"></i> Full Store</a>
      </div>
    </div>
    <div class="grid-3" id="marketGrid">
      <div class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i><p>Loading products...</p></div>
    </div>
    <div id="marketPagination" style="display:flex;justify-content:center;gap:6px;margin-top:16px"></div>
  </div>

  <!-- ===================== SELLER PANEL ===================== -->
  <div class="page" id="page-seller">
    <div class="stats-row" style="grid-template-columns:repeat(4,1fr)">
      <div class="stat-card">
        <div class="seller-stat">
          <div class="val" id="selProducts">0</div>
          <div class="lbl">Products</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="seller-stat">
          <div class="val" id="selApproved">0</div>
          <div class="lbl">Approved</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="seller-stat">
          <div class="val" id="selOrders">0</div>
          <div class="lbl">Total Orders</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="seller-stat">
          <div class="val" id="selEarnings">‚Çπ0</div>
          <div class="lbl">Earnings</div>
        </div>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
      <h3 style="font-size:16px;font-weight:800"><i class="fa-solid fa-boxes-stacked" style="color:var(--accent)"></i> Your Products</h3>
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="openModal('aiListingModal')" style="background:linear-gradient(135deg,#E87722,#c9621a);color:#fff;font-weight:700;border:none;display:flex;align-items:center;gap:6px"><i class="fa-solid fa-wand-magic-sparkles"></i> FWF Assistant</button>
        <button class="btn btn-primary" onclick="openModal('addProductModal')"><i class="fa-solid fa-plus"></i> Add Product</button>
      </div>
    </div>

    <div class="content-card" id="sellerProductsList">
      <div class="empty-state">
        <i class="fa-solid fa-spinner fa-spin"></i>
        <p>Loading your products...</p>
      </div>
    </div>

    <div class="content-card" style="margin-top:18px">
      <h3 style="margin-bottom:12px"><i class="fa-solid fa-receipt"></i> Recent Orders</h3>
      <div class="table-wrap">
        <table class="data-table">
          <thead><tr><th>Order ID</th><th>Product</th><th>Buyer</th><th>Qty</th><th>Amount</th><th>Status</th><th>Date</th></tr></thead>
          <tbody id="sellerOrdersBody">
            <tr><td colspan="7" class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i><p>Loading...</p></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===================== EVENTS & ACTIVITIES ===================== -->
  <div class="page" id="page-events">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MY ACTIVITY (compact) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div style="margin-bottom:20px">
      <h3 style="font-size:15px;font-weight:800;margin:0 0 12px"><i class="fa-solid fa-chart-line" style="color:var(--accent)"></i> My Activity</h3>
      <div class="stats-row" style="margin-bottom:0">
        <div class="stat-card" style="background:linear-gradient(135deg,#f0fdf4,#dcfce7)">
          <div class="s-icon s-green"><i class="fa-solid fa-check-circle"></i></div>
          <div class="s-label">Tasks Done</div>
          <div class="s-value" id="myTasksCompleted">0</div>
        </div>
        <div class="stat-card" style="background:linear-gradient(135deg,#fef3c7,#fde68a)">
          <div class="s-icon s-amber"><i class="fa-solid fa-gamepad"></i></div>
          <div class="s-label">Quizzes Played</div>
          <div class="s-value" id="myQuizCount">0</div>
        </div>
        <div class="stat-card" style="background:linear-gradient(135deg,#fce7f3,#fbcfe8)">
          <div class="s-icon" style="background:linear-gradient(135deg,#ec4899,#db2777)"><i class="fa-solid fa-trophy"></i></div>
          <div class="s-label">Quiz Wins</div>
          <div class="s-value" id="myQuizWins">0</div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SOCIAL WORK ‚Äî MOTIVATIONAL HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div style="text-align:center;padding:24px 16px 8px">
      <div style="font-size:40px;margin-bottom:4px">üôè</div>
      <h2 style="font-size:20px;font-weight:900;margin:0 0 6px;color:var(--text-primary);line-height:1.3">‡§¨‡§¶‡§≤‡§æ‡§µ ‡§Ü‡§™ ‡§∏‡•á ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã‡§§‡§æ ‡§π‡•à!</h2>
      <p style="font-size:13px;color:var(--text-muted);margin:0;line-height:1.5">‡§è‡§ï ‡§õ‡•ã‡§ü‡§æ ‡§∏‡§æ ‡§ï‡§¶‡§Æ ‚Äî ‡§∏‡§Æ‡§æ‡§ú ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§°‡§º‡§æ ‡§¨‡§¶‡§≤‡§æ‡§µ‡•§ ‡§Ü‡§ú ‡§π‡•Ä ‡§ï‡•ã‡§à ‡§®‡•á‡§ï ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ Selfie share ‡§ï‡§∞‡•á‡§Ç!</p>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SOCIAL TASKS GRID ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div style="margin:16px 0 24px">
      <div id="socialTasksGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:12px">
        <div class="skeleton-loader" style="height:160px;border-radius:16px"></div>
        <div class="skeleton-loader" style="height:160px;border-radius:16px"></div>
        <div class="skeleton-loader" style="height:160px;border-radius:16px"></div>
        <div class="skeleton-loader" style="height:160px;border-radius:16px"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FUND RAISER GAMES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div style="margin-bottom:24px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <h3 style="font-size:15px;font-weight:800;margin:0"><i class="fa-solid fa-trophy" style="color:#e5a100"></i> Fund Raiser Games</h3>
      </div>

      <!-- Game Type Chips -->
      <div style="display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px">
        <button class="game-chip active" data-tier="all" onclick="filterQuizTier('all')" style="display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:20px;border:1.5px solid var(--accent);background:var(--accent);color:#fff;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;transition:.2s">üéØ All Games</button>
        <button class="game-chip" data-tier="monthly" onclick="filterQuizTier('monthly')" style="display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:20px;border:1.5px solid #3b82f6;background:transparent;color:#3b82f6;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;transition:.2s">üóìÔ∏è Monthly ‚Çπ100</button>
        <button class="game-chip" data-tier="half_yearly" onclick="filterQuizTier('half_yearly')" style="display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:20px;border:1.5px solid #8b5cf6;background:transparent;color:#8b5cf6;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;transition:.2s">üìÖ Half-Yearly ‚Çπ500</button>
        <button class="game-chip" data-tier="yearly" onclick="filterQuizTier('yearly')" style="display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:20px;border:1.5px solid #e11d48;background:transparent;color:#e11d48;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap;transition:.2s">üèÜ Yearly ‚Çπ1000</button>
      </div>

      <!-- Quiz Cards Container -->
      <div id="quizGamesGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px">
        <div class="skeleton-loader" style="height:220px;border-radius:16px"></div>
        <div class="skeleton-loader" style="height:220px;border-radius:16px"></div>
      </div>

      <!-- Empty state -->
      <div id="quizEmptyState" style="display:none;text-align:center;padding:40px 20px">
        <div style="font-size:48px;margin-bottom:12px">üéÆ</div>
        <h4 style="color:var(--text-muted);font-weight:700;margin-bottom:6px">‡§ï‡•ã‡§à game ‡§Ö‡§≠‡•Ä available ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à</h4>
        <p style="font-size:13px;color:var(--text-muted)">‡§ú‡§≤‡•ç‡§¶‡•Ä ‡§π‡•Ä ‡§®‡§è fund raiser games ‡§Ü‡§è‡§Ç‡§ó‡•á!</p>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê VIEW TASK & QUIZ HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div style="margin-bottom:20px">
      <details style="background:#fff;border:1px solid var(--card-border);border-radius:14px;overflow:hidden">
        <summary style="padding:14px 16px;cursor:pointer;font-size:13px;font-weight:700;color:var(--text-primary);display:flex;align-items:center;gap:8px">
          <i class="fa-solid fa-clock-rotate-left" style="color:var(--accent)"></i> View Task & Quiz Result
        </summary>
        <div style="padding:0 16px 16px">
          <h4 style="font-size:13px;font-weight:700;margin:8px 0">üìã Task History</h4>
          <div id="taskHistoryList">
            <p style="font-size:12px;color:var(--text-muted);text-align:center;padding:10px 0">‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à task ‡§™‡•Ç‡§∞‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ</p>
          </div>
          <h4 style="font-size:13px;font-weight:700;margin:14px 0 8px">üéÆ Quiz History</h4>
          <div id="quizHistoryList">
            <p style="font-size:12px;color:var(--text-muted);text-align:center;padding:10px 0">‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡§ø‡§∏‡•Ä quiz ‡§Æ‡•á‡§Ç ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§≤‡§ø‡§Ø‡§æ</p>
          </div>
        </div>
      </details>
    </div>

  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SOCIAL TASK POPUP MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="modal" id="socialTaskModal">
    <div class="modal-content" style="max-width:440px;border-radius:20px;overflow:hidden">
      <div id="taskModalHeader" style="padding:20px 20px 14px;color:#fff;position:relative">
        <div style="position:absolute;top:0;right:0;width:100px;height:100px;background:radial-gradient(circle,rgba(255,255,255,.1),transparent);pointer-events:none"></div>
        <button onclick="closeModal('socialTaskModal')" style="position:absolute;top:12px;right:14px;background:rgba(255,255,255,.2);border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:16px">&times;</button>
        <div style="font-size:36px;margin-bottom:6px" id="taskModalIcon">üå±</div>
        <h3 style="color:#fff;margin:0 0 4px;font-size:18px;font-weight:900" id="taskModalTitle">Task Title</h3>
      </div>
      <div style="padding:16px 20px 20px">
        <p style="font-size:13px;color:var(--text-secondary);line-height:1.6;margin:0 0 12px" id="taskModalDesc">Task description...</p>
        <div style="background:#f8fafc;border-radius:12px;padding:12px;margin-bottom:14px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <i class="fa-solid fa-camera" style="color:var(--accent)"></i>
            <span style="font-size:12px;font-weight:700;color:var(--text-primary)">üì∏ How to participate</span>
          </div>
          <p style="font-size:12px;color:var(--text-muted);margin:0;line-height:1.5" id="taskModalInstruction">Photo instruction...</p>
        </div>

        <!-- Selfie section -->
        <div style="border:2px dashed #e5e7eb;border-radius:14px;padding:14px;text-align:center;margin-bottom:14px" id="taskSelfieArea">
          <div id="taskSelfiePreview" style="display:none;margin-bottom:10px">
            <img id="taskSelfieImg" style="max-width:100%;max-height:200px;border-radius:12px">
          </div>
          <label style="display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg,#E87722,#ff9a3c);color:#fff;border-radius:12px;cursor:pointer;font-weight:700;font-size:13px">
            <i class="fa-solid fa-camera"></i> Selfie ‡§≤‡•á‡§Ç / Photo ‡§ö‡•Å‡§®‡•á‡§Ç
            <input type="file" accept="image/*" capture="user" id="taskSelfieInput" onchange="previewTaskSelfie(this)" style="display:none">
          </label>
        </div>

        <button class="btn" id="taskSelfieSubmitBtn" onclick="submitTaskSelfie()" style="width:100%;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;border:none;border-radius:12px;padding:12px;font-weight:800;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px" disabled>
          <i class="fa-solid fa-paper-plane"></i> Selfie Share ‡§ï‡§∞‡•á‡§Ç ‚Äî Social Book ‡§™‡§∞ Post ‡§π‡•ã‡§ó‡§æ!
        </button>
      </div>
    </div>
  </div>

  <!-- ===================== HELP & SUPPORT ===================== -->
  <div class="page" id="page-support">
    <div class="grid-2">
      <div>
        <div class="content-card">
          <h3><i class="fa-solid fa-ticket"></i> Submit Support Ticket</h3>
          <div class="form-group">
            <label>Category</label>
            <select class="form-input" id="supCategory">
              <option value="general">General</option>
              <option value="technical">Technical</option>
              <option value="payment">Payment</option>
              <option value="membership">Membership</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Subject</label>
            <input type="text" class="form-input" id="supSubject" placeholder="Brief subject">
          </div>
          <div class="form-group">
            <label>Message</label>
            <textarea class="form-input" id="supMessage" placeholder="Describe your issue in detail..." rows="4"></textarea>
          </div>
          <button class="btn btn-primary" id="submitTicketBtn"><i class="fa-solid fa-paper-plane"></i> Submit Ticket</button>
        </div>

        <div class="content-card">
          <h3><i class="fa-solid fa-circle-question"></i> Quick Help</h3>
          <div style="display:flex;flex-direction:column;gap:8px">
            <a href="https://wa.me/919580118412" target="_blank" class="btn btn-success" style="justify-content:center"><i class="fa-brands fa-whatsapp"></i> WhatsApp Support</a>
            <a href="mailto:info@fwfindia.org" class="btn btn-ghost" style="justify-content:center"><i class="fa-solid fa-envelope"></i> Email Support</a>
          </div>
        </div>

        <div class="content-card">
          <h3><i class="fa-solid fa-message"></i> FAQ</h3>
          <details style="margin-bottom:8px">
            <summary style="font-weight:700;font-size:13px;cursor:pointer;padding:8px 0">How do I earn reward points?</summary>
            <p style="font-size:12px;color:var(--text-muted);padding:8px 0 8px 16px">Earn points through referrals (50% of joining fee), donation collection (10%), quiz ticket selling (10%), and supporter participation.</p>
          </details>
          <details style="margin-bottom:8px">
            <summary style="font-weight:700;font-size:13px;cursor:pointer;padding:8px 0">How can I redeem my points?</summary>
            <p style="font-size:12px;color:var(--text-muted);padding:8px 0 8px 16px">Go to the "Redeem Points" section and support NGO projects like education kits, health camps, and more.</p>
          </details>
          <details style="margin-bottom:8px">
            <summary style="font-weight:700;font-size:13px;cursor:pointer;padding:8px 0">How does the Marketplace work?</summary>
            <p style="font-size:12px;color:var(--text-muted);padding:8px 0 8px 16px">Members can list handmade/local products for sale. Other members and public users can purchase. Go to Seller Panel to start selling.</p>
          </details>
          <details>
            <summary style="font-weight:700;font-size:13px;cursor:pointer;padding:8px 0">How do I renew my membership?</summary>
            <p style="font-size:12px;color:var(--text-muted);padding:8px 0 8px 16px">Contact support via WhatsApp or email for membership renewal. Annual fee keeps your account active.</p>
          </details>
        </div>
      </div>

      <div>
        <div class="content-card">
          <h3><i class="fa-solid fa-list-check"></i> My Tickets</h3>
          <div class="table-wrap">
            <table class="data-table">
              <thead><tr><th>Ticket</th><th>Subject</th><th>Status</th><th>Reply</th><th>Date</th></tr></thead>
              <tbody id="myTicketsBody">
                <tr><td colspan="5" class="empty-state"><p>No tickets submitted</p></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- ======== MOBILE BOTTOM NAV ======== -->
<nav class="mobile-bottom-nav" id="mobileBottomNav">
  <div class="nav-row">
    <button class="bnav active" data-page="home"><i class="fa-solid fa-house"></i><span>Home</span></button>
    <button class="bnav" data-page="wallet"><i class="fa-solid fa-wallet"></i><span>Wallet</span></button>
    <button class="bnav" data-page="referral"><i class="fa-solid fa-user-plus"></i><span>Referral</span></button>
    <button class="bnav" data-page="training"><i class="fa-solid fa-graduation-cap"></i><span>Learn</span></button>
    <button class="bnav" data-page="profile"><i class="fa-solid fa-user"></i><span>Profile</span></button>
  </div>
</nav>

<!-- ======== MODALS ======== -->

<!-- New Post Modal - WhatsApp Style -->
<div class="modal-overlay hidden" id="postModal">
  <div class="modal-card" style="max-width:480px;background:#fff;border-radius:16px;padding:0;overflow:hidden;display:flex;flex-direction:column;max-height:92vh">
    <!-- Header - WhatsApp green -->
    <div style="background:#075e54;padding:14px 18px;color:#fff;display:flex;align-items:center;gap:12px;flex-shrink:0">
      <button onclick="closeModal('postModal')" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:0;display:flex;align-items:center"><i class="fa-solid fa-arrow-left"></i></button>
      <div class="feed-avatar" id="postModalAvatar" style="width:36px;height:36px;font-size:13px;flex-shrink:0">M</div>
      <div style="flex:1">
        <div style="font-size:15px;font-weight:700">Share Your Impact</div>
        <div style="font-size:11px;opacity:.75">your story inspires others ‚ú®</div>
      </div>
    </div>

    <!-- Scrollable body -->
    <div style="flex:1;overflow-y:auto;background:#e5ddd5;background-image:url('data:image/svg+xml,%3Csvg width=%2220%22 height=%2220%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cpath d=%22M0 0h20v20H0z%22 fill=%22%23e5ddd5%22/%3E%3Cpath d=%22M10 3l1 2 2 .3-1.5 1.4.4 2L10 8l-1.9 .7.4-2L7 5.3l2-.3z%22 fill=%22%23d4ccb5%22 opacity=%22.15%22/%3E%3C/svg%3E')">

      <!-- IMAGE PREVIEW AREA (WhatsApp-style large preview) -->
      <div id="postImageArea" style="display:none;background:#111;position:relative">
        <!-- Large main image -->
        <div id="postMainPreview" style="width:100%;height:280px;overflow:hidden;position:relative">
          <img id="postMainImg" src="" style="width:100%;height:100%;object-fit:cover;display:block;transition:opacity .2s" alt="">
          <!-- Gradient overlay at bottom for thumbnail strip readability -->
          <div style="position:absolute;bottom:0;left:0;right:0;height:80px;background:linear-gradient(to top,rgba(0,0,0,.65),transparent);pointer-events:none"></div>
        </div>
        <!-- Horizontal thumbnail strip (overlaid on bottom of image) -->
        <div id="postThumbStrip" style="display:none;position:absolute;bottom:8px;left:0;right:0;padding:0 10px;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;scrollbar-width:none">
        </div>
        <!-- Add more photos button -->
        <button type="button" onclick="document.getElementById('postMedia').click()" style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);color:#fff;border:none;border-radius:20px;padding:5px 12px;font-size:11px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:4px;font-family:inherit;transition:.2s" onmouseover="this.style.background='rgba(0,0,0,.8)'" onmouseout="this.style.background='rgba(0,0,0,.55)'">
          <i class="fa-solid fa-plus" style="font-size:9px"></i> Add More
        </button>
        <!-- Photo count badge -->
        <div id="postPhotoCount" style="position:absolute;top:10px;left:10px;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);color:#fff;border-radius:20px;padding:4px 10px;font-size:11px;font-weight:700;display:flex;align-items:center;gap:4px">
          <i class="fa-solid fa-image" style="font-size:10px"></i> <span id="postPhotoNum">0</span>
        </div>
      </div>

      <!-- ADD PHOTO PROMPT (shown when no images) -->
      <div id="postAddPhotoPrompt" style="padding:16px">
        <div onclick="document.getElementById('postMedia').click()" style="background:rgba(255,255,255,.6);border:2px dashed #b8b8b8;border-radius:14px;padding:28px 16px;text-align:center;cursor:pointer;transition:all .2s" onmouseover="this.style.borderColor='#25d366';this.style.background='rgba(255,255,255,.85)'" onmouseout="this.style.borderColor='#b8b8b8';this.style.background='rgba(255,255,255,.6)'">
          <i class="fa-solid fa-camera-retro" style="font-size:32px;color:#075e54;margin-bottom:8px;display:block"></i>
          <div style="font-size:14px;font-weight:700;color:#303030">Add Photos</div>
          <div style="font-size:11px;color:#667781;margin-top:2px">Tap to upload from gallery</div>
        </div>
      </div>

    </div>

    <!-- Bottom bar ‚Äî WhatsApp-style with inline text input -->
    <div style="background:#f0f0f0;padding:6px 8px;display:flex;align-items:flex-end;gap:6px;flex-shrink:0;border-top:1px solid #dfe5e7">
      <!-- Camera -->
      <button type="button" onclick="document.getElementById('postMedia').click()" style="background:none;border:none;cursor:pointer;padding:8px;border-radius:50%;color:#54656f;font-size:20px;transition:.2s;flex-shrink:0;display:flex;align-items:center;justify-content:center" onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='none'" title="Add Photos">
        <i class="fa-solid fa-camera"></i>
      </button>
      <!-- Paperclip -->
      <button type="button" onclick="document.getElementById('postMedia').click()" style="background:none;border:none;cursor:pointer;padding:8px;border-radius:50%;color:#54656f;font-size:20px;transition:.2s;flex-shrink:0;display:flex;align-items:center;justify-content:center" onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='none'" title="Attach File">
        <i class="fa-solid fa-paperclip"></i>
      </button>

      <input type="file" id="postMedia" accept="image/*,video/*" multiple style="display:none" onchange="handlePostImageSelect(event)">

      <!-- WhatsApp-style growing textarea -->
      <div style="flex:1;background:#fff;border-radius:22px;padding:8px 14px;display:flex;align-items:flex-end;gap:8px;box-shadow:0 1px 2px rgba(0,0,0,.1)">
        <textarea id="postDesc" rows="1" style="flex:1;border:none;outline:none;font-family:inherit;font-size:14px;color:#303030;background:transparent;resize:none;max-height:100px;overflow-y:auto;line-height:1.5;padding:0" placeholder="Describe your activity... üìç Where? üë• Who? üéØ What?" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px';document.getElementById('postCharCount').textContent=this.value.length"></textarea>
        <span style="font-size:9px;color:#aaa;align-self:flex-end;white-space:nowrap" id="postCharCount">0</span>
      </div>

      <!-- Send button -->
      <button type="button" id="submitPostBtn" onclick="submitPost()" style="background:#00a884;border:none;width:44px;height:44px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;transition:all .2s;flex-shrink:0;box-shadow:0 2px 8px rgba(0,168,132,.3)" onmouseover="this.style.transform='scale(1.08)'" onmouseout="this.style.transform='scale(1)'">
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>

<style>
.post-pill{
  background:#fff;border:1.5px solid #d1d5db;border-radius:20px;padding:4px 10px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;color:#303030;white-space:nowrap;
}
.post-pill:hover{background:#f0f0f0}
.post-pill.active{background:#dcf8c6;border-color:#25d366;color:#075e54;font-weight:700;box-shadow:0 0 0 2px rgba(37,211,102,.15)}
#postThumbStrip::-webkit-scrollbar{display:none}
#postThumbStrip .thumb-item{
  display:inline-block;width:56px;height:56px;border-radius:8px;overflow:hidden;
  margin-right:8px;cursor:pointer;border:2px solid transparent;transition:border-color .15s;
  position:relative;flex-shrink:0;vertical-align:middle;
}
#postThumbStrip .thumb-item.active{border-color:#25d366}
#postThumbStrip .thumb-item img{width:100%;height:100%;object-fit:cover;display:block}
#postThumbStrip .thumb-item .thumb-remove{
  position:absolute;top:1px;right:1px;width:18px;height:18px;border-radius:50%;
  background:rgba(0,0,0,.65);color:#fff;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:10px;transition:.15s;
}
#postThumbStrip .thumb-item .thumb-remove:hover{background:rgba(220,38,38,.9)}
</style>

<!-- Add Product Modal (Rich Flipkart/Amazon style) -->
<div class="modal-overlay hidden" id="addProductModal">
  <div class="modal-card" style="max-width:680px;max-height:90vh;overflow-y:auto">
    <div class="modal-head">
      <h3><i class="fa-solid fa-box-open"></i> Add Product</h3>
      <button class="modal-close" onclick="closeModal('addProductModal')">&times;</button>
    </div>

    <!-- STEP 1: Basic Info -->
    <div style="background:var(--bg-soft);border-radius:10px;padding:14px;margin-bottom:14px">
      <h4 style="font-size:13px;font-weight:800;color:var(--accent);margin:0 0 10px"><i class="fa-solid fa-info-circle"></i> Basic Information</h4>
      <div class="form-group">
        <label>Product Title *</label>
        <input type="text" class="form-input" id="prodTitle" placeholder="e.g. Handmade Madhubani Painting - Large Frame">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Category *</label>
          <select class="form-input" id="prodCat" onchange="loadSubcategories()">
            <option value="">Select Category</option>
          </select>
        </div>
        <div class="form-group">
          <label>Sub-Category</label>
          <select class="form-input" id="prodSubCat">
            <option value="">Select Sub-Category</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Brand / Maker Name</label>
        <input type="text" class="form-input" id="prodBrand" placeholder="e.g. FWF Artisans, Your Brand Name">
      </div>
    </div>

    <!-- STEP 2: Pricing -->
    <div style="background:var(--bg-soft);border-radius:10px;padding:14px;margin-bottom:14px">
      <h4 style="font-size:13px;font-weight:800;color:var(--accent);margin:0 0 10px"><i class="fa-solid fa-indian-rupee-sign"></i> Pricing & Stock</h4>
      <div class="form-row">
        <div class="form-group">
          <label>Selling Price (‚Çπ) *</label>
          <input type="number" class="form-input" id="prodPrice" placeholder="0" min="1">
        </div>
        <div class="form-group">
          <label>MRP (‚Çπ) <small style="color:var(--text-muted)">(Original price)</small></label>
          <input type="number" class="form-input" id="prodMRP" placeholder="0" min="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Stock Quantity</label>
          <input type="number" class="form-input" id="prodStock" placeholder="1" min="1" value="1">
        </div>
        <div class="form-group">
          <label>Unit</label>
          <select class="form-input" id="prodUnit">
            <option value="piece">Piece</option>
            <option value="kg">Kg</option>
            <option value="gram">Gram</option>
            <option value="litre">Litre</option>
            <option value="ml">ml</option>
            <option value="pack">Pack</option>
            <option value="set">Set</option>
            <option value="pair">Pair</option>
            <option value="box">Box</option>
            <option value="dozen">Dozen</option>
          </select>
        </div>
      </div>
    </div>

    <!-- STEP 3: Details -->
    <div style="background:var(--bg-soft);border-radius:10px;padding:14px;margin-bottom:14px">
      <h4 style="font-size:13px;font-weight:800;color:var(--accent);margin:0 0 10px"><i class="fa-solid fa-list-check"></i> Product Details</h4>
      <div class="form-group">
        <label>Description</label>
        <textarea class="form-input" id="prodDesc" placeholder="Describe your product in detail ‚Äî material, usage, care instructions..." rows="3"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Condition</label>
          <select class="form-input" id="prodCondition">
            <option value="new">New</option>
            <option value="like-new">Like New</option>
            <option value="used">Used</option>
            <option value="refurbished">Refurbished</option>
          </select>
        </div>
        <div class="form-group">
          <label>Weight</label>
          <input type="text" class="form-input" id="prodWeight" placeholder="e.g. 500g, 1.2kg">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Material</label>
          <input type="text" class="form-input" id="prodMaterial" placeholder="e.g. Cotton, Wood, Silver">
        </div>
        <div class="form-group">
          <label>Color</label>
          <input type="text" class="form-input" id="prodColor" placeholder="e.g. Red, Multi-color">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Size</label>
          <input type="text" class="form-input" id="prodSize" placeholder="e.g. Large, 12x18 inches">
        </div>
        <div class="form-group">
          <label>Tags <small style="color:var(--text-muted)">(comma sep)</small></label>
          <input type="text" class="form-input" id="prodTags" placeholder="e.g. handmade, organic, gift">
        </div>
      </div>
    </div>

    <!-- STEP 4: Images -->
    <div style="background:var(--bg-soft);border-radius:10px;padding:14px;margin-bottom:14px">
      <h4 style="font-size:13px;font-weight:800;color:var(--accent);margin:0 0 10px"><i class="fa-solid fa-images"></i> Product Images <small style="font-weight:600;color:var(--text-muted)">(Max 8 images, 5MB each ‚Äî JPG, PNG, WebP)</small></h4>
      <div style="border:2px dashed var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:.2s;background:#fff" id="imageDropZone" onclick="document.getElementById('prodImages').click()" ondragover="event.preventDefault();this.style.borderColor='var(--accent)'" ondragleave="this.style.borderColor='var(--border)'" ondrop="handleImageDrop(event)">
        <i class="fa-solid fa-cloud-arrow-up" style="font-size:2rem;color:var(--accent);margin-bottom:8px;display:block"></i>
        <p style="font-size:13px;font-weight:700;margin:0">Click to upload or drag & drop images</p>
        <p style="font-size:11px;color:var(--text-muted);margin:4px 0 0">First image will be the thumbnail</p>
      </div>
      <input type="file" id="prodImages" accept="image/jpeg,image/png,image/webp,image/gif" multiple style="display:none" onchange="handleImageSelect(event)">
      <div id="imagePreviewGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px"></div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('addProductModal')">Cancel</button>
      <button class="btn btn-primary" id="submitProductBtn" onclick="submitProduct()"><i class="fa-solid fa-rocket"></i> Submit for Approval</button>
    </div>
  </div>
</div>

<!-- FWF Assistant Modal -->
<div class="modal-overlay hidden" id="aiListingModal">
  <div class="modal-card" style="max-width:700px;background:#fff;border-radius:20px;padding:0;overflow:hidden;max-height:92vh;display:flex;flex-direction:column">
    <!-- Header -->
    <div style="background:linear-gradient(135deg,#E87722,#c9621a);padding:18px 24px;color:#fff;display:flex;justify-content:space-between;align-items:center;flex-shrink:0">
      <h3 style="margin:0;font-size:18px;font-weight:900;display:flex;align-items:center;gap:10px">
        <i class="fa-solid fa-wand-magic-sparkles"></i> FWF Assistant
      </h3>
      <button class="modal-close" onclick="resetAIListing();closeModal('aiListingModal')" style="background:rgba(255,255,255,.2);border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:18px;color:#fff;display:flex;align-items:center;justify-content:center">&times;</button>
    </div>

    <!-- Steps Indicator -->
    <div style="display:flex;padding:16px 24px;background:var(--accent-light);border-bottom:1px solid #f5c99d;gap:4px;flex-shrink:0" id="aiStepsBar">
      <div class="ai-step active" id="aiStep1"><span class="ai-step-num">1</span> Upload</div>
      <div class="ai-step-line"></div>
      <div class="ai-step" id="aiStep2"><span class="ai-step-num">2</span> AI Chat</div>
      <div class="ai-step-line"></div>
      <div class="ai-step" id="aiStep3"><span class="ai-step-num">3</span> Preview</div>
    </div>

    <!-- Body (scrollable) -->
    <div style="flex:1;overflow-y:auto;padding:24px" id="aiModalBody">

      <!-- STEP 1: Upload Image -->
      <div id="aiUploadStep">
        <p style="font-size:14px;color:var(--text-secondary);margin:0 0 16px;font-weight:600">Upload your product image and AI will help you create a professional listing</p>
        <div style="border:2px dashed #d1d5db;border-radius:16px;padding:40px 20px;text-align:center;cursor:pointer;transition:all .3s;background:var(--accent-light)" id="aiDropZone" onclick="document.getElementById('aiImageInput').click()" ondragover="event.preventDefault();this.style.borderColor='var(--accent)';this.style.background='#FFE8D6'" ondragleave="this.style.borderColor='#d1d5db';this.style.background='var(--accent-light)'" ondrop="handleAIImageDrop(event)">
          <i class="fa-solid fa-camera" style="font-size:48px;color:var(--accent);margin-bottom:14px;display:block"></i>
          <p style="font-weight:800;font-size:15px;color:var(--text-primary);margin:0 0 6px">Upload Product Photo</p>
          <p style="font-size:12px;color:#6b7280;margin:0">Click or drag & drop ‚Ä¢ JPG, PNG, WebP ‚Ä¢ Max 5MB</p>
        </div>
        <input type="file" id="aiImageInput" accept="image/jpeg,image/png,image/webp" style="display:none" onchange="handleAIImageUpload(event)">

        <!-- Image Preview -->
        <div id="aiImagePreview" style="display:none;margin-top:16px;text-align:center">
          <img id="aiPreviewImg" style="max-height:220px;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.1);margin-bottom:12px">
          <div style="display:flex;gap:8px;justify-content:center">
            <button class="btn btn-ghost" onclick="document.getElementById('aiImageInput').click()" style="font-size:12px"><i class="fa-solid fa-rotate"></i> Change</button>
            <button class="btn" onclick="startAIAnalysis()" style="background:var(--accent);color:#fff;font-weight:700;font-size:13px"><i class="fa-solid fa-wand-magic-sparkles"></i> Analyze with AI</button>
          </div>
        </div>
      </div>

      <!-- STEP 2: AI Chat -->
      <div id="aiChatStep" style="display:none">
        <div id="aiChatMessages" style="display:flex;flex-direction:column;gap:12px;min-height:200px"></div>
        
        <!-- User Input Area -->
        <div id="aiUserInputArea" style="display:none;margin-top:16px;border-top:1px solid #e5e7eb;padding-top:16px">
          <div id="aiQuickOptions" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px"></div>
          <div style="display:flex;gap:8px">
            <input type="text" class="form-input" id="aiUserInput" placeholder="Type your answer..." style="flex:1;border-radius:12px;padding:12px 16px" onkeydown="if(event.key==='Enter')sendAIAnswer()">
            <button class="btn" onclick="sendAIAnswer()" style="background:var(--accent);color:#fff;border:none;border-radius:12px;padding:12px 18px"><i class="fa-solid fa-paper-plane"></i></button>
          </div>
        </div>
      </div>

      <!-- STEP 3: Preview -->
      <div id="aiPreviewStep" style="display:none">
        <div id="aiListingPreview" style="border:1px solid #e5e7eb;border-radius:16px;overflow:hidden;background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.06)"></div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:20px;flex-wrap:wrap">
          <button class="btn" onclick="editAIListing()" style="background:#f3f4f6;color:var(--text-primary);font-weight:700;border:1px solid #d1d5db;border-radius:12px;padding:12px 24px"><i class="fa-solid fa-pen"></i> Edit</button>
          <button class="btn" onclick="deleteAIListing()" style="background:#fef2f2;color:#dc2626;font-weight:700;border:1px solid #fecaca;border-radius:12px;padding:12px 24px"><i class="fa-solid fa-trash"></i> Delete</button>
          <button class="btn" onclick="postAIListing()" style="background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;font-weight:700;border:none;border-radius:12px;padding:12px 28px"><i class="fa-solid fa-rocket"></i> Post Listing</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.ai-step{
  display:flex;align-items:center;gap:6px;
  font-size:12px;font-weight:700;color:#E87722;
  transition:all .3s;
}
.ai-step.active{ color:#b8591a; }
.ai-step.done{ color:#22c55e; }
.ai-step-num{
  width:24px;height:24px;border-radius:50%;
  background:var(--accent-light);color:var(--accent);
  display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:900;
}
.ai-step.active .ai-step-num{ background:var(--accent);color:#fff; }
.ai-step.done .ai-step-num{ background:#22c55e;color:#fff; }
.ai-step-line{
  flex:1;height:2px;background:#f5c99d;border-radius:2px;
  margin:0 4px;
}
.ai-msg{
  max-width:85%;padding:14px 18px;
  border-radius:16px;font-size:13px;line-height:1.5;
  animation:tabSlideIn .3s ease;
}
.ai-msg.bot{
  background:var(--accent-light);
  border:1px solid #f5c99d;
  color:#7a3d00;
  align-self:flex-start;
  border-bottom-left-radius:4px;
}
.ai-msg.user{
  background:var(--accent);
  color:#fff;
  align-self:flex-end;
  border-bottom-right-radius:4px;
}
.ai-msg.bot .typing-dots span{
  display:inline-block;width:6px;height:6px;
  background:var(--accent);border-radius:50%;
  margin:0 2px;animation:dotPulse 1.4s infinite;
}
.ai-msg.bot .typing-dots span:nth-child(2){ animation-delay:.2s; }
.ai-msg.bot .typing-dots span:nth-child(3){ animation-delay:.4s; }
@keyframes dotPulse{ 0%,80%,100%{opacity:.3;transform:scale(.8)} 40%{opacity:1;transform:scale(1)} }
.ai-quick-btn{
  padding:8px 14px;border-radius:20px;
  background:var(--accent-light);border:1px solid #f5c99d;
  color:var(--accent);font-size:12px;font-weight:700;
  cursor:pointer;transition:all .2s;font-family:inherit;
}
.ai-quick-btn:hover{ background:#FFE8D6;border-color:var(--accent); }

/* AI Preview Card */
.ai-preview-header{ padding:0; }
.ai-preview-header img{
  width:100%;height:240px;object-fit:cover;
}
.ai-preview-body{ padding:20px; }
.ai-preview-title{
  font-size:18px;font-weight:900;margin:0 0 8px;
  color:var(--text-primary);
}
.ai-preview-price{
  font-size:22px;font-weight:900;color:#22c55e;
  margin:0 0 4px;
}
.ai-preview-mrp{
  font-size:13px;color:var(--text-muted);
  text-decoration:line-through;margin-left:8px;
}
.ai-preview-discount{
  font-size:12px;color:#dc2626;font-weight:800;
  background:#fef2f2;padding:2px 8px;border-radius:6px;margin-left:8px;
}
.ai-preview-meta{
  display:grid;grid-template-columns:1fr 1fr;gap:8px;
  margin-top:14px;padding-top:14px;
  border-top:1px solid #f3f4f6;
}
.ai-preview-meta-item{
  font-size:12px;color:var(--text-secondary);
}
.ai-preview-meta-item strong{
  color:var(--text-primary);font-weight:700;
}
.ai-preview-desc{
  font-size:13px;color:var(--text-secondary);line-height:1.6;
  margin-top:14px;padding-top:14px;
  border-top:1px solid #f3f4f6;
}
.ai-preview-tags{
  display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;
}
.ai-preview-tag{
  padding:4px 10px;border-radius:20px;
  background:var(--accent-light);color:var(--accent);
  font-size:11px;font-weight:700;
}
</style>

<script src="/assets/js/fwf.js"></script>
<script src="/auth.js"></script>
<script>
/* ============================================
   NAVIGATION
   ============================================ */
const pageTitles = {
  home: '<i class="fa-solid fa-house"></i> Dashboard',
  profile: '<i class="fa-solid fa-id-card"></i> Profile & ID Card',
  feed: '<i class="fa-solid fa-book-open"></i> Social Book',
  training: '<i class="fa-solid fa-graduation-cap"></i> Training & Courses',
  wallet: '<i class="fa-solid fa-wallet"></i> Wallet',
  referral: '<i class="fa-solid fa-user-plus"></i> Referral & Earn',
  marketplace: '<i class="fa-solid fa-store"></i> Marketplace',
  seller: '<i class="fa-solid fa-boxes-stacked"></i> Seller Panel',
  events: '<i class="fa-solid fa-calendar-days"></i> Events & Activities',
  support: '<i class="fa-solid fa-headset"></i> Help & Support'
};

function switchPage(page, updateHash = true){
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item[data-page]').forEach(n => n.classList.remove('active'));
  const el = document.getElementById('page-' + page);
  if(el) el.classList.add('active');
  const nav = document.querySelector('.nav-item[data-page="'+page+'"]');
  if(nav) nav.classList.add('active');
  document.getElementById('pageTitle').innerHTML = pageTitles[page] || page;
  closeMobile();

  // Sync bottom nav
  document.querySelectorAll('.mobile-bottom-nav .bnav').forEach(b => b.classList.remove('active'));
  const bnav = document.querySelector('.mobile-bottom-nav .bnav[data-page="'+page+'"]');
  if(bnav) bnav.classList.add('active');

  // Update URL hash without reloading
  if(updateHash) {
    history.pushState({ page }, '', location.pathname + (page === 'home' ? '' : '#' + page));
  }

  // Lazy load data
  if(page === 'wallet')      loadWallet();
  if(page === 'referral')    loadReferral();
  if(page === 'support')     loadMyTickets();
  if(page === 'profile')     loadProfile();
  if(page === 'marketplace') loadMarketProducts();
  if(page === 'seller')      loadSellerData();
  if(page === 'events')      loadEventsPage();
}

document.querySelectorAll('.nav-item[data-page]').forEach(btn => {
  btn.addEventListener('click', () => switchPage(btn.dataset.page));
});

// Bottom nav clicks
document.querySelectorAll('.mobile-bottom-nav .bnav').forEach(btn => {
  btn.addEventListener('click', () => switchPage(btn.dataset.page));
});

// Handle browser back/forward
window.addEventListener('popstate', (e) => {
  const page = (e.state && e.state.page) || (location.hash.slice(1)) || 'home';
  switchPage(page, false);
});

// On load ‚Äî path-based routing takes precedence over hash
window.addEventListener('load', () => {
  const pathMap = {
    '/member/profile':  'profile',
    '/member/wallet':   'wallet',
    '/member/referral': 'referral',
    '/member/post':     'feed',
    '/member/store':    'marketplace',
    '/member/training': 'training',
    '/member/support':  'support',
  };
  const pathPage = pathMap[location.pathname];
  const hashPage = location.hash.slice(1);
  const target = pathPage || hashPage;
  if(target && document.getElementById('page-' + target)) {
    switchPage(target, false);
  }
});

// Mobile
document.getElementById('mobileToggle').addEventListener('click', () => {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('mobileOverlay').classList.toggle('show');
});
document.getElementById('mobileOverlay').addEventListener('click', closeMobile);
function closeMobile(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('mobileOverlay').classList.remove('show');
}

// Tabs
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const parent = btn.closest('.page');
    parent.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

// Category filters (marketplace) - now handled by loadMarketProducts()
// Image upload for Seller panel
let selectedImages = [];

function handleImageSelect(e){
  addImages(Array.from(e.target.files));
}
function handleImageDrop(e){
  e.preventDefault();
  e.currentTarget.style.borderColor = 'var(--border)';
  addImages(Array.from(e.dataTransfer.files));
}
function addImages(files){
  const MAX = 8, MAX_SIZE = 5*1024*1024;
  const allowed = ['image/jpeg','image/png','image/webp','image/gif'];
  for(const f of files){
    if(selectedImages.length >= MAX){ notify(`Max ${MAX} images allowed`,'warning'); break; }
    if(!allowed.includes(f.type)){ notify(`${f.name}: Only JPG, PNG, WebP, GIF allowed`,'warning'); continue; }
    if(f.size > MAX_SIZE){ notify(`${f.name}: Max 5MB per image`,'warning'); continue; }
    selectedImages.push(f);
  }
  renderImagePreviews();
}
function renderImagePreviews(){
  const grid = document.getElementById('imagePreviewGrid');
  grid.innerHTML = selectedImages.map((f,i) => {
    const url = URL.createObjectURL(f);
    return `<div style="position:relative;aspect-ratio:1;border-radius:10px;overflow:hidden;border:2px solid ${i===0?'var(--accent)':'var(--border)'}">
      <img src="${url}" style="width:100%;height:100%;object-fit:cover"/>
      ${i===0?'<div style="position:absolute;top:4px;left:4px;background:var(--accent);color:#fff;font-size:9px;font-weight:800;padding:2px 6px;border-radius:6px">THUMB</div>':''}
      <button onclick="removeImage(${i})" style="position:absolute;top:4px;right:4px;width:22px;height:22px;border-radius:50%;background:rgba(0,0,0,.6);color:#fff;border:none;cursor:pointer;font-size:11px">&times;</button>
    </div>`;
  }).join('');
}
function removeImage(i){ selectedImages.splice(i,1); renderImagePreviews(); }

// Convert File to base64
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

// Upload image directly to Cloudinary using unsigned upload preset
// cloud_name + upload_preset are public for unsigned uploads (no secret exposed)
async function uploadToCloudinary(file){
  const fd = new FormData();
  fd.append('file',          file);
  fd.append('upload_preset', 'fwf_posts');
  fd.append('folder',        'fwf-posts');

  const upRes = await fetch(
    'https://api.cloudinary.com/v1_1/dm1jowk69/image/upload',
    { method:'POST', body: fd }
  );
  const up = await upRes.json();
  if(up.error) throw new Error(up.error.message || 'Cloudinary upload failed');
  return up.secure_url;
}

// Load categories for dropdowns
let storeCategories = {};

/* ============================================
   FWF ASSISTANT - ChatGPT Integration
   ============================================ */
let aiImageBase64 = null;
let aiConversation = [];
let aiProductData = {};
let aiCurrentStep = 1;
let aiQuestionIndex = 0;

const AI_QUESTIONS = [
  { key:'title', q:'Product ka naam kya hai? (What is the product name?)', placeholder:'e.g. Handmade Aloe Vera Soap' },
  { key:'price', q:'Selling price kitna rakhna hai? (‚Çπ)', placeholder:'e.g. 70', type:'number' },
  { key:'mrp', q:'MRP (original price) kya hai? (‚Çπ)', placeholder:'e.g. 90', type:'number' },
  { key:'stock', q:'Kitna stock hai? (How many units available?)', placeholder:'e.g. 100', type:'number' },
  { key:'weight', q:'Weight/Size kya hai?', placeholder:'e.g. 100g, 500ml' },
];

function resetAIListing(){
  aiImageBase64 = null;
  aiConversation = [];
  aiProductData = {};
  aiCurrentStep = 1;
  aiQuestionIndex = 0;
  document.getElementById('aiUploadStep').style.display = 'block';
  document.getElementById('aiChatStep').style.display = 'none';
  document.getElementById('aiPreviewStep').style.display = 'none';
  document.getElementById('aiImagePreview').style.display = 'none';
  document.getElementById('aiDropZone').style.display = 'block';
  document.getElementById('aiChatMessages').innerHTML = '';
  document.getElementById('aiImageInput').value = '';
  setAIStep(1);
}

function setAIStep(n){
  aiCurrentStep = n;
  [1,2,3].forEach(i => {
    const el = document.getElementById('aiStep'+i);
    el.classList.remove('active','done');
    if(i < n) el.classList.add('done');
    if(i === n) el.classList.add('active');
  });
}

function handleAIImageDrop(e){
  e.preventDefault();
  const dt = e.dataTransfer;
  if(dt.files.length > 0){
    document.getElementById('aiImageInput').files = dt.files;
    handleAIImageUpload({target:{files:dt.files}});
  }
  document.getElementById('aiDropZone').style.borderColor = '#d1d5db';
  document.getElementById('aiDropZone').style.background = 'var(--accent-light)';
}

function handleAIImageUpload(e){
  const file = e.target.files[0];
  if(!file) return;
  if(file.size > 5*1024*1024){ notify('Image too large. Max 5MB','warning'); return; }
  
  const reader = new FileReader();
  reader.onload = (ev) => {
    aiImageBase64 = ev.target.result;
    document.getElementById('aiPreviewImg').src = aiImageBase64;
    document.getElementById('aiDropZone').style.display = 'none';
    document.getElementById('aiImagePreview').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

function addAIMessage(text, type){
  const container = document.getElementById('aiChatMessages');
  const msg = document.createElement('div');
  msg.className = 'ai-msg ' + type;
  msg.innerHTML = text;
  container.appendChild(msg);
  msg.scrollIntoView({behavior:'smooth', block:'end'});
}

function showTyping(){
  const container = document.getElementById('aiChatMessages');
  const msg = document.createElement('div');
  msg.className = 'ai-msg bot';
  msg.id = 'aiTyping';
  msg.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
  container.appendChild(msg);
  msg.scrollIntoView({behavior:'smooth', block:'end'});
}

function removeTyping(){
  const el = document.getElementById('aiTyping');
  if(el) el.remove();
}

async function startAIAnalysis(){
  if(!aiImageBase64){ notify('Please upload an image first','warning'); return; }
  
  // Move to step 2
  document.getElementById('aiUploadStep').style.display = 'none';
  document.getElementById('aiChatStep').style.display = 'block';
  setAIStep(2);
  
  // Show uploaded image in chat
  addAIMessage(`<img src="${aiImageBase64}" style="max-height:150px;border-radius:10px;margin-bottom:8px;display:block"><span style="font-size:11px;opacity:.7">Product image uploaded</span>`, 'user');
  
  showTyping();
  
  try{
    // Call serverless proxy to analyze image via ChatGPT Vision
    const response = await fetch('/api/ai-analyze', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ image: aiImageBase64 })
    });
    
    const data = await response.json();
    removeTyping();
    
    if(!data.ok){
      addAIMessage('Sorry, AI analysis failed: ' + (data.error || 'Unknown error'), 'bot');
      return;
    }
    
    const aiText = data.result;
    
    // Try to parse JSON from AI response
    try{
      const jsonMatch = aiText.match(/\{[\s\S]*\}/);
      if(jsonMatch){
        const parsed = JSON.parse(jsonMatch[0]);
        aiProductData = {
          title: parsed.title || '',
          category: parsed.category || '',
          subcategory: parsed.subcategory || '',
          description: parsed.description || '',
          material: parsed.material || '',
          color: parsed.color || '',
          condition: parsed.condition || 'new',
          price: parsed.suggested_price || 0,
          mrp: 0,
          stock: 1,
          weight: '',
          tags: (parsed.tags || []).join(', '),
          brand: ''
        };
        
        addAIMessage(`<strong><i class="fa-solid fa-sparkles"></i> AI ne aapka product analyze kar liya!</strong><br><br>
          <strong>Product:</strong> ${aiProductData.title}<br>
          <strong>Category:</strong> ${aiProductData.category}<br>
          <strong>Description:</strong> ${aiProductData.description}<br>
          <strong>Material:</strong> ${aiProductData.material}<br>
          <strong>Color:</strong> ${aiProductData.color}<br>
          <strong>Suggested Price:</strong> ‚Çπ${aiProductData.price}<br><br>
          <em>Ab mujhe kuch aur details chahiye listing ke liye...</em>`, 'bot');
        
        // Start asking additional questions
        aiQuestionIndex = 0;
        setTimeout(() => askNextQuestion(), 800);
      }
    } catch(parseErr){
      addAIMessage('AI ne product identify kiya: ' + aiText + '<br><br><em>Ab mujhe kuch details chahiye...</em>', 'bot');
      aiQuestionIndex = 0;
      setTimeout(() => askNextQuestion(), 800);
    }
    
  } catch(err){
    removeTyping();
    addAIMessage('Network error. Please check your internet connection.', 'bot');
  }
}

function askNextQuestion(){
  if(aiQuestionIndex >= AI_QUESTIONS.length){
    // All questions answered, generate preview
    generateAIPreview();
    return;
  }
  
  const q = AI_QUESTIONS[aiQuestionIndex];
  addAIMessage(`<strong>${q.q}</strong>`, 'bot');
  
  // Show input area
  const inputArea = document.getElementById('aiUserInputArea');
  inputArea.style.display = 'block';
  const input = document.getElementById('aiUserInput');
  input.placeholder = q.placeholder || 'Type your answer...';
  input.type = q.type || 'text';
  input.value = aiProductData[q.key] || '';
  input.focus();
  
  // Quick options for some questions
  const optionsDiv = document.getElementById('aiQuickOptions');
  optionsDiv.innerHTML = '';
  if(q.key === 'stock'){
    ['10','50','100','500','1000'].forEach(v => {
      optionsDiv.innerHTML += `<button class="ai-quick-btn" onclick="quickAnswer('${v}')">${v}</button>`;
    });
  }
}

function quickAnswer(val){
  document.getElementById('aiUserInput').value = val;
  sendAIAnswer();
}

function sendAIAnswer(){
  const input = document.getElementById('aiUserInput');
  const val = input.value.trim();
  if(!val) return;
  
  const q = AI_QUESTIONS[aiQuestionIndex];
  aiProductData[q.key] = val;
  
  addAIMessage(val, 'user');
  input.value = '';
  document.getElementById('aiQuickOptions').innerHTML = '';
  
  aiQuestionIndex++;
  setTimeout(() => askNextQuestion(), 500);
}

function generateAIPreview(){
  document.getElementById('aiUserInputArea').style.display = 'none';
  
  showTyping();
  setTimeout(() => {
    removeTyping();
    addAIMessage('<strong><i class="fa-solid fa-check-circle" style="color:#22c55e"></i> Listing ready!</strong><br>Aapka product preview dekh lo...', 'bot');
    
    // Move to step 3
    setTimeout(() => {
      document.getElementById('aiChatStep').style.display = 'none';
      document.getElementById('aiPreviewStep').style.display = 'block';
      setAIStep(3);
      renderAIPreview();
    }, 800);
  }, 1000);
}

function renderAIPreview(){
  const p = aiProductData;
  const discount = p.mrp && p.mrp > p.price ? Math.round((1 - p.price/p.mrp)*100) : 0;
  
  document.getElementById('aiListingPreview').innerHTML = `
    <div class="ai-preview-header">
      <img src="${aiImageBase64}" alt="${p.title}">
    </div>
    <div class="ai-preview-body">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span style="background:#f0fdf4;color:#16a34a;font-size:10px;font-weight:800;padding:3px 8px;border-radius:6px;text-transform:uppercase">${p.category || 'General'}</span>
        ${p.subcategory ? `<span style="background:var(--accent-light);color:var(--accent);font-size:10px;font-weight:800;padding:3px 8px;border-radius:6px">${p.subcategory}</span>` : ''}
      </div>
      <h3 class="ai-preview-title">${p.title || 'Untitled Product'}</h3>
      <div style="display:flex;align-items:baseline">
        <span class="ai-preview-price">‚Çπ${p.price || 0}</span>
        ${p.mrp && p.mrp > p.price ? `<span class="ai-preview-mrp">‚Çπ${p.mrp}</span><span class="ai-preview-discount">${discount}% OFF</span>` : ''}
      </div>
      
      <div class="ai-preview-meta">
        <div class="ai-preview-meta-item"><i class="fa-solid fa-box" style="color:var(--accent);margin-right:4px"></i> <strong>Stock:</strong> ${p.stock || 1} ${p.unit || 'piece'}</div>
        <div class="ai-preview-meta-item"><i class="fa-solid fa-weight-scale" style="color:var(--accent);margin-right:4px"></i> <strong>Weight:</strong> ${p.weight || 'N/A'}</div>
        <div class="ai-preview-meta-item"><i class="fa-solid fa-paint-brush" style="color:var(--accent);margin-right:4px"></i> <strong>Material:</strong> ${p.material || 'N/A'}</div>
        <div class="ai-preview-meta-item"><i class="fa-solid fa-palette" style="color:var(--accent);margin-right:4px"></i> <strong>Color:</strong> ${p.color || 'N/A'}</div>
        <div class="ai-preview-meta-item"><i class="fa-solid fa-tag" style="color:var(--accent);margin-right:4px"></i> <strong>Condition:</strong> ${p.condition || 'New'}</div>
        ${p.brand ? `<div class="ai-preview-meta-item"><i class="fa-solid fa-building" style="color:var(--accent);margin-right:4px"></i> <strong>Brand:</strong> ${p.brand}</div>` : ''}
      </div>
      
      <div class="ai-preview-desc">
        <strong><i class="fa-solid fa-align-left" style="margin-right:4px"></i> Description</strong><br>
        ${p.description || 'No description provided'}
      </div>
      
      ${p.tags ? `<div class="ai-preview-tags">${p.tags.split(',').map(t => `<span class="ai-preview-tag">#${t.trim()}</span>`).join('')}</div>` : ''}
    </div>
  `;
}

function editAIListing(){
  // Go back to chat to edit
  document.getElementById('aiPreviewStep').style.display = 'none';
  document.getElementById('aiChatStep').style.display = 'block';
  setAIStep(2);
  
  addAIMessage('<strong><i class="fa-solid fa-pen"></i> Edit mode!</strong><br>Kya change karna hai? Koi bhi field bata do...', 'bot');
  
  // Show edit options
  const optionsDiv = document.getElementById('aiQuickOptions');
  optionsDiv.innerHTML = '';
  ['Title','Price','MRP','Description','Stock','Weight','Tags'].forEach(field => {
    optionsDiv.innerHTML += `<button class="ai-quick-btn" onclick="editAIField('${field.toLowerCase()}')">${field}</button>`;
  });
  
  document.getElementById('aiUserInputArea').style.display = 'block';
  document.getElementById('aiUserInput').placeholder = 'Type field name or new value...';
}

let aiEditingField = null;
function editAIField(field){
  aiEditingField = field;
  const labels = {title:'Product Name', price:'Selling Price (‚Çπ)', mrp:'MRP (‚Çπ)', description:'Description', stock:'Stock Quantity', weight:'Weight', tags:'Tags'};
  addAIMessage(`<strong>${labels[field] || field}</strong> ka naya value type karo:`, 'bot');
  const input = document.getElementById('aiUserInput');
  input.value = aiProductData[field] || '';
  input.focus();
  document.getElementById('aiQuickOptions').innerHTML = '';
  
  // Override sendAIAnswer for editing
  input.onkeydown = (e) => {
    if(e.key === 'Enter'){
      const val = input.value.trim();
      if(!val) return;
      aiProductData[aiEditingField] = val;
      addAIMessage(val, 'user');
      input.value = '';
      aiEditingField = null;
      input.onkeydown = (e) => { if(e.key==='Enter') sendAIAnswer(); };
      
      addAIMessage('<strong><i class="fa-solid fa-check" style="color:#22c55e"></i> Updated!</strong> Preview refresh ho raha hai...', 'bot');
      
      setTimeout(() => {
        document.getElementById('aiChatStep').style.display = 'none';
        document.getElementById('aiPreviewStep').style.display = 'block';
        setAIStep(3);
        renderAIPreview();
      }, 800);
    }
  };
}

function deleteAIListing(){
  if(typeof FWF_Notify !== 'undefined'){
    FWF_Notify.confirm('Are you sure? This will discard the AI listing.', () => {
      resetAIListing();
      closeModal('aiListingModal');
      notify('Listing deleted', 'info');
    });
  } else {
    if(confirm('Discard this listing?')){
      resetAIListing();
      closeModal('aiListingModal');
    }
  }
}

async function postAIListing(){
  const p = aiProductData;
  if(!p.title || !p.price){
    notify('Product title and price required','warning');
    return;
  }
  
  const postBtn = document.querySelector('#aiPreviewStep .btn:last-child');
  postBtn.disabled = true;
  postBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Posting...';
  
  try{
    const images = aiImageBase64 ? [aiImageBase64] : [];
    
    const body = {
      title: p.title,
      category: p.category || 'other',
      subcategory: p.subcategory || null,
      brand: p.brand || null,
      price: parseFloat(p.price) || 0,
      mrp: parseFloat(p.mrp) || null,
      stock: parseInt(p.stock) || 1,
      unit: p.unit || 'piece',
      description: p.description || null,
      condition: p.condition || 'new',
      weight: p.weight || null,
      material: p.material || null,
      color: p.color || null,
      size: p.size || null,
      tags: p.tags || null,
      images
    };
    
    const r = await AUTH.api('/api/member/add-product', {method:'POST', body});
    
    if(typeof FWF_Notify !== 'undefined'){
      FWF_Notify.toast('üéâ Product listing submitted for approval!<br><small>You will be notified once it\'s approved.</small>', 'success');
    } else {
      notify(r.message || 'Product submitted!','success');
    }
    
    resetAIListing();
    closeModal('aiListingModal');
    loadSellerData();
    
  } catch(e){
    notify(e.message || 'Failed to post product','error');
  } finally {
    postBtn.disabled = false;
    postBtn.innerHTML = '<i class="fa-solid fa-rocket"></i> Post Listing';
  }
}
async function loadStoreCategories(){
  try{
    const r = await fetch('/api/store/categories');
    const d = await r.json();
    if(d.ok) storeCategories = d.categories;
  } catch(e){}
  // Populate Add Product category dropdown
  const sel = document.getElementById('prodCat');
  const filterSel = document.getElementById('marketCatFilter');
  sel.innerHTML = '<option value="">Select Category</option>';
  for(const [key,cat] of Object.entries(storeCategories)){
    sel.innerHTML += `<option value="${key}">${cat.label}</option>`;
    filterSel.innerHTML += `<option value="${key}">${cat.label}</option>`;
  }
}
function loadSubcategories(){
  const cat = document.getElementById('prodCat').value;
  const sub = document.getElementById('prodSubCat');
  sub.innerHTML = '<option value="">Select Sub-Category</option>';
  if(cat && storeCategories[cat] && storeCategories[cat].subs){
    storeCategories[cat].subs.forEach(s => {
      sub.innerHTML += `<option value="${s}">${s}</option>`;
    });
  }
}

// Submit product
async function submitProduct(){
  const title = document.getElementById('prodTitle').value.trim();
  const category = document.getElementById('prodCat').value;
  const price = parseFloat(document.getElementById('prodPrice').value);
  if(!title){ notify('Product title is required','warning'); return; }
  if(!category){ notify('Select a category','warning'); return; }
  if(!price || price <= 0){ notify('Enter a valid price','warning'); return; }

  const btn = document.getElementById('submitProductBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading...';

  try{
    // Convert images to base64
    const images = [];
    for(const f of selectedImages){
      const b64 = await fileToBase64(f);
      images.push(b64);
    }

    const body = {
      title,
      category,
      subcategory: document.getElementById('prodSubCat').value || null,
      brand: document.getElementById('prodBrand').value.trim() || null,
      price,
      mrp: parseFloat(document.getElementById('prodMRP').value) || null,
      stock: parseInt(document.getElementById('prodStock').value) || 1,
      unit: document.getElementById('prodUnit').value,
      description: document.getElementById('prodDesc').value.trim() || null,
      condition: document.getElementById('prodCondition').value,
      weight: document.getElementById('prodWeight').value.trim() || null,
      material: document.getElementById('prodMaterial').value.trim() || null,
      color: document.getElementById('prodColor').value.trim() || null,
      size: document.getElementById('prodSize').value.trim() || null,
      tags: document.getElementById('prodTags').value.trim() || null,
      images
    };

    const r = await AUTH.api('/api/member/add-product', { method:'POST', body });
    notify(r.message || 'Product submitted!', 'success');
    closeModal('addProductModal');
    // Reset form
    selectedImages = [];
    renderImagePreviews();
    document.querySelectorAll('#addProductModal input, #addProductModal textarea').forEach(el => el.value = '');
    document.querySelectorAll('#addProductModal select').forEach(el => el.selectedIndex = 0);
    loadSellerData();
  } catch(e){
    notify(e.message || 'Failed to submit product','error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-rocket"></i> Submit for Approval';
  }
}

// Load marketplace products (browse)
let marketPage = 1;
async function loadMarketProducts(){
  const grid = document.getElementById('marketGrid');
  grid.innerHTML = '<div class="empty-state"><i class="fa-solid fa-spinner fa-spin"></i><p>Loading...</p></div>';
  const params = new URLSearchParams();
  const cat = document.getElementById('marketCatFilter').value;
  if(cat) params.set('category', cat);
  const search = document.getElementById('marketSearch').value.trim();
  if(search) params.set('search', search);
  const sort = document.getElementById('marketSort').value;
  if(sort) params.set('sort', sort);
  params.set('page', marketPage);
  params.set('limit', 12);
  try{
    const r = await fetch('/api/store/products?' + params.toString());
    const d = await r.json();
    if(!d.ok || !d.products.length){
      grid.innerHTML = '<div class="empty-state"><i class="fa-solid fa-box-open"></i><p>No products found. Check back soon!</p></div>';
      document.getElementById('marketPagination').innerHTML = '';
      return;
    }
    grid.innerHTML = d.products.map(p => {
      const img = p.thumbnail || (p.images && p.images[0]);
      const catInfo = storeCategories[p.category];
      const catLabel = catInfo ? catInfo.label : p.category;
      return `<div class="product-card" style="cursor:pointer" onclick="window.open('store.html','_blank')">
        <div class="product-thumb" style="${img ? 'padding:0' : ''}">
          ${img ? `<img src="${img}" style="width:100%;height:100%;object-fit:cover;border-radius:10px 10px 0 0"/>` : `<i class="fa-solid fa-image"></i>`}
        </div>
        <div class="product-info">
          <div style="font-size:10px;font-weight:700;color:var(--accent);text-transform:uppercase;margin-bottom:2px">${catLabel}</div>
          <h4 style="font-size:13px;margin:0 0 4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">${p.title}</h4>
          <div class="seller" style="font-size:11px">By ${p.seller_name || 'FWF Seller'}</div>
          <div class="product-price" style="display:flex;align-items:baseline;gap:6px">
            ‚Çπ${fmtN(p.price)}
            ${p.mrp && p.mrp > p.price ? `<span style="font-size:11px;color:var(--text-muted);text-decoration:line-through">‚Çπ${fmtN(p.mrp)}</span><span style="font-size:10px;color:var(--success);font-weight:800">${p.discount_percent}% off</span>` : ''}
          </div>
        </div>
      </div>`;
    }).join('');
    // Simple pagination
    const pag = document.getElementById('marketPagination');
    if(d.pages > 1){
      let ph = '';
      for(let i=1;i<=d.pages;i++) ph += `<button class="btn btn-ghost btn-sm ${i===d.page?'active':''}" onclick="marketPage=${i};loadMarketProducts()" style="${i===d.page?'background:var(--accent);color:#fff':''}">${i}</button>`;
      pag.innerHTML = ph;
    } else pag.innerHTML = '';
  } catch(e){
    grid.innerHTML = '<div class="empty-state"><i class="fa-solid fa-wifi"></i><p>Failed to load. Try again.</p></div>';
  }
}
document.getElementById('marketSearch').addEventListener('keydown', e => { if(e.key==='Enter'){ marketPage=1; loadMarketProducts(); } });

// Load seller data
async function loadSellerData(){
  try{
    const [prods, orders] = await Promise.all([
      AUTH.api('/api/member/my-products'),
      AUTH.api('/api/member/seller-orders')
    ]);
    // Stats
    if(prods.stats){
      document.getElementById('selProducts').textContent = prods.stats.total;
      document.getElementById('selApproved').textContent = prods.stats.approved;
    }
    if(orders.stats){
      document.getElementById('selOrders').textContent = orders.stats.total;
      document.getElementById('selEarnings').textContent = '‚Çπ' + fmtN(orders.stats.totalEarnings);
    }
    // Products list
    const list = document.getElementById('sellerProductsList');
    if(!prods.products || !prods.products.length){
      list.innerHTML = `<div class="empty-state">
        <i class="fa-solid fa-store"></i>
        <p>No products listed yet. Start selling!</p>
        <button class="btn btn-primary" style="margin-top:12px" onclick="openModal('addProductModal')"><i class="fa-solid fa-plus"></i> Add First Product</button>
      </div>`;
    } else {
      list.innerHTML = `<div style="display:grid;gap:10px">${prods.products.map(p => {
        const img = p.thumbnail || (p.images && p.images[0]);
        const statusColors = {pending:'#f59e0b',approved:'#22c55e',rejected:'#ef4444','out-of-stock':'#6b7280',draft:'#94a3b8',archived:'#6b7280'};
        return `<div style="display:flex;gap:12px;align-items:center;padding:12px;background:var(--bg-soft);border-radius:12px;border:1px solid var(--border)">
          <div style="width:60px;height:60px;border-radius:10px;overflow:hidden;background:#fff;flex-shrink:0;display:flex;align-items:center;justify-content:center">
            ${img ? `<img src="${img}" style="width:100%;height:100%;object-fit:cover"/>` : '<i class="fa-solid fa-image" style="color:var(--border);font-size:1.5rem"></i>'}
          </div>
          <div style="flex:1;min-width:0">
            <div style="font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.title}</div>
            <div style="font-size:11px;color:var(--text-muted)">${p.product_id} ‚Ä¢ ‚Çπ${fmtN(p.price)} ‚Ä¢ Stock: ${p.stock}</div>
          </div>
          <span style="font-size:11px;font-weight:800;color:${statusColors[p.status]||'#6b7280'};background:${statusColors[p.status]||'#6b7280'}15;padding:3px 10px;border-radius:8px;text-transform:uppercase">${p.status}</span>
          <button class="btn btn-ghost btn-sm" onclick="deleteProduct('${p.product_id}')" title="Delete"><i class="fa-solid fa-trash" style="color:#ef4444"></i></button>
        </div>`;
      }).join('')}</div>`;
    }
    // Orders
    const tbody = document.getElementById('sellerOrdersBody');
    if(!orders.orders || !orders.orders.length){
      tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><p>No orders yet</p></td></tr>';
    } else {
      tbody.innerHTML = orders.orders.map(o => `<tr>
        <td style="font-weight:700;color:var(--accent);font-size:12px">${o.order_id}</td>
        <td style="font-size:12px">${o.product_title||o.product_id}</td>
        <td style="font-size:12px">${o.buyer_name}<br><span style="color:var(--text-muted)">${o.buyer_contact}</span></td>
        <td>${o.quantity}</td>
        <td style="font-weight:700">‚Çπ${fmtN(o.total_amount)}</td>
        <td>${statusBadge(o.status)}</td>
        <td style="color:var(--text-muted);font-size:12px">${fmtDate(o.created_at)}</td>
      </tr>`).join('');
    }
  } catch(e){
    console.error('Seller data error:', e);
  }
}

async function deleteProduct(productId){
  if(!confirm('Delete this product?')) return;
  try{
    await AUTH.api('/api/member/product/' + productId, { method:'DELETE' });
    notify('Product deleted','success');
    loadSellerData();
  } catch(e){ notify(e.message||'Failed','error'); }
}

/* ============================================
   MODALS
   ============================================ */
function openModal(id){ 
  const modal = document.getElementById(id);
  if(modal.classList.contains('modal-overlay')){
    modal.classList.remove('hidden'); 
  } else {
    modal.classList.add('show');
  }
}
function closeModal(id){ 
  const modal = document.getElementById(id);
  if(modal.classList.contains('modal-overlay')){
    modal.classList.add('hidden'); 
  } else {
    modal.classList.remove('show');
  }
}

/* ============================================
   UTILITIES
   ============================================ */
function fmtN(n){ return Math.round(n||0).toLocaleString('en-IN'); }
function fmtDate(d){
  if(!d) return '‚Äî';
  try{ return new Date(d).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'}); }
  catch(e){ return d; }
}
function notify(msg, type){
  if(typeof FWF_Notify !== 'undefined') FWF_Notify.toast(msg, type);
  else alert(msg);
}
function statusBadge(s){
  const map = {active:'b-active',inactive:'b-inactive',open:'b-open','in-progress':'b-progress',resolved:'b-resolved',closed:'b-closed',pending:'b-pending',donation:'b-active',referral:'b-open',quiz:'b-progress',redeem:'b-closed'};
  return `<span class="badge ${map[s]||'b-open'}">${s}</span>`;
}

/* ============================================
   MEMBER DATA
   ============================================ */
let memberData = null;

async function loadDashboard(){
  try {
    const data = await AUTH.api('/api/member/me');
    memberData = data;
    const u = data.user || {};
    const w = data.wallet || {};

    // Welcome
    document.getElementById('welcomeName').textContent = 'Welcome, ' + (u.name || 'Member') + '!';
    document.getElementById('welcomeId').textContent = u.member_id || 'FWFM000';
    document.getElementById('memberBadge').innerHTML = `<i class="fa-solid fa-circle-check"></i> ${u.member_id || 'Member'}`;

    // Top header
    const topUserEl = document.getElementById('topUserName');
    if(topUserEl) topUserEl.textContent = (u.name || 'MEMBER').toUpperCase().split(' ')[0];

    // Home stats
    document.getElementById('hPoints').textContent = fmtN(w.points_balance || w.total_points_earned);
    document.getElementById('hWallet').textContent = '‚Çπ' + fmtN(w.balance_inr);
    document.getElementById('hReferrals').textContent = fmtN(data.referralStats?.total || 0);
    document.getElementById('hDonations').textContent = '‚Çπ' + fmtN(data.recentDonations?.reduce((s,d)=>s+(d.amount||0),0) || 0);

    // Recent activity on home
    if(data.pointsLedger && data.pointsLedger.length){
      document.getElementById('homeActivity').innerHTML = data.pointsLedger.slice(0,5).map(p => `
        <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #f1f5f9">
          <div style="width:32px;height:32px;border-radius:8px;background:var(--accent-soft);color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:12px">
            <i class="fa-solid fa-${p.type==='donation'?'heart':p.type==='referral'?'user-plus':p.type==='quiz'?'ticket':'star'}"></i>
          </div>
          <div style="flex:1">
            <div style="font-size:12px;font-weight:700">${p.description||p.type}</div>
            <div style="font-size:11px;color:var(--text-muted)">${fmtDate(p.created_at)}</div>
          </div>
          <div style="font-weight:800;color:var(--success);font-size:13px">+${p.points}</div>
        </div>
      `).join('');
    }

    // Cache for profile
    populateProfile(data);

  } catch(e){
    if(e.status === 401 || e.status === 403){
      notify('Session expired. Redirecting to login...', 'error');
      setTimeout(() => location.href = '/login', 2000);
    } else {
      notify('Failed to load dashboard: ' + (e.message || 'Server error. Please refresh.'), 'error');
    }
  }
}

function populateProfile(data){
  const u = data.user || {};
  const initials = (u.name||'M').split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
  document.getElementById('profileAvatar').textContent = initials;
  document.getElementById('profileName').textContent = u.name || 'Member';
  document.getElementById('profileId').textContent = u.member_id || '';
  document.getElementById('profileMobile').textContent = u.mobile || '‚Äî';
  document.getElementById('profileEmail').textContent = u.email || '‚Äî';
  document.getElementById('profileJoined').textContent = fmtDate(u.created_at);
  document.getElementById('profileStatus').textContent = u.membership_active ? 'Active' : 'Expired';
  document.getElementById('profileStatus').style.color = u.membership_active ? 'var(--success)' : 'var(--danger)';
  document.getElementById('editName').value = u.name || '';
  document.getElementById('editBio').value = u.bio || '';

  // Dashboard ID Card
  document.getElementById('dashCardName').textContent = u.name || 'Member';
  document.getElementById('dashCardId').textContent = u.member_id || 'FWFM000';
  document.getElementById('dashCardMobile').textContent = u.mobile || '‚Äî';
  document.getElementById('dashCardJoined').textContent = fmtDate(u.created_at);

  // Profile ID Card
  document.getElementById('cardName').textContent = u.name || 'Member';
  document.getElementById('cardId').textContent = u.member_id || '';
  document.getElementById('cardMobile').textContent = u.mobile || '‚Äî';
  document.getElementById('cardJoined').textContent = fmtDate(u.created_at);

  // Social Book Feed Avatar
  const feedAvatar = document.getElementById('feedUserAvatar');
  if(feedAvatar) feedAvatar.textContent = initials;
}

function loadProfile(){
  if(memberData) populateProfile(memberData);
}

/* ============================================
   WALLET
   ============================================ */
async function loadWallet(){
  try{
    const data = memberData || await AUTH.api('/api/member/me');
    memberData = data;
    const w = data.wallet || {};

    // Overview stats
    const totalPts = w.points_balance || w.total_points_earned || 0;
    document.getElementById('walletTotalPoints').textContent = fmtN(totalPts);
    document.getElementById('walletBalance').textContent = '‚Çπ' + fmtN(w.balance_inr || 0);
    document.getElementById('walletTotalEarned').textContent = fmtN(w.total_points_earned || 0);
    document.getElementById('walletRedeemed').textContent = fmtN((w.total_points_earned || 0) - (w.points_balance || 0));

    // Points section stats
    document.getElementById('wPoints').textContent = fmtN(totalPts);
    document.getElementById('wDonPts').textContent = fmtN(w.points_from_donations);
    document.getElementById('wRefPts').textContent = fmtN(w.points_from_referrals);
    document.getElementById('wQuizPts').textContent = fmtN(w.points_from_quiz);

    // Points summary
    document.getElementById('pointsDonSummary').textContent = fmtN(w.points_from_donations) + ' pts';
    document.getElementById('pointsRefSummary').textContent = fmtN(w.points_from_referrals) + ' pts';
    document.getElementById('pointsQuizSummary').textContent = fmtN(w.points_from_quiz) + ' pts';

    // Points history
    const pts = data.recentPoints || [];
    const tbody = document.getElementById('pointsHistoryBody');
    if(pts.length){
      tbody.innerHTML = pts.map(p => `<tr>
        <td>${statusBadge(p.type)}</td>
        <td style="font-weight:800;color:var(--success)">+${p.points}</td>
        <td style="font-size:12px">${p.description||'‚Äî'}</td>
        <td style="color:var(--text-muted);font-size:12px">${fmtDate(p.created_at)}</td>
      </tr>`).join('');
    }

    // Membership fees
    const fees = data.membershipFees || [];
    const feeBody = document.getElementById('membershipFeesBody');
    if(fees.length){
      feeBody.innerHTML = fees.map(f => `<tr>
        <td style="color:var(--text-muted);font-size:12px">${fmtDate(f.created_at)}</td>
        <td style="font-weight:800">‚Çπ${fmtN(f.amount)}</td>
        <td>${statusBadge(f.status)}</td>
        <td style="font-size:12px">${f.txn_id || '‚Äî'}</td>
      </tr>`).join('');
    }

    // Donations
    const dons = data.recentDonations || [];
    const donBody = document.getElementById('myDonationsBody');
    if(dons.length){
      donBody.innerHTML = dons.map(d => `<tr>
        <td>${d.donor_name || 'Anonymous'}</td>
        <td style="font-weight:800">‚Çπ${fmtN(d.amount)}</td>
        <td style="color:var(--success);font-weight:700">+${d.points_earned}</td>
        <td style="color:var(--text-muted);font-size:12px">${fmtDate(d.created_at)}</td>
      </tr>`).join('');
    }

  } catch(e){ notify('Failed to load wallet','error'); }
}

/* ============================================
   REFERRAL & EARN
   ============================================ */
async function loadReferral(){
  try{
    const data = memberData || await AUTH.api('/api/member/me');
    memberData = data;

    // Referral code
    document.getElementById('refCode').value = data.user?.referral_code || 'N/A';

    // Referrals table
    const refs = data.referrals || [];
    const refBody = document.getElementById('referralsBody');
    if(refs.length){
      refBody.innerHTML = refs.map(r => `<tr>
        <td style="font-weight:700">${r.referred_name || '‚Äî'}</td>
        <td style="font-family:monospace;font-size:12px">${r.referred_member_id || '‚Äî'}</td>
        <td style="font-weight:800">‚Çπ${fmtN(r.amount)}</td>
        <td style="color:var(--success);font-weight:700">+${r.points_earned}</td>
        <td>${statusBadge(r.status)}</td>
        <td style="color:var(--text-muted);font-size:12px">${fmtDate(r.created_at)}</td>
      </tr>`).join('');
    }

    // Setup affiliate links
    setupQuizReferralLinks();

    // Load affiliate dashboard
    await loadAffiliateDashboard();

  } catch(e){ notify('Failed to load referral data','error'); }
}

/* ============================================
   APP-STYLE TABS (Wallet Single Page)
   ============================================ */
document.querySelectorAll('.app-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const group = tab.dataset.group;
    const target = tab.dataset.target;
    
    // Update tabs in same group
    document.querySelectorAll(`.app-tab[data-group="${group}"]`).forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    
    // Hide all tab bodies in same section
    const parent = tab.closest('.wallet-single-section');
    parent.querySelectorAll('.app-tab-body').forEach(c => {
      c.style.display = 'none';
    });
    
    // Show target
    const targetEl = document.getElementById(target);
    if(targetEl){
      targetEl.style.display = 'block';
    }
  });
});

function scrollToSection(id){
  const el = document.getElementById(id);
  if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
}

/* ============================================
   REDEEM MODAL
   ============================================ */
function openRedeemModal(){
  const pts = memberData?.wallet?.points_balance || memberData?.wallet?.total_points_earned || 0;
  document.getElementById('availPointsDisplay').textContent = pts;
  openModal('redeemModal');
}

// Close modal on outside click
document.addEventListener('click', (e) => {
  if(e.target.classList.contains('modal')){
    closeModal(e.target.id);
  }
});

// Close modal on ESC key
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape'){
    document.querySelectorAll('.modal.show').forEach(m => closeModal(m.id));
  }
});

// Payment method toggle
document.getElementById('bankRadio').addEventListener('change', () => {
  document.getElementById('bankDetailsSection').style.display = 'block';
  document.getElementById('upiDetailsSection').style.display = 'none';
});

document.getElementById('upiRadio').addEventListener('change', () => {
  document.getElementById('bankDetailsSection').style.display = 'none';
  document.getElementById('upiDetailsSection').style.display = 'block';
});

async function submitRedeemRequest(){
  const points = parseFloat(document.getElementById('redeemPointsInput').value);
  const cause = document.getElementById('socialCauseSelect').value;
  const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
  
  // Validation
  if(!points || points <= 0) return notify('Enter valid points amount','warning');
  
  const availPts = memberData?.wallet?.points_balance || memberData?.wallet?.total_points_earned || 0;
  if(points > availPts) return notify(`Insufficient points! You have ${availPts} points`,'warning');
  
  if(!cause) return notify('Select a social cause','warning');
  
  let paymentDetails = {};
  
  if(paymentMethod === 'bank'){
    const acc1 = document.getElementById('accNumber1').value.trim();
    const acc2 = document.getElementById('accNumber2').value.trim();
    const ifsc = document.getElementById('ifscCode').value.trim();
    const bank = document.getElementById('bankName').value.trim();
    const holder = document.getElementById('accHolder').value.trim();
    
    if(!acc1 || !acc2 || !ifsc || !bank || !holder){
      return notify('Fill all bank details','warning');
    }
    
    if(acc1 !== acc2){
      return notify('Account numbers do not match','error');
    }
    
    paymentDetails = {
      type: 'bank',
      accountNumber: acc1,
      ifsc,
      bankName: bank,
      accountHolder: holder
    };
  } else {
    const upi = document.getElementById('upiId').value.trim();
    if(!upi) return notify('Enter UPI ID','warning');
    
    paymentDetails = {
      type: 'upi',
      upiId: upi
    };
  }
  
  try{
    document.getElementById('submitRedeemBtn').disabled = true;
    document.getElementById('submitRedeemBtn').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Submitting...';
    
    // TODO: Send to backend API
    // For now, simulate success
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    closeModal('redeemModal');
    
    // Show success message
    if(typeof FWF_Notify !== 'undefined'){
      FWF_Notify.success(`Redemption request submitted successfully!<br><small>Your points will be received within 24 hours.</small>`, 5000);
    } else {
      notify('Request submitted! Points received within 24 hours.','success');
    }
    
    // Clear form
    document.getElementById('redeemPointsInput').value = '';
    document.getElementById('socialCauseSelect').value = '';
    document.getElementById('accNumber1').value = '';
    document.getElementById('accNumber2').value = '';
    document.getElementById('ifscCode').value = '';
    document.getElementById('bankName').value = '';
    document.getElementById('accHolder').value = '';
    document.getElementById('upiId').value = '';
    
    memberData = null;
    loadWallet();
    
  } catch(e){
    notify(e.message || 'Failed to submit request','error');
  } finally {
    document.getElementById('submitRedeemBtn').disabled = false;
    document.getElementById('submitRedeemBtn').innerHTML = '<i class="fa-solid fa-check"></i> Submit Request';
  }
}

/* ============================================
   ADD MEMBER & SUPPORTER
   ============================================ */
/* ============================================
   ACTION CARDS ‚Äî MODAL OPEN/CLOSE
   ============================================ */
const actionModalMap = {
  addMember:    'modalAddMember',
  addSupporter: 'modalAddSupporter',
  donation:     'modalDonation',
  sellTicket:   'modalSellTicket'
};

function openActionModal(key) {
  const el = document.getElementById(actionModalMap[key]);
  if (!el) return;
  el.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  // Reset Add Member to step 1
  if (key === 'addMember') {
    document.getElementById('amStep1').style.display = 'block';
    document.getElementById('amStep2').style.display = 'none';
    document.getElementById('amName').value = '';
    document.getElementById('amMobile').value = '';
    document.getElementById('amEmail').value = '';
  }
  // Reset Add Supporter to step 1
  if (key === 'addSupporter') {
    document.getElementById('spStep1').style.display = 'block';
    document.getElementById('spStep2').style.display = 'none';
    document.getElementById('spName').value = '';
    document.getElementById('spContact').value = '';
    document.getElementById('spAmount').value = '500';
    document.getElementById('spNotes').value = '';
    const btn = document.getElementById('spPayBtn');
    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-lock"></i> Proceed to Payment'; }
  }
}
function closeActionModal(key) {
  const el = document.getElementById(actionModalMap[key]);
  if (el) el.style.display = 'none';
  document.body.style.overflow = '';
}
// Close on backdrop click
Object.values(actionModalMap).forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('click', e => { if (e.target === el) closeActionModal(Object.keys(actionModalMap).find(k => actionModalMap[k] === id)); });
});

/* ============================================
   ADD MEMBER ‚Äî RAZORPAY PAYMENT FLOW
   ============================================ */
async function startMemberPayment() {
  const name   = document.getElementById('amName').value.trim();
  const mobile = document.getElementById('amMobile').value.trim();
  const email  = document.getElementById('amEmail').value.trim();

  if (!name || !mobile || !email) return notify('Please fill all fields', 'warning');
  if (mobile.length !== 10 || !/^\d{10}$/.test(mobile)) return notify('Enter valid 10-digit mobile', 'warning');
  if (!/\S+@\S+\.\S+/.test(email)) return notify('Enter valid email', 'warning');

  const btn = document.getElementById('amPayBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Creating order...';

  try {
    const orderRes = await AUTH.api('/api/pay/create-order', {
      method: 'POST',
      body: { amount: 500, type: 'membership', notes: { addedBy: memberData?.user?.member_id || '' } }
    });
    if (!orderRes.ok) throw new Error(orderRes.error || 'Order creation failed');

    btn.innerHTML = '<i class="fa-solid fa-lock"></i> Proceed to Pay ‚Çπ500';
    btn.disabled = false;

    const referrerCode = memberData?.user?.referral_code || '';

    const options = {
      key: orderRes.key,
      amount: orderRes.order.amount,
      currency: 'INR',
      name: 'FWF ‚Äî Foundation for Women\'s Future',
      description: 'Membership Registration ‚Çπ500',
      image: '/assets/images/logo.png',
      order_id: orderRes.order.id,
      prefill: { name, contact: mobile, email },
      theme: { color: '#E87722' },
      handler: async function(response) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Registering member...';
        try {
          const regRes = await AUTH.api('/api/pay/membership', {
            method: 'POST',
            body: {
              name, mobile, email,
              referrerCode,
              razorpay_payment_id:  response.razorpay_payment_id,
              razorpay_order_id:    response.razorpay_order_id,
              razorpay_signature:   response.razorpay_signature
            }
          });
          if (!regRes.ok) throw new Error(regRes.error || 'Registration failed');

          // Show success step
          document.getElementById('amStep1').style.display = 'none';
          document.getElementById('amStep2').style.display = 'block';
          document.getElementById('amResultId').textContent   = regRes.memberId;
          document.getElementById('amResultPass').textContent = regRes.password;
          document.getElementById('amResultPoints').textContent = regRes.referralPoints
            ? `üéâ You earned ${regRes.referralPoints} referral points!`
            : '‚úÖ Member registered successfully!';

          memberData = null; // refresh wallet
          loadWallet();
        } catch(e) {
          notify(e.message || 'Registration failed after payment. Contact support.', 'error');
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<i class="fa-solid fa-lock"></i> Proceed to Pay ‚Çπ500';
        }
      },
      modal: { ondismiss: () => { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-lock"></i> Proceed to Pay ‚Çπ500'; } }
    };
    const rzp = new Razorpay(options);
    rzp.on('payment.failed', resp => { notify('Payment failed: ' + (resp.error?.description || 'Unknown error'), 'error'); });
    rzp.open();
  } catch(e) {
    notify(e.message || 'Failed to start payment', 'error');
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-lock"></i> Proceed to Pay ‚Çπ500';
  }
}

/* ============================================
   ADD SUPPORTER (Razorpay payment + 10% points)
   ============================================ */
async function startSupporterPayment() {
  const name    = document.getElementById('spName').value.trim();
  const contact = document.getElementById('spContact').value.trim();
  const amount  = parseFloat(document.getElementById('spAmount').value);
  const notes   = document.getElementById('spNotes').value.trim();

  if (!name || !contact)        return notify('Enter supporter name and contact', 'warning');
  if (!amount || amount < 1)    return notify('Enter a valid joining amount', 'warning');

  const btn = document.getElementById('spPayBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Creating order...';
  try {
    // Create Razorpay order
    const order = await AUTH.api('/api/pay/create-order', {
      method: 'POST',
      body: { amount, type: 'supporter', notes: { supporter: name } }
    });

    const options = {
      key:         order.key,
      amount:      order.order.amount,
      currency:    order.order.currency,
      name:        'FWF ‚Äî Supporter Joining',
      description: `Supporter: ${name}`,
      order_id:    order.order.id,
      handler: async function(resp) {
        try {
          const result = await AUTH.api('/api/pay/supporter', {
            method: 'POST',
            body: {
              supporterName:    name,
              supporterContact: contact,
              supporterNotes:   notes,
              amount,
              razorpay_payment_id: resp.razorpay_payment_id,
              razorpay_order_id:   resp.razorpay_order_id,
              razorpay_signature:  resp.razorpay_signature
            }
          });
          document.getElementById('spResultPoints').textContent =
            result.message || `Supporter added! You earned ${result.pointsEarned} points.`;
          document.getElementById('spStep1').style.display = 'none';
          document.getElementById('spStep2').style.display = 'block';
          memberData = null;
          loadWallet();
        } catch(e) {
          notify('Payment received but failed to record ‚Äî contact support: ' + e.message, 'warning');
        }
      },
      prefill:  { name: memberData?.name || '', contact: contact },
      theme:    { color: '#0a8f3f' },
      modal:    { ondismiss: () => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-lock"></i> Proceed to Payment';
      }}
    };
    const rzp = new Razorpay(options);
    rzp.open();
  } catch(e) {
    notify('Could not initiate payment: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-lock"></i> Proceed to Payment';
  }
}

function copyRefCode(){
  const code = document.getElementById('refCode').value;
  navigator.clipboard.writeText(code).then(()=> notify('Referral code copied!','success')).catch(()=>{});
}

/* ============================================
   EARN POINTS
   ============================================ */
async function submitDonation() {
  const amount = parseFloat(document.getElementById('donAmount').value);
  if (!amount || amount <= 0) return notify('Enter valid donation amount', 'warning');
  const btn = document.getElementById('donBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Recording...';
  try {
    const r = await AUTH.api('/api/member/record-donation', { method: 'POST', body: {
      amount,
      donorName:    document.getElementById('donName').value.trim(),
      donorContact: document.getElementById('donContact').value.trim()
    }});
    notify(r.message || `Donation recorded! +${r.pointsEarned} points`, 'success');
    document.getElementById('donAmount').value = '';
    document.getElementById('donName').value   = '';
    document.getElementById('donContact').value = '';
    closeActionModal('donation');
    memberData = null;
    loadWallet();
  } catch(e) { notify(e.message || 'Failed', 'error'); }
  finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-plus"></i> Record Donation'; }
}

async function submitTicket() {
  const buyerName = document.getElementById('tickBuyer').value.trim();
  if (!buyerName) return notify('Enter buyer name', 'warning');
  const btn = document.getElementById('tickBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Recording...';
  try {
    const r = await AUTH.api('/api/member/sell-ticket', { method: 'POST', body: {
      buyerName,
      buyerContact: document.getElementById('tickContact').value.trim(),
      ticketPrice:  parseFloat(document.getElementById('tickPrice').value) || 100
    }});
    notify(r.message || `Ticket recorded! +${r.pointsEarned} points`, 'success');
    document.getElementById('tickBuyer').value   = '';
    document.getElementById('tickContact').value = '';
    closeActionModal('sellTicket');
    memberData = null;
    loadWallet();
  } catch(e) { notify(e.message || 'Failed', 'error'); }
  finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-plus"></i> Record Ticket Sale'; }
}

/* ============================================
   REDEEM
   ============================================ */
async function redeemProject(projectName, cost){
  const pts = memberData?.wallet?.points_balance || memberData?.wallet?.total_points_earned || 0;
  if(pts < cost){
    notify(`Not enough points! You need ${cost} but have ${pts}`,'warning');
    return;
  }
  if(typeof FWF_Notify !== 'undefined'){
    FWF_Notify.confirm(`Redeem ${cost} points for "${projectName}"?`, async ()=>{
      try{
        await AUTH.api('/api/member/apply-wallet',{method:'POST',body:{amount:cost}});
        notify(`Successfully redeemed ${cost} points for ${projectName}!`,'success');
        memberData = null;
        loadRedeemPage();
      } catch(e){ notify(e.message||'Redemption failed','error'); }
    });
  } else {
    if(!confirm(`Redeem ${cost} points for "${projectName}"?`)) return;
    try{
      await AUTH.api('/api/member/apply-wallet',{method:'POST',body:{amount:cost}});
      notify('Redeemed!','success');
      memberData = null;
      loadRedeemPage();
    } catch(e){ notify(e.message||'Failed','error'); }
  }
}

/* ============================================
   SUPPORT
   ============================================ */
document.getElementById('submitTicketBtn').addEventListener('click', async ()=>{
  const subject = document.getElementById('supSubject').value.trim();
  const message = document.getElementById('supMessage').value.trim();
  if(!subject || !message) return notify('Fill subject and message','warning');
  try{
    await AUTH.api('/api/member/support-ticket',{method:'POST',body:{
      subject,
      message,
      category: document.getElementById('supCategory').value
    }});
    notify('Support ticket submitted!','success');
    document.getElementById('supSubject').value = '';
    document.getElementById('supMessage').value = '';
    loadMyTickets();
  } catch(e){ notify(e.message||'Failed','error'); }
});

async function loadMyTickets(){
  try{
    const d = await AUTH.api('/api/member/support-tickets');
    const tbody = document.getElementById('myTicketsBody');
    if(!d.tickets || !d.tickets.length){
      tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><p>No tickets submitted</p></td></tr>';
      return;
    }
    tbody.innerHTML = d.tickets.map(t => `<tr>
      <td style="font-weight:700;color:var(--accent)">${t.ticket_id}</td>
      <td style="font-weight:700;font-size:12px">${t.subject}</td>
      <td>${statusBadge(t.status)}</td>
      <td style="font-size:12px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.admin_reply||'‚Äî'}</td>
      <td style="color:var(--text-muted);font-size:12px">${fmtDate(t.created_at)}</td>
    </tr>`).join('');
  } catch(e){}
}

/* ============================================
   PROFILE UPDATE
   ============================================ */
document.getElementById('saveProfileBtn').addEventListener('click', async ()=>{
  const name = document.getElementById('editName').value.trim();
  const bio = document.getElementById('editBio').value.trim();
  try{
    await AUTH.api('/api/member/update-profile',{method:'POST',body:{name, bio}});
    notify('Profile updated!','success');
    memberData = null;
    loadDashboard();
  } catch(e){ notify(e.message||'Failed','error'); }
});

/* ============================================
   SOCIAL BOOK POST SUBMISSION
   ============================================ */

// Post templates for each activity type
const POST_TEMPLATES = {
  welfare: `üìç Location:
üë• Participants:
üéØ Activity:
üíö Impact:
‚ú® Outcome:`,
  
  training: `üéì Course:
üìç Location:
üë• Participants:
üìö Topics Covered:
‚úÖ Certification:
üíº Placement Rate:`,
  
  health: `üè• Camp Type:
üìç Location:
üë• Beneficiaries:
üíä Services:
üéØ Impact:`,
  
  plantation: `üå± Trees Planted:
üìç Location:
üë• Supporters:
üåç Area Covered:
üåø Species:`,
  
  education: `üìö Program:
üë• Students:
üìç Location:
üìñ Subjects:
üéØ Results:`,
  
  donation: `üíù Items Collected:
üìä Quantity:
üë• Donors:
üìç Location:
üéÅ Beneficiaries:`,
  
  awareness: `üì£ Campaign:
üéØ Message:
üë• Reached:
üìç Location:
üìä Methods:
üí° Impact:`,
  
  skill: `üíº Skill:
üë• Trained:
‚è±Ô∏è Duration:
üìç Location:
üèÜ Certification:
üéØ Employability:`,
  
  other: `üìå Activity:
üìç Location:
üë• Involved:
üéØ Goal:
‚úÖ Completed:`
};

// (pill selector replaces updateTemplate - moved below)

// (drag-drop handled inline in the new compact UI)

// Pill selector for activity type
function selectPostPill(btn){
  document.querySelectorAll('.post-pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  // Fill template if textarea is empty
  const type = btn.dataset.value;
  const textarea = document.getElementById('postDesc');
  if(type && POST_TEMPLATES[type]){
    if(!textarea.value || textarea.value.includes('üìç') || textarea.value.includes('üìå') || textarea.value.length < 5){
      textarea.value = POST_TEMPLATES[type];
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
      document.getElementById('postCharCount').textContent = textarea.value.length;
    }
  }
  textarea.focus();
}

// Char counter for post textarea
(function(){
  const desc = document.getElementById('postDesc');
  const counter = document.getElementById('postCharCount');
  if(desc && counter){
    desc.addEventListener('input', () => { counter.textContent = desc.value.length; });
  }
})();

// Handle image file selection and show preview (WhatsApp-style)
let postImageFiles = [];
let postImageDataUrls = [];
let postActiveImageIdx = 0;

function handlePostImageSelect(e){
  const files = Array.from(e.target.files || []);
  for(const file of files){
    if(postImageFiles.length >= 10){ notify('Max 10 photos allowed','warning'); break; }
    if(file.size > 5 * 1024 * 1024){ notify(`${file.name} is too large (max 5MB)`,'warning'); continue; }
    postImageFiles.push(file);
    const reader = new FileReader();
    reader.onload = (event) => {
      postImageDataUrls.push(event.target.result);
      renderPostImagePreview();
    };
    reader.readAsDataURL(file);
  }
  // Reset file input so same file can be re-selected
  e.target.value = '';
}

function renderPostImagePreview(){
  const area = document.getElementById('postImageArea');
  const prompt = document.getElementById('postAddPhotoPrompt');
  const mainImg = document.getElementById('postMainImg');
  const strip = document.getElementById('postThumbStrip');
  const countEl = document.getElementById('postPhotoNum');
  
  if(postImageDataUrls.length === 0){
    area.style.display = 'none';
    prompt.style.display = 'block';
    return;
  }
  
  area.style.display = 'block';
  prompt.style.display = 'none';
  
  // Clamp active index
  if(postActiveImageIdx >= postImageDataUrls.length) postActiveImageIdx = postImageDataUrls.length - 1;
  if(postActiveImageIdx < 0) postActiveImageIdx = 0;
  
  // Main large image
  mainImg.src = postImageDataUrls[postActiveImageIdx];
  
  // Photo count
  countEl.textContent = postImageDataUrls.length;
  
  // Thumbnail strip (show if more than 1 photo)
  if(postImageDataUrls.length > 1){
    strip.style.display = 'block';
    strip.innerHTML = postImageDataUrls.map((url, i) => `
      <span class="thumb-item ${i === postActiveImageIdx ? 'active' : ''}" onclick="selectPostThumb(${i})">
        <img src="${url}" alt="">
        <button type="button" class="thumb-remove" onclick="event.stopPropagation();removePostImage(${i})">&times;</button>
      </span>
    `).join('');
    // Scroll active thumb into view
    setTimeout(() => {
      const activeThumb = strip.querySelector('.thumb-item.active');
      if(activeThumb) activeThumb.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
    }, 50);
  } else {
    strip.style.display = 'none';
    strip.innerHTML = '';
  }
}

function selectPostThumb(idx){
  postActiveImageIdx = idx;
  renderPostImagePreview();
}

function removePostImage(idx){
  postImageFiles.splice(idx, 1);
  postImageDataUrls.splice(idx, 1);
  renderPostImagePreview();
}

function updatePostImageCount(){
  // Legacy compat - now handled by renderPostImagePreview
  renderPostImagePreview();
}

async function submitPost(){
  const description = document.getElementById('postDesc').value.trim();
  const mediaFiles = document.getElementById('postMedia').files;
  
  if(!description || description.length < 10){ 
    notify('Please describe your activity (at least 10 characters)','warning'); 
    return; 
  }
  
  const btn = document.getElementById('submitPostBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
  
  try{
    // Upload images to Cloudinary directly from browser (original quality, no size limit)
    const images = [];
    const allFiles = postImageFiles.length > 0 ? postImageFiles : Array.from(mediaFiles);
    if(allFiles.length > 0){
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i><span style="font-size:11px;margin-left:4px">Uploading...</span>';
    }
    for(const f of allFiles){
      if(f.size > 15*1024*1024){ notify(`${f.name} is too large (max 15MB)`,'warning'); continue; }
      const url = await uploadToCloudinary(f);
      images.push(url);
    }
    
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
    
    // Submit to backend ‚Äî saved as 'pending' until admin approves
    await AUTH.api('/api/member/create-post', {
      method: 'POST',
      body: { content: description, images, post_type: 'other' }
    });
    
    closeModal('postModal');
    
    if(typeof FWF_Notify !== 'undefined'){
      FWF_Notify.toast('üéâ Post submitted for admin review!<br><small>You will be notified once it is approved.</small>', 'success');
    } else {
      notify('Post submitted! Pending admin approval.','success');
    }
    
    // Clear form
    document.getElementById('postDesc').value = '';
    document.getElementById('postDesc').style.height = 'auto';
    document.getElementById('postMedia').value = '';
    document.getElementById('postCharCount').textContent = '0';
    postImageFiles = [];
    postImageDataUrls = [];
    postActiveImageIdx = 0;
    renderPostImagePreview();
    
  } catch(e){
    notify(e.message || 'Failed to submit post','error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
  }
}

/* ============================================
   EVENTS & ACTIVITIES ‚Äî UNIFIED PAGE
   ============================================ */
let eventsLoaded = false;
let allQuizzesCache = []; // for tier filtering
let currentTaskData = null; // for popup

async function loadEventsPage(){
  if(eventsLoaded) return;
  eventsLoaded = true;
  try {
    await Promise.all([loadSocialTasksGrid(), loadActiveQuizzes(), loadMyActivities()]);
    setupQuizReferralLinks();
  } catch(e){ console.error('Events load err:', e); }
}

// --- SOCIAL TASKS GRID ---
const taskGradients = [
  'linear-gradient(135deg,#065f46,#059669)', // green
  'linear-gradient(135deg,#1e40af,#3b82f6)', // blue
  'linear-gradient(135deg,#92400e,#d97706)', // amber
  'linear-gradient(135deg,#7c2d12,#ea580c)', // orange
  'linear-gradient(135deg,#581c87,#9333ea)', // purple
  'linear-gradient(135deg,#155e75,#06b6d4)', // cyan
  'linear-gradient(135deg,#9f1239,#f43f5e)', // rose
  'linear-gradient(135deg,#1e3a5f,#3b82f6)', // navy
  'linear-gradient(135deg,#064e3b,#10b981)', // emerald
  'linear-gradient(135deg,#78350f,#f59e0b)', // gold
];

async function loadSocialTasksGrid(){
  try {
    const data = await AUTH.api('/api/member/all-tasks');
    const grid = document.getElementById('socialTasksGrid');
    if(!data.ok || !data.tasks?.length){
      grid.innerHTML = '<p style="color:var(--text-muted);font-size:13px;text-align:center;padding:20px">‡§ï‡•ã‡§à task ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç</p>';
      return;
    }
    const completedIds = new Set(data.completions?.map(c => c.task_id || `TASK-0${c.week_number}`) || []);

    grid.innerHTML = data.tasks.map((t, i) => {
      const done = completedIds.has(t.task_id);
      const grad = taskGradients[i % taskGradients.length];
      return `
        <div onclick="openTaskPopup(${i})" style="cursor:pointer;border-radius:18px;overflow:hidden;position:relative;background:${grad};padding:18px 14px 14px;color:#fff;min-height:150px;display:flex;flex-direction:column;justify-content:space-between;transition:transform .15s,box-shadow .15s;box-shadow:0 4px 16px rgba(0,0,0,.08)" onmouseenter="this.style.transform='translateY(-3px)'" onmouseleave="this.style.transform='none'">
          <div style="position:absolute;top:0;right:0;width:70px;height:70px;background:radial-gradient(circle,rgba(255,255,255,.1),transparent);pointer-events:none"></div>
          ${done ? '<div style="position:absolute;top:8px;right:8px;background:rgba(255,255,255,.25);width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px">‚úÖ</div>' : ''}
          <div style="font-size:32px;margin-bottom:8px">${t.icon}</div>
          <div>
            <div style="font-size:12px;font-weight:800;line-height:1.35;margin-bottom:4px">${t.title}</div>
            <div style="font-size:10px;opacity:.75;line-height:1.3">${t.description.substring(0,50)}...</div>
          </div>
        </div>`;
    }).join('');

    // Store for popup use
    window._socialTasks = data.tasks;
    window._socialCompletedIds = completedIds;
  } catch(e){
    document.getElementById('socialTasksGrid').innerHTML = '<p style="color:var(--danger);font-size:13px">Tasks load error</p>';
  }
}

function openTaskPopup(idx){
  const t = window._socialTasks[idx];
  if(!t) return;
  currentTaskData = t;
  const grad = taskGradients[idx % taskGradients.length];
  const done = window._socialCompletedIds?.has(t.task_id);

  document.getElementById('taskModalHeader').style.background = grad;
  document.getElementById('taskModalIcon').textContent = t.icon;
  document.getElementById('taskModalTitle').textContent = t.title;
  document.getElementById('taskModalDesc').textContent = t.description;
  document.getElementById('taskModalInstruction').textContent = t.photo_instruction;

  // Reset selfie
  document.getElementById('taskSelfiePreview').style.display = 'none';
  document.getElementById('taskSelfieInput').value = '';
  const submitBtn = document.getElementById('taskSelfieSubmitBtn');
  submitBtn.disabled = true;

  if(done){
    document.getElementById('taskSelfieArea').innerHTML = `
      <div style="padding:16px;text-align:center">
        <div style="font-size:40px;margin-bottom:6px">üéâ</div>
        <div style="font-weight:800;font-size:14px;color:#166534">‡§Ü‡§™‡§®‡•á ‡§Ø‡§π ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§™‡•Ç‡§∞‡§æ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ!</div>
      </div>`;
    submitBtn.style.display = 'none';
  } else {
    document.getElementById('taskSelfieArea').innerHTML = `
      <div id="taskSelfiePreview" style="display:none;margin-bottom:10px">
        <img id="taskSelfieImg" style="max-width:100%;max-height:200px;border-radius:12px">
      </div>
      <label style="display:inline-flex;align-items:center;gap:8px;padding:12px 20px;background:linear-gradient(135deg,#E87722,#ff9a3c);color:#fff;border-radius:12px;cursor:pointer;font-weight:700;font-size:13px">
        <i class="fa-solid fa-camera"></i> Selfie ‡§≤‡•á‡§Ç / Photo ‡§ö‡•Å‡§®‡•á‡§Ç
        <input type="file" accept="image/*" capture="user" id="taskSelfieInput" onchange="previewTaskSelfie(this)" style="display:none">
      </label>`;
    submitBtn.style.display = 'flex';
    submitBtn.disabled = true;
  }

  openModal('socialTaskModal');
}

function previewTaskSelfie(input){
  if(input.files && input.files[0]){
    const reader = new FileReader();
    reader.onload = (e) => {
      let preview = document.getElementById('taskSelfiePreview');
      let img = document.getElementById('taskSelfieImg');
      if(!preview || !img){
        // Re-query after DOM rebuild
        const area = document.getElementById('taskSelfieArea');
        preview = area.querySelector('#taskSelfiePreview');
        img = area.querySelector('#taskSelfieImg');
      }
      if(img) img.src = e.target.result;
      if(preview) preview.style.display = 'block';
      document.getElementById('taskSelfieSubmitBtn').disabled = false;
    };
    reader.readAsDataURL(input.files[0]);
  }
}

async function submitTaskSelfie(){
  const fileInput = document.getElementById('taskSelfieInput');
  if(!fileInput?.files?.length){ notify('‡§ï‡•É‡§™‡§Ø‡§æ Selfie/Photo ‡§≤‡•á‡§Ç','error'); return; }
  if(!currentTaskData){ notify('Task data not found','error'); return; }

  const btn = document.getElementById('taskSelfieSubmitBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading...';

  try {
    // 1. Upload to Cloudinary
    const imgUrl = await uploadToCloudinary(fileInput.files[0]);

    // 2. Complete the task via existing API
    let latitude = null, longitude = null;
    try {
      const pos = await new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
      });
      latitude = pos.coords.latitude;
      longitude = pos.coords.longitude;
    } catch(e){ /* optional */ }

    const taskRes = await AUTH.api('/api/member/complete-task', {
      method: 'POST',
      body: { task_id: currentTaskData.task_id, photo_url: imgUrl, latitude, longitude, location_address: '' }
    });
    // Note: backend auto-creates a Social Book post on task completion

    closeModal('socialTaskModal');
    if(taskRes.ok){
      notify('üéâ ‡§¨‡§π‡•Å‡§§ ‡§Ö‡§ö‡•ç‡§õ‡•á! Selfie Social Book ‡§™‡§∞ share ‡§π‡•ã ‡§ó‡§à!', 'success');
    } else {
      notify(taskRes.error || 'Error submitting task', 'error');
    }
    eventsLoaded = false;
    loadEventsPage();
    memberData = null;
  } catch(e){
    notify(e.message || 'Submit failed', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Selfie Share ‡§ï‡§∞‡•á‡§Ç ‚Äî Social Book ‡§™‡§∞ Post ‡§π‡•ã‡§ó‡§æ!';
  }
}

// --- QUIZ GAMES (Modern Cards + Tier Filter) ---
const tierConfig = {
  monthly:     { color:'#3b82f6', gradient:'linear-gradient(135deg,#3b82f6,#2563eb)', label:'Monthly', emoji:'üóìÔ∏è', fee:100 },
  half_yearly: { color:'#8b5cf6', gradient:'linear-gradient(135deg,#8b5cf6,#7c3aed)', label:'Half-Yearly', emoji:'üìÖ', fee:500 },
  yearly:      { color:'#e11d48', gradient:'linear-gradient(135deg,#e11d48,#be123c)', label:'Yearly', emoji:'üèÜ', fee:1000 }
};
const gameTypeIcons = {
  mcq:         { icon:'fa-solid fa-list-check', label:'MCQ Quiz', color:'#3b82f6' },
  true_false:  { icon:'fa-solid fa-check-double', label:'True / False', color:'#10b981' },
  picture:     { icon:'fa-solid fa-image', label:'Picture Quiz', color:'#f59e0b' },
  speed:       { icon:'fa-solid fa-bolt', label:'Speed Round', color:'#ef4444' },
  puzzle:      { icon:'fa-solid fa-puzzle-piece', label:'Puzzle', color:'#8b5cf6' },
  general:     { icon:'fa-solid fa-brain', label:'GK Quiz', color:'#06b6d4' }
};

async function loadActiveQuizzes(){
  try {
    const data = await AUTH.api('/api/member/active-quizzes');
    const grid = document.getElementById('quizGamesGrid');
    const empty = document.getElementById('quizEmptyState');

    if(!data.ok || !data.quizzes?.length){
      grid.style.display = 'none';
      empty.style.display = 'block';
      allQuizzesCache = [];
      return;
    }
    allQuizzesCache = data.quizzes;
    renderQuizCards(allQuizzesCache);
  } catch(e){
    document.getElementById('quizGamesGrid').innerHTML = '<p style="color:var(--danger);font-size:13px;text-align:center;padding:20px">Games load error</p>';
  }
}

function renderQuizCards(quizzes){
  const grid = document.getElementById('quizGamesGrid');
  const empty = document.getElementById('quizEmptyState');

  if(!quizzes.length){
    grid.style.display = 'none';
    empty.style.display = 'block';
    return;
  }
  grid.style.display = 'grid';
  empty.style.display = 'none';

  grid.innerHTML = quizzes.map(q => {
    const tc = tierConfig[q.type] || tierConfig.monthly;
    const gt = gameTypeIcons[q.game_type] || gameTypeIcons.mcq;
    const endDate = new Date(q.end_date).toLocaleDateString('hi-IN',{day:'numeric',month:'short'});
    const resultDate = new Date(q.result_date).toLocaleDateString('hi-IN',{day:'numeric',month:'short',year:'numeric'});
    const participants = q.total_participants || 0;
    const prizePool = q.prize_pool || (q.entry_fee * participants * 0.7);

    return `
      <div class="quiz-game-card" data-tier="${q.type}" style="position:relative;border-radius:18px;overflow:hidden;background:#fff;border:1.5px solid ${tc.color}22;box-shadow:0 4px 20px rgba(0,0,0,.06);transition:transform .2s,box-shadow .2s">
        <!-- Card Header -->
        <div style="background:${tc.gradient};padding:16px 18px 14px;color:#fff;position:relative">
          <div style="position:absolute;top:0;right:0;width:80px;height:80px;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%);pointer-events:none"></div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
            <span style="background:rgba(255,255,255,.2);padding:3px 10px;border-radius:16px;font-size:10px;font-weight:800;letter-spacing:.5px">${tc.emoji} ${tc.label.toUpperCase()}</span>
            <span style="background:rgba(255,255,255,.2);padding:3px 10px;border-radius:16px;font-size:10px;font-weight:700"><i class="${gt.icon}"></i> ${gt.label}</span>
          </div>
          <h4 style="margin:6px 0 4px;font-size:16px;font-weight:900;line-height:1.3;color:#fff">${q.title}</h4>
          ${q.description ? `<p style="font-size:11px;opacity:.85;margin:0;line-height:1.4">${q.description.substring(0,80)}${q.description.length>80?'...':''}</p>` : ''}
        </div>

        <!-- Card Body -->
        <div style="padding:14px 18px 16px">
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px">
            <div style="flex:1;min-width:70px;background:${tc.color}08;border-radius:10px;padding:8px 10px;text-align:center">
              <div style="font-size:16px;font-weight:900;color:${tc.color}">‚Çπ${q.entry_fee}</div>
              <div style="font-size:9px;color:var(--text-muted);font-weight:600">ENTRY FEE</div>
            </div>
            <div style="flex:1;min-width:70px;background:#fef3c708;border:1px solid #fde68a;border-radius:10px;padding:8px 10px;text-align:center">
              <div style="font-size:16px;font-weight:900;color:#92400e">${participants}</div>
              <div style="font-size:9px;color:var(--text-muted);font-weight:600">PLAYERS</div>
            </div>
            <div style="flex:1;min-width:70px;background:#f0fdf408;border:1px solid #bbf7d0;border-radius:10px;padding:8px 10px;text-align:center">
              <div style="font-size:16px;font-weight:900;color:#166534">‚Çπ${prizePool > 0 ? prizePool.toLocaleString() : '‚Äî'}</div>
              <div style="font-size:9px;color:var(--text-muted);font-weight:600">PRIZE POOL</div>
            </div>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--text-muted);margin-bottom:12px">
            <span>üìÖ Last: ${endDate}</span>
            <span>üèÜ Result: ${resultDate}</span>
          </div>

          ${q.enrolled ? `
            <div style="background:#f0fdf4;border:1.5px solid #86efac;border-radius:12px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px">
              <div>
                <div style="color:#166534;font-weight:800;font-size:13px">‚úÖ Enrolled</div>
                <div style="color:#15803d;font-size:10px">${q.enrollment?.enrollment_number || ''}</div>
              </div>
              ${q.enrollment && !q.enrollment.quiz_submitted && q.status === 'active' ? 
                `<button class="btn btn-sm" onclick="openQuizPlay('${q.quiz_id}')" style="background:${tc.gradient};color:#fff;font-weight:700;border:none"><i class="fa-solid fa-play"></i> Play</button>` : ''}
              ${q.enrollment?.quiz_submitted ? '<span style="font-size:11px;color:#166534;font-weight:700">Submitted ‚úÖ</span>' : ''}
            </div>
          ` : `
            <button class="btn" onclick="enrollInQuiz('${q.quiz_id}','${q.title}',${q.entry_fee})" style="width:100%;background:${tc.gradient};color:#fff;font-weight:800;border:none;border-radius:12px;padding:11px;font-size:13px;display:flex;align-items:center;justify-content:center;gap:6px">
              <i class="fa-solid fa-ticket"></i> Enroll ‚Äî ‚Çπ${q.entry_fee}
            </button>
          `}
        </div>
      </div>`;
  }).join('');
}

function filterQuizTier(tier){
  // Update chip styles
  document.querySelectorAll('.game-chip').forEach(chip => {
    const isActive = chip.dataset.tier === tier;
    chip.classList.toggle('active', isActive);
    if(isActive){
      chip.style.background = chip.dataset.tier === 'all' ? 'var(--accent)' : (tierConfig[chip.dataset.tier]?.color || 'var(--accent)');
      chip.style.color = '#fff';
    } else {
      chip.style.background = 'transparent';
      chip.style.color = chip.dataset.tier === 'all' ? 'var(--accent)' : (tierConfig[chip.dataset.tier]?.color || 'var(--accent)');
    }
  });
  // Filter and render
  const filtered = tier === 'all' ? allQuizzesCache : allQuizzesCache.filter(q => q.type === tier);
  renderQuizCards(filtered);
}

async function enrollInQuiz(quizId, title, fee){
  if(!confirm(`"${title}" ‡§Æ‡•á‡§Ç enroll ‡§ï‡§∞‡•á‡§Ç?\nEntry Fee: ‚Çπ${fee}\n\nPayment proceed ‡§ï‡§∞‡•á‡§Ç?`)) return;

  try {
    // Create Razorpay order
    const orderRes = await AUTH.api('/api/pay/create-order', {
      method: 'POST',
      body: { amount: fee, receipt: `quiz_${quizId}_${Date.now()}`, notes: { type: 'quiz', quizId } }
    });
    if(!orderRes.ok) throw new Error(orderRes.error || 'Order creation failed');

    // Open Razorpay
    const options = {
      key: orderRes.key,
      amount: orderRes.order.amount,
      currency: 'INR',
      name: 'FWF Fund Raiser Quiz',
      description: title,
      order_id: orderRes.order.id,
      handler: async function(response){
        try {
          // Get referral code from URL if any
          const urlParams = new URLSearchParams(window.location.search);
          const referred_by = urlParams.get('ref') || '';

          const enrollRes = await AUTH.api('/api/member/quiz-enroll', {
            method: 'POST',
            body: {
              quiz_id: quizId,
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_order_id: response.razorpay_order_id,
              razorpay_signature: response.razorpay_signature,
              referred_by
            }
          });
          if(enrollRes.ok){
            notify(enrollRes.message || 'üéâ Enrollment successful!', 'success');
            eventsLoaded = false;
            loadEventsPage();
            memberData = null;
          } else {
            notify(enrollRes.error || 'Enrollment failed', 'error');
          }
        } catch(e){ notify('Enrollment error: ' + e.message, 'error'); }
      },
      prefill: {
        name: memberData?.user?.name || '',
        contact: memberData?.user?.mobile || '',
        email: memberData?.user?.email || ''
      },
      theme: { color: '#E87722' }
    };
    const rzp = new Razorpay(options);
    rzp.open();
  } catch(e){
    notify(e.message || 'Payment failed', 'error');
  }
}

async function openQuizPlay(quizId){
  try {
    const data = await AUTH.api(`/api/member/quiz-questions/${quizId}`);
    if(!data.ok){ notify(data.error || 'Quiz load failed','error'); return; }

    const questions = data.questions;
    let currentQ = 0;
    const answers = [];

    const gameType = data.gameType || 'mcq';
    const gtInfo = gameTypeIcons[gameType] || gameTypeIcons.mcq;

    // Build quiz modal
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.id = 'quizPlayModal';
    modal.innerHTML = `
      <div class="modal-content" style="max-width:600px;max-height:90vh;overflow-y:auto">
        <div class="modal-header" style="background:var(--accent);color:#fff">
          <h3 style="color:#fff"><i class="${gtInfo.icon}"></i> ${data.quizTitle}</h3>
          <div style="display:flex;gap:8px;align-items:center;margin-top:4px">
            <span style="background:rgba(255,255,255,.2);padding:2px 8px;border-radius:12px;font-size:10px;font-weight:700">${gtInfo.label}</span>
            <span style="font-size:11px;opacity:.8">${data.enrollmentNumber}</span>
          </div>
        </div>
        <div class="modal-body" id="quizPlayBody"></div>
        <div class="modal-actions" id="quizPlayActions"></div>
      </div>`;
    document.body.appendChild(modal);

    function renderQuestion(){
      const q = questions[currentQ];
      const isTrueFalse = gameType === 'true_false';
      const isPicture = gameType === 'picture';
      const isSpeed = gameType === 'speed';

      document.getElementById('quizPlayBody').innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <span style="background:#eff6ff;color:#1d4ed8;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700">
            Q ${currentQ+1}/${questions.length}
          </span>
          ${isSpeed ? `<span style="background:#fef2f2;color:#ef4444;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700"><i class="fa-solid fa-bolt"></i> Speed Round</span>` : ''}
          ${isPicture ? `<span style="background:#fef3c7;color:#92400e;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700"><i class="fa-solid fa-image"></i> Picture Quiz</span>` : ''}
        </div>
        <h4 style="font-size:15px;margin-bottom:16px;line-height:1.5">${q.question}</h4>
        ${isPicture && q.image_url ? `<img src="${q.image_url}" style="max-width:100%;max-height:200px;border-radius:12px;margin-bottom:12px;border:2px solid #e5e7eb">` : ''}
        <div style="display:${isTrueFalse ? 'grid;grid-template-columns:1fr 1fr;' : 'flex;flex-direction:column;'}gap:8px">
          ${q.options.map((opt,i) => `
            <label style="display:flex;align-items:center;${isTrueFalse ? 'justify-content:center;' : ''}gap:10px;padding:${isTrueFalse ? '16px' : '12px'};border-radius:${isTrueFalse ? '14px' : '10px'};border:2px solid ${answers[currentQ]===i?'#E87722':'#e5e7eb'};cursor:pointer;transition:all .2s;background:${answers[currentQ]===i?'#FFF4EB':'#fff'};${isTrueFalse ? 'font-size:16px;font-weight:800;' : ''}" onclick="selectQuizAnswer(${currentQ},${i})">
              ${!isTrueFalse ? `<input type="radio" name="q${currentQ}" value="${i}" ${answers[currentQ]===i?'checked':''} style="accent-color:#E87722">` : ''}
              <span style="font-size:${isTrueFalse ? '15px' : '14px'}">${isTrueFalse ? (i===0 ? '‚úÖ ' : '‚ùå ') : ''}${opt}</span>
            </label>
          `).join('')}
        </div>`;
      document.getElementById('quizPlayActions').innerHTML = `
        ${currentQ > 0 ? `<button class="btn btn-ghost" onclick="quizPrev()"><i class="fa-solid fa-arrow-left"></i> Previous</button>` : '<span></span>'}
        ${currentQ < questions.length-1 ? 
          `<button class="btn btn-primary" onclick="quizNext()">Next <i class="fa-solid fa-arrow-right"></i></button>` :
          `<button class="btn btn-success" onclick="submitQuizAnswers('${quizId}')"><i class="fa-solid fa-paper-plane"></i> Submit Quiz</button>`}`;
    }

    window.selectQuizAnswer = (qi, ai) => { answers[qi] = ai; renderQuestion(); };
    window.quizPrev = () => { if(currentQ > 0){ currentQ--; renderQuestion(); } };
    window.quizNext = () => { if(currentQ < questions.length-1){ currentQ++; renderQuestion(); } };
    window.submitQuizAnswers = async (qId) => {
      const unanswered = questions.filter((_,i) => answers[i] === undefined).length;
      if(unanswered > 0 && !confirm(`${unanswered} questions unanswered! Submit anyway?`)) return;
      try {
        const formattedAnswers = questions.map((q,i) => ({ q_no: q.q_no, selected: answers[i] ?? -1 }));
        const res = await AUTH.api('/api/member/quiz-submit', {
          method: 'POST',
          body: { quiz_id: qId, answers: formattedAnswers }
        });
        if(res.ok){
          notify(res.message || 'Quiz submitted!', 'success');
          document.getElementById('quizPlayModal').remove();
          eventsLoaded = false;
          loadEventsPage();
        } else { notify(res.error, 'error'); }
      } catch(e){ notify('Submit failed','error'); }
    };

    renderQuestion();
  } catch(e){ notify(e.message || 'Quiz load failed','error'); }
}

// --- MY ACTIVITIES ---
async function loadMyActivities(){
  try {
    const [taskRes, quizRes] = await Promise.all([
      AUTH.api('/api/member/task-history'),
      AUTH.api('/api/member/quiz-history')
    ]);

    // Stats
    document.getElementById('myTasksCompleted').textContent = taskRes.totalTasks || 0;
    document.getElementById('myQuizCount').textContent = quizRes.participations?.length || 0;
    document.getElementById('myQuizWins').textContent = quizRes.participations?.filter(p => p.status === 'won').length || 0;

    // Task history
    const taskList = document.getElementById('taskHistoryList');
    if(taskRes.completions?.length){
      taskList.innerHTML = taskRes.completions.map(c => `
        <div style="display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:var(--bg-1);margin-bottom:6px">
          <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#22c55e,#16a34a);display:flex;align-items:center;justify-content:center;color:#fff;font-size:14px;flex-shrink:0">‚úÖ</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:13px;font-weight:700">Task #${c.week_number}</div>
            <div style="font-size:11px;color:var(--text-muted)">${fmtDate(c.completed_at)}</div>
          </div>
          ${c.photo_url ? `<img src="${c.photo_url}" style="width:36px;height:36px;border-radius:6px;object-fit:cover" onclick="window.open(this.src)">` : ''}
        </div>
      `).join('');
    }

    // Quiz history
    const quizList = document.getElementById('quizHistoryList');
    if(quizRes.participations?.length){
      quizList.innerHTML = quizRes.participations.map(p => {
        const statusColors = { enrolled:'#3b82f6', submitted:'#f59e0b', won:'#22c55e', lost:'#ef4444' };
        const statusLabels = { enrolled:'Enrolled', submitted:'Submitted', won:'üèÜ Won', lost:'Result Out' };
        return `
          <div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:var(--bg-1);margin-bottom:6px">
            <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,${statusColors[p.status]||'#6b7280'},${statusColors[p.status]||'#4b5563'});display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;flex-shrink:0">
              <i class="fa-solid fa-${p.status==='won'?'trophy':p.status==='submitted'?'check':'ticket'}"></i>
            </div>
            <div style="flex:1;min-width:0">
              <div style="font-size:13px;font-weight:700">${p.quiz_details?.title || p.quiz_ref}</div>
              <div style="font-size:11px;color:var(--text-muted)">${p.enrollment_number} ‚Ä¢ ‚Çπ${p.amount_paid}</div>
            </div>
            <span style="background:${statusColors[p.status]}22;color:${statusColors[p.status]};padding:3px 8px;border-radius:12px;font-size:11px;font-weight:700">${statusLabels[p.status]}</span>
          </div>`;
      }).join('');
    }
  } catch(e){ console.error('Activities load err:', e); }
}

// --- REFERRAL LINKS ---
function setupQuizReferralLinks(){
  const refCode = memberData?.user?.referral_code || '';
  const baseUrl = window.location.origin;
  const quizRefLink = document.getElementById('quizReferralLink');
  if(quizRefLink) quizRefLink.value = `${baseUrl}/membership?ref=${refCode}#quiz`;

  const affJoinLink = document.getElementById('affJoinLink');
  if(affJoinLink) affJoinLink.value = `${baseUrl}/membership?ref=${refCode}`;

  const affQuizLink = document.getElementById('affQuizLink');
  if(affQuizLink) affQuizLink.value = `${baseUrl}/membership?ref=${refCode}#quiz`;
}

function copyQuizReferralLink(){
  const el = document.getElementById('quizReferralLink');
  if(el){ navigator.clipboard.writeText(el.value); notify('Link copied!','success'); }
}

function shareQuizReferral(platform){
  const link = document.getElementById('quizReferralLink')?.value || '';
  const text = `üéØ FWF Fund Raiser Quiz ‡§Æ‡•á‡§Ç ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ ‡§≤‡•á‡§Ç ‡§î‡§∞ ‡§á‡§®‡§æ‡§Æ ‡§ú‡•Ä‡§§‡•á‡§Ç!\n${link}`;
  if(platform === 'whatsapp') window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
  if(platform === 'telegram') window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`);
}

function copyAffLink(inputId){
  const el = document.getElementById(inputId);
  if(el){ navigator.clipboard.writeText(el.value); notify('Link copied!','success'); }
}

function shareAffLink(platform){
  const link = document.getElementById('affJoinLink')?.value || '';
  const text = `‚ú® FWF ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á‡§Ç! ‡§Æ‡§π‡§ø‡§≤‡§æ‡§ì‡§Ç ‡§ï‡§æ ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§¨‡§®‡§æ‡§è‡§Ç‡•§\n${link}`;
  if(platform === 'whatsapp') window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
  else if(platform === 'telegram') window.open(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`);
  else { navigator.clipboard.writeText(link); notify('Link copied!','success'); }
}

// --- AFFILIATE DASHBOARD ---
async function loadAffiliateDashboard(){
  try {
    const data = await AUTH.api('/api/member/affiliate');
    if(!data.ok) return;

    const s = data.stats || {};
    document.getElementById('affTotalClicks').textContent = fmtN(s.totalClicks || 0);
    document.getElementById('affConversions').textContent = fmtN(s.conversions || 0);
    document.getElementById('affQuizClicks').textContent = fmtN(s.quizClicks || 0);
    document.getElementById('affRevenue').textContent = '‚Çπ' + fmtN(s.totalRevenue || 0);

    // Quiz referral earnings table
    const earningsBody = document.getElementById('affQuizEarningsBody');
    if(data.quizRefEarnings?.length){
      earningsBody.innerHTML = data.quizRefEarnings.map(e => `<tr>
        <td style="font-size:12px">${e.description}</td>
        <td style="font-weight:800;color:var(--success)">+${e.points}</td>
        <td style="color:var(--text-muted);font-size:12px">${fmtDate(e.created_at)}</td>
      </tr>`).join('');
    }

    // Recent clicks table
    const clicksBody = document.getElementById('affRecentClicksBody');
    if(data.recentClicks?.length){
      clicksBody.innerHTML = data.recentClicks.map(c => `<tr>
        <td>${statusBadge(c.link_type)}</td>
        <td>${c.converted ? '<span style="color:var(--success);font-weight:700">‚úÖ Yes</span>' : '<span style="color:var(--text-muted)">‚Äî</span>'}</td>
        <td>${c.conversion_amount ? '‚Çπ'+fmtN(c.conversion_amount) : '‚Äî'}</td>
        <td style="color:var(--text-muted);font-size:12px">${fmtDate(c.created_at)}</td>
      </tr>`).join('');
    }
  } catch(e){ console.error('Affiliate load err:', e); }
}

/* ============================================
   LOGOUT
   ============================================ */
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  if(typeof FWF_Notify !== 'undefined'){
    FWF_Notify.confirm('Logout from your account?', async ()=>{
      await AUTH.api('/api/auth/logout',{method:'POST'});
      notify('Logged out','success');
      setTimeout(()=> location.href = '/', 1000);
    });
  } else {
    if(confirm('Logout?')){
      AUTH.api('/api/auth/logout',{method:'POST'}).finally(()=> location.href = '/');
    }
  }
});

/* ============================================
   INIT
   ============================================ */
loadDashboard();
loadStoreCategories();
</script>
</body>
</html>
