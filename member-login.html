<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Member Login Portal — FWF</title>

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="/assets/images/logo.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/logo.png">
<link rel="apple-touch-icon" href="/assets/images/logo.png">
<link rel="shortcut icon" href="/assets/images/logo.png">

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Plus Jakarta Sans',sans-serif;
  min-height:100vh;
  display:grid;
  place-items:center;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);
  background-size:200% 200%;
  animation:gradientShift 15s ease infinite;
  padding:20px;
  position:relative;
  overflow:hidden;
}
@keyframes gradientShift{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
body::before{
  content:"";position:absolute;inset:0;
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.05" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,138.7C960,139,1056,117,1152,101.3C1248,85,1344,75,1392,69.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
  background-size:cover;
  background-position:bottom;
  pointer-events:none;
}

.login-container{
  width:100%;max-width:440px;
  background:rgba(255,255,255,.95);
  backdrop-filter:blur(20px) saturate(180%);
  border-radius:24px;
  padding:48px 40px;
  box-shadow:0 20px 60px rgba(0,0,0,.3),0 0 1px rgba(255,255,255,.5) inset;
  position:relative;
  animation:slideUp .6s cubic-bezier(.34,1.56,.64,1);
}
@keyframes slideUp{
  from{opacity:0;transform:translateY(30px) scale(.95)}
  to{opacity:1;transform:translateY(0) scale(1)}
}

.logo-box{
  text-align:center;margin-bottom:32px;
}
.logo-img{
  width:80px;height:80px;border-radius:20px;
  box-shadow:0 8px 24px rgba(102,126,234,.3);
  margin-bottom:16px;
  animation:float 3s ease-in-out infinite;
}
@keyframes float{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-10px)}
}
.logo-title{
  font-size:28px;font-weight:800;
  background:linear-gradient(135deg,#667eea,#764ba2);
  -webkit-background-clip:text;
  background-clip:text;
  -webkit-text-fill-color:transparent;
  letter-spacing:-.5px;
}
.logo-subtitle{
  color:#64748b;font-size:14px;font-weight:600;
  margin-top:4px;letter-spacing:.3px;
}

.input-group{
  position:relative;margin-bottom:24px;
}
.input-icon{
  position:absolute;left:18px;top:50%;transform:translateY(-50%);
  color:#667eea;font-size:18px;transition:all .3s;
  pointer-events:none;
}
.input-field{
  width:100%;padding:16px 20px 16px 52px;
  border:2px solid #e2e8f0;
  border-radius:14px;
  background:#f8fafc;
  font-size:15px;font-weight:600;
  color:#1e293b;
  transition:all .3s;
  font-family:'Plus Jakarta Sans',sans-serif;
}
.input-field:focus{
  outline:none;
  border-color:#667eea;
  background:#fff;
  box-shadow:0 0 0 4px rgba(102,126,234,.1);
}
.input-field:focus + .input-icon{
  color:#764ba2;transform:translateY(-50%) scale(1.1);
}
.input-field::placeholder{color:#94a3b8;font-weight:500}

.toggle-password{
  position:absolute;right:18px;top:50%;
  transform:translateY(-50%);
  background:transparent;
  border:none;
  cursor:pointer;
  padding:8px;
  color:#667eea;
  font-size:18px;
  transition:all .3s;
  z-index:2;
}
.toggle-password:hover{
  color:#764ba2;
  transform:translateY(-50%) scale(1.15);
}
.toggle-password:active{
  transform:translateY(-50%) scale(0.95);
}

.input-group.has-toggle .input-field{
  padding-right:52px;
}

.forgot-password{
  display:inline-block;
  font-size:13px;
  font-weight:700;
  color:#667eea;
  text-decoration:none;
  margin-bottom:16px;
  transition:all .3s;
  letter-spacing:.3px;
}
.forgot-password:hover{
  color:#764ba2;
  transform:translateX(2px);
}
.forgot-password i{
  margin-right:4px;
  font-size:12px;
}

.login-btn{
  width:100%;padding:16px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:#fff;border:none;border-radius:14px;
  font-size:16px;font-weight:800;
  cursor:pointer;
  box-shadow:0 8px 20px rgba(102,126,234,.4);
  transition:all .3s;
  letter-spacing:.5px;
  position:relative;
  overflow:hidden;
}
.login-btn::before{
  content:"";position:absolute;inset:0;
  background:linear-gradient(135deg,#764ba2,#f093fb);
  opacity:0;transition:opacity .3s;
}
.login-btn:hover{
  transform:translateY(-2px);
  box-shadow:0 12px 28px rgba(102,126,234,.5);
}
.login-btn:hover::before{opacity:1}
.login-btn:active{transform:translateY(0)}
.login-btn span{position:relative;z-index:1}

.divider{
  display:flex;align-items:center;gap:12px;
  margin:28px 0;color:#94a3b8;font-size:13px;font-weight:600;
}
.divider::before,.divider::after{
  content:"";flex:1;height:1px;
  background:linear-gradient(90deg,transparent,#e2e8f0,transparent);
}

.signup-link{
  text-align:center;font-size:14px;color:#64748b;font-weight:600;
}
.signup-link a{
  color:#667eea;text-decoration:none;font-weight:800;
  transition:color .3s;
}
.signup-link a:hover{color:#764ba2}

.home-btn{
  position:fixed;top:24px;left:24px;
  width:48px;height:48px;
  background:rgba(255,255,255,.9);
  border-radius:12px;
  display:grid;place-items:center;
  color:#667eea;font-size:20px;
  text-decoration:none;
  box-shadow:0 4px 12px rgba(0,0,0,.1);
  transition:all .3s;
}
.home-btn:hover{
  transform:scale(1.05);
  background:#fff;
  box-shadow:0 8px 20px rgba(0,0,0,.15);
}

@media (max-width:480px){
  .login-container{padding:36px 28px}
  .logo-title{font-size:24px}
}

/* Forgot Password Modal */
.modal-overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(8px);
  display:none;align-items:center;justify-content:center;
  z-index:9999;
  animation:fadeIn .3s;
}
.modal-overlay.active{display:flex}

@keyframes fadeIn{
  from{opacity:0}
  to{opacity:1}
}

.modal-container{
  background:#fff;
  border-radius:24px;
  max-width:440px;width:90%;
  padding:40px;
  box-shadow:0 20px 60px rgba(0,0,0,.3);
  animation:slideUp .4s cubic-bezier(.34,1.56,.64,1);
  position:relative;
  max-height:90vh;
  overflow-y:auto;
}

.modal-close{
  position:absolute;top:16px;right:16px;
  background:transparent;border:none;
  font-size:24px;color:#94a3b8;
  cursor:pointer;width:40px;height:40px;
  border-radius:50%;
  display:grid;place-items:center;
  transition:all .3s;
}
.modal-close:hover{
  background:#f1f5f9;color:#667eea;
  transform:rotate(90deg);
}

.modal-title{
  font-size:24px;font-weight:800;
  background:linear-gradient(135deg,#667eea,#764ba2);
  -webkit-background-clip:text;
  background-clip:text;
  -webkit-text-fill-color:transparent;
  margin-bottom:8px;
}

.modal-subtitle{
  color:#64748b;font-size:14px;
  margin-bottom:28px;line-height:1.6;
}

.modal-step{
  display:none;
}
.modal-step.active{
  display:block;
  animation:fadeIn .3s;
}

.success-icon{
  width:80px;height:80px;
  background:linear-gradient(135deg,#10b981,#059669);
  border-radius:50%;
  display:grid;place-items:center;
  color:#fff;font-size:40px;
  margin:20px auto;
  animation:scaleIn .5s cubic-bezier(.34,1.56,.64,1);
}

@keyframes scaleIn{
  from{transform:scale(0);opacity:0}
  to{transform:scale(1);opacity:1}
}

.otp-inputs{
  display:flex;gap:12px;justify-content:center;
  margin:24px 0;
}

.otp-input{
  width:50px;height:56px;
  border:2px solid #e2e8f0;
  border-radius:12px;
  text-align:center;
  font-size:24px;font-weight:800;
  color:#1e293b;
  background:#f8fafc;
  transition:all .3s;
  font-family:'Plus Jakarta Sans',sans-serif;
}
.otp-input:focus{
  outline:none;
  border-color:#667eea;
  background:#fff;
  box-shadow:0 0 0 4px rgba(102,126,234,.1);
}

.resend-otp{
  display:block;text-align:center;
  margin-top:16px;font-size:13px;
  color:#667eea;text-decoration:none;
  font-weight:700;transition:color .3s;
}
.resend-otp:hover{color:#764ba2}
.resend-otp:disabled{
  color:#94a3b8;cursor:not-allowed;
  pointer-events:none;
}

</style>
</head><body>
<a href="/" class="home-btn" aria-label="Home"><i class="fa-solid fa-house"></i></a>

<div class="login-container">
  <div class="logo-box">
    <img src="/assets/images/logo.png" alt="FWF" class="logo-img">
    <h1 class="logo-title">Member Login</h1>
    <p class="logo-subtitle">Access your dashboard</p>
  </div>

  <form id="loginForm">
    <div class="input-group">
      <input id="mid" class="input-field" type="text" placeholder="FWF-000001" required autocomplete="username">
      <i class="input-icon fa-solid fa-id-card"></i>
    </div>

    <div class="input-group has-toggle">
      <input id="pwd" class="input-field" type="password" placeholder="••••••••" required autocomplete="current-password">
      <i class="input-icon fa-solid fa-lock"></i>
      <button type="button" class="toggle-password" onclick="togglePassword()" aria-label="Toggle password visibility">
        <i class="fa-solid fa-eye" id="toggleIcon"></i>
      </button>
    </div>

    <a href="#" class="forgot-password" onclick="handleForgotPassword(event)"><i class="fa-solid fa-key"></i> Forgot Password?</a>

    <button type="submit" class="login-btn">
      <span id="btnText"><i class="fa-solid fa-arrow-right-to-bracket"></i> Login to Dashboard</span>
    </button>
  </form>

  <div class="divider">New to FWF?</div>

  <div class="signup-link">
    <a href="/register"><i class="fa-solid fa-user-plus"></i> Join &amp; Get Member ID</a>
  </div>
</div>

<!-- Forgot Password Modal -->
<div class="modal-overlay" id="forgotModal">
  <div class="modal-container">
    <button class="modal-close" onclick="closeForgotModal()">&times;</button>
    
    <!-- Step 1: Enter Member ID -->
    <div class="modal-step active" id="step1">
      <h2 class="modal-title">Forgot Password?</h2>
      <p class="modal-subtitle">Enter your Member ID to receive an OTP on your registered email.</p>
      
      <form id="requestOtpForm">
        <div class="input-group">
          <input id="resetMemberId" class="input-field" type="text" placeholder="FWF-000001" required>
          <i class="input-icon fa-solid fa-id-card"></i>
        </div>
        
        <button type="submit" class="login-btn">
          <span id="otpBtnText"><i class="fa-solid fa-paper-plane"></i> Send OTP</span>
        </button>
      </form>
    </div>
    
    <!-- Step 2: Enter OTP and New Password -->
    <div class="modal-step" id="step2">
      <h2 class="modal-title">Verify OTP</h2>
      <p class="modal-subtitle">Enter the 6-digit OTP sent to <strong id="maskedEmail"></strong></p>
      
      <form id="resetPasswordForm">
        <div class="otp-inputs">
          <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="0">
          <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="1">
          <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="2">
          <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="3">
          <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="4">
          <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" inputmode="numeric" data-index="5">
        </div>
        
        <a href="#" class="resend-otp" id="resendBtn" onclick="resendOTP(event)">
          <i class="fa-solid fa-rotate-right"></i> Resend OTP (<span id="timer">60</span>s)
        </a>
        
        <div class="input-group has-toggle" style="margin-top:24px">
          <input id="newPassword" class="input-field" type="password" placeholder="New Password (min 8 characters)" required minlength="8">
          <i class="input-icon fa-solid fa-lock"></i>
          <button type="button" class="toggle-password" onclick="toggleNewPassword()" aria-label="Toggle password visibility">
            <i class="fa-solid fa-eye" id="toggleNewIcon"></i>
          </button>
        </div>
        
        <button type="submit" class="login-btn" style="margin-top:8px">
          <span id="resetBtnText"><i class="fa-solid fa-check"></i> Reset Password</span>
        </button>
      </form>
    </div>
    
    <!-- Step 3: Success -->
    <div class="modal-step" id="step3">
      <div class="success-icon">
        <i class="fa-solid fa-check"></i>
      </div>
      <h2 class="modal-title" style="text-align:center">Password Reset Successful!</h2>
      <p class="modal-subtitle" style="text-align:center">Your password has been updated. Redirecting to login...</p>
    </div>
  </div>
</div>

<script src="/assets/js/fwf.js"></script>
<script src="/auth.js"></script>
<script>
// Password visibility toggle
function togglePassword() {
  const pwdInput = document.getElementById('pwd');
  const toggleIcon = document.getElementById('toggleIcon');
  
  if (pwdInput.type === 'password') {
    pwdInput.type = 'text';
    toggleIcon.className = 'fa-solid fa-eye-slash';
  } else {
    pwdInput.type = 'password';
    toggleIcon.className = 'fa-solid fa-eye';
  }
}

// Forgot password handler
let timerInterval;
let currentMemberId = '';

function handleForgotPassword(e) {
  e.preventDefault();
  document.getElementById('forgotModal').classList.add('active');
  showStep(1);
}

function closeForgotModal() {
  document.getElementById('forgotModal').classList.remove('active');
  resetModal();
}

function resetModal() {
  showStep(1);
  document.getElementById('resetMemberId').value = '';
  document.getElementById('newPassword').value = '';
  document.querySelectorAll('.otp-input').forEach(input => input.value = '');
  if(timerInterval) clearInterval(timerInterval);
  currentMemberId = '';
}

function showStep(step) {
  document.querySelectorAll('.modal-step').forEach(s => s.classList.remove('active'));
  document.getElementById(`step${step}`).classList.add('active');
}

function toggleNewPassword() {
  const pwdInput = document.getElementById('newPassword');
  const toggleIcon = document.getElementById('toggleNewIcon');
  
  if (pwdInput.type === 'password') {
    pwdInput.type = 'text';
    toggleIcon.className = 'fa-solid fa-eye-slash';
  } else {
    pwdInput.type = 'password';
    toggleIcon.className = 'fa-solid fa-eye';
  }
}

// OTP input auto-focus
document.addEventListener('DOMContentLoaded', () => {
  const otpInputs = document.querySelectorAll('.otp-input');
  otpInputs.forEach((input, index) => {
    input.addEventListener('input', (e) => {
      if(e.target.value.length === 1 && index < otpInputs.length - 1) {
        otpInputs[index + 1].focus();
      }
    });
    input.addEventListener('keydown', (e) => {
      if(e.key === 'Backspace' && !e.target.value && index > 0) {
        otpInputs[index - 1].focus();
      }
    });
  });
});

// Request OTP
document.getElementById('requestOtpForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btnText = document.getElementById('otpBtnText');
  const memberId = document.getElementById('resetMemberId').value.trim();
  
  if(!memberId) {
    FWF_Notify.toast('Please enter your Member ID', 'error');
    return;
  }
  
  btnText.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending OTP...';
  
  try {
    const res = await fetch('/api/password?action=forgot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ memberId })
    });
    
    const data = await res.json();
    
    if(!res.ok) {
      throw new Error(data.error || 'Failed to send OTP');
    }
    
    currentMemberId = memberId;
    document.getElementById('maskedEmail').textContent = data.email;
    FWF_Notify.toast(data.message, 'success');
    showStep(2);
    startTimer();
    
  } catch(err) {
    FWF_Notify.toast(err.message || 'Failed to send OTP', 'error');
  } finally {
    btnText.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send OTP';
  }
});

// Reset password with OTP
document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btnText = document.getElementById('resetBtnText');
  
  const otpInputs = document.querySelectorAll('.otp-input');
  const otp = Array.from(otpInputs).map(input => input.value).join('');
  const newPassword = document.getElementById('newPassword').value;
  
  if(otp.length !== 6) {
    FWF_Notify.toast('Please enter complete OTP', 'error');
    return;
  }
  
  if(newPassword.length < 8) {
    FWF_Notify.toast('Password must be at least 8 characters', 'error');
    return;
  }
  
  btnText.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Resetting...';
  
  try {
    const res = await fetch('/api/password?action=reset', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ memberId: currentMemberId, otp, newPassword })
    });
    
    const data = await res.json();
    
    if(!res.ok) {
      throw new Error(data.error || 'Failed to reset password');
    }
    
    showStep(3);
    FWF_Notify.toast(data.message, 'success');
    
    setTimeout(() => {
      closeForgotModal();
      location.reload();
    }, 3000);
    
  } catch(err) {
    FWF_Notify.toast(err.message || 'Failed to reset password', 'error');
    btnText.innerHTML = '<i class="fa-solid fa-check"></i> Reset Password';
  }
});

// Resend OTP
async function resendOTP(e) {
  e.preventDefault();
  const btnText = document.getElementById('otpBtnText');
  
  btnText.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending OTP...';
  
  try {
    const res = await fetch('/api/password?action=forgot', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ memberId: currentMemberId })
    });
    
    const data = await res.json();
    
    if(!res.ok) {
      throw new Error(data.error || 'Failed to send OTP');
    }
    
    FWF_Notify.toast('OTP resent successfully', 'success');
    startTimer();
    
  } catch(err) {
    FWF_Notify.toast(err.message || 'Failed to resend OTP', 'error');
  } finally {
    btnText.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Send OTP';
  }
}

// Timer for resend OTP
function startTimer() {
  let timeLeft = 60;
  const timerEl = document.getElementById('timer');
  const resendBtn = document.getElementById('resendBtn');
  
  resendBtn.style.pointerEvents = 'none';
  resendBtn.style.color = '#94a3b8';
  
  if(timerInterval) clearInterval(timerInterval);
  
  timerInterval = setInterval(() => {
    timeLeft--;
    timerEl.textContent = timeLeft;
    
    if(timeLeft <= 0) {
      clearInterval(timerInterval);
      resendBtn.style.pointerEvents = 'auto';
      resendBtn.style.color = '#667eea';
    }
  }, 1000);
}

document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.querySelector('.login-btn');
  const btnText = document.getElementById('btnText');
  const memberId = document.getElementById('mid').value.trim();
  const password = document.getElementById('pwd').value.trim();
  
  btn.disabled = true;
  btnText.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Logging in...';
  
  try{
    let res;
    // Detect admin-style login (email with @) vs member ID (FWF-XXXXXX)
    if(memberId.includes('@')){
      res = await AUTH.api('/api/admin/login', {method:'POST', body:{username:memberId, password}});
      res.role = 'admin';
    } else {
      res = await AUTH.api('/api/auth/login', {method:'POST', body:{memberId, password}});
    }
    btnText.innerHTML = '<i class="fa-solid fa-check"></i> Success!';
    setTimeout(() => {
      if(res.role==='admin') location.href = '/admin/dashboard';
      else if(res.role==='supporter') location.href = '/supporter/dashboard';
      else location.href = '/member/dashboard';
    }, 500);
  }catch(e){ 
    btnText.innerHTML = '<i class="fa-solid fa-xmark"></i> Login Failed';
    FWF_Notify.toast(e.message || 'Invalid credentials', 'error');
    setTimeout(() => {
      btnText.innerHTML = '<i class="fa-solid fa-arrow-right-to-bracket"></i> Login to Dashboard';
      btn.disabled = false;
    }, 2000);
  }
});
</script>
</body></html>

