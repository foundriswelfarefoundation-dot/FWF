<!DOCTYPE html>
<html lang="en" data-lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FWF â€” Online Store</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="assets/images/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/images/logo.png">
  <link rel="apple-touch-icon" href="assets/images/logo.png">
  <link rel="shortcut icon" href="assets/images/logo.png">

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Plus+Jakarta+Sans:wght@400;700;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;700;800&family=Mukta:wght@400;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <style>
  :root{
    --primary:#6153ff; --accent:#22c55e; --blue:#3b82f6;
    --deep:#0f172a; --muted:#475569; --soft:#f1f5f9; --brd:#e3e8f5;
  }
  html{ scroll-behavior:smooth; background:linear-gradient(120deg,#f6f8ff 0%,#eef2ff 50%,#f8fafc 100%) }
  body{
    margin:0; font-family:'Plus Jakarta Sans',Montserrat,sans-serif; color:var(--deep);
    padding-top:90px; overflow-x:hidden; letter-spacing:.01em
  }
  *{ box-sizing:border-box } a{ color:inherit; text-decoration:none }
  .container{ width:100%; max-width:1260px; margin:0 auto; padding:0 20px }
  html[data-lang="hi"] body{font-family:'Noto Sans Devanagari','Mukta','Plus Jakarta Sans',system-ui,sans-serif}

  /* HEADER */
  .header{
    position:fixed; inset:0 0 auto 0; height:78px; z-index:200; display:flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,.78); backdrop-filter:blur(14px) saturate(140%); border-bottom:1px solid #dbe3f3
  }
  .header.scrolled{ height:64px; background:rgba(255,255,255,.88); box-shadow:0 10px 30px rgba(2,6,23,.06) }
  .header .H{ max-width:1240px; width:100%; padding:0 18px; display:flex; align-items:center; justify-content:space-between }
  .brand{ flex:0 0 auto; display:flex; align-items:center; gap:10px; font-weight:900; font-size:1.15em }
  .brand img{ width:52px; height:52px; object-fit:contain }
  .brand .title{ font-size:1em; line-height:1.15 }
  .brand .tag{ font-size:.65em; color:var(--muted); font-weight:600 }
  nav{ flex:1 1 0; display:flex; justify-content:center; align-items:center }
  .navList{ display:flex; gap:28px; list-style:none; margin:0; padding:0; font-size:1.05rem; font-weight:700 }
  .navList a{
    display:inline-flex; align-items:center; padding:10px 14px; border-radius:12px;
    font-weight:800; color:#0f172a; position:relative; transition:.18s
  }
  .navList a:after{
    content:""; position:absolute; left:12px; right:12px; bottom:6px; height:3px; border-radius:3px;
    background:linear-gradient(90deg,#6366f1,#22c55e); opacity:0; transform:translateY(4px); transition:.18s
  }
  .navList a:hover{ background:rgba(15,23,42,.06) }
  .navList a:hover:after{ opacity:1; transform:translateY(0) }
  .navList a.active:after{ opacity:1; transform:translateY(0) }
  .navToggle{ display:none; background:none; border:none; font-size:1.5rem; cursor:pointer }
  @media(max-width:900px){
    .navToggle{ display:block }
    nav{ position:fixed; top:78px; left:0; right:0; background:#fff; flex-direction:column; display:none; border-bottom:1px solid var(--brd); z-index:199 }
    nav.open{ display:flex }
    .navList{ flex-direction:column; gap:0; padding:12px 0 }
    .navList a{ padding:14px 24px; width:100%; border-radius:0 }
  }

  /* HERO BANNER */
  .store-hero{
    background:linear-gradient(135deg,#6153ff 0%,#22c55e 100%); color:#fff;
    padding:48px 0 40px; text-align:center; margin-bottom:0
  }
  .store-hero h1{ font-size:clamp(1.8rem,4vw,2.8rem); font-weight:900; margin:0 0 8px }
  .store-hero p{ font-size:1.1rem; opacity:.9; margin:0 }

  /* SEARCH BAR */
  .search-section{ background:#fff; border-bottom:1px solid var(--brd); padding:16px 0; position:sticky; top:78px; z-index:100 }
  .search-bar{
    display:flex; gap:10px; align-items:center; max-width:700px; margin:0 auto
  }
  .search-bar input{
    flex:1; padding:12px 18px; border-radius:14px; border:2px solid var(--brd);
    font-size:1rem; font-family:inherit; outline:none; transition:.2s
  }
  .search-bar input:focus{ border-color:var(--primary); box-shadow:0 0 0 4px rgba(97,83,255,.12) }
  .search-bar button{
    padding:12px 24px; border:none; border-radius:14px; background:var(--primary); color:#fff;
    font-weight:700; font-size:1rem; cursor:pointer; transition:.2s; white-space:nowrap
  }
  .search-bar button:hover{ background:#4a3ddd }

  /* MAIN LAYOUT */
  .store-layout{
    display:grid; grid-template-columns:260px 1fr; gap:24px; padding:24px 0 60px; min-height:60vh
  }
  @media(max-width:900px){ .store-layout{ grid-template-columns:1fr } }

  /* SIDEBAR CATEGORIES */
  .cat-sidebar{
    background:#fff; border-radius:18px; padding:20px; border:1px solid var(--brd);
    height:fit-content; position:sticky; top:150px
  }
  .cat-sidebar h3{ margin:0 0 14px; font-size:1.05rem; color:var(--muted); font-weight:800; text-transform:uppercase; letter-spacing:.04em }
  .cat-item{
    display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px;
    cursor:pointer; font-weight:600; font-size:.92rem; transition:.15s; color:var(--deep)
  }
  .cat-item:hover, .cat-item.active{ background:rgba(97,83,255,.08); color:var(--primary) }
  .cat-item i{ width:22px; text-align:center; font-size:1rem; color:var(--muted) }
  .cat-item.active i{ color:var(--primary) }
  .cat-item .count{ margin-left:auto; font-size:.8rem; color:var(--muted); background:var(--soft); padding:2px 8px; border-radius:20px }
  .cat-subs{ padding-left:32px; display:none }
  .cat-item.active + .cat-subs{ display:block }
  .cat-sub{
    padding:7px 12px; font-size:.85rem; border-radius:8px; cursor:pointer; font-weight:600; transition:.15s
  }
  .cat-sub:hover, .cat-sub.active{ color:var(--primary); background:rgba(97,83,255,.06) }
  @media(max-width:900px){
    .cat-sidebar{ display:none }
    .cat-mobile{ display:flex !important }
  }

  .cat-mobile{
    display:none; overflow-x:auto; gap:8px; padding:0 0 12px; scrollbar-width:none
  }
  .cat-mobile::-webkit-scrollbar{ display:none }
  .cat-chip{
    flex-shrink:0; padding:8px 16px; border-radius:30px; border:2px solid var(--brd);
    background:#fff; font-weight:700; font-size:.85rem; cursor:pointer; transition:.15s; white-space:nowrap
  }
  .cat-chip:hover, .cat-chip.active{ background:var(--primary); color:#fff; border-color:var(--primary) }

  /* PRODUCT GRID */
  .products-area{ min-width:0 }
  .products-bar{
    display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:8px
  }
  .products-bar .count{ font-weight:700; color:var(--muted) }
  .products-bar select{
    padding:8px 14px; border-radius:10px; border:2px solid var(--brd); font-family:inherit;
    font-weight:600; background:#fff; cursor:pointer; outline:none
  }
  .product-grid{
    display:grid; grid-template-columns:repeat(auto-fill,minmax(230px,1fr)); gap:18px
  }
  @media(max-width:560px){ .product-grid{ grid-template-columns:repeat(2,1fr); gap:10px } }

  .product-card{
    background:#fff; border-radius:16px; border:1px solid var(--brd); overflow:hidden;
    transition:.22s; cursor:pointer; position:relative
  }
  .product-card:hover{ transform:translateY(-4px); box-shadow:0 12px 32px rgba(2,6,23,.1) }
  .product-card .badge{
    position:absolute; top:10px; left:10px; background:var(--accent); color:#fff; font-size:.7rem;
    font-weight:800; padding:3px 10px; border-radius:8px; z-index:2; text-transform:uppercase
  }
  .product-card .img-wrap{
    width:100%; aspect-ratio:1; background:var(--soft); display:flex; align-items:center; justify-content:center;
    overflow:hidden; position:relative
  }
  .product-card .img-wrap img{ width:100%; height:100%; object-fit:cover; transition:.3s }
  .product-card:hover .img-wrap img{ transform:scale(1.06) }
  .product-card .img-wrap .placeholder{ font-size:3rem; color:var(--brd) }
  .product-card .info{ padding:14px 14px 16px }
  .product-card .cat-label{ font-size:.72rem; font-weight:700; color:var(--primary); text-transform:uppercase; letter-spacing:.04em; margin-bottom:4px }
  .product-card .title{ font-weight:800; font-size:.95rem; line-height:1.35; margin-bottom:6px; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
  .product-card .seller{ font-size:.78rem; color:var(--muted); margin-bottom:8px }
  .product-card .price-row{ display:flex; align-items:baseline; gap:8px; flex-wrap:wrap }
  .product-card .price{ font-weight:900; font-size:1.15rem; color:var(--deep) }
  .product-card .mrp{ font-size:.85rem; color:var(--muted); text-decoration:line-through }
  .product-card .discount{ font-size:.78rem; font-weight:800; color:var(--accent) }
  .product-card .rating{ display:flex; align-items:center; gap:4px; margin-top:6px; font-size:.8rem; color:#f59e0b; font-weight:700 }
  .product-card .rating .count{ color:var(--muted); font-weight:600 }

  /* EMPTY STATE */
  .empty-state{
    text-align:center; padding:60px 20px; color:var(--muted)
  }
  .empty-state i{ font-size:3rem; margin-bottom:12px; opacity:.4 }
  .empty-state h3{ font-size:1.2rem; margin:0 0 6px }
  .empty-state p{ font-size:.95rem }

  /* PRODUCT DETAIL MODAL */
  .modal-overlay{
    display:none; position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,.55);
    backdrop-filter:blur(6px); justify-content:center; align-items:flex-start; padding:40px 16px; overflow-y:auto
  }
  .modal-overlay.show{ display:flex }
  .modal-content{
    background:#fff; border-radius:22px; max-width:900px; width:100%; margin:auto;
    box-shadow:0 30px 60px rgba(0,0,0,.2); overflow:hidden; animation:slideUp .3s ease
  }
  @keyframes slideUp{ from{ opacity:0; transform:translateY(30px) } to{ opacity:1; transform:translateY(0) } }
  .modal-close{
    position:absolute; top:16px; right:16px; width:40px; height:40px; border-radius:50%;
    background:rgba(0,0,0,.06); border:none; font-size:1.2rem; cursor:pointer; z-index:10; transition:.15s
  }
  .modal-close:hover{ background:rgba(0,0,0,.12) }
  .modal-body{ display:grid; grid-template-columns:1fr 1fr; gap:0; position:relative }
  @media(max-width:700px){ .modal-body{ grid-template-columns:1fr } }

  .modal-gallery{ background:var(--soft); padding:24px; display:flex; flex-direction:column; gap:12px }
  .modal-gallery .main-img{
    width:100%; aspect-ratio:1; border-radius:14px; overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center
  }
  .modal-gallery .main-img img{ max-width:100%; max-height:100%; object-fit:contain }
  .modal-gallery .thumbs{ display:flex; gap:8px; overflow-x:auto }
  .modal-gallery .thumb{
    width:60px; height:60px; border-radius:10px; border:2px solid transparent; overflow:hidden;
    cursor:pointer; flex-shrink:0; background:#fff
  }
  .modal-gallery .thumb.active{ border-color:var(--primary) }
  .modal-gallery .thumb img{ width:100%; height:100%; object-fit:cover }

  .modal-details{ padding:28px 28px 28px 24px; display:flex; flex-direction:column; gap:14px }
  .modal-details .cat-label{ font-size:.78rem; font-weight:700; color:var(--primary); text-transform:uppercase }
  .modal-details h2{ margin:0; font-size:1.5rem; font-weight:900; line-height:1.3 }
  .modal-details .seller-info{ font-size:.9rem; color:var(--muted) }
  .modal-details .price-section{ display:flex; align-items:baseline; gap:10px; flex-wrap:wrap }
  .modal-details .price-section .price{ font-size:1.6rem; font-weight:900 }
  .modal-details .price-section .mrp{ font-size:1rem; color:var(--muted); text-decoration:line-through }
  .modal-details .price-section .discount{ font-size:.9rem; font-weight:800; color:var(--accent) }
  .modal-details .meta-grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
  .modal-details .meta-item{ font-size:.85rem; color:var(--muted) }
  .modal-details .meta-item strong{ color:var(--deep) }
  .modal-details .desc{ font-size:.92rem; color:var(--muted); line-height:1.6 }
  .modal-details .stock-info{ font-size:.85rem; display:flex; align-items:center; gap:6px }
  .modal-details .stock-info.in-stock{ color:var(--accent) }
  .modal-details .stock-info.low-stock{ color:#f59e0b }

  /* ORDER FORM IN MODAL */
  .order-section{ border-top:1px solid var(--brd); padding-top:16px; margin-top:auto }
  .order-section h4{ margin:0 0 12px; font-size:1rem }
  .order-form{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .order-form .full{ grid-column:1/-1 }
  .order-form input, .order-form textarea, .order-form select{
    padding:10px 14px; border:2px solid var(--brd); border-radius:10px; font-family:inherit;
    font-size:.9rem; outline:none; width:100%; transition:.2s
  }
  .order-form input:focus, .order-form textarea:focus{ border-color:var(--primary) }
  .order-form textarea{ resize:vertical; min-height:60px }
  .order-form .qty-row{ display:flex; align-items:center; gap:8px }
  .order-form .qty-btn{
    width:34px; height:34px; border-radius:8px; border:2px solid var(--brd); background:#fff;
    font-size:1.1rem; font-weight:900; cursor:pointer; transition:.15s
  }
  .order-form .qty-btn:hover{ border-color:var(--primary); color:var(--primary) }
  .order-form .qty-val{ font-weight:900; font-size:1.1rem; min-width:30px; text-align:center }
  .btn-order{
    grid-column:1/-1; padding:14px; border:none; border-radius:14px;
    background:linear-gradient(135deg,var(--primary),var(--accent)); color:#fff;
    font-weight:800; font-size:1rem; cursor:pointer; transition:.2s; margin-top:4px
  }
  .btn-order:hover{ transform:translateY(-2px); box-shadow:0 8px 24px rgba(97,83,255,.3) }
  .btn-order:disabled{ opacity:.6; cursor:not-allowed; transform:none }

  /* ORDER SUCCESS */
  .order-success{
    text-align:center; padding:30px; display:none
  }
  .order-success.show{ display:block }
  .order-success i{ font-size:3rem; color:var(--accent); margin-bottom:12px }
  .order-success h3{ margin:0 0 6px; font-size:1.3rem }
  .order-success p{ color:var(--muted) }

  /* PAGINATION */
  .pagination{
    display:flex; justify-content:center; gap:8px; margin-top:30px; flex-wrap:wrap
  }
  .pagination button{
    padding:8px 16px; border-radius:10px; border:2px solid var(--brd); background:#fff;
    font-weight:700; font-size:.9rem; cursor:pointer; transition:.15s
  }
  .pagination button:hover, .pagination button.active{ background:var(--primary); color:#fff; border-color:var(--primary) }
  .pagination button:disabled{ opacity:.4; cursor:not-allowed }

  /* LOADING */
  .loading{ text-align:center; padding:40px; color:var(--muted) }
  .loading i{ font-size:2rem; animation:spin 1s linear infinite }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* TOAST */
  .toast{
    position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(100px); z-index:2000;
    background:var(--deep); color:#fff; padding:14px 28px; border-radius:14px; font-weight:700;
    font-size:.95rem; box-shadow:0 10px 30px rgba(0,0,0,.25); transition:.3s; opacity:0; pointer-events:none
  }
  .toast.show{ transform:translateX(-50%) translateY(0); opacity:1 }

  /* FOOTER */
  .footer{
    background:var(--deep); color:#94a3b8; padding:48px 0 24px; margin-top:40px
  }
  .footer .f-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:30px; margin-bottom:30px }
  .footer h4{ color:#fff; margin:0 0 12px; font-size:.95rem }
  .footer a{ color:#94a3b8; font-size:.88rem; display:block; padding:3px 0; transition:.15s }
  .footer a:hover{ color:#fff }
  .footer .bottom{ text-align:center; border-top:1px solid rgba(255,255,255,.1); padding-top:20px; font-size:.82rem }
  </style>
</head>
<body>

<!-- HEADER -->
<div class="header" id="siteHeader">
  <div class="H">
    <a href="index.html" class="brand">
      <img src="assets/images/logo.png" alt="FWF logo"/>
      <div>
        <div class="title">Foundris Welfare Foundation</div>
        <div class="tag">Skill &bull; Partnership &bull; Prosperity</div>
      </div>
    </a>
    <nav id="mainNav">
      <ul class="navList">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="projects.html">Projects</a></li>
        <li><a href="store.html" class="active">Store</a></li>
        <li><a href="join.html">Join</a></li>
        <li><a href="donation.html">Donate</a></li>
      </ul>
    </nav>
    <button class="navToggle" id="navToggle" onclick="document.getElementById('mainNav').classList.toggle('open')"><i class="fas fa-bars"></i></button>
  </div>
</div>

<!-- HERO -->
<div class="store-hero">
  <div class="container">
    <h1><i class="fas fa-store"></i> FWF Community Store</h1>
    <p>Shop handcrafted, organic & artisan products from women entrepreneurs</p>
  </div>
</div>

<!-- SEARCH -->
<div class="search-section">
  <div class="container">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search products, brands, categories..." />
      <button onclick="searchProducts()"><i class="fas fa-search"></i> Search</button>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="container">
  <!-- MOBILE CATEGORIES -->
  <div class="cat-mobile" id="catMobile"></div>

  <div class="store-layout">
    <!-- SIDEBAR -->
    <aside class="cat-sidebar" id="catSidebar">
      <h3><i class="fas fa-th-large"></i> Categories</h3>
      <div class="cat-item active" data-cat="all" onclick="filterCategory('all',this)">
        <i class="fas fa-border-all"></i> All Products <span class="count" id="countAll">0</span>
      </div>
      <div id="catList"></div>
    </aside>

    <!-- PRODUCTS -->
    <div class="products-area">
      <div class="products-bar">
        <span class="count" id="resultsCount">0 products</span>
        <select id="sortSelect" onchange="loadProducts()">
          <option value="">Featured</option>
          <option value="newest">Newest First</option>
          <option value="price-low">Price: Low to High</option>
          <option value="price-high">Price: High to Low</option>
          <option value="rating">Top Rated</option>
          <option value="popular">Most Popular</option>
        </select>
      </div>
      <div class="product-grid" id="productGrid">
        <div class="loading"><i class="fas fa-spinner"></i><br>Loading products...</div>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>
</div>

<!-- PRODUCT DETAIL MODAL -->
<div class="modal-overlay" id="productModal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeProductModal()"><i class="fas fa-times"></i></button>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- SUCCESS TOAST -->
<div class="toast" id="toast"></div>

<!-- FOOTER -->
<div class="footer">
  <div class="container">
    <div class="f-grid">
      <div>
        <h4>FWF Store</h4>
        <a href="index.html">Home</a>
        <a href="about.html">About Us</a>
        <a href="projects.html">Projects</a>
        <a href="join.html">Become a Seller</a>
      </div>
      <div>
        <h4>Categories</h4>
        <a href="#" onclick="filterCategory('handicraft');return false">Handicraft & Art</a>
        <a href="#" onclick="filterCategory('organic-natural');return false">Organic & Natural</a>
        <a href="#" onclick="filterCategory('fashion-women');return false">Women's Fashion</a>
        <a href="#" onclick="filterCategory('food-beverages');return false">Food & Beverages</a>
      </div>
      <div>
        <h4>Help</h4>
        <a href="terms-conditions.html">Terms & Conditions</a>
        <a href="privacy-policy.html">Privacy Policy</a>
        <a href="member-login.html">Seller Login</a>
      </div>
      <div>
        <h4>Contact</h4>
        <p style="font-size:.88rem">Foundris Welfare Foundation<br>Email: support@fwf.org</p>
      </div>
    </div>
    <div class="bottom">&copy; 2025 Foundris Welfare Foundation. All rights reserved.</div>
  </div>
</div>

<script>
const API_BASE = '';
let currentCategory = 'all';
let currentSubcategory = '';
let currentPage = 1;
let allCategories = {};
let orderQty = 1;

// Init
document.addEventListener('DOMContentLoaded', async () => {
  await loadCategories();
  await loadProducts();
  document.getElementById('searchInput').addEventListener('keydown', e => { if(e.key === 'Enter') searchProducts(); });
});

// Load categories
async function loadCategories(){
  try {
    const r = await fetch(API_BASE + '/api/store/categories');
    const d = await r.json();
    if(!d.ok) return;
    allCategories = d.categories;
    renderCategories();
  } catch(e){ console.error('Categories error:', e); }
}

function renderCategories(){
  const list = document.getElementById('catList');
  const mobile = document.getElementById('catMobile');
  let html = '';
  let mobileHtml = '<div class="cat-chip active" data-cat="all" onclick="filterCategory(\'all\',this)">All</div>';

  for(const [key, cat] of Object.entries(allCategories)){
    html += `<div class="cat-item" data-cat="${key}" onclick="filterCategory('${key}',this)">
      <i class="fas ${cat.icon}"></i> ${cat.label} <span class="count"></span>
    </div>`;
    if(cat.subs && cat.subs.length){
      html += `<div class="cat-subs" data-parent="${key}">`;
      cat.subs.forEach(sub => {
        html += `<div class="cat-sub" onclick="filterSubcategory('${key}','${sub}',this)">${sub}</div>`;
      });
      html += `</div>`;
    }
    mobileHtml += `<div class="cat-chip" data-cat="${key}" onclick="filterCategory('${key}',this)">${cat.label}</div>`;
  }
  list.innerHTML = html;
  mobile.innerHTML = mobileHtml;
}

function filterCategory(cat, el){
  currentCategory = cat;
  currentSubcategory = '';
  currentPage = 1;
  // Update sidebar active
  document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active'));
  document.querySelectorAll('.cat-subs').forEach(s => s.style.display = 'none');
  document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
  if(el) el.classList.add('active');
  else {
    document.querySelector(`.cat-item[data-cat="${cat}"]`)?.classList.add('active');
    document.querySelector(`.cat-chip[data-cat="${cat}"]`)?.classList.add('active');
  }
  // Show subcategories
  const subsEl = document.querySelector(`.cat-subs[data-parent="${cat}"]`);
  if(subsEl) subsEl.style.display = 'block';
  loadProducts();
}

function filterSubcategory(cat, sub, el){
  currentCategory = cat;
  currentSubcategory = sub;
  currentPage = 1;
  document.querySelectorAll('.cat-sub').forEach(s => s.classList.remove('active'));
  if(el) el.classList.add('active');
  loadProducts();
}

// Search
function searchProducts(){
  currentPage = 1;
  loadProducts();
}

// Load products
async function loadProducts(){
  const grid = document.getElementById('productGrid');
  grid.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i><br>Loading...</div>';

  const params = new URLSearchParams();
  if(currentCategory && currentCategory !== 'all') params.set('category', currentCategory);
  if(currentSubcategory) params.set('subcategory', currentSubcategory);
  const search = document.getElementById('searchInput').value.trim();
  if(search) params.set('search', search);
  const sort = document.getElementById('sortSelect').value;
  if(sort) params.set('sort', sort);
  params.set('page', currentPage);
  params.set('limit', 24);

  try {
    const r = await fetch(API_BASE + '/api/store/products?' + params.toString());
    const d = await r.json();
    if(!d.ok){ grid.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Something went wrong</h3></div>'; return; }

    document.getElementById('resultsCount').textContent = `${d.total} product${d.total !== 1 ? 's' : ''}`;
    document.getElementById('countAll').textContent = d.total;

    // Update category counts
    if(d.categoryStats){
      d.categoryStats.forEach(cs => {
        const el = document.querySelector(`.cat-item[data-cat="${cs.category}"] .count`);
        if(el) el.textContent = cs.count;
      });
    }

    if(!d.products.length){
      grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1">
        <i class="fas fa-box-open"></i>
        <h3>No products found</h3>
        <p>${search ? 'Try a different search term' : 'Check back soon for new listings!'}</p>
      </div>`;
      document.getElementById('pagination').innerHTML = '';
      return;
    }

    grid.innerHTML = d.products.map(p => renderProductCard(p)).join('');
    renderPagination(d.page, d.pages, d.total);
  } catch(e){
    console.error('Load error:', e);
    grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1">
      <i class="fas fa-wifi"></i>
      <h3>Unable to load products</h3>
      <p>Please check your connection and try again</p>
    </div>`;
  }
}

function renderProductCard(p){
  const imgHtml = p.thumbnail
    ? `<img src="${p.thumbnail}" alt="${esc(p.title)}" loading="lazy"/>`
    : (p.images && p.images.length ? `<img src="${p.images[0]}" alt="${esc(p.title)}" loading="lazy"/>` : `<i class="fas fa-image placeholder"></i>`);
  const catInfo = allCategories[p.category];
  const catLabel = catInfo ? catInfo.label : p.category;
  const discount = p.discount_percent > 0 ? `<span class="discount">${p.discount_percent}% off</span>` : '';
  const mrp = p.mrp && p.mrp > p.price ? `<span class="mrp">â‚¹${fmtPrice(p.mrp)}</span>` : '';
  const badge = p.discount_percent >= 20 ? `<div class="badge">${p.discount_percent}% Off</div>` : '';
  const rating = p.rating_avg > 0 ? `<div class="rating"><i class="fas fa-star"></i> ${p.rating_avg.toFixed(1)} <span class="count">(${p.rating_count})</span></div>` : '';

  return `<div class="product-card" onclick="openProduct('${p.product_id}')">
    ${badge}
    <div class="img-wrap">${imgHtml}</div>
    <div class="info">
      <div class="cat-label">${esc(catLabel)}${p.subcategory ? ' &bull; ' + esc(p.subcategory) : ''}</div>
      <div class="title">${esc(p.title)}</div>
      <div class="seller"><i class="fas fa-user-circle"></i> ${esc(p.seller_name || 'FWF Seller')}</div>
      <div class="price-row">
        <span class="price">â‚¹${fmtPrice(p.price)}</span>
        ${mrp} ${discount}
      </div>
      ${rating}
    </div>
  </div>`;
}

function renderPagination(page, pages){
  const el = document.getElementById('pagination');
  if(pages <= 1){ el.innerHTML = ''; return; }
  let html = `<button ${page<=1?'disabled':''} onclick="goPage(${page-1})"><i class="fas fa-chevron-left"></i></button>`;
  const start = Math.max(1, page - 2);
  const end = Math.min(pages, page + 2);
  if(start > 1) html += `<button onclick="goPage(1)">1</button>`;
  if(start > 2) html += `<button disabled>...</button>`;
  for(let i = start; i <= end; i++){
    html += `<button class="${i===page?'active':''}" onclick="goPage(${i})">${i}</button>`;
  }
  if(end < pages - 1) html += `<button disabled>...</button>`;
  if(end < pages) html += `<button onclick="goPage(${pages})">${pages}</button>`;
  html += `<button ${page>=pages?'disabled':''} onclick="goPage(${page+1})"><i class="fas fa-chevron-right"></i></button>`;
  el.innerHTML = html;
}

function goPage(p){ currentPage = p; loadProducts(); window.scrollTo({top:300,behavior:'smooth'}); }

// Product detail modal
async function openProduct(productId){
  const modal = document.getElementById('productModal');
  const body = document.getElementById('modalBody');
  modal.classList.add('show');
  document.body.style.overflow = 'hidden';
  body.innerHTML = '<div class="loading" style="grid-column:1/-1;padding:60px"><i class="fas fa-spinner"></i><br>Loading...</div>';

  try {
    const r = await fetch(API_BASE + '/api/store/product/' + productId);
    const d = await r.json();
    if(!d.ok){ body.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><h3>Product not found</h3></div>'; return; }
    renderProductDetail(d.product);
  } catch(e){
    body.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><h3>Failed to load product</h3></div>';
  }
}

function renderProductDetail(p){
  const body = document.getElementById('modalBody');
  orderQty = 1;

  // Gallery
  const images = p.images && p.images.length ? p.images : (p.thumbnail ? [p.thumbnail] : []);
  let galleryHtml = `<div class="modal-gallery">
    <div class="main-img" id="mainImg">
      ${images.length ? `<img src="${images[0]}" alt="${esc(p.title)}"/>` : '<i class="fas fa-image" style="font-size:4rem;color:var(--brd)"></i>'}
    </div>
    ${images.length > 1 ? `<div class="thumbs">${images.map((img,i) =>
      `<div class="thumb ${i===0?'active':''}" onclick="switchImage(this,'${img.replace(/'/g,"\\'")}')"><img src="${img}" alt="thumb"/></div>`
    ).join('')}</div>` : ''}
  </div>`;

  const catInfo = allCategories[p.category];
  const catLabel = catInfo ? catInfo.label : p.category;
  const discount = p.discount_percent > 0 ? `<span class="discount">${p.discount_percent}% off</span>` : '';
  const mrp = p.mrp && p.mrp > p.price ? `<span class="mrp">â‚¹${fmtPrice(p.mrp)}</span>` : '';
  const stockClass = p.stock > 5 ? 'in-stock' : (p.stock > 0 ? 'low-stock' : '');
  const stockText = p.stock > 5 ? 'In Stock' : (p.stock > 0 ? `Only ${p.stock} left` : 'Out of Stock');
  
  // Meta items
  let metaHtml = '';
  if(p.brand) metaHtml += `<div class="meta-item"><strong>Brand:</strong> ${esc(p.brand)}</div>`;
  if(p.condition && p.condition !== 'new') metaHtml += `<div class="meta-item"><strong>Condition:</strong> ${esc(p.condition)}</div>`;
  if(p.material) metaHtml += `<div class="meta-item"><strong>Material:</strong> ${esc(p.material)}</div>`;
  if(p.color) metaHtml += `<div class="meta-item"><strong>Color:</strong> ${esc(p.color)}</div>`;
  if(p.size) metaHtml += `<div class="meta-item"><strong>Size:</strong> ${esc(p.size)}</div>`;
  if(p.weight) metaHtml += `<div class="meta-item"><strong>Weight:</strong> ${esc(p.weight)}</div>`;

  let detailsHtml = `<div class="modal-details">
    <div class="cat-label">${esc(catLabel)}${p.subcategory ? ' &bull; ' + esc(p.subcategory) : ''}</div>
    <h2>${esc(p.title)}</h2>
    <div class="seller-info"><i class="fas fa-user-circle"></i> Sold by <strong>${esc(p.seller_name || 'FWF Seller')}</strong></div>
    <div class="price-section">
      <span class="price">â‚¹${fmtPrice(p.price)}</span> ${mrp} ${discount}
    </div>
    <div class="stock-info ${stockClass}"><i class="fas fa-${p.stock > 0 ? 'check-circle' : 'times-circle'}"></i> ${stockText}</div>
    ${metaHtml ? `<div class="meta-grid">${metaHtml}</div>` : ''}
    ${p.description ? `<div class="desc">${esc(p.description)}</div>` : ''}
    <div class="order-section" id="orderSection">
      <h4><i class="fas fa-shopping-cart"></i> Place Order</h4>
      <div class="order-form" id="orderForm">
        <input type="text" id="ordName" placeholder="Your Name *" required/>
        <input type="text" id="ordContact" placeholder="Mobile Number *" required/>
        <input type="email" id="ordEmail" placeholder="Email (optional)"/>
        <div class="qty-row">
          <button class="qty-btn" type="button" onclick="changeQty(-1)">âˆ’</button>
          <span class="qty-val" id="qtyVal">1</span>
          <button class="qty-btn" type="button" onclick="changeQty(1)">+</button>
          <span style="font-size:.85rem;color:var(--muted);margin-left:8px">Ã—â‚¹${fmtPrice(p.price)} = <strong id="orderTotal">â‚¹${fmtPrice(p.price)}</strong></span>
        </div>
        <textarea class="full" id="ordAddress" placeholder="Delivery Address *" required></textarea>
        <select id="ordPayment">
          <option value="online">Online Payment</option>
          <option value="cod">Cash on Delivery</option>
          <option value="upi">UPI</option>
        </select>
        <button class="btn-order" id="btnOrder" onclick="placeOrder('${p.product_id}',${p.price})" ${p.stock<=0?'disabled':''}>
          ${p.stock > 0 ? '<i class="fas fa-check"></i> Place Order' : 'Out of Stock'}
        </button>
      </div>
    </div>
    <div class="order-success" id="orderSuccess">
      <i class="fas fa-check-circle"></i>
      <h3>Order Placed Successfully!</h3>
      <p id="orderSuccessMsg">Your order ID will appear here</p>
    </div>
  </div>`;

  body.innerHTML = galleryHtml + detailsHtml;
}

function switchImage(el, src){
  document.querySelector('#mainImg img').src = src;
  document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
}

function changeQty(delta){
  orderQty = Math.max(1, orderQty + delta);
  document.getElementById('qtyVal').textContent = orderQty;
  const price = parseFloat(document.querySelector('.modal-details .price').textContent.replace('â‚¹','').replace(/,/g,''));
  document.getElementById('orderTotal').textContent = 'â‚¹' + fmtPrice(price * orderQty);
}

async function placeOrder(productId, unitPrice){
  const name = document.getElementById('ordName').value.trim();
  const contact = document.getElementById('ordContact').value.trim();
  const email = document.getElementById('ordEmail').value.trim();
  const address = document.getElementById('ordAddress').value.trim();
  const payment = document.getElementById('ordPayment').value;

  if(!name || !contact || !address){
    showToast('Please fill Name, Mobile & Address', 'error');
    return;
  }
  const btn = document.getElementById('btnOrder');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Placing Order...';

  try {
    const r = await fetch(API_BASE + '/api/store/order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        productId,
        quantity: orderQty,
        buyerName: name,
        buyerContact: contact,
        buyerEmail: email,
        buyerAddress: address,
        paymentMode: payment
      })
    });
    const d = await r.json();
    if(d.ok){
      document.getElementById('orderForm').style.display = 'none';
      const suc = document.getElementById('orderSuccess');
      suc.classList.add('show');
      document.getElementById('orderSuccessMsg').innerHTML = `Order ID: <strong>${d.orderId}</strong><br>Total: â‚¹${fmtPrice(d.total)}<br><br>We'll contact you soon to confirm.`;
      showToast('Order placed successfully! ðŸŽ‰');
    } else {
      showToast(d.error || 'Failed to place order', 'error');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-check"></i> Place Order';
    }
  } catch(e){
    showToast('Network error. Please try again.', 'error');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-check"></i> Place Order';
  }
}

function closeProductModal(){
  document.getElementById('productModal').classList.remove('show');
  document.body.style.overflow = '';
}

// Click outside to close
document.getElementById('productModal').addEventListener('click', e => {
  if(e.target.classList.contains('modal-overlay')) closeProductModal();
});

// Utilities
function esc(s){ if(!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function fmtPrice(n){ return Number(n).toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
function showToast(msg, type){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = type === 'error' ? '#ef4444' : 'var(--deep)';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3500);
}

// Header scroll effect
window.addEventListener('scroll', () => {
  document.getElementById('siteHeader').classList.toggle('scrolled', window.scrollY > 20);
});
</script>
</body>
</html>
