<!DOCTYPE html>
<html lang="en" data-lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment — FWF Membership</title>

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="assets/images/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/images/logo.png">
  <link rel="apple-touch-icon" href="assets/images/logo.png">
  <link rel="shortcut icon" href="assets/images/logo.png">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  
  <!-- Razorpay Checkout -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="assets/js/fwf.js"></script>
  
  <style>
    :root{
      --ink:#1e293b; --muted:#64748b; --soft:#f1f5f9;
      --success:#22c55e; --error:#ef4444;
      --card:#ffffff; --brd:#e2e8f0;
      --primary:#6153ff;
    }
    body{margin:0;font-family:'Plus Jakarta Sans',system-ui,sans-serif;background:#f8fafc;color:var(--ink);padding:20px 0}
    *{box-sizing:border-box}
    
    .container{max-width:720px;margin:40px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--brd);border-radius:26px;box-shadow:0 18px 50px rgba(2,6,23,.12);padding:40px 32px}
    .card h2{margin:0 0 8px;font-size:2rem;font-weight:900;color:var(--ink)}
    .card .subtitle{margin:0 0 24px;color:var(--muted);font-weight:600}
    
    .summary-box{background:linear-gradient(135deg,#fef3c7,#fef08a);border:2px solid #fbbf24;border-radius:16px;padding:24px;margin-bottom:24px}
    .summary-box h3{margin:0 0 16px;color:#92400e;font-size:1.2rem}
    .summary-item{display:flex;justify-content:space-between;margin:10px 0;padding:8px 0;border-bottom:1px solid #fcd34d}
    .summary-item:last-child{border:0;font-weight:800;font-size:1.3rem;color:#92400e}
    .summary-label{color:#78350f}
    .summary-value{font-weight:700;color:#92400e}
    
    .secure-badge{display:flex;align-items:center;gap:10px;background:#f0fdf4;border:1px solid #86efac;border-radius:12px;padding:16px;margin-bottom:24px;color:#166534;font-weight:700}
    .secure-badge i{font-size:1.5rem;color:#22c55e}
    
    .razorpay-info{background:linear-gradient(135deg,#eef2ff,#e0e7ff);border:2px solid #c7d2fe;border-radius:16px;padding:20px;margin-bottom:24px;text-align:center}
    .razorpay-info p{margin:0;font-weight:600;color:#4338ca;font-size:0.95rem}
    .razorpay-info .methods{display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap}
    .razorpay-info .method{display:flex;align-items:center;gap:6px;background:#fff;padding:8px 14px;border-radius:10px;font-size:0.9rem;font-weight:700;color:#334155;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    
    .btn-pay{width:100%;padding:18px 0;background:linear-gradient(135deg,#6153ff,#8b5cf6);color:#fff;font-weight:900;border:none;border-radius:16px;font-size:1.15rem;cursor:pointer;box-shadow:0 10px 30px rgba(97,83,255,.3);transition:all .2s;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:10px}
    .btn-pay:hover:not(:disabled){filter:brightness(1.08);transform:translateY(-2px);box-shadow:0 14px 36px rgba(97,83,255,.35)}
    .btn-pay:disabled{opacity:0.6;cursor:not-allowed}
    
    .message{padding:14px 18px;border-radius:12px;margin-bottom:20px;font-weight:600;display:none}
    .message.success{background:#d1fae5;color:#065f46;border:1px solid #6ee7b7;display:block}
    .message.error{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;display:block}
    
    .back-link{display:inline-flex;align-items:center;gap:8px;color:#6153ff;text-decoration:none;font-weight:700;margin-bottom:20px}
    .back-link:hover{text-decoration:underline}
    
    .success-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:1000}
    .success-modal.show{display:flex}
    .success-content{background:#fff;border-radius:24px;padding:40px;max-width:500px;text-align:center}
    .success-icon{font-size:4rem;color:#22c55e;margin-bottom:20px}
    .success-content h2{margin:0 0 12px;color:#22c55e}
    .success-content p{margin:12px 0;color:var(--muted)}
    .credentials{background:#f0fdf4;border:1px solid #86efac;border-radius:12px;padding:20px;margin:20px 0}
    .credentials div{margin:10px 0}
    .credentials strong{color:#166534}
    .btn-primary{display:inline-block;margin-top:20px;padding:14px 32px;background:#6153ff;color:#fff;border:none;border-radius:12px;font-weight:700;cursor:pointer;text-decoration:none}
    
    .payment-id-box{background:#eff6ff;border:1px solid #93c5fd;border-radius:10px;padding:12px;margin:12px 0;font-size:0.9rem;word-break:break-all}
    .payment-id-box strong{color:#1d4ed8}

    @media(max-width:560px){
      .card{padding:24px 16px}
      .container{padding:0 10px}
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/join" class="back-link">
      <i class="fas fa-arrow-left"></i> Back to Form
    </a>
    
    <div class="card">
      <h2><i class="fas fa-shield-alt" style="color:#6153ff"></i> Complete Payment</h2>
      <p class="subtitle">Secure your FWF membership</p>
      
      <div class="summary-box">
        <h3><i class="fas fa-receipt"></i> Order Summary</h3>
        <div class="summary-item">
          <span class="summary-label">Membership Plan:</span>
          <span class="summary-value">Monthly</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Registration Fee:</span>
          <span class="summary-value">₹500</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Total Amount:</span>
          <span class="summary-value">₹500</span>
        </div>
      </div>
      
      <div class="secure-badge">
        <i class="fas fa-lock"></i>
        <div>
          <div>100% Secure Payment</div>
          <div style="font-size:0.85rem;font-weight:500;color:#166534;margin-top:2px">Powered by Razorpay — India's most trusted payment gateway</div>
        </div>
      </div>
      
      <div class="razorpay-info">
        <p>Pay using any method you prefer</p>
        <div class="methods">
          <div class="method"><i class="fas fa-mobile-alt" style="color:#22c55e"></i> UPI</div>
          <div class="method"><i class="fas fa-credit-card" style="color:#3b82f6"></i> Card</div>
          <div class="method"><i class="fas fa-university" style="color:#8b5cf6"></i> Net Banking</div>
          <div class="method"><i class="fas fa-wallet" style="color:#f59e0b"></i> Wallet</div>
        </div>
      </div>
      
      <div id="message" class="message"></div>
      
      <button class="btn-pay" type="button" id="payBtn">
        <i class="fas fa-lock"></i> Pay ₹500 Securely
      </button>
      
      <p style="text-align:center;margin-top:16px;font-size:0.85rem;color:var(--muted)">
        <i class="fas fa-info-circle"></i> You will be redirected to Razorpay's secure payment page
      </p>
    </div>
  </div>
  
  <!-- Success Modal -->
  <div class="success-modal" id="successModal">
    <div class="success-content">
      <div class="success-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h2>Welcome to FWF!</h2>
      <p>Your membership has been successfully registered</p>
      <div class="credentials" id="credentials">
        <div><strong>Member ID:</strong> <span id="displayMemberId">Loading...</span></div>
        <div><strong>Password:</strong> <span id="displayPassword">Loading...</span></div>
      </div>
      <div class="payment-id-box">
        <strong>Payment ID:</strong> <span id="displayPaymentId"></span>
      </div>
      <p style="font-size:0.9rem;color:var(--error)">
        <i class="fas fa-exclamation-triangle"></i> Please save these credentials securely
      </p>
      <a href="/login" class="btn-primary">Login to Dashboard</a>
    </div>
  </div>

  <script>
    // Load saved data from join form
    const savedData = JSON.parse(sessionStorage.getItem('fwfJoinData') || '{}');
    if (!savedData.fullName) {
      FWF_Notify.modal({
        title: '⚠️ Session Expired',
        message: 'Your session has expired. Please fill the form again to continue.',
        type: 'warning',
        confirmText: 'Go to Form',
        onConfirm: () => { window.location.href = '/register'; }
      });
      setTimeout(() => window.location.href = '/register', 3000);
    }
    
    const payBtn = document.getElementById('payBtn');
    const message = document.getElementById('message');
    const successModal = document.getElementById('successModal');
    const AMOUNT = 500; // ₹500 membership fee
    
    function showMessage(text, type) {
      message.textContent = text;
      message.className = 'message ' + type;
      message.style.display = 'block';
      setTimeout(() => { message.style.display = 'none'; }, 6000);
    }
    
    payBtn.addEventListener('click', async () => {
      payBtn.disabled = true;
      payBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Order...';
      
      try {
        // Step 1: Create Razorpay order on backend
        const orderRes = await fetch('/api/pay/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: AMOUNT,
            type: 'membership',
            notes: { name: savedData.fullName, email: savedData.email }
          })
        });
        const orderData = await orderRes.json();
        
        if (!orderData.ok) {
          showMessage(orderData.error || 'Failed to create order', 'error');
          payBtn.disabled = false;
          payBtn.innerHTML = '<i class="fas fa-lock"></i> Pay ₹500 Securely';
          return;
        }
        
        payBtn.innerHTML = '<i class="fas fa-lock"></i> Pay ₹500 Securely';
        
        // Step 2: Open Razorpay Checkout
        const options = {
          key: orderData.key,
          amount: orderData.order.amount,
          currency: orderData.order.currency,
          name: 'FWF - Foundation for Women\'s Future',
          description: 'Membership Registration Fee (₹500)',
          image: '/assets/images/logo.png',
          order_id: orderData.order.id,
          prefill: {
            name: savedData.fullName || '',
            email: savedData.email || '',
            contact: savedData.mobile || ''
          },
          theme: {
            color: '#6153ff',
            backdrop_color: 'rgba(15,23,42,0.85)'
          },
          handler: async function(response) {
            // Step 3: Payment successful → verify + register member
            payBtn.disabled = true;
            payBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying & Registering...';
            
            try {
              const regRes = await fetch('/api/pay/membership', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  name: savedData.fullName,
                  mobile: savedData.mobile,
                  email: savedData.email,
                  project: savedData.project || '',
                  razorpay_payment_id: response.razorpay_payment_id,
                  razorpay_order_id: response.razorpay_order_id,
                  razorpay_signature: response.razorpay_signature
                })
              });
              
              const regData = await regRes.json();
              
              if (regData.ok) {
                // Also save to MongoDB via /api/join for email records
                try {
                  await fetch('/api/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      ...savedData,
                      paymentRef: response.razorpay_payment_id
                    })
                  });
                } catch(e) { console.log('MongoDB record save note:', e.message); }
                
                // Show success modal
                document.getElementById('displayMemberId').textContent = regData.memberId || 'Check email';
                document.getElementById('displayPassword').textContent = regData.password || 'Check email';
                document.getElementById('displayPaymentId').textContent = response.razorpay_payment_id;
                successModal.classList.add('show');
                sessionStorage.removeItem('fwfJoinData');
              } else {
                showMessage(regData.error || 'Registration failed. Contact support with Payment ID: ' + response.razorpay_payment_id, 'error');
                payBtn.disabled = false;
                payBtn.innerHTML = '<i class="fas fa-lock"></i> Pay ₹500 Securely';
              }
            } catch(err) {
              showMessage('Network error. Payment was successful! Contact support with Payment ID: ' + response.razorpay_payment_id, 'error');
              payBtn.disabled = false;
              payBtn.innerHTML = '<i class="fas fa-lock"></i> Pay ₹500 Securely';
            }
          },
          modal: {
            ondismiss: function() {
              payBtn.disabled = false;
              payBtn.innerHTML = '<i class="fas fa-lock"></i> Pay ₹500 Securely';
              showMessage('Payment was cancelled. You can try again.', 'error');
            }
          }
        };
        
        const rzp = new Razorpay(options);
        rzp.on('payment.failed', function(response) {
          showMessage('Payment failed: ' + (response.error.description || 'Unknown error'), 'error');
          payBtn.disabled = false;
          payBtn.innerHTML = '<i class="fas fa-lock"></i> Pay ₹500 Securely';
        });
        rzp.open();
        
      } catch(err) {
        console.error('Payment error:', err);
        showMessage('Error initiating payment. Please try again.', 'error');
        payBtn.disabled = false;
        payBtn.innerHTML = '<i class="fas fa-lock"></i> Pay ₹500 Securely';
      }
    });
  </script>
</body>
</html>
